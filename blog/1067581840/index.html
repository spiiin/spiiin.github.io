<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | daScript - скорость</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/2550823652/">Позже</a><a class="pagination__link pagination__next" href="/blog/4256110900/">Раньше</a></div><article class="article post"><h3 class="article__title">daScript - скорость</h3><div class="article__date metadata"><div class="post-info">2022/07/27</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/dascript/">dascript</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>Рассказывал о <code>daScript</code> коллеге в отпуске, в ответ на то, почему он такой быстрый, задумался, что особо коротко и не ответишь, не влезая в детали реализации, проще замерить. Очень поверхностно:</p>
<h2><span id="zayavlennoe-avtorami">Заявленное авторами</span><a href="#zayavlennoe-avtorami" class="header-anchor">#</a></h2><p>(<a href="https://dascript.org/doc/reference/introduction.html#performance" target="_blank" rel="noopener">Performance</a>, <a href="https://dascript.org/" target="_blank" rel="noopener">overview</a>, <a href="https://dascript.org/doc/reference/embedding/vm.html" target="_blank" rel="noopener">VM</a>):</p>
<ul>
<li>Быстрый интероп в C++ и обратно.</li>
<li>AoT, чтобы вообще убрать интероп, в случаях, когда можно транспилировать в C++ вместо интерпретации.</li>
<li>Кастомные аллокаторы для строк и хипа. Плюс политика для отдельных скриптов, в которых не нужно хранить выделенное — быстро перезапустить всю виртуальную машину, прибив всё аллоцированное без освобождения. Политика управления памятью или сохранения состояния может быть кастомизирована на стороне C++ — модель памяти daScript максимально простая и быстрая.</li>
<li>Использование hardware-friendly типов для нод, поддержка векторных типов в языке (в геймдеве повсюду встречаются vec4 и mat4 — многие алгоритмы просто векторизировать).</li>
</ul>
<h2><span id="aot">AoT</span><a href="#aot" class="header-anchor">#</a></h2><p>Код, скомпиленный из daScript в C++, может получиться быстрее среднего C++ кода, так же как компилятор может перевести C++ в более быстрый ассемблерный код, чем средний код, написанный на ассемблере. Причина в том, что при выборе вариантов реализации asm инструкций может быть много вариантов, из которых компилятор может выбрать более быстрый, чем рядовой программист. Т.е. если авторы языка хорошо представляют себе, во что скомпилиться сгенерированный C++ код, то теоретически, они могут сгенерировать код лучше, чем написанный средним программистом.</p>
<p>Кроме <code>daScript</code>, транспиляцию в C++ поддерживает <code>Nim</code>, который на тестах также выдаёт очень хорошие результаты. Скорее всего, генерировать LLVM код было бы эффективнее, что и планируют делать авторы языка в будущем, однако и генерация быстрого C++-кода делает эти языки очень быстрыми уже сейчас.</p>
<h2><span id="perestroyka-koda">Перестройка кода</span><a href="#perestroyka-koda" class="header-anchor">#</a></h2><p>Данные и код на daScript можно кастомизировать (<a href="/blog/1547564887/" title="макросы">макросы</a>, преобразовывающие AST, а также <a href="https://github.com/GaijinEntertainment/daScript/blob/250c5124dc1ce5e56933d42d15ef5e209d30dd20/include/daScript/ast/ast.h#L340" target="_blank" rel="noopener">перегрузка</a> simulate и visit, <a href="https://github.com/GaijinEntertainment/daScript/blob/985eaeda9ec6d4c594f9f9583ce3b14aed023d91/include/daScript/das_config.h#L74" target="_blank" rel="noopener">fusion engine</a> для паковки инструкций), это делать намного легче чем на C++. Пример из <a href="https://youtu.be/IvHGczF6Go0?t=2565" target="_blank" rel="noopener">доклада</a>, про разницу подходов при задаче раскладывания данных data-oriented для ECS фреймворка, на C++ и на daScript.</p>
<p>Наверное, чё-то ещё есть, лучше у авторов уточнить.</p>
<h2><span id="doverie-avtoram">Доверие авторам</span><a href="#doverie-avtoram" class="header-anchor">#</a></h2><p>Отдельный очевидный момент — быстрый код на языке следует из идеи языка. Если авторы всячески <a href="/blog/2630317622/" title="декларируют">декларируют</a> желание сделать быстрый язык и продолжать разгонять его — то они и будут делать именно это.</p>
<p>Косвенный признак возможности сделать что-то в языке быстро — наличие специализированных оптимизированных конструкций/структур/алгоритмов (block+lambda, string+das_string, array<t>+int[N] etc).</t></p>
<p>Почему я верю конкретно в этот язык — потому что давно видел изнутри движки <code>Gaijin</code>, их тулзы, и знаю качество их кода и используемые скриптовые языки. Ковырял все доступные материалы по скриптовым языкам <code>Naughty Dogs</code> (книга “Архитектура игровых движков”, доклады про использование Lisp-а как языка описания данных и скриптового языка в играх), некоторые идеи из которых, по интервью с автором, реализованны в <code>daScript</code>. Ну и сам Борис Баткин, небезызвестен в русском геймдев-комьюнити еще образца 2000х годов (<a href="https://web.archive.org/web/20071218053755/http://blog.gamedeff.com/?p=64" target="_blank" rel="noopener">интервью глазами пострадавшего</a>), да и просто <a href="https://www.mobygames.com/developer/sheet/view/developerId,53108/" target="_blank" rel="noopener">интересный человек</a>, скорее всего знает толк в быстром коде.</p>
<p><em>update</em><br><a href="/blog/2115627465/" title="Устройство интерпретаторов lua-jit и daScript">Устройство интерпретаторов lua-jit и daScript</a> — продолжение</p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"Ov23liG1mZbiQOIdi91X","clientSecret":"e05812685eb741a752982b89dcf6f5b58dc10251","repo":"spiiin.github.io","owner":"spiiin","admin":["spiiin"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/2550823652/">Позже</a><a class="pagination__link pagination__next" href="/blog/4256110900/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>