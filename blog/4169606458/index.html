<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | Реверс Duck Tales, Duck Tales 2, Chip and Dale 2 [NES]</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/470759513/">Позже</a><a class="pagination__link pagination__next" href="/blog/51457079/">Раньше</a></div><article class="article post"><h3 class="article__title">Реверс Duck Tales, Duck Tales 2, Chip and Dale 2 [NES]</h3><div class="article__date metadata"><div class="post-info">2013/03/31</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/nes/">nes</a><a class="article__tags__link metadata" href="/tags/hack/">hack</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p><strong>Duck Tales 1.</strong></p>
<p>Lанные на экран попадают после предварительного размещения по адресам 400-40F, где хранятся в формате набора записей вида (адрес в видеопамяти, сколько байт копировать, байты для копирования).</p>
<p>В более поздних версиях движка эту функцию изменили на простое копирование байт рядами.</p>
<p>Для скроллинга байты копируются парами квадратов 4x4 блока за один шаг, так за 8 шагов составляются 2 новых ряда. Квадраты для следующего шага записываются по адресам 3F0-3F1, 3F4-3F5 - ряды блоков на четном шаге, 3F2-3F3, 3F6-3F7 на нечетном.</p>
<p>Текущий макроблок из 4 блоков перед этим считывается из rom-памяти, мапящейся по адресам BB00, BC00, BD00, BE00.</p>
<p>В BF00 - байт цвета + типа.</p>
<p>С этого момента становится понятно, что алгоритм также совпадает с уже разобранным, чип-и-дейловским, но со смещением проекции макроблока на 256 байт вперёд.</p>
<p>Следуюшим шагом должно было бы быть вычисление индекса макротайла, но оно вычисляется сложным рассчетом адресов и битовой магией, в которой участвует непонятный набор адресов, который складывается из смеси позиции бурундука на экране, относительной позиции относительно экрана начала и нескольких констант.</p>
<p>В чипе-и-дейле я не смог дизассемблировать её и написал построчный эмулятор на питоне, через который прогнал все возможные значения из дампа. Но он работал с ошибкой, из-за которой корректно показывались только четные ряды. Повторять такой не хотелось, поэтому я просто воспользовался тем, что разности адресов совпадали во всех играх и получил адрес проекции макроблоков 0xB6E0 + 0x100 = 0xB7E0</p>
<p>Базовый адрес раскладки уровня лежит по смещению, записанному в $20-$21 (в C&amp;D был в $32-$33), код алгоритма полностью такой же, изменились только адреса.</p>
<p>Загружая разные уровни, можно посмотреть все наборы раскладок (CE6B/CEA3/CEE3/CF13/CF43 - размеры всех уровней одинаковы). Указатели на раскладки хранятся в разобранным на старший и младший байт виде, найдя их в ROM, можно определить смещение записи об уровне - 0x1CF90, и рядом со смещениями считать оставшуюся необходимую информацию для загрузки.</p>
<p>Хронологически Duck Tales - первая из серии диснеевских игр, движок которой потом оптимизировали для Chip’n’Dale, перенесли базовые адреса (которые остались и в Черном Плаще), расширили возможные раскладки уровня, добавили гибкие настройки способов скроллинга и переключение параметров после входа в двери.</p>
<p><strong>Duck Tales 2.</strong><br>Скроллинг экрана делается построчно, данные для него собираются в 56E-57E.<br>Данные выбираются по смещению от поинтеров, предварительно записанных по адресам 00-01 и 02-03 (для первого уровня смещения 807A/827A).<br>Индекс смещения означает номер блока.</p>
<p>Индекс сохраняется в регистр X, а берётся из строки байт с началом в 3A и индексом в Y. </p>
<p>В 0x3A данные попадают из ячейки с адресом, записанным в(0E-0F). Это - указатель на данные о блоках текущего экрана.</p>
<p>После записи индекса макроблока в ряд 3A-3F вызывается функция инплейсной трансформации номера макроблока в индексы составляющих его блоков.</p>
<p>Индексы блоков записываются в 4 поинтера (4D-4E), (4F-50),(51-52) и (53-54). </p>
<p>Данные об адресе раскладки уровня записаны в (4B-4C), а номер в этой раскладке кодируется байтами B и D (индекс = B*8 + D). </p>
<p>Данные в B и D попадают изначально из ячеек 97 и 98 через ячейки 18 и 1B. 97 и 98 - стартовые координаты экранов скруджа в начале уровня, берутся из ROM, спроецированного в адресное пространство AE0B - AE0E.</p>
<p>Данные о раскладке попадают в 4B на старте уровня. Адрес считавания записан в (00-01). Считываются 20 байт - 2 смещение начала, дальше следом в (4В-54) 4 поинтера на макротайлы и следом в (55-5E) 5 поинтеров на тайлы (4 кусочка и 5-й на байты цвета, тип кажется где-то в другом месте кодируется).</p>
<p>Скроллы тоже где-то отдельно лежат, если они вообще используются и нужны. </p>
<p>Пример раскладки 1 уровня, начало в 0F (9C2A):<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00 01 02 03 00 00 00 00 00 04 00 05 06 06 07 08 00 09 0A 0B 0C 0D 00 0E 0F 10 11 12 13 14 00 14 00 15 16 17 18 19 1A 1B 00 00 00 00 1C 1D 1E 1F</span><br></pre></td></tr></table></figure></p>
<p>Остальные раскладки лежат по смещениям (9C2A/9C5A/9C8A/9CBA/9CEA/901A/9C5A)</p>
<p>Вторые Duck Tales вышли в 1993, после ЧП и Чипа и Дейла, движок допилен окончательно. Отточено сжатие экранов - если видно только левую часть, то правая половинка используется где-то в другом месте.</p>
<p>Раскладки уровня заполнены практически полностью, так, чтобы было несколько проходов и множество секретных комнат.</p>
<p>Код написан просто и понятно, оперативная память распределяется грамотно, похожие значение лежат рядом.</p>
<p>Единственная странность - переход от макротайлов к тайлам сделан через указатели, и их смещение неравномерные - разница между блоками не 256 байт, а переменная, из-за этого труднее запихнуть это в редактор.</p>
<p>Скорее всего между записями о макроблоках лежит еще какая-то дополнительная информация об уровне.</p>
<p><strong>Chip and Dale 2.</strong></p>
<p>Раскопки начал не с нуля, а с картинки об устройстве уровня Roket’а :<br><a href="http://ic.pics.livejournal.com/spiiin/20318251/24611/24611_original.png" target="_blank" rel="noopener">картинка</a></p>
<p>Что сразу навело на нехорошие мысли о чём-то заумном :(</p>
<p>Данные в видеопамять попадают через строку 53B, куда они копируются из 5D1-5EF - странное дублирование.</p>
<p>Скроллинг делается в два ряда, но из маленьких тайлов, а не больших.</p>
<p>С какой-то целью было принято решение отказаться от макроблоков и строить уровни просто из блоков 2x2.</p>
<p>Из-за этого описания уровня весит в 4 раза больше, и чтобы обойти ограничение размера, в уровне где-то две трети экранов повторяющиеся (хотя очень грамотно перемешаны так, что обычный игрок об этом навряд ли догадается).</p>
<p>Начала блоков записаны 00-01 и 02-03, стандартно это 8000 и 8200.</p>
<p>Номера блоков записаны в 52A (ряд из 14 штук). Где-то рядом с ними должны миксоваться байты цвета и типа. </p>
<p>Адрес описания экрана тоже записан через указатели %). Записан в (0E), адреса в ром - 0x10, 0x110 + X 6. X считывается из (7B), где можно прочитать адрес раскладки уровня - 9E6A, 9EAA, 9EEA, 9FAA, 9F6A и т.д.</p>
<p>Адрес начала в расладке берется из содержимого 0C, деленного пополам, а туда попадает через B1 и B3, где хранятся X и Y координаты экрана. </p>
<p>Загрузка начальных значений B1 и B3 при загрузке уровня или входе в дверь.</p>
<p>Данные о начальных значениях:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">B9B5 - уровень 1-1</span><br><span class="line">B9CE - уровень 1-2</span><br><span class="line">B9E7 - уровень 1-3</span><br><span class="line">BA00 - бонус</span><br><span class="line">BDB6 - диалог с боссом</span><br><span class="line">BA19 - босс 1.</span><br></pre></td></tr></table></figure></p>
<p>Вторые C&amp;D вышли в том же году, что и DT2, но движок решили кардинально поменять, выкинули систему макроблоков и сделали уровни из повторяющихся экранов. Обращение к любым данным сделано через указатели или указатели на указатели, что мешает разбору. Архитектурно первая часть игры намного ближе к другим диснеевским аркадам от Capcom, чем ко второй части.</p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/470759513/">Позже</a><a class="pagination__link pagination__next" href="/blog/51457079/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2022 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>