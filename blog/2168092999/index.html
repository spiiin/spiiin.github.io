<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | Способ редактирования уровней Sega игр без знания ассемблера</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/3320927120/">Позже</a><a class="pagination__link pagination__next" href="/blog/3673672218/">Раньше</a></div><article class="article post"><h3 class="article__title">Способ редактирования уровней Sega игр без знания ассемблера</h3><div class="article__date metadata"><div class="post-info">2014/01/27</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/hack/">hack</a><a class="article__tags__link metadata" href="/tags/sega/">sega</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>ЧАСТЬ 1.<br>В продолжение поста “<a href="http://spiiin.livejournal.com/73202.html" target="_blank" rel="noopener">Взлом NES игр без знания ассемблера</a>“.</p>
<p>Идея та же, с небольшими модификациями. Берётся любой эмулятор Sega Mega Drive, который умеет запускать lua-скрипты (например, <a href="http://code.google.com/p/gens-rerecording/downloads/list" target="_blank" rel="noopener">Gens Rerecording v11b</a>).</p>
<p>Дальше важный факт о сеговских играх - в большинстве из них используются разные варианты сжатия данных, но для некоторых игр существуют компрессоры-декомпрессоры. Распаковку данных игра чаще всего проводит при загрузке уровня. Процесс распаковки не мгновенный, поэтому допускаем, что уровень распаковывается в оперативную память целиком. Соответственно, начинать поиск можно сразу в оперативной памяти. Однако, следует учесть, что данные на экране зависят оттого, что находится не в оперативной, а в видеопамяти, и поймать момент между загрузкой данных в оперативную память и передачей её видеоадаптеру без отладчика не выйдет. Поэтому заметить измененные в оперативной памяти данные получится только, проскроллив до 2-го игрового экрана. Это можно сделать, загрузив на проигрывание файл с записью нажатий кнопок, или сделать руками.</p>
<p>Второй вариант более простой, поэтому стоит рассмотреть его. Адресное пространство оперативной памяти - 0xFF0000-0xFFFFFF - 64 кб. Луа-скрипт для изменения данных может быть таким:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">startAddr &#x3D; 0xFF0000</span><br><span class="line">size &#x3D; 0x1000</span><br><span class="line">val &#x3D; 0x00</span><br><span class="line">savestate.load(1);</span><br><span class="line">for mem &#x3D; startAddr,startAddr+size ,1 do</span><br><span class="line">  memory.writebyte(mem, val);</span><br><span class="line">  val &#x3D; val + 1;</span><br><span class="line">end;</span><br></pre></td></tr></table></figure><br>Перед запуском нужно сделать сейв тестируемой игры в момент, когда уровень уже распакован и загружен. Дальше мы забиваем первые 0x1000 байт оперативной памяти своими данными и пробегаемся по уровню, чтобы обнаружить изменения. Их с первого раза обнаружить, естественно, не удаётся, поэтому надо сделать следующий шаг в организации поиска. Эмулятор сам обнаруживает изменение скрипта и перезагружает его, поэтому можно изменять скрипт “налету”. Для этого удобно использовать внешний метаскрипт (например, на python), который будет перезаписывать файл скрипта, меняя значение startAddr, затем засыпать на несколько секунд, давая игроку доскроллить до экрана и заметить наличие/отсутствие изменений, а потом инкрементировать начальный адрес коррапта, чтобы эмулятор перезапустил скрипт и снова отправил игрока на исследования.</p>
<p>В случае неоднозначных изменений (например, персонаж проваливается сквозь пол, застревает в пустоте или мгновенно умирает), можно сужать пространство поиска, уменьшая размер size в два раза и проверяя отдельные половины оперативной памяти, пока не обнаружатся такие блоки уровня, которые не мешают персонажу пройти, но в то же время видны визуально на соседнем экране.</p>
<p>После сужения поиска до обнаружения одного-двух рядов блоков (см. скрин ниже), можно переписать метаскрипт так, чтобы он больше не менял значение адреса и размера, зато менял значение val в оперативной памяти. Это нужно, чтобы сделать скриншоты всех возможных блоков уровня для блочного редактора. Для удобства снятия скриншотов можно отключить фоны и/или отображение спрайтов в эмуляторе (клавишами Ctrl+F1/F2/F3). Процесс нужно будет повторить для блоков переднего и заднего фонов (Layer A &amp; Layer B), они обычно находятся в памяти рядом друг с другом.</p>
<p><img src="http://ic.pics.livejournal.com/spiiin/20318251/35421/35421_300.png" alt="Quack Shot Starring Donald Duck_000" title="Quack Shot Starring Donald Duck_000"></p>
<p>После этого остаётся вырезать со скриншотов линии с блоками и “сшить” их в ленту, чтобы засунуть в редактор CadEditor. После этого нужно сохранить дамп оперативной памяти в файл (в меню эмулятора - Tools-&gt;Ram dump) и написать конфиг для редактора, в котором указать файл с картинками и найденное смещение начала данных в дампе.</p>
<p>Метод протестирован на играх Tiny Toon Buster’s Hidden Treasure, QuackShot и Contra Hard Corps (^_^), все получилось добавить в редактор уровней:<br><img src="http://ic.pics.livejournal.com/spiiin/20318251/34633/34633_300.png" alt="cad_editor_contra" title="cad_editor_contra"><br><img src="http://ic.pics.livejournal.com/spiiin/20318251/34993/34993_300.png" alt="cad_editor_quackshot" title="cad_editor_quackshot"><br><img src="http://ic.pics.livejournal.com/spiiin/20318251/35309/35309_300.png" alt="cad_editor_tt" title="cad_editor_tt"></p>
<p>Игры используют системы построения уровней из блоков размером 32x32 (16x16 для QuackShot) пиксела, как и большинство NES-овских). Разница только в том, что Tiny Toon и Quackshot хранят их поэкранно, и используют раскладку(layout), в которой записаны номера экранов (они частенько повторяются в первых четырёх подуровнях первой зоны Tiny Toon), а Contra описывает весь уровень длинными линиями в 256 блоков и 16 блоков в высоту (причём в местах, куда игрок не может добраться, здания и не дорисованы доверху).</p>
<p>После редактирования уровня его ещё нужно упаковать и засунуть обратно в игру. Этого без кодирования сделать не удастся =\ Про запаковку в следующий раз.</p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/3320927120/">Позже</a><a class="pagination__link pagination__next" href="/blog/3673672218/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2022 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>