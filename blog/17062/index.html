<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | Adventure Island 2 [NES] - Алгоритм выбор пути</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/28787/">Позже</a><a class="pagination__link pagination__next" href="/blog/23504/">Раньше</a></div><article class="article post"><h3 class="article__title">Adventure Island 2 [NES] - Алгоритм выбор пути</h3><div class="article__date metadata"><div class="post-info">2012/10/02</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/nes/">nes</a><a class="article__tags__link metadata" href="/tags/hack/">hack</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>Еще одна оставшаяся нерешенной задачка из мира старых игр - алгоритм выбора пути между уровнями в Adventure Island 2. </p>
<p>В третьей части выбор следующей зоны зависел от того, обычным путём был закончен уровень или нахождением тайного выхода, а вот во второй главгерой мог шарится по острову по дороге к боссу довольно долго или добежать почти сразу.</p>
<p>Единственное, что было известно - что алгоритм выбора зависел от выбора яйца с бонусом в конце каждого уровня - так как в 3-м яйце чаще всего была спрятана жизнь, то игрок выбирал его и получал одинаковый маршрут. Поиск в интернете показал, что точного алгоритма выбора не знал никто, так что надо было выяснить его, вооружившись отладчиком.</p>
<p><strong>Поиск</strong> дал немного полезной информации - на сайте у <a href="http://cah4e3.shedevr.org.ru/cheatsbase.php" target="_blank" rel="noopener">cah4e3’а</a> нашёлся код на выбор уровня и <a href="http://ru.wikipedia.org/wiki/Game_Genie" target="_blank" rel="noopener">game-genie</a> код для перевода игры в дебаг режим. Из него доступны - выбор любой зоны, мира, бессмертие, тест звуков и предметов. </p>
<p>По номерам уровня можно расчерчить <strong>карту всех участков</strong> и составить планы уровней.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00-0F - горы (обычные, снежные, вулканы)</span><br><span class="line">10-17 - джунгли(обычные и снежные)</span><br><span class="line">18-1F - озера</span><br><span class="line">20-2F - пещеры(обычные, темные и заснеженные)</span><br><span class="line">30-3A - леса(обычные, закатные, морозные)</span><br><span class="line">3B - логово последнего босса</span><br><span class="line">3C-3F - леса</span><br><span class="line">40-41 - ночные джунгли</span><br><span class="line">42-43 - пики гор</span><br><span class="line">44-47 - горные озёра</span><br><span class="line">48-49 - ледяные пещеры</span><br><span class="line">4A-4B - пустыня</span><br><span class="line">4C-4D - облака</span><br><span class="line">4E - логово 2-го босса</span><br><span class="line">4F - вулканы</span><br><span class="line">50-57 - боссы</span><br></pre></td></tr></table></figure>
<p><strong>Визуальным поиском</strong> по оперативной памяти номеров уровней в комнате бонусов можно найти, что все они располагаются в диапазоне 3E0-3FF - “мапа” уровня вперемежку с пустыми байтами. Если поменять эти байты и исследовать поведение игры, то выяснится: - Пройденная зона отмечается байтом F0, причем иногда в мапе уровня изначально присутствуют такие байты, что наводит на мысль о существовании коридоров, через которые можно ускоряться. - Если проиграть боссу, то он перемещается в свободную зону. Но, если свободных зон уже не осталось, остается в той же. Босс движется по тому же алгоритму, что и игрок. - Обычно из каждого уровня можно перейти в один из двух возможных, но бывают и исключения. Тут стоит прекратить гадание и поставить в отладчике точку остановки на запись в диапазоне памяти 3E0-3FF. 4. Остановка срабатывает по адресу: <em>F682: LDA #$F0, STA $03E0,X</em> В X текущая координата, относительно мапы уровней. Ячейка памяти, из которой считывается это смещение - D1.</p>
<p><strong>Дизассемблированная процедура выбора:</strong> <a href="https://gist.github.com/3814486" target="_blank" rel="noopener">https://gist.github.com/3814486</a></p>
<p>Описание алгоритма: Берём номер яйца с бонусом в конце уровня, пытаемся перейти последовательно по одному из 8 вариантов, соотвествующих этому яйцу и прописанных в таблице переходов в ROM, по порядку (доступные смещения переходов +1,+7,+8,+9, -1,-7,-8,-9, то есть сместиться можно либо в соседний участок на острове, либо в один из дальних). Если не выходит (участок пустой или пройденный), то пытаемся хотя бы сменить уровень на тот, что уже был пройден и повторить процедуру поиска следующего уровня сначала. Если с 4х раз не получилось, берем последний доступный уровень с конца мапы. Если же все уровни пройдены, остаемся в том же.</p>
<p><strong>Мапы всех островов.</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. FF FF FF FF FF FF FF FF FF FF FF 36 41 FF FF FF FF 00 20 F0 40 FF FF FF 15 37 F0 18 2A FF FF FF (начало - 15, конец - 41)</span><br><span class="line">2. FF 4E 1A 2C FF FF FF FF FF 01 23 31 FF FF FF FF FF FF FF FF 19 FF FF FF FF FF 14 30 FF FF FF FF (начало - 14, конец - 4E)</span><br><span class="line">3. FF FF FF 4A 4B FF FF FF FF FF 33 FF FF 02 03 FF FF FF FF 10 13 FF FF FF FF FF FF 21 3D FF FF FF (начало - 3D, конец - 4A)</span><br><span class="line">4. FF FF 48 FF FF FF FF FF FF 1E 43 17 FF FF FF FF 27 FF FF FF 3F FF FF FF FF 3E 08 09 FF FF FF FF (начало - 08, конец - 48)</span><br><span class="line">5. 2E 46 45 2B FF FF FF FF 22 07 06 11 FF FF FF FF 32 FF FF 1C FF FF FF FF FF 24 FF FF FF FF FF FF (начало - 24, конец - 46)</span><br><span class="line">6. 4D FF FF FF FF FF FF FF 2D FF FF FF 35 FF FF FF 3A 05 FF FF 1D FF FF FF 25 16 4C 04 FF FF FF FF (начало - 35, конец - 4D)</span><br><span class="line">7. 4F FF FF FF FF FF FF FF 0E 0A FF FF FF FF FF FF 29 34 26 FF 0B FF FF FF 12 FF FF 3C FF FF FF FF (начало - 0B, конец - 4F)</span><br><span class="line">8. FF 0C 0D 44 FF FF FF FF 2F 3B 1F 39 FF FF FF FF FF 0F 47 38 1B 49 FF FF FF FF FF 28 FF 42 FF FF (начало - 42, конец - 3B)</span><br></pre></td></tr></table></figure>
<p><strong>Реверс алгоритма выбора пути и сравнение путей на питоне:</strong> <a href="https://gist.github.com/3814503" target="_blank" rel="noopener">https://gist.github.com/3814503</a> </p>
<p><strong>Самые короткие и самые длинные дороги через острова:</strong> номер означает участок, через который проходит игрок, а в скобках стоит номер яйца, необходимого для перемещения к следующему участку. </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">**FERN ISLAND** * остров содержит бонус-сокращалку, можно не сражаться с боссом</span><br><span class="line">КОРОТКИЕ ПУТИ: 15 -&gt;(0)-&gt; 0 -&gt;(0)-&gt; 20 -&gt;(0)-&gt; 36 -&gt;(0)-&gt; 41 15 -&gt;(3)-&gt; 37 -&gt;(4)-&gt; 20 -&gt;(0)-&gt; 36 -&gt;(0)-&gt; 41</span><br><span class="line">ДЛИННЫЕ ПУТЬ: 15 -&gt;(0)-&gt; 0 -&gt;(0)-&gt; 20 -&gt;(0)-&gt; 36 -&gt;(2)-&gt; 40 -&gt;(2)-&gt; 18 -&gt;(0)-&gt; 2A -&gt;(0)-&gt; 37 -&gt;(0)-&gt; 41 </span><br><span class="line"></span><br><span class="line">**LAKE ISLAND**</span><br><span class="line">КОРОТКИЕ ПУТИ: 0X14 -&gt;(0)-&gt; 30 -&gt;(0)-&gt; 19 -&gt;(0)-&gt; 31 -&gt;(1)-&gt; 1A -&gt;(1)-&gt; 4E 0X14 -&gt;(0)-&gt; 30 -&gt;(0)-&gt; 19 -&gt;(0)-&gt; 31 -&gt;(2)-&gt; 23 -&gt;(1)-&gt; 4E</span><br><span class="line">ДЛИННЫЙ ПУТЬ: 0X14 -&gt;(0)-&gt; 30 -&gt;(0)-&gt; 19 -&gt;(0)-&gt; 31 -&gt;(0)-&gt; 2C -&gt;(0)-&gt; 1A -&gt;(3)-&gt; 1 -&gt;(4)-&gt; 23 -&gt;(0)-&gt; 4E </span><br><span class="line"></span><br><span class="line"> **DESERT ISLAND** * остров содержит бонус-сокращалку, можно не сражаться с боссом</span><br><span class="line"> КОРОТКИЕ ПУТИ: 0X3D -&gt;(1)-&gt; 10 -&gt;(0)-&gt; 33 -&gt;(0)-&gt; 4A</span><br><span class="line"> ДЛИННЫЙ ПУТЬ: 0X3D -&gt;(0)-&gt; 13 -&gt;(0)-&gt; 2 -&gt;(4)-&gt; 3 -&gt;(0)-&gt; 21 -&gt;(0)-&gt; 10 -&gt;(0)-&gt; 33 -&gt;(0)-&gt; 4A </span><br><span class="line"> </span><br><span class="line"> **ICE ISLAND**</span><br><span class="line"> КОРОТКИЕ ПУТИ: 0X8 -&gt;(0)-&gt; 9 -&gt;(0)-&gt; 3F -&gt;(0)-&gt; 17 -&gt;(0)-&gt; 48 0X8 -&gt;(1)-&gt; 3E -&gt;(0)-&gt; 27 -&gt;(0)-&gt; 1E -&gt;(0)-&gt; 48</span><br><span class="line"> ДЛИННЫЙ ПУТЬ: 0X8 -&gt;(0)-&gt; 9 -&gt;(0)-&gt; 3F -&gt;(0)-&gt; 17 -&gt;(2)-&gt; 43 -&gt;(2)-&gt; 1E -&gt;(2)-&gt; 27 -&gt;(0)-&gt; 3E -&gt;(0)-&gt; 48 </span><br><span class="line"> </span><br><span class="line"> **CAVE ISLAND** * остров содержит бонус-сокращалку, можно не сражаться с боссом</span><br><span class="line"> КОРОТКИЕ ПУТИ: 0X24 -&gt;(0)-&gt; 32 -&gt;(0)-&gt; 22 -&gt;(7)-&gt; 46 0X24 -&gt;(0)-&gt; 32 -&gt;(4)-&gt; 7 -&gt;(0)-&gt; 46</span><br><span class="line"> ДЛИННЫЙ ПУТЬ: 0X24 -&gt;(0)-&gt; 32 -&gt;(0)-&gt; 22 -&gt;(0)-&gt; 2E -&gt;(2)-&gt; 7 -&gt;(4)-&gt; 6 -&gt;(0)-&gt; 45 -&gt;(0)-&gt; 2B -&gt;(0)-&gt; 11 -&gt;(0)-&gt; 1C -&gt;(0)-&gt; 46 </span><br><span class="line"> </span><br><span class="line"> **CLOUD ISLAND** </span><br><span class="line"> КОРОТКИЕ ПУТИ: 0X35 -&gt;(0)-&gt; 1D -&gt;(0)-&gt; 4 -&gt;(0)-&gt; 4C -&gt;(0)-&gt; 5 -&gt;(0)-&gt; 2D -&gt;(0)-&gt; 4D</span><br><span class="line"> ДЛИННЫЙ ПУТЬ: 0X35 -&gt;(0)-&gt; 1D -&gt;(0)-&gt; 4 -&gt;(0)-&gt; 4C -&gt;(0)-&gt; 5 -&gt;(0)-&gt; 2D -&gt;(3)-&gt; 3A -&gt;(0)-&gt; 16 -&gt;(0)-&gt; 25 -&gt;(0)-&gt; 4D </span><br><span class="line"> </span><br><span class="line"> **VOLCANO ISLAND**</span><br><span class="line"> КОРОТКИЕ ПУТИ: 0XB -&gt;(0)-&gt; 3C -&gt;(0)-&gt; 26 -&gt;(0)-&gt; A -&gt;(0)-&gt; 4F</span><br><span class="line"> ДЛИННЫЙ ПУТЬ: 0XB -&gt;(0)-&gt; 3C -&gt;(0)-&gt; 26 -&gt;(0)-&gt; A -&gt;(2)-&gt; E -&gt;(3)-&gt; 29 -&gt;(0)-&gt; 34 -&gt;(0)-&gt; 12 -&gt;(0)-&gt; 4F </span><br><span class="line"> </span><br><span class="line"> **DINOSAUR ISLAND** </span><br><span class="line"> КОРОТКИЕ ПУТИ: </span><br><span class="line"> 0X42 -&gt;(1)-&gt; 1B -&gt;(0)-&gt; 39 -&gt;(1)-&gt; D -&gt;(3)-&gt; 3B 0X42 -&gt;(1)-&gt; 1B -&gt;(0)-&gt; 39 -&gt;(2)-&gt; 1F -&gt;(2)-&gt; 3B</span><br><span class="line"> 0X42 -&gt;(1)-&gt; 1B -&gt;(0)-&gt; 39 -&gt;(3)-&gt; 47 -&gt;(1)-&gt; 3B 0X42 -&gt;(1)-&gt; 1B -&gt;(2)-&gt; 38 -&gt;(1)-&gt; 1F -&gt;(2)-&gt; 3B</span><br><span class="line"> 0X42 -&gt;(1)-&gt; 1B -&gt;(2)-&gt; 38 -&gt;(2)-&gt; 47 -&gt;(1)-&gt; 3B 0X42 -&gt;(1)-&gt; 1B -&gt;(3)-&gt; 28 -&gt;(1)-&gt; 47 -&gt;(1)-&gt; 3B</span><br><span class="line"></span><br><span class="line"> ДЛИННЫЙ ПУТЬ: 0X42 -&gt;(0)-&gt; 49 -&gt;(0)-&gt; 1B -&gt;(0)-&gt; 39 -&gt;(0)-&gt; 44 -&gt;(0)-&gt; D -&gt;(0)-&gt; C -&gt;(0)-&gt; 1F -&gt;(4)-&gt; 47 -&gt;(4)-&gt; 28 -&gt;(0)-&gt; 38 -&gt;(0)-&gt; F -&gt;(1)-&gt; 2F -&gt;(0)-&gt; 3B</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/28787/">Позже</a><a class="pagination__link pagination__next" href="/blog/23504/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2023 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>