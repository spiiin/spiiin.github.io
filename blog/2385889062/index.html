<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | daScript - решение задачек</title><meta name="description" content="&lt;p&gt;Решение нескольких алгоритмических задачек на &lt;code&gt;daScript&lt;/code&gt;.&lt;br&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/4060902549/">Позже</a><a class="pagination__link pagination__next" href="/blog/2115627465/">Раньше</a></div><article class="article post"><h3 class="article__title">daScript - решение задачек</h3><div class="article__date metadata"><div class="post-info">2022/10/16</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/dascript/">dascript</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>Решение нескольких алгоритмических задачек на <code>daScript</code>.<br><a id="more"></a></p>
<p>Задачки со старого собеса Nokia на C++ программиста (уже закрыли офис в России), <a href="https://twitter.com/st_1ena/status/1419689924505260032" target="_blank" rel="noopener">разбор</a></p>
<h2 id="Вычислить-первые-N-простых-чисел"><a href="#Вычислить-первые-N-простых-чисел" class="headerlink" title="Вычислить первые N простых чисел"></a>Вычислить первые N простых чисел</h2><p>.. и вернуть результат в качестве массива.</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">calc_primes</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">n</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">; </span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">:</span><span style="color: #c586c0;">array</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&gt;)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a |&gt; </span><span style="color: #dcdcaa;">clear</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a |&gt; reserve(n)</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; a |&gt; </span><span style="color: #dcdcaa;">push</span><span style="color: #d4d4d4;">(</span><span style="color: #b5cea8;">2</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> n == </span><span style="color: #b5cea8;">1</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a |&gt; </span><span style="color: #dcdcaa;">push</span><span style="color: #d4d4d4;">(</span><span style="color: #b5cea8;">3</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> gen &lt;- </span><span style="color: #4ec9b0;">generator</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&gt;() &lt;| </span><span style="color: #569cd6;">$</span><span style="color: #d4d4d4;">()</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> t = </span><span style="color: #b5cea8;">6</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">true</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #4ec9b0;">yield</span><span style="color: #d4d4d4;"> t-</span><span style="color: #b5cea8;">1</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #4ec9b0;">yield</span><span style="color: #d4d4d4;"> t+</span><span style="color: #b5cea8;">1</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; t += </span><span style="color: #b5cea8;">6</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">false</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> iterVal: </span><span style="color: #4ec9b0;">int</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">length</span><span style="color: #d4d4d4;">(a) &lt; n</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; next(gen, iterVal)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> simple = </span><span style="color: #c586c0;">true</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> prim </span><span style="color: #c586c0;">in</span><span style="color: #d4d4d4;"> a</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> iterVal % prim == </span><span style="color: #b5cea8;">0</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; simple = </span><span style="color: #c586c0;">false</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> prim * prim &gt; iterVal</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">break</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> simple</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; a |&gt; </span><span style="color: #dcdcaa;">push</span><span style="color: #d4d4d4;">(iterVal)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a: </span><span style="color: #c586c0;">array</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&gt;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; calc_primes(</span><span style="color: #b5cea8;">1000000</span><span style="color: #d4d4d4;">, a)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">[</span><span style="color: #569cd6;">length</span><span style="color: #ce9178;">(a)-1]}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div></div>
<p><a href="https://github.com/spiiin/dascript_trivial_examples/blob/main/primes/primes.das" target="_blank" rel="noopener">https://github.com/spiiin/dascript_trivial_examples/blob/main/primes/primes.das</a></p>
<p>Тривиальная версия:</p>
<ul>
<li>чуть более улучшенная формула перебора чисел-кандидатов (вместо всех нечётных — t*6+/-1) + проверка границы не корнем, а квадратом.</li>
<li>не совсем понял, как хочет применить решето Эратосфена в варианте на C++ сама st_1ena, если нужны первые N простых чисел, а не “все числа меньшие N”, то возникает подзадача оценить минимальное натуральное число, меньше которого точно окажутся N простых чисел, что также нетривиально, или построить ленивых фильтров, что совсем нетривиально на C++, и требует оценки памяти под эти фильтры.</li>
<li>вместо этого, версия решения, которая может вычислить первые N чисел в compile-time — в предположении, что у нас есть некоторое количество памяти, для сохранения решета эратосфена, эффективнее тогда потратить всю эту память на хранение предпросчитанных первых значений, и начинать рассчёт только сверх этих предпросчитанных чисел. На языках с макросами — предпросчёт в compile-time выполняется той же функцией, что в run-time, т.е. не требует написания дополнительного кода.<br><a href="https://github.com/spiiin/dascript_trivial_examples/blob/main/primes/primes_mix_compile_runtime.das" target="_blank" rel="noopener">Версия</a>, которая сохраняет первый числа в кеш (макрос [cached_primes (count=200)] - с параметром, сколько чисел будет предпросчитано заранее)</li>
</ul>
<h2 id="Посчитать-статистику-слов-в-тексте-по-длине-слова"><a href="#Посчитать-статистику-слов-в-тексте-по-длине-слова" class="headerlink" title="Посчитать статистику слов в тексте по длине слова"></a>Посчитать статистику слов в тексте по длине слова</h2><p>Задача на то, чтобы найти в стандартной библиотеке языка нужные функциии</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> fio</span></div><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> strings</span></div><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> daslib/strings_boost</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">main</span><span style="color: #d4d4d4;">()</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> strings : </span><span style="color: #c586c0;">array</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">string</span><span style="color: #d4d4d4;">&gt;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; fopen(</span><span style="color: #ce9178;">"eng_to_rus.txt"</span><span style="color: #d4d4d4;">,</span><span style="color: #ce9178;">"rt"</span><span style="color: #d4d4d4;">) &lt;| </span><span style="color: #569cd6;">$</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">f</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> f != </span><span style="color: #c586c0;">null</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> !feof(f)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; strings |&gt; </span><span style="color: #dcdcaa;">push </span><span style="color: #d4d4d4;">&lt;| fgets(f)</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> counter : </span><span style="color: #c586c0;">table</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">; </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&gt;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> str </span><span style="color: #c586c0;">in</span><span style="color: #d4d4d4;"> strings</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> words &lt;- str |&gt; split_by_chars(</span><span style="color: #ce9178;">" .,:-</span><span style="color: #d7ba7d;">\n\t</span><span style="color: #ce9178;">()%</span><span style="color: #d7ba7d;">\"</span><span style="color: #ce9178;">'"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> word </span><span style="color: #c586c0;">in</span><span style="color: #d4d4d4;"> words</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> word != </span><span style="color: #ce9178;">""</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; counter[</span><span style="color: #569cd6;">length</span><span style="color: #d4d4d4;">(word)] += </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;"> &#160; </span><span style="color: #6a9955;">//word length</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//counter[word] += 1 &#160; &#160; &#160; &#160; //word</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> freq_pairs : </span><span style="color: #c586c0;">array</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">tuple</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&gt;&gt;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> k, v </span><span style="color: #c586c0;">in</span><span style="color: #d4d4d4;"> keys(counter), values(counter)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; freq_pairs |&gt; </span><span style="color: #dcdcaa;">push </span><span style="color: #d4d4d4;">&lt;| [[ </span><span style="color: #4ec9b0;">tuple</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&gt; k, v]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; freq_pairs |&gt; sort(</span><span style="color: #569cd6;">$</span><span style="color: #d4d4d4;">(a,</span><span style="color: #9cdcfe;">b</span><span style="color: #d4d4d4;">) =&gt; !(a._1 &lt; b._1))</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> pair </span><span style="color: #c586c0;">in</span><span style="color: #d4d4d4;"> freq_pairs</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">pair</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">_0</span><span style="color: #ce9178;">} : {</span><span style="color: #9cdcfe;">pair</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">_1</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div></div>
<p><a href="https://github.com/spiiin/dascript_trivial_examples/blob/main/sort_words_stat_by_word_len/sort_words_stat_by_word_len.das" target="_blank" rel="noopener">https://github.com/spiiin/dascript_trivial_examples/blob/main/sort_words_stat_by_word_len/sort_words_stat_by_word_len.das</a></p>
<p>Решение в лоб - прочитать файл построчно, разбить на символы <code>split_by_chars</code>, обновляя в словаре значения количество слов. Дальше переложить значение в список пар, который отсортировать по первому элементу, и вывести на экран.</p>
<ul>
<li>Можно упороться по тому, чтобы выяснять у интервьюера, какие допустимы кодировки, разделители или что есть слова, как кажется подразумевали авторы задачи, которые потом расстроились, что ни один кандидат не учёл все возможные кейсы.</li>
<li>Можно сохранять данные не в словаре, а сразу в списке пар <code>(длина слова, частота)</code>, не так то и много возможных длин слов. Сортировка такого списка пар в daScript - либо с помощью явной передачи функции сортировки, либо определением <a href="https://github.com/GaijinEntertainment/daScript/blob/17941ef0b0199dff0db27a2bee603db1a45b69b3/examples/test/unit_tests/sort.das#L20" target="_blank" rel="noopener">оператора &lt;</a> для своего типа.</li>
</ul>
<h2 id="Удалить-из-односвязного-списка-каждый-пятый-элемент"><a href="#Удалить-из-односвязного-списка-каждый-пятый-элемент" class="headerlink" title="Удалить из односвязного списка каждый пятый элемент"></a>Удалить из односвязного списка каждый пятый элемент</h2><p>Интересно посмотреть на разницу в работе с памятью между C++ и daScript</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> ListItem</span></div><div><span style="color: #d4d4d4;">&#160; &#160; value: </span><span style="color: #4ec9b0;">int</span></div><div><span style="color: #d4d4d4;">&#160; &#160; [[do_not_delete]] next: ListItem?</span></div><br><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> makeDemoList</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> head = &#160;</span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[ListItem value=</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> current = head</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> i </span><span style="color: #c586c0;">in</span><span style="color: #d4d4d4;"> range(</span><span style="color: #b5cea8;">2</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">21</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; current.next = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[ListItem value=i]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; current = current.next</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> head</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">sideeffects</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">deleteEveryFifth</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">lst</span><span style="color: #d4d4d4;">: ListItem?)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> counter = </span><span style="color: #b5cea8;">1</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> current = lst</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> current != </span><span style="color: #c586c0;">null</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> counter++ % </span><span style="color: #b5cea8;">4</span><span style="color: #d4d4d4;"> == </span><span style="color: #b5cea8;">0</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> toDelete = current.next</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; current.next = current.next?.next</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">unsafe</span><span style="color: #d4d4d4;"> { </span><span style="color: #c586c0;">delete</span><span style="color: #d4d4d4;"> toDelete; }</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; current = current.next</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">printList</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">lst</span><span style="color: #d4d4d4;">: ListItem?)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> lst != </span><span style="color: #c586c0;">null</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">lst</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">value</span><span style="color: #ce9178;">} "</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; printList(lst.next)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">else</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> list = makeDemoList()</span></div><div><span style="color: #d4d4d4;">&#160; &#160; printList(list)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; deleteEveryFifth(list)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; printList(list)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//freeList //or just kill context</span></div><br><div><span style="color: #6a9955;">//Output:</span></div><div><span style="color: #6a9955;">// 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20</span></div><div><span style="color: #6a9955;">// 1 2 3 4 6 7 8 9 11 12 13 14 16 17 18 19</span></div></div>
<p><a href="https://github.com/spiiin/dascript_trivial_examples/blob/main/delete_list_every_5/delete_every_fifth.das" target="_blank" rel="noopener">https://github.com/spiiin/dascript_trivial_examples/blob/main/delete_list_every_5/delete_every_fifth.das</a></p>
<ul>
<li>Раз мы “играем в C++”, то попробуем при удалении элемента из списка сразу же звать <a href="https://dascript.org/doc/reference/language/finalizers.html?highlight=finalizer" target="_blank" rel="noopener">финализатор</a> для него. Финализатор по умолчанию рекурсивно зовёт финализаторы для всех полей структуры. Это поведение можно изменить, если переопределить функцию <code>finalize</code>, или если пометить поле атрибутом <code>[[do_not_delete]]</code> (так как мы вручную измененяем указатели при удалении элемента, то элемент списка не отвечает за удаление следующего элемента по ссылке next).</li>
<li>С помощью <code>options persistent_heap = true</code>, можно настроить также освобождение памяти после вызова финализатора (иначе за освобождение памяти отвечает хост-программа, один из паттернов быстрой работы с памятью — грохнуть всю выделенную в цикле работы скрипта память разом).</li>
</ul>
<h2 id="Вывести-максимальное-число-составленное-из-единиц-двоичного-представления-заданного-числа"><a href="#Вывести-максимальное-число-составленное-из-единиц-двоичного-представления-заданного-числа" class="headerlink" title="Вывести максимальное число, составленное из единиц двоичного представления заданного числа"></a>Вывести максимальное число, составленное из единиц двоичного представления заданного числа</h2><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">popcount</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> temp = x</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> count = </span><span style="color: #b5cea8;">0</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">while</span><span style="color: #d4d4d4;"> temp != </span><span style="color: #b5cea8;">0</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; temp &amp;= temp - </span><span style="color: #b5cea8;">1</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; count++</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> count</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">maxFrom1s</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> count1s = popcount(x)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> res = </span><span style="color: #b5cea8;">0</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> i </span><span style="color: #c586c0;">in</span><span style="color: #d4d4d4;"> range(count1s)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; res++</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; res&lt;&lt;=</span><span style="color: #b5cea8;">1</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> i </span><span style="color: #c586c0;">in</span><span style="color: #d4d4d4;"> range(</span><span style="color: #b5cea8;">31</span><span style="color: #d4d4d4;"> - count1s) </span><span style="color: #6a9955;">//assume 32 bits</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; res&lt;&lt;=</span><span style="color: #b5cea8;">1</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> res </span></div><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{uint(maxFrom1s(</span><span style="color: #b5cea8;">256</span><span style="color: #d4d4d4;">-</span><span style="color: #b5cea8;">1</span><span style="color: #ce9178;">))}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">) &#160;</span><span style="color: #6a9955;">//'0xff000000'</span></div></div>
<p><a href="https://github.com/spiiin/dascript_trivial_examples/blob/main/max_value_from_1s/max_value_from_1s.das" target="_blank" rel="noopener">https://github.com/spiiin/dascript_trivial_examples/blob/main/max_value_from_1s/max_value_from_1s.das</a></p>
<p>Тоже без заморочек, в лоб.</p>
<p>В продакшен-варианте, если нужно действительно быстро, решение прокидывается в C++, где задействуются всевозможные интринсики компилятора для того, чтобы получать кол-во битов так, как умеет процессор, или другие трюки для минимизации количества инструкций (развернуть циклы, и наложить кучу масок — <a href="https://en.wikipedia.org/wiki/Hamming_weight" target="_blank" rel="noopener">Hamming weight</a>).</p>
<h2 id="Вывести-список-всех-самых-длинных-путей-в-дереве"><a href="#Вывести-список-всех-самых-длинных-путей-в-дереве" class="headerlink" title="Вывести список всех самых длинных путей в дереве"></a>Вывести список всех самых длинных путей в дереве</h2><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> daslib/functional</span></div><br><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> Tree</span></div><div><span style="color: #d4d4d4;">&#160; &#160; data : </span><span style="color: #4ec9b0;">int</span></div><div><span style="color: #d4d4d4;">&#160; &#160; left, right : Tree?</span></div><br><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> tree = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[ Tree data = </span><span style="color: #b5cea8;">5</span><span style="color: #d4d4d4;">,</span></div><div><span style="color: #d4d4d4;">&#160; &#160; left = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[Tree data = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, </span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; right = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[Tree data = </span><span style="color: #b5cea8;">2</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; ]],</span></div><div><span style="color: #d4d4d4;">&#160; &#160; right = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[Tree data = </span><span style="color: #b5cea8;">7</span><span style="color: #d4d4d4;">,</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; right = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[Tree data = </span><span style="color: #b5cea8;">10</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; ]]</span></div><div><span style="color: #d4d4d4;">]]</span></div><br><div><span style="color: #6a9955;">//TODO: optimize</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">clone_array</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">: </span><span style="color: #c586c0;">array</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&gt;; </span><span style="color: #9cdcfe;">newData</span><span style="color: #d4d4d4;">:</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">unsafe</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> newArr &lt;- to_array(each(a))</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; newArr |&gt; </span><span style="color: #dcdcaa;">push </span><span style="color: #d4d4d4;">&lt;| newData</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> &lt;- newArr</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">each_element</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">tree</span><span style="color: #d4d4d4;">:Tree?; </span><span style="color: #9cdcfe;">path</span><span style="color: #d4d4d4;">: </span><span style="color: #c586c0;">array</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&gt;; </span><span style="color: #9cdcfe;">depth</span><span style="color: #d4d4d4;">:</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">; </span><span style="color: #9cdcfe;">blk</span><span style="color: #d4d4d4;">:</span><span style="color: #4ec9b0;">lambda</span><span style="color: #d4d4d4;">&lt;(what: </span><span style="color: #9cdcfe;">int</span><span style="color: #d4d4d4;">; </span><span style="color: #9cdcfe;">path</span><span style="color: #d4d4d4;">: </span><span style="color: #c586c0;">array</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&gt;; </span><span style="color: #9cdcfe;">depth</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">):</span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;">&gt;)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> tree.left != </span><span style="color: #c586c0;">null</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; each_element(tree.left, clone_array(path, tree.data), depth+</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, blk)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">invoke</span><span style="color: #d4d4d4;">(blk, tree.data, path, depth)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> tree.right != </span><span style="color: #c586c0;">null</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; each_element(tree.right, clone_array(path, tree.data), depth+</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, blk)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> startPath: </span><span style="color: #c586c0;">array</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&gt;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> globalResult : </span><span style="color: #c586c0;">table</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">; </span><span style="color: #c586c0;">array</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #c586c0;">array</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&gt;&gt;&gt;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">unsafe</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; tree |&gt; each_element(startPath, </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">) &lt;| @[[&amp;globalResult]](value: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">; path: </span><span style="color: #c586c0;">array</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&gt;; depth: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; globalResult[</span><span style="color: #569cd6;">depth</span><span style="color: #d4d4d4;">] |&gt; push_clone &lt;| clone_array(path, value)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//find max depth</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> maxDepth = reduce(keys(globalResult)) &lt;| </span><span style="color: #569cd6;">$</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">left, right </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> left &gt; right ? left : right</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//print all pathes</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"All pathes with longest depth:</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> path </span><span style="color: #c586c0;">in</span><span style="color: #d4d4d4;"> globalResult[</span><span style="color: #569cd6;">maxDepth</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">path</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #6a9955;">//All pathes with longest depth:</span></div><div><span style="color: #6a9955;">//[[ 5; 1; 2]]</span></div><div><span style="color: #6a9955;">//[[ 5; 7; 10]]</span></div></div>
<p><a href="https://github.com/spiiin/dascript_trivial_examples/blob/main/all_pathes_max_depth/all_pathes_max_depth.das" target="_blank" rel="noopener">https://github.com/spiiin/dascript_trivial_examples/blob/main/all_pathes_max_depth/all_pathes_max_depth.das</a></p>
<p>Туповатое решение, с кучей лишних копирований путей.</p>
<p>Можно оптимайзить. Либо по памяти, разделив обход на 2 — сначала найти максимальную глубину, затем собрать только самые длинные пути. Либо в один проход, но сохраняя не полные копии путей, а альтернативное дерево с записью глубины каждой ветви рядом с указателем на оригинальные ноды left и right, по которому можно будет восстановить пути + обновляя максимальное значение глубины каждую итерацию.</p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/4060902549/">Позже</a><a class="pagination__link pagination__next" href="/blog/2115627465/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>