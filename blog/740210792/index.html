<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | Сборка эмулятора NES (NESOID) под Android</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/1604429615/">Позже</a><a class="pagination__link pagination__next" href="/blog/1579894033/">Раньше</a></div><article class="article post"><h3 class="article__title">Сборка эмулятора NES (NESOID) под Android</h3><div class="article__date metadata"><div class="post-info">2014/08/01</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/nes/">nes</a><a class="article__tags__link metadata" href="/tags/hack/">hack</a><a class="article__tags__link metadata" href="/tags/android/">android</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>В сети валяются несколько версий эмуляторов NES с открытыми исходниками.</p>
<p>В основном это либо едва начатые учебные проекты, либо порты написанного на C универсального эмулятора <a href="http://www.zophar.net/nes/fce-ultra.html" target="_blank" rel="noopener">FCE</a>.</p>
<p>Версия под android называется Nesoid, исходники её разбросаны по интернету<br><a href="http://sourceforge.net/projects/nesoid" target="_blank" rel="noopener">http://sourceforge.net/projects/nesoid</a><br><a href="https://code.google.com/p/androidnes/source/browse/" target="_blank" rel="noopener">https://code.google.com/p/androidnes/source/browse/</a><br><a href="https://f-droid.org/repository/browse/?fdfilter=nesoid&amp;fdid=com.androidemu.nes" target="_blank" rel="noopener">https://f-droid.org/repository/browse/?fdfilter=nesoid&amp;fdid=com.androidemu.nes</a></p>
<p>Полные исходники, с библиотекой <a href="https://github.com/Pretz/Emudroid-Common" target="_blank" rel="noopener">Emudroid-Common</a>, (без неё при сборке будет ругаться на нехватку файла <em>utils/Log.h</em>) и интерфейсом на Java, есть только на <a href="https://f-droid.org/repo/com.androidemu.nes_61_src.tar.gz" target="_blank" rel="noopener">f-droid</a>, там же есть и собранный из них готовый apk, так что для старта лучше выбрать их.</p>
<p>Библиотеки на C собирается с помощью <a href="https://developer.android.com/tools/sdk/ndk/index.html" target="_blank" rel="noopener">Android Native SDK</a>, после установки в папке с Nesoid достаточно набрать <em>ndk-build</em>, чтобы собрать нужные для эмулятора библиотека <strong><em>libnes</em></strong>, <strong><em>libemu</em></strong> и <strong><em>libnativehelper</em></strong>.</p>
<p>Для сборки самого эмулятора необходим <a href="http://developer.android.com/sdk/index.html" target="_blank" rel="noopener">Android SDK</a>, с доустановленным через <em>SDK Manager</em> <strong><em>Android API 10</em></strong> (под него по умолчанию собирается эмулятор).</p>
<p>Сами <em>Build tools</em> лучше использовать версии &gt; 19.0, потому что на 19.0 компилятор падает с <a href="http://stackoverflow.com/questions/19727915/android-dex-gives-a-bufferoverflowexception-when-building" target="_blank" rel="noopener">Buffer overflow exception</a>.</p>
<p> После установки всех необходимых sdk осталось установить систему сборки <a href="http://ant.apache.org" target="_blank" rel="noopener">Ant</a>, и для него указать в файле <em>(PATH_TO_EMULATOR_SOURCES)/local.properties</em> пути к sdk и ndk, например: sdk.dir=C:/android-sdk ndk.dir=C:/android-ndk-r9d</p>
<p> Далее можно собрать эмулятор с помощью команды ant debug и установить на подключенное по usb устройство с android: ant installd</p>
<p> После этого при открытии рома эмулятор будет падать из-за <a href="https://github.com/Pretz/SNesoid/issues/3" target="_blank" rel="noopener">ошибки</a> в сигнатуре метода, поэтому в файле <strong><em>common\emumedia.cpp</em></strong> стоит поправить строчку 116: - env-&gt;CallStaticIntMethod(jPeerClass, midSetSurfaceRegion, x, y, w, h); + env-&gt;CallStaticVoidMethod(jPeerClass, midSetSurfaceRegion, x, y, w, h); После этого эмулятор будет работать нормально. </p>
<p> Что можно добавить в эмулятор полезного? Практически любую фичу из реализованных в современной версии <a href="http://www.fceux.com/web/version.html" target="_blank" rel="noopener">fceux</a>.</p>
<p> Например, можно вернуть поддерживаемую в FCE опцию автоматической загрузки <em>ips-патчей</em> и <em>проигрывание повторений</em> игры. Если открыть файл <strong>romname.nes.ips</strong> или <strong>romname.nes.fcm</strong>, то эмулятор использует его, чтобы открыть игру <strong>romname.nes</strong> и загрузить данный файл - функция <em>FCEUI_LoadGamе</em>.</p>
<p> Всё, что нужно для активации данной фишки -добавить в GUI эмулятора отображение файлов нужных типов.</p>
<p> Они описаны в файле <strong><em>(EMU_PATH)/res/values/arrays.xml</em></strong>: <string-array name="file\_chooser\_filters"> <item>.nes</item> <item>.fds</item> <item>.zip</item> <item>.ips</item> <!-- ips patches --> <item>.fcm</item> <!-- movies --> &lt;/string-array&gt; 6. Можно также начать возвращение скриптовых возможностей.</p>
<p> Встроить <em>lua</em> быстро не выйдет, но можно добавить свой обработчик в главный цикл эмуляции процессора <strong>X6502</strong>.</p>
<p> Для этого сначала отредактировать файл <strong><em>(EMU_PATH)/neslib/Android.mk</em></strong>: #LOCAL_CFLAGS += -DASM_6502 #убрать директиву, которая включает код реализации главного цикла на ассемблере.<br> LOCAL_SRC_FILES +=x6502.c #добавить код реализации главного цикла процессора на C.<br> Дальше можно просто добавить в функцию X6502_Run_c вызов своего кода:<br> … CallInjected();<br> //вызов функции обработки каждый такт процессора.<br> _PC++; switch(b1) {<br>   …</p>
<p>   Затем надо реализовать обработчик для конкретной игры и сделать распознавание конкретных игр по хэшу при открытии. </p>
<p>   Можно для теста найти места переключения уровней в Super Mario Bros. Lua-скрипт для win версии FCEUltra:<br>   function logLevel()<br>   local logStr = string.format(“Level %01X-%01X\n”, memory.readbyte(0x75F)+1, memory.readbyte(0x75C)+1)<br>   rint(logStr)<br>   end</p>
<p>   memory.registerexec(0xB8A5, logLevel) — переключение обычных сцен<br>   memory.registerexec(0x845A, logLevel) — конец мира 8.</p>
<p>   Если подключить к эмулятору <a href="http://developer.android.com/google/play-services/games.html" target="_blank" rel="noopener">Google Play Services</a> (про это нужна отдельная статья), то можно играть в Марио и получать ачивменты за пройденные уровни ^_^.</p>
<p>   <a href="http://ic.pics.livejournal.com/spiiin/20318251/38390/38390_original.png" target="_blank" rel="noopener"><img src="http://ic.pics.livejournal.com/spiiin/20318251/38390/38390_300.png" alt="Screenshot_2014-07-31-18-43-43" title="Screenshot_2014-07-31-18-43-43"></a></p>
<p>   Ссылка на приложение в маркете: <a href="https://play.google.com/store/apps/details?id=com.androidemu.nesachiev" target="_blank" rel="noopener">https://play.google.com/store/apps/details?id=com.androidemu.nesachiev</a></p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/1604429615/">Позже</a><a class="pagination__link pagination__next" href="/blog/1579894033/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>