<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | daScript - контексты</title><meta name="description" content="&lt;p&gt;В заметке про &lt;a href=&quot;/blog/3006126295/&quot; title=&quot;live-режим&quot;&gt;live-режим&lt;/a&gt; для opengl-приложений в daScript я кратко описывал контексты (раздел &lt;code&gt;Архитектура приложения&lt;/code&gt;). Здесь разберу их немного более подробно.&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/4174799834/">Позже</a><a class="pagination__link pagination__next" href="/blog/1728452067/">Раньше</a></div><article class="article post"><h3 class="article__title">daScript - контексты</h3><div class="article__date metadata"><div class="post-info">2023/03/08</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/dascript/">dascript</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>В заметке про <a href="/blog/3006126295/" title="live-режим">live-режим</a> для opengl-приложений в daScript я кратко описывал контексты (раздел <code>Архитектура приложения</code>). Здесь разберу их немного более подробно.</p>
<a id="more"></a>
<h2 id="Контекст"><a href="#Контекст" class="headerlink" title="Контекст"></a>Контекст</h2><p>Программы daScript выполняются в <a href="https://github.com/GaijinEntertainment/daScript/blob/master/include/daScript/simulate/simulate.h#L252" target="_blank" rel="noopener">контексте</a>, структуре, которая хранит окружение программы — выделенную память, в которой хранятся код и данные программы, загруженные модули, настройки виртуальной машины.</p>
<p><a href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/tutorial/tutorial06.cpp" target="_blank" rel="noopener">tutorual06</a> показывает работу с контекстом в daScript:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//загружаем das-файл и компилируем его</span></span><br><span class="line"><span class="keyword">auto</span> program = compileDaScript(<span class="string">"dummy.das"</span>, fAccess, tout, dummyLibGroup);</span><br><span class="line"><span class="comment">//создаём контекст, в котором будет выполняться программа</span></span><br><span class="line">ContextPtr ctx = make_shared&lt;Context&gt;(program-&gt;getContextStackSize());</span><br><span class="line"><span class="comment">//симулируем выполнение программу (строит дерево симуляции для выполнения в виртуальной машине)</span></span><br><span class="line">program-&gt;simulate(*ctx, tout);</span><br><span class="line"><span class="comment">//находим в контексте скомпилированную функцию</span></span><br><span class="line">SimFunction *fni = ctx-&gt;findFunction(<span class="string">"test"</span>);</span><br><span class="line"><span class="comment">//тут могут быть опциональные стадии проверки сигнатуры функции</span></span><br><span class="line">verifyCall&lt;<span class="keyword">float</span>&gt;(fni-&gt;debugInfo, dummyLibGroup);</span><br><span class="line"><span class="comment">//выполняем функцию в контексте, тип результата -- 128-бит</span></span><br><span class="line">vec4f res = ctx-&gt;evalWithCatch(fni, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="comment">//приводим результат к C++-типу</span></span><br><span class="line"><span class="keyword">float</span> result = cast&lt;<span class="keyword">float</span>&gt;::to(res);</span><br></pre></td></tr></table></figure>
<p>(<a href="/blog/2115627465/" title="Устройство интерпретаторов lua-jit и daScript">Устройство интерпретаторов lua-jit и daScript</a> — немного более детально про симуляцию программы)</p>
<p>Создание и удаление контекстов в daScript дешёво, один из паттернов организации C++-приложения, использующего daScript — выделение нового контекста, выполнение в нём работы и уничтожение.</p>
<p>Контекст можно воспринимать как экземпляр выполняющейся программы. Программа на С++ может иметь несколько контекстов, каждый из которых может выполнять программу на daScript (как скомпилированную из различных das-файлов, так и из одного и того же).</p>
<h2 id="Создание-контекста-из-daScript"><a href="#Создание-контекста-из-daScript" class="headerlink" title="Создание контекста из daScript"></a>Создание контекста из daScript</h2><p>API для создания контекстов также доступно в самом daScript, так что скрипт сам может создавать новые контексты и выполнять в них программы.</p>
<p>Пример <a href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/test/misc/eval_in_context.das" target="_blank" rel="noopener">eval_in_context</a>:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//создание текста программы</span></span><br><span class="line">let text = build_string &lt;| $(st)</span><br><span class="line">    st |&gt; write(<span class="string">"[export]\n"</span>)</span><br><span class="line">    st |&gt; write(<span class="string">"def eval(var res:int?)\n"</span>)</span><br><span class="line">    st |&gt; write(<span class="string">"\tunsafe\n"</span>)</span><br><span class="line">    st |&gt; write(<span class="string">"\t\t*res = 42\n"</span>)</span><br><span class="line">    st |&gt; write(<span class="string">"\n"</span>)</span><br><span class="line"><span class="comment">//def eval(var res:int?)</span></span><br><span class="line"><span class="comment">//  unsafe</span></span><br><span class="line"><span class="comment">//      *res = 42</span></span><br><span class="line"></span><br><span class="line">access |&gt; set_file_source(<span class="string">"__dummy_file_name"</span>, text)</span><br><span class="line">  <span class="keyword">using</span> &lt;| $(var mg:ModuleGroup)</span><br><span class="line">    <span class="keyword">using</span> &lt;| $(var cop:CodeOfPolicies)</span><br><span class="line">      <span class="comment">//компилируем строку с текстом программы</span></span><br><span class="line">      compile_file(<span class="string">"__dummy_file_name"</span>,access,unsafe(addr(mg)), cop) &lt;| $(ok,program,errors)</span><br><span class="line">        <span class="comment">//строим дерево симуляции</span></span><br><span class="line">        simulate(program) &lt;| $ (sok; context; serrors )</span><br><span class="line">          unsafe</span><br><span class="line">            var res:<span class="keyword">int</span></span><br><span class="line">            <span class="comment">//выполняем функцию eval в контексте скомпилированной программы</span></span><br><span class="line">            context |&gt; invoke_in_context(<span class="string">"eval"</span>, addr(res))</span><br><span class="line">            print(<span class="string">"&#123;res&#125;\n"</span>)</span><br></pre></td></tr></table></figure>
<p>В примере выше в скомплированные программу передаётся адрес из другого контекста. Это небезопасно, так как один контекст ничего не знает про время жизни переменных другом, поэтому операция отмечена как <code>unsafe</code>.</p>
<h2 id="Форк-контекста"><a href="#Форк-контекста" class="headerlink" title="Форк контекста"></a>Форк контекста</h2><p>Кроме возможности иметь раздельные контексты, daScript позволяет склонировать существующий контекст — <a href="https://github.com/GaijinEntertainment/daScript/blob/cd448fdbd4c6aa81897d2a8543943af112e2cbeb/src/simulate/simulate.cpp#L1659" target="_blank" rel="noopener">fork_debug_agent_context</a>. Функция создаёт клон контекста, и выставляет флаг контекста <code>persistent</code>, а затем в этом клонированном контексте выполняет функцию инициализации, переданную аргументом. Обычно в этой функции регистрируется новый <code>DebugAgent</code> — обёртка над контекстом, которая позволяет найти указатель на склонированный контекст по имени (и опционально, изменить поведение с помощью хуков). Склонированный контекст имеет доступ к тому же окружению, что и основной (модули, функции, копии переменных).</p>
<p><strong>Склонированный контекст не копирует состояние из основного!</strong></p>
<p>Пример <a href="https://github.com/GaijinEntertainment/daScript/blob/726d440be7618fb431815b18e6f785c37a335d5d/examples/test/misc/agent_fork_sample.das" target="_blank" rel="noopener">agent_fork_sample.das</a></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">require debugapi</span><br><span class="line"></span><br><span class="line">var test_value = <span class="string">"default"</span></span><br><span class="line"></span><br><span class="line">[<span class="keyword">export</span>] def debug_context_set()</span><br><span class="line">    print(<span class="string">"&#123;this_context().name&#125;:&#123;test_value&#125;\n"</span>)</span><br><span class="line">    test_value = <span class="string">"debug_context"</span> <span class="comment">//изменить значение переменной в контексте debug_context</span></span><br><span class="line">    print(<span class="string">"&#123;this_context().name&#125;:&#123;test_value&#125;\n"</span>)</span><br><span class="line"></span><br><span class="line">[<span class="keyword">export</span>]</span><br><span class="line">def main</span><br><span class="line">    this_context().name := <span class="string">"my_context"</span></span><br><span class="line">    fork_debug_agent_context &lt;| @@(var new_context : Context)</span><br><span class="line">        <span class="comment">//вызывается в новом контексте, устанавливаем DebugAgent, который сохранит ссылку на новый контекст</span></span><br><span class="line">        install_new_debug_agent(<span class="keyword">new</span> DapiDebugAgent(), <span class="string">"debug_context"</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"&#123;this_context().name&#125;:&#123;test_value&#125;\n"</span>)</span><br><span class="line">    <span class="comment">//меняем значение глобальной переменной</span></span><br><span class="line">    test_value = <span class="string">"my_context"</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">"&#123;this_context().name&#125;:&#123;test_value&#125;\n"</span>)</span><br><span class="line">    <span class="comment">//ждём создания контекста агента</span></span><br><span class="line">    <span class="keyword">while</span> !has_debug_agent_context(<span class="string">"debug_context"</span>)</span><br><span class="line">        pass</span><br><span class="line">    unsafe</span><br><span class="line">        <span class="comment">//изменяем значение переменной в контексте debug_context</span></span><br><span class="line">        get_debug_agent_context(<span class="string">"debug_context"</span>) |&gt; invoke_in_context(<span class="string">"debug_context_set"</span>)</span><br><span class="line">    </span><br><span class="line">    print(<span class="string">"&#123;this_context().name&#125;:&#123;test_value&#125;\n"</span>)</span><br></pre></td></tr></table></figure>
<p>Выведет:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">my_context:default                            &#x2F;&#x2F; в основном контексте test_value имеет значение по умолчанию</span><br><span class="line">my_context:my_context                         &#x2F;&#x2F; изменили значение в основном контексте</span><br><span class="line">debug agent debug_context:default             &#x2F;&#x2F; &lt;--в склонированном контексте test_value имеет значение по умолчанию</span><br><span class="line">debug agent debug_context:debug_context       &#x2F;&#x2F; изменили значение в склонированном контексте</span><br><span class="line">my_context:my_context                         &#x2F;&#x2F; в основном контексте значение test_value не изменилось</span><br></pre></td></tr></table></figure></p>
<p>Аннотация для функций <a href="https://github.com/GaijinEntertainment/daScript/blob/726d440be7618fb431815b18e6f785c37a335d5d/examples/test/misc/apply_in_context_example.das" target="_blank" rel="noopener">apply_in_context</a> позволяет вызывать функцию в другом контексте прозрачно для вызывающего кода. Пример выше можно переписать так:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">require daslib/apply_in_context</span><br><span class="line"></span><br><span class="line">[apply_in_context(debug_context)]</span><br><span class="line"><span class="function">def <span class="title">debug_context_set</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="title">print</span><span class="params">(<span class="string">"&#123;this_context().name&#125;:&#123;test_value&#125;\n"</span>)</span></span></span><br><span class="line"><span class="function">    test_value </span>= <span class="string">"debug_context"</span> <span class="comment">//изменить значение переменной в контексте debug_context</span></span><br><span class="line">    print(<span class="string">"&#123;this_context().name&#125;:&#123;test_value&#125;\n"</span>)</span><br><span class="line"></span><br><span class="line">...<span class="comment">//тот же код создания агента</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> !has_debug_agent_context(<span class="string">"debug_context"</span>)</span><br><span class="line">    pass</span><br><span class="line">debug_context_set() <span class="comment">//функция будет вызвана в контексте debug_context</span></span><br></pre></td></tr></table></figure>
<p>Пример создания отдельного контекста — модуль <a href="https://github.com/GaijinEntertainment/daScript/blob/master/daslib/live.das#L189" target="_blank" rel="noopener">live</a>, пример клонирования — <a href="https://github.com/GaijinEntertainment/daScript/blob/5649b32e8b779ceb90b7eabd73f58b7d2077cff6/modules/dasOpenGL/opengl/opengl_cache.das#L56" target="_blank" rel="noopener">opengl_cache</a>.</p>
<h2 id="Переопределение-поведения-debug-агентов"><a href="#Переопределение-поведения-debug-агентов" class="headerlink" title="Переопределение поведения debug-агентов"></a>Переопределение поведения debug-агентов</h2><p>Можно вызвать функции, определённые в классе-наследнике debug-агента (<a href="https://github.com/GaijinEntertainment/daScript/blob/37b86881a8f4890913e2f80537708575c3441a3f/examples/test/misc/invoke_debug_agent_function.das" target="_blank" rel="noopener">invoke_debug_agent_function</a>), но намного более интересной возможностью является переопределения методов. Виртуальная машина daScript отслеживает наличие зарегистрированных отладочных агентов и передаёт им информацию в ходе выполнения программы — интерфейс <a href="https://github.com/GaijinEntertainment/daScript/blob/62f8b1b2ff4c873c9fc1b7ada61ed332fb349e4c/src/builtin/debugger.das#L10" target="_blank" rel="noopener">DapiDebugAgent</a>.</p>
<p>Простые примеры определения кастомных debug-агентов:<br><a href="https://github.com/GaijinEntertainment/daScript/blob/685f0415fc1cb2d52ae6c875f702eb7c09862e38/examples/test/misc/logger_and_logger_agent.das" target="_blank" rel="noopener">logger_agent</a> — добавление кастомного префикса при логгировании<br><a href="https://github.com/GaijinEntertainment/daScript/blob/eaa99142af33e7499137c4c7351d02075223cd5b/examples/test/misc/insturment_function.das" target="_blank" rel="noopener">insturment_function</a> — профилирование вызовов функций.<br><a href="https://github.com/GaijinEntertainment/daScript/blob/726d440be7618fb431815b18e6f785c37a335d5d/examples/test/misc/instrument.das" target="_blank" rel="noopener">instrument</a> — программный брейкпоинт и пошаговая трассировка</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">options debugger = <span class="literal">true</span>    <span class="comment">//настройка контекста для работы с хуками debug-агентов</span></span><br><span class="line">require debugapi           <span class="comment">//интерфейсы для кастомных debug-агентов</span></span><br><span class="line">require rtti               <span class="comment">//получение информации о контексте выполнения (доступные модули/функции/переменные/etc)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//программный брейкпоинт, вызывает хук onBreakpoint в debug-агенте</span></span><br><span class="line">breakpoint</span><br><span class="line"><span class="comment">//устанавливает номер строчки, для которой будет вызван хук onInstrument</span></span><br><span class="line">instrument_node </span><br><span class="line"><span class="comment">//устанавливает режим трассирования, хук onSingleStep будет вызван для каждой строчки выполнения до отключения</span></span><br><span class="line">set_single_step</span><br><span class="line"><span class="comment">//устанавливает фильтр на функции, для которых будет вызван хук onInstrumentFunction </span></span><br><span class="line">instrument_all_functions</span><br><span class="line"><span class="comment">//вызывает хук onLog</span></span><br><span class="line">to_log</span><br><span class="line"><span class="comment">//вызывает хук onCollect</span></span><br><span class="line">collect_debug_agent_state</span><br><span class="line"><span class="comment">//вызывает хук onVariable у установленного DapiStackWalker</span></span><br><span class="line">report_context_state</span><br></pre></td></tr></table></figure>
<p>Более сложные примеры:<br><a href="https://github.com/GaijinEntertainment/daScript/blob/726d440be7618fb431815b18e6f785c37a335d5d/examples/test/misc/stackwalk.das" target="_blank" rel="noopener">stackwalk</a> — более продвинутая версия <code>instrument</code>, устанавливает кастомный <code>DapiStackWalker</code> и <code>DapiDataWalker</code>, печатает значение локальных переменных на каждом шаге<br><a href="https://github.com/GaijinEntertainment/daScript/blob/66e627465d8aca7934c4b6a92f2fc0d16347c9f7/examples/test/misc/context_state_example.das" target="_blank" rel="noopener">context_state_example</a> — еще немного более полная версия информации о переменных, уже более похожая на информацию для отладчика<br><a href="https://github.com/GaijinEntertainment/daScript/blob/767ebf69143244c544dacdc2efed5a7410940ed5/modules/dasOpenGL/opengl/opengl_state.das" target="_blank" rel="noopener">opengl_state</a> — в хуке onCollect печатает информацию о состояниях OpenGL<br><a href="https://github.com/GaijinEntertainment/daScript/blob/62f8b1b2ff4c873c9fc1b7ada61ed332fb349e4c/daslib/decs_state.das" target="_blank" rel="noopener">decs_state</a> — собирает информацию из модуля <code>decs</code> (entity-component-system)<br><a href="https://github.com/GaijinEntertainment/daScript/blob/62f8b1b2ff4c873c9fc1b7ada61ed332fb349e4c/daslib/ast_debug.das" target="_blank" rel="noopener">ast_debug</a> — информация о состоянии expression tree, для отладки макросов</p>
<h2 id="Инструмнты-основе-debug-агентов"><a href="#Инструмнты-основе-debug-агентов" class="headerlink" title="Инструмнты  основе debug-агентов"></a>Инструмнты  основе debug-агентов</h2><p>Полноценный <strong><code>отладчик</code></strong> — <a href="https://github.com/GaijinEntertainment/daScript/blob/2695f756b17bc184016ea97973ef143a669a937e/daslib/debug.das" target="_blank" rel="noopener">debug</a> (debug-агент + сервер для связи с IDE) (<a href="https://marketplace.visualstudio.com/items?itemName=profelis.dascript-plugin" target="_blank" rel="noopener">плагин для vscode</a>):<br>(необходимо определить <code>#define DAS_DEBUGGER 1</code> если это по каким-то причинам не определилось в das_config.h автоматически)<br><img src="/blog/3298324261/debugger.png" alt=""></p>
<p>Более продвинутый <a href="https://borisbat.github.io/dascf-blog/2022/12/11/instruments/" target="_blank" rel="noopener">пример</a> <strong><code>instrument_function</code></strong> — обёртка, сохраняющая результат в файл, который можно посмотреть в виде флеймграфа.</p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/4174799834/">Позже</a><a class="pagination__link pagination__next" href="/blog/1728452067/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2023 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>