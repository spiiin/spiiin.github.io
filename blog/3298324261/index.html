<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | daScript - контексты</title><meta name="description" content="&lt;p&gt;В заметке про &lt;a href=&quot;/blog/3006126295/&quot; title=&quot;daScript - live-режим&quot;&gt;live-режим&lt;/a&gt; для opengl-приложений в daScript я кратко описывал контексты (раздел &lt;code&gt;Архитектура приложения&lt;/code&gt;). Здесь разберу их немного более подробно.&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,0.1),rgba(40,44,52,0.9))}</style><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/4174799834/">Позже</a><a class="pagination__link pagination__next" href="/blog/1728452067/">Раньше</a></div><article class="article post"><h3 class="article__title">daScript - контексты</h3><div class="article__date metadata"><div class="post-info">2023/03/08</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/dascript/">dascript</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>В заметке про <a href="/blog/3006126295/" title="daScript - live-режим">live-режим</a> для opengl-приложений в daScript я кратко описывал контексты (раздел <code>Архитектура приложения</code>). Здесь разберу их немного более подробно.</p>
<span id="more"></span>
<h2><span id="kontekst">Контекст</span><a href="#kontekst" class="header-anchor">#</a></h2><p>Программы daScript выполняются в <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/include/daScript/simulate/simulate.h#L252">контексте</a>, структуре, которая хранит окружение программы — выделенную память, в которой хранятся код и данные программы, загруженные модули, настройки виртуальной машины.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/tutorial/tutorial06.cpp">tutorual06</a> показывает работу с контекстом в daScript:</p>
<figure class="shiki cpp"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//загружаем das-файл и компилируем его</span></span>
<span class="line"><span style="color: #569CD6">auto</span><span style="color: #E6E6E6"> program </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">compileDaScript</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;dummy.das&quot;</span><span style="color: #E6E6E6">, fAccess, tout, dummyLibGroup);</span></span>
<span class="line"><span style="color: #6A9955">//создаём контекст, в котором будет выполняться программа</span></span>
<span class="line"><span style="color: #E6E6E6">ContextPtr ctx </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">make_shared</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Context</span><span style="color: #E6E6E6">&gt;(</span><span style="color: #9CDCFE">program</span><span style="color: #E6E6E6">-&gt;</span><span style="color: #DCDCAA">getContextStackSize</span><span style="color: #E6E6E6">());</span></span>
<span class="line"><span style="color: #6A9955">//симулируем выполнение программу (строит дерево симуляции для выполнения в виртуальной машине)</span></span>
<span class="line"><span style="color: #9CDCFE">program</span><span style="color: #E6E6E6">-&gt;</span><span style="color: #DCDCAA">simulate</span><span style="color: #E6E6E6">(</span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6">ctx, tout);</span></span>
<span class="line"><span style="color: #6A9955">//находим в контексте скомпилированную функцию</span></span>
<span class="line"><span style="color: #E6E6E6">SimFunction </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6">fni </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">ctx</span><span style="color: #E6E6E6">-&gt;</span><span style="color: #DCDCAA">findFunction</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;test&quot;</span><span style="color: #E6E6E6">);</span></span>
<span class="line"><span style="color: #6A9955">//тут могут быть опциональные стадии проверки сигнатуры функции</span></span>
<span class="line"><span style="color: #DCDCAA">verifyCall</span><span style="color: #E6E6E6">&lt;</span><span style="color: #569CD6">float</span><span style="color: #E6E6E6">&gt;(</span><span style="color: #9CDCFE">fni</span><span style="color: #E6E6E6">-&gt;</span><span style="color: #9CDCFE">debugInfo</span><span style="color: #E6E6E6">, dummyLibGroup);</span></span>
<span class="line"><span style="color: #6A9955">//выполняем функцию в контексте, тип результата -- 128-бит</span></span>
<span class="line"><span style="color: #E6E6E6">vec4f res </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">ctx</span><span style="color: #E6E6E6">-&gt;</span><span style="color: #DCDCAA">evalWithCatch</span><span style="color: #E6E6E6">(fni, </span><span style="color: #569CD6">nullptr</span><span style="color: #E6E6E6">);</span></span>
<span class="line"><span style="color: #6A9955">//приводим результат к C++-типу</span></span>
<span class="line"><span style="color: #569CD6">float</span><span style="color: #E6E6E6"> result </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> cast&lt;</span><span style="color: #569CD6">float</span><span style="color: #E6E6E6">&gt;::</span><span style="color: #DCDCAA">to</span><span style="color: #E6E6E6">(res);</span></span></code></pre></div></div></figure>
<p>(<a href="/blog/2115627465/" title="Устройство интерпретаторов lua-jit и daScript">Устройство интерпретаторов lua-jit и daScript</a> — немного более детально про симуляцию программы)</p>
<p>Создание и удаление контекстов в daScript дешёво, один из паттернов организации C++-приложения, использующего daScript — выделение нового контекста, выполнение в нём работы и уничтожение.</p>
<p>Контекст можно воспринимать как экземпляр выполняющейся программы. Программа на С++ может иметь несколько контекстов, каждый из которых может выполнять программу на daScript (как скомпилированную из различных das-файлов, так и из одного и того же).</p>
<h2><span id="sozdanie-konteksta-iz-dascript">Создание контекста из daScript</span><a href="#sozdanie-konteksta-iz-dascript" class="header-anchor">#</a></h2><p>API для создания контекстов также доступно в самом daScript, так что скрипт сам может создавать новые контексты и выполнять в них программы.</p>
<p>Пример <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/test/misc/eval_in_context.das">eval_in_context</a>:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//создание текста программы</span></span>
<span class="line"><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> text </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> build_string </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">st</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    st </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> write(</span><span style="color: #CE9178">&quot;[export]</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    st </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> write(</span><span style="color: #CE9178">&quot;def eval(var res:int?)</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    st </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> write(</span><span style="color: #CE9178">&quot;</span><span style="color: #D7BA7D">\t</span><span style="color: #CE9178">unsafe</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    st </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> write(</span><span style="color: #CE9178">&quot;</span><span style="color: #D7BA7D">\t\t</span><span style="color: #CE9178">*res = 42</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    st </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> write(</span><span style="color: #CE9178">&quot;</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #6A9955">//def eval(var res:int?)</span></span>
<span class="line"><span style="color: #6A9955">//  unsafe</span></span>
<span class="line"><span style="color: #6A9955">//      *res = 42</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">access </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> set_file_source(</span><span style="color: #CE9178">&quot;__dummy_file_name&quot;</span><span style="color: #E6E6E6">, text)</span></span>
<span class="line"><span style="color: #E6E6E6">  using </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">mg</span><span style="color: #E6E6E6">:ModuleGroup)</span></span>
<span class="line"><span style="color: #E6E6E6">    using </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">cop</span><span style="color: #E6E6E6">:CodeOfPolicies)</span></span>
<span class="line"><span style="color: #E6E6E6">      </span><span style="color: #6A9955">//компилируем строку с текстом программы</span></span>
<span class="line"><span style="color: #E6E6E6">      compile_file(</span><span style="color: #CE9178">&quot;__dummy_file_name&quot;</span><span style="color: #E6E6E6">,access,</span><span style="color: #C586C0">unsafe</span><span style="color: #E6E6E6">(</span><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(mg)), cop) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(ok,program,</span><span style="color: #9CDCFE">errors</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//строим дерево симуляции</span></span>
<span class="line"><span style="color: #E6E6E6">        simulate(program) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6"> (</span><span style="color: #9CDCFE">sok</span><span style="color: #E6E6E6">; </span><span style="color: #9CDCFE">context</span><span style="color: #E6E6E6">; </span><span style="color: #9CDCFE">serrors</span><span style="color: #E6E6E6"> )</span></span>
<span class="line"><span style="color: #E6E6E6">          </span><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> res:</span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #6A9955">//выполняем функцию eval в контексте скомпилированной программы</span></span>
<span class="line"><span style="color: #E6E6E6">            context </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> invoke_in_context(</span><span style="color: #CE9178">&quot;eval&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(res))</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #9CDCFE">res</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span></code></pre></div></div></figure>
<p>В примере выше в скомплированные программу передаётся адрес из другого контекста. Это небезопасно, так как один контекст ничего не знает про время жизни переменных другом, поэтому операция отмечена как <code>unsafe</code>.</p>
<h2><span id="fork-konteksta">Форк контекста</span><a href="#fork-konteksta" class="header-anchor">#</a></h2><p>Кроме возможности иметь раздельные контексты, daScript позволяет склонировать существующий контекст — <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/cd448fdbd4c6aa81897d2a8543943af112e2cbeb/src/simulate/simulate.cpp#L1659">fork_debug_agent_context</a>. Функция создаёт клон контекста, и выставляет флаг контекста <code>persistent</code>, а затем в этом клонированном контексте выполняет функцию инициализации, переданную аргументом. Обычно в этой функции регистрируется новый <code>DebugAgent</code> — обёртка над контекстом, которая позволяет найти указатель на склонированный контекст по имени (и опционально, изменить поведение с помощью хуков). Склонированный контекст имеет доступ к тому же окружению, что и основной (модули, функции, копии переменных).</p>
<p><strong>Склонированный контекст не копирует состояние из основного!</strong></p>
<p>Пример <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/726d440be7618fb431815b18e6f785c37a335d5d/examples/test/misc/agent_fork_sample.das">agent_fork_sample.das</a></p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> debugapi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> test_value </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&quot;default&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">] </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">debug_context_set</span><span style="color: #E6E6E6">()</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{this_context()</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">name</span><span style="color: #CE9178">}:{</span><span style="color: #9CDCFE">test_value</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    test_value </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&quot;debug_context&quot;</span><span style="color: #E6E6E6"> </span><span style="color: #6A9955">//изменить значение переменной в контексте debug_context</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{this_context()</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">name</span><span style="color: #CE9178">}:{</span><span style="color: #9CDCFE">test_value</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    this_context()</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">name </span><span style="color: #D4D4D4">:=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&quot;my_context&quot;</span></span>
<span class="line"><span style="color: #E6E6E6">    fork_debug_agent_context </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> @@(</span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> new_context : Context)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//вызывается в новом контексте, устанавливаем DebugAgent, который сохранит ссылку на новый контекст</span></span>
<span class="line"><span style="color: #E6E6E6">        install_new_debug_agent(</span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> DapiDebugAgent(), </span><span style="color: #CE9178">&quot;debug_context&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{this_context()</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">name</span><span style="color: #CE9178">}:{</span><span style="color: #9CDCFE">test_value</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//меняем значение глобальной переменной</span></span>
<span class="line"><span style="color: #E6E6E6">    test_value </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&quot;my_context&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{this_context()</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">name</span><span style="color: #CE9178">}:{</span><span style="color: #9CDCFE">test_value</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//ждём создания контекста агента</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">while</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">!</span><span style="color: #E6E6E6">has_debug_agent_context(</span><span style="color: #CE9178">&quot;debug_context&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">pass</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//изменяем значение переменной в контексте debug_context</span></span>
<span class="line"><span style="color: #E6E6E6">        get_debug_agent_context(</span><span style="color: #CE9178">&quot;debug_context&quot;</span><span style="color: #E6E6E6">) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> invoke_in_context(</span><span style="color: #CE9178">&quot;debug_context_set&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{this_context()</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">name</span><span style="color: #CE9178">}:{</span><span style="color: #9CDCFE">test_value</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span></code></pre></div></div></figure>
<p>Выведет:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">my_context:default                            // в основном контексте test_value имеет значение по умолчанию</span></span>
<span class="line"><span style="color: #E6E6E6">my_context:my_context                         // изменили значение в основном контексте</span></span>
<span class="line"><span style="color: #E6E6E6">debug agent debug_context:default             // &lt;--в склонированном контексте test_value имеет значение по умолчанию</span></span>
<span class="line"><span style="color: #E6E6E6">debug agent debug_context:debug_context       // изменили значение в склонированном контексте</span></span>
<span class="line"><span style="color: #E6E6E6">my_context:my_context                         // в основном контексте значение test_value не изменилось</span></span></code></pre></div></div></figure></p>
<p>Аннотация для функций <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/726d440be7618fb431815b18e6f785c37a335d5d/examples/test/misc/apply_in_context_example.das">apply_in_context</a> позволяет вызывать функцию в другом контексте прозрачно для вызывающего кода. Пример выше можно переписать так:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> daslib</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">apply_in_context</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">apply_in_context</span><span style="color: #E6E6E6">(debug_context)]</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">debug_context_set</span><span style="color: #E6E6E6">()</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{this_context()</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">name</span><span style="color: #CE9178">}:{</span><span style="color: #9CDCFE">test_value</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    test_value </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&quot;debug_context&quot;</span><span style="color: #E6E6E6"> </span><span style="color: #6A9955">//изменить значение переменной в контексте debug_context</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{this_context()</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">name</span><span style="color: #CE9178">}:{</span><span style="color: #9CDCFE">test_value</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">...</span><span style="color: #6A9955">//тот же код создания агента</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">while</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">!</span><span style="color: #E6E6E6">has_debug_agent_context(</span><span style="color: #CE9178">&quot;debug_context&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">pass</span></span>
<span class="line"><span style="color: #E6E6E6">debug_context_set() </span><span style="color: #6A9955">//функция будет вызвана в контексте debug_context</span></span></code></pre></div></div></figure>
<p>Пример создания отдельного контекста — модуль <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/daslib/live.das#L189">live</a>, пример клонирования — <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/5649b32e8b779ceb90b7eabd73f58b7d2077cff6/modules/dasOpenGL/opengl/opengl_cache.das#L56">opengl_cache</a>.</p>
<h2><span id="pereopredelenie-povedeniya-debug-agentov">Переопределение поведения debug-агентов</span><a href="#pereopredelenie-povedeniya-debug-agentov" class="header-anchor">#</a></h2><p>Можно вызвать функции, определённые в классе-наследнике debug-агента (<a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/37b86881a8f4890913e2f80537708575c3441a3f/examples/test/misc/invoke_debug_agent_function.das">invoke_debug_agent_function</a>), но намного более интересной возможностью является переопределения методов. Виртуальная машина daScript отслеживает наличие зарегистрированных отладочных агентов и передаёт им информацию в ходе выполнения программы — интерфейс <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/62f8b1b2ff4c873c9fc1b7ada61ed332fb349e4c/src/builtin/debugger.das#L10">DapiDebugAgent</a>.</p>
<p>Простые примеры определения кастомных debug-агентов:<br><a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/685f0415fc1cb2d52ae6c875f702eb7c09862e38/examples/test/misc/logger_and_logger_agent.das">logger_agent</a> — добавление кастомного префикса при логгировании<br><a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/eaa99142af33e7499137c4c7351d02075223cd5b/examples/test/misc/insturment_function.das">insturment_function</a> — профилирование вызовов функций.<br><a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/726d440be7618fb431815b18e6f785c37a335d5d/examples/test/misc/instrument.das">instrument</a> — программный брейкпоинт и пошаговая трассировка</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">options</span><span style="color: #E6E6E6"> debugger </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">true</span><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//настройка контекста для работы с хуками debug-агентов</span></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> debugapi           </span><span style="color: #6A9955">//интерфейсы для кастомных debug-агентов</span></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> rtti               </span><span style="color: #6A9955">//получение информации о контексте выполнения (доступные модули/функции/переменные/etc)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//программный брейкпоинт, вызывает хук onBreakpoint в debug-агенте</span></span>
<span class="line"><span style="color: #DCDCAA">breakpoint</span></span>
<span class="line"><span style="color: #6A9955">//устанавливает номер строчки, для которой будет вызван хук onInstrument</span></span>
<span class="line"><span style="color: #E6E6E6">instrument_node </span></span>
<span class="line"><span style="color: #6A9955">//устанавливает режим трассирования, хук onSingleStep будет вызван для каждой строчки выполнения до отключения</span></span>
<span class="line"><span style="color: #E6E6E6">set_single_step</span></span>
<span class="line"><span style="color: #6A9955">//устанавливает фильтр на функции, для которых будет вызван хук onInstrumentFunction </span></span>
<span class="line"><span style="color: #E6E6E6">instrument_all_functions</span></span>
<span class="line"><span style="color: #6A9955">//вызывает хук onLog</span></span>
<span class="line"><span style="color: #E6E6E6">to_log</span></span>
<span class="line"><span style="color: #6A9955">//вызывает хук onCollect</span></span>
<span class="line"><span style="color: #E6E6E6">collect_debug_agent_state</span></span>
<span class="line"><span style="color: #6A9955">//вызывает хук onVariable у установленного DapiStackWalker</span></span>
<span class="line"><span style="color: #E6E6E6">report_context_state</span></span></code></pre></div></div></figure>
<p>Более сложные примеры:<br><a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/726d440be7618fb431815b18e6f785c37a335d5d/examples/test/misc/stackwalk.das">stackwalk</a> — более продвинутая версия <code>instrument</code>, устанавливает кастомный <code>DapiStackWalker</code> и <code>DapiDataWalker</code>, печатает значение локальных переменных на каждом шаге<br><a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/66e627465d8aca7934c4b6a92f2fc0d16347c9f7/examples/test/misc/context_state_example.das">context_state_example</a> — еще немного более полная версия информации о переменных, уже более похожая на информацию для отладчика<br><a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/767ebf69143244c544dacdc2efed5a7410940ed5/modules/dasOpenGL/opengl/opengl_state.das">opengl_state</a> — в хуке onCollect печатает информацию о состояниях OpenGL<br><a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/62f8b1b2ff4c873c9fc1b7ada61ed332fb349e4c/daslib/decs_state.das">decs_state</a> — собирает информацию из модуля <code>decs</code> (entity-component-system)<br><a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/62f8b1b2ff4c873c9fc1b7ada61ed332fb349e4c/daslib/ast_debug.das">ast_debug</a> — информация о состоянии expression tree, для отладки макросов</p>
<h2><span id="instrumnty-osnove-debug-agentov">Инструмнты  основе debug-агентов</span><a href="#instrumnty-osnove-debug-agentov" class="header-anchor">#</a></h2><p>Полноценный <strong><code>отладчик</code></strong> — <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/2695f756b17bc184016ea97973ef143a669a937e/daslib/debug.das">debug</a> (debug-агент + сервер для связи с IDE) (<a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=profelis.dascript-plugin">плагин для vscode</a>):<br>(необходимо определить <code>#define DAS_DEBUGGER 1</code> если это по каким-то причинам не определилось в das_config.h автоматически)<br><img src="/blog/3298324261/debugger.png" alt></p>
<p>Более продвинутый <a target="_blank" rel="noopener" href="https://borisbat.github.io/dascf-blog/2022/12/11/instruments/">пример</a> <strong><code>instrument_function</code></strong> — обёртка, сохраняющая результат в файл, который можно посмотреть в виде флеймграфа.</p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"Ov23liG1mZbiQOIdi91X","clientSecret":"e05812685eb741a752982b89dcf6f5b58dc10251","repo":"spiiin.github.io","owner":"spiiin","admin":["spiiin"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/4174799834/">Позже</a><a class="pagination__link pagination__next" href="/blog/1728452067/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div><!-- hexo injector body_end start -->
  <script>
  const CODE_CONFIG = {
    beautify: undefined,
    highlightCopy: undefined,
    highlightLang: undefined,
    highlightHeightLimit: undefined,
    isHighlightShrink: undefined,
    copy: {
      success: 'undefined',
      error: 'undefined',
      noSupport: 'undefined',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body></html>