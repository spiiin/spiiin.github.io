<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | Реверс Darkwing Duck(U) [NES]</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/51457079/">Позже</a><a class="pagination__link pagination__next" href="/blog/57614/">Раньше</a></div><article class="article post"><h3 class="article__title">Реверс Darkwing Duck(U) [NES]</h3><div class="article__date metadata"><div class="post-info">2013/03/18</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/nes/">nes</a><a class="article__tags__link metadata" href="/tags/hack/">hack</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>Под впечатлением от безумного и весёлого хака управления  <a href="http://shedevr.org.ru/cgi-bin/parse.cgi?id=darkwinghack" target="_blank" rel="noopener">Черного Плаща</a> захотелось устроить исследование формата уровней этой игры. </p>
<p>Проверка брейкпоинтами по тому же методу, что и для <a href="/blog/48271/" title="Chip and Dale">Chip and Dale</a> - куски кода идентичны, только располагаются немного по другим адресам.</p>
<p>Но адреса проецирования описаний блоков, макро-блоков и байт цвета из палитры остаются неизменными, так что получить их можно из дампов памяти игры по тем же смещениям:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makeTileBlocks</span><span class="params">(data)</span>:</span></span><br><span class="line">  res = []</span><br><span class="line">  baseAddrs = [<span class="number">0xBAE0</span>, <span class="number">0xBBE0</span>,<span class="number">0xBCE0</span>,<span class="number">0xBDE0</span>]</span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">256</span>):</span><br><span class="line">    val = map(<span class="keyword">lambda</span> v : data[v+x], baseAddrs)</span><br><span class="line">    res.append(val)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makeTilePalsBytes</span><span class="params">(data)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> data[<span class="number">0xBEE0</span>:<span class="number">0xBEE0</span>+<span class="number">256</span>]</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makeBigTileBlocks</span><span class="params">(data)</span>:</span></span><br><span class="line">  res = []</span><br><span class="line">  baseAddr = <span class="number">0xB6E0</span></span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">256</span>):</span><br><span class="line">    res.append(data[baseAddr+x*<span class="number">4</span>:baseAddr+x*<span class="number">4</span>+<span class="number">4</span>])</span><br><span class="line">  <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>
<p>Так можно получить описания экранов, макротайлов и тайлов.</p>
<p>Указатель на активный объект также хранится в байте 70, так что можно от него вычислить расположение описания врагов.<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00 - Стрелок</span><br><span class="line">01 - Летучая мышь</span><br><span class="line">02 - Краб</span><br><span class="line">03 - Каталка</span><br><span class="line">04 - Балка</span><br><span class="line">05 - Каталка(1-я)</span><br><span class="line">06 - Каталка(2-я)</span><br><span class="line">07 - Прыгающий стрелок</span><br><span class="line">08 - Балка</span><br><span class="line">09 - Кидатель ножей</span><br><span class="line">0A - Слизняк</span><br><span class="line">0B - Каталка(3-я)</span><br><span class="line">0C - Висячий слизняк</span><br><span class="line">0D - Пушка</span><br><span class="line">0E - Чих. черепаха</span><br><span class="line">0F - Резиновый робот</span><br><span class="line"></span><br><span class="line">10 - Бриллиант</span><br><span class="line">11 - Слитки</span><br><span class="line">12 - Жизнь</span><br><span class="line">13 - Аптечка</span><br><span class="line">14 - Баночка здоровья</span><br><span class="line">15 - Большая батарейка</span><br><span class="line">16 - Маленькая батарейка</span><br><span class="line">17 - Газ стрелок</span><br><span class="line">18 - Газ тяжести</span><br><span class="line">19 - Газ молний</span><br><span class="line">1A - Банановая кожура</span><br><span class="line">1B - Бонус на крыше</span><br><span class="line">1C - Бонус в канализации</span><br><span class="line">1D - Бонус крыша</span><br><span class="line">1E - Пищалка?</span><br><span class="line">1F - Высовывающийся робот с молотом</span><br><span class="line"></span><br><span class="line">20 - Рыцарь бегающий</span><br><span class="line">21 - Терминатор</span><br><span class="line">22 - Джинн</span><br><span class="line">23 - Катящееся колесо</span><br><span class="line">24 - Катящееся колесо влево</span><br><span class="line">25 - Яйцо-десант</span><br><span class="line">26 - Огнеметчик</span><br><span class="line">27 - Бомбист-вертолетчик</span><br><span class="line">28 - Ворона</span><br><span class="line">29 - Собака-ищейка</span><br><span class="line">2A - Кенгуру-баскетболист</span><br><span class="line">2B - Насос</span><br><span class="line">2C - Воздушный шарик</span><br><span class="line">2D - Прыгуны-кидалки</span><br><span class="line">2E - Собака с конурой</span><br><span class="line">2F - Древесный ползун</span><br><span class="line"></span><br><span class="line">30 - Платформа вниз</span><br><span class="line">31 - Платформа вверх-вниз</span><br><span class="line">32 - Сова</span><br><span class="line">33 - Ускоренная сова</span><br><span class="line">34 - Бронерыцарь</span><br><span class="line">35 - Надутая птица</span><br><span class="line">36 - Подвес-кольцо</span><br><span class="line">37 - Цепь</span><br><span class="line">38 - Платформа влево-вправо</span><br><span class="line">39 - Крокодил</span><br><span class="line">3A - Котик-бейсболист</span><br><span class="line">3B - Лет. ковер</span><br><span class="line">3C - Бочкометатель</span><br><span class="line">3D - Включалка</span><br><span class="line">3E - Включалка</span><br><span class="line">3F - Включалка</span><br><span class="line"></span><br><span class="line">40 - Включалка платформы</span><br><span class="line">41 - Платформа из канализации</span><br><span class="line">42 - Платформа из канализации влево</span><br><span class="line">43 - Лампа (и темнота)</span><br><span class="line">44 - Каталка средняя</span><br><span class="line">45 - мерцание палитры (водопад)</span><br><span class="line">46 - Что-то колючее</span><br><span class="line">47 - босс-крот</span><br><span class="line">48 - стрелялки у бушрута и крота?</span><br><span class="line">49 - Кидалка бананов</span><br><span class="line">4A - Квага</span><br><span class="line">4B - Волфдак просто ходит</span><br><span class="line">4C - Волфдак дышит</span><br><span class="line">4D - босс-водяной</span><br><span class="line">4E - босс-мегавольт</span><br><span class="line">4F - босс-бушрут</span><br><span class="line"></span><br><span class="line">50 - босс стальной клюв</span><br><span class="line">51 - Лет. тарелки</span><br><span class="line">52 - Лет. тарелки</span><br><span class="line">53 - Лет. тарелки</span><br><span class="line">54 - механизмы крота</span><br><span class="line">55 - механизмы крота</span><br><span class="line">56 - цепи (3)</span><br><span class="line">57 - цепи (1)</span><br><span class="line">58 - цепи (2)</span><br><span class="line">59 - бонус 2-го уровня (между черепахами)</span><br><span class="line">5A - бонус 3-го уровня (конец)</span><br><span class="line">5B - бонус 3-го уровня (начало)</span><br><span class="line">5C - бонус 6-го уровня (начало)</span><br><span class="line">5D - бонус 6-го уровня (возле 1-й черепахи)</span><br><span class="line">5E - бонус 4-го уровня (в тайнике-водопаде)</span><br><span class="line">5F - бонус 4-го уровня (слева от фонаря возле первого бриллианта)</span><br><span class="line"></span><br><span class="line">60 - бонус 5-го уровня (над первой мышью)</span><br><span class="line">61 - бонус 5-го уровня (между двумя каталками)</span><br><span class="line">62 - бонус 7-го уровня (возле двух метателей ножей)</span><br><span class="line">63 - бонус 7-го уровня (в начале этапа с терминаторами)</span><br><span class="line">64 - терминатор</span><br><span class="line">65 - начало уровня</span><br><span class="line">66 - вторя дорога (3 уровень, бонусы)</span><br><span class="line">67 - часть мегавольта</span><br><span class="line">68 - вторая дорога(4 уровень, спуск в водопад)</span><br></pre></td></tr></table></figure></p>
<p>Адреса описаний объектов:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1 уровень - 10315-10347</span><br><span class="line">2 уровень - 10438-10473</span><br><span class="line">3 уровень - 10584-105C7</span><br><span class="line">6 уровень - 106A0-106D5</span><br><span class="line">4 уровень - 10816-10865</span><br><span class="line">5 уровень - 10962-109A0</span><br><span class="line">7 уровень - 10A89-10AC2</span><br></pre></td></tr></table></figure></p>
<p>перед описаниями объектов по 4 массива с парами координат X и Y объектов.</p>
<p>Уровни описываются двумя двумерными массивами - в одном хранятся номера экранов, в другом совмещенные значение скроллов и дверей (5 бит на дверь, 3 на значение скролла), которые находятся на выбранном экране.</p>
<p>Массивы экранов начинается с 1DFAO, массивы скроллов - примерно с 1E1AD, длины массивов хранятся в 1DEE7.</p>
<p>описание уровней.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Мост</span><br><span class="line">15 XX 16 XX XX XX XX XX XX XX XX XX XX XX XX XX XX</span><br><span class="line">XX XX XX XX XX 08 09 0A 0B 0C 0D 0E XX XX XX 14 14</span><br><span class="line">XX XX XX XX XX 07 XX XX XX XX XX 0F 10 11 12 13 XX</span><br><span class="line">01 02 03 04 05 06 XX XX XX XX XX XX XX XX XX XX XX</span><br><span class="line"></span><br><span class="line">Город</span><br><span class="line">15 XX 16 XX XX XX XX XX XX XX XX XX XX XX XX XX XX</span><br><span class="line">XX XX XX XX 27 28 29 XX XX XX XX XX XX XX 34 34 34</span><br><span class="line">XX XX XX XX 26 XX 2A 2B 2C 2D 2E 2F 30 31 32 33 00</span><br><span class="line">21 22 23 24 25 XX XX XX XX XX XX XX XX XX XX XX XX</span><br><span class="line"></span><br><span class="line">Канализация</span><br><span class="line">41 42 43 XX XX XX 15 XX 16 XX XX XX XX XX XX XX XX</span><br><span class="line">XX XX 44 45 46 XX XX XX XX XX XX XX XX XX XX XX XX</span><br><span class="line">XX XX 47 48 49 4A 4B XX XX XX XX XX XX XX XX 56 XX</span><br><span class="line">XX XX XX XX XX XX 4C 4D 4E 4F 50 51 52 53 54 55 XX</span><br><span class="line"></span><br><span class="line">Вышка</span><br><span class="line">15 XX 16 XX XX XX XX XX 76 76</span><br><span class="line">XX XX XX XX XX XX XX 74 75 XX</span><br><span class="line">XX XX XX XX XX XX XX 73 XX XX</span><br><span class="line">XX XX XX XX XX XX XX 72 XX XX</span><br><span class="line">XX XX XX XX XX XX XX 71 XX XX</span><br><span class="line">XX XX XX XX XX XX XX 70 XX XX</span><br><span class="line">XX XX 68 69 6A 6B XX 6F XX XX</span><br><span class="line">XX XX 67 XX XX 6C 6D 6E XX XX</span><br><span class="line">XX XX 66 XX XX XX XX XX XX XX</span><br><span class="line">XX XX 65 XX XX XX XX XX XX XX</span><br><span class="line">XX XX 64 XX XX XX XX XX XX XX</span><br><span class="line">61 62 63 XX XX XX XX XX XX XX</span><br><span class="line"></span><br><span class="line">Лес</span><br><span class="line">81 82 83 84 85 86 87 88 89 8A 8B 8C 8D 8E 8F XX XX 97 XX</span><br><span class="line">XX XX XX XX XX XX XX XX XX XX XX XX XX XX 90 91 92 XX XX</span><br><span class="line">XX XX XX XX XX XX XX XX XX XX XX XX XX XX 93 94 95 96 XX</span><br><span class="line"></span><br><span class="line">Электростанция</span><br><span class="line">A1 A2 A3 A4 XX XX XX XX XX XX XX XX XX XX XX XX B3 B4 XX</span><br><span class="line">XX XX XX A5 A6 A7 A8 A9 AA AB AC AD AE AF B0 B1 B2 XX XX</span><br><span class="line">XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX B5 XX</span><br><span class="line"></span><br><span class="line">Корабль (к индексу экрана надо прибавлять 100)</span><br><span class="line">01 02 03 04 05 XX XX XX XX 15 XX XX 98 XX 16 XX 16 XX XX</span><br><span class="line">XX XX XX XX 06 07 08 09 0A XX XX XX XX XX XX XX XX XX XX</span><br><span class="line">XX XX XX XX XX XX XX XX 0B 0C 0D 0E 0F 10 11 12 13 14 XX</span><br></pre></td></tr></table></figure>
<p> В целом устройство намного проще и логичнее, чем в <code>Chip and Dale</code>. На один уровень - один блок видеопамяти, тайлов и макротайлов и в среднем по 2 палитры, в отличие от C&amp;D, в которой эти наборы определялись сочетанием двери и номера уровня, причем было много переключений с целью сжать 2 уровня в один набор.</p>
<p> Типов блоков тоже оставлено только 5 (пустой, платформа, крюк, шипы, дверь), вместо 16 чипидейловых.</p>
<p> Сами уровни геометрически сделаны проще, геймдизайн направлен на борьбу с врагами в большей степени, чем на решение загадок и обход препятствий, количество уровней изначально проектировалось так, чтобы уместиться в доступную на картридже память.</p>
<p> Из-за такой простоты достаточно легко добавить поддержку игры в редактор уровней Chip and Dale, рассчитанный на более замудренных бурундуков.<br> <img src="http://ic.pics.livejournal.com/spiiin/20318251/24526/24526_900.png" alt="cad_editor_v7" title="cad_editor_v7"></p>
<p> скачать : <a href="http://www.emu-land.net/forum/index.php?action=dlattach;topic=60286.0;attach=66399" target="_blank" rel="noopener">emu-land</a> или <a href="https://dl.dropbox.com/u/852723/cad_editor/cad_editor_v7.zip" target="_blank" rel="noopener">dropbox</a></p>
<p> <strong>UPDATED</strong> v0.8, добавлены редакторы врагов и раскладок скачать :<br> <a href="http://www.emu-land.net/forum/index.php?action=dlattach;topic=60286.0;attach=66625" target="_blank" rel="noopener">emu-land</a><br> <a href="https://dl.dropbox.com/u/852723/cad_editor/cad_editor_v8.zip" target="_blank" rel="noopener">dropbox</a></p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/51457079/">Позже</a><a class="pagination__link pagination__next" href="/blog/57614/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>