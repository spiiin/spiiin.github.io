<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | daScript. Brainfuck и оптимизации</title><meta name="description" content="&lt;p&gt;Попробовал портировать с &lt;code&gt;nim&lt;/code&gt; на &lt;code&gt;daScript&lt;/code&gt; &lt;a href=&quot;https://howistart.org/posts/nim/1/&quot;&gt;интерпретатор&lt;/a&gt; &lt;code&gt;brainfuck&lt;/code&gt; кода. Брейфак предельно простой язык, и базовая реализация интерпретатора занимает полчаса, но на нём можно потренироваться в ускорении кода и продемонстрировать возможности daScript в оптимизации.&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,0.1),rgba(40,44,52,0.9))}</style><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/1976052536/">Позже</a><a class="pagination__link pagination__next" href="/blog/1601029690/">Раньше</a></div><article class="article post"><h3 class="article__title">daScript. Brainfuck и оптимизации</h3><div class="article__date metadata"><div class="post-info">2022/11/11</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/longread/">longread</a><a class="article__tags__link metadata" href="/tags/llvm/">llvm</a><a class="article__tags__link metadata" href="/tags/dascript/">dascript</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>Попробовал портировать с <code>nim</code> на <code>daScript</code> <a target="_blank" rel="noopener" href="https://howistart.org/posts/nim/1/">интерпретатор</a> <code>brainfuck</code> кода. Брейфак предельно простой язык, и базовая реализация интерпретатора занимает полчаса, но на нём можно потренироваться в ускорении кода и продемонстрировать возможности daScript в оптимизации.</p>
<span id="more"></span>
<p>Самая первая, максимально наивная, построчно скопированная реализация:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> strings</span></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> fio</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">run</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">code</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">string</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">tape</span><span style="color: #E6E6E6">: </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint8</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">codePos, tapePos</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">; </span><span style="color: #9CDCFE">skip</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">bool</span><span style="color: #E6E6E6">): </span><span style="color: #4EC9B0">bool</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #C586C0">while</span><span style="color: #E6E6E6"> tapePos </span><span style="color: #D4D4D4">&gt;=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&amp;&amp;</span><span style="color: #E6E6E6"> codePos </span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">length</span><span style="color: #E6E6E6">(code)</span></span>
<span class="line"><span style="color: #E6E6E6">		</span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> tapePos </span><span style="color: #D4D4D4">&gt;=</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">length</span><span style="color: #E6E6E6">(tape) { tape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">push</span><span style="color: #E6E6E6">(uint8(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">)); }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">		</span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> sym1  </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> code </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> character_at(codePos)</span></span>
<span class="line"><span style="color: #E6E6E6">		</span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> sym1 </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;[&#39;</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #D4D4D4">++</span><span style="color: #E6E6E6">codePos</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> oldPos </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> codePos</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">while</span><span style="color: #E6E6E6"> run(code, tape, codePos, tapePos, tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> uint8(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">))</span></span>
<span class="line"><span style="color: #E6E6E6">				codePos </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> oldPos</span></span>
<span class="line"><span style="color: #E6E6E6">		</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym1 </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;]&#39;</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">!=</span><span style="color: #E6E6E6"> uint8(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">		</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">!</span><span style="color: #E6E6E6">skip</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> sym  </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> code </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> character_at(codePos)</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;+&#39;</span><span style="color: #E6E6E6"> { tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(int(tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">]) </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">); }</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;-&#39;</span><span style="color: #E6E6E6"> { tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(int(tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">]) </span><span style="color: #D4D4D4">-</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">); }</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;&gt;&#39;</span><span style="color: #E6E6E6"> { </span><span style="color: #D4D4D4">++</span><span style="color: #E6E6E6">tapePos; }</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;&lt;&#39;</span><span style="color: #E6E6E6"> { </span><span style="color: #D4D4D4">--</span><span style="color: #E6E6E6">tapePos; }</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;.&#39;</span><span style="color: #E6E6E6"> { </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{int(tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #CE9178">]) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">to_char</span><span style="color: #CE9178">}&quot;</span><span style="color: #E6E6E6">); }</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;,&#39;</span><span style="color: #E6E6E6"> { tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(getchar()); }</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">else</span><span style="color: #E6E6E6"> { }</span></span>
<span class="line"><span style="color: #E6E6E6">		</span><span style="color: #D4D4D4">++</span><span style="color: #E6E6E6">codePos</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">false</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">interpret</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">code</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">string</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> totalTime </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> ref_time_ticks()</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> tape: </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint8</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> codePos, tapePos : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #E6E6E6">	run(code, tape, codePos, tapePos, </span><span style="color: #C586C0">false</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> totalDt </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> double(get_time_usec(totalTime)) </span><span style="color: #D4D4D4">/</span><span style="color: #B5CEA8">1000000.0l</span><span style="color: #E6E6E6">f</span></span>
<span class="line"><span style="color: #E6E6E6">	to_log(LOG_INFO, </span><span style="color: #CE9178">&quot;total {</span><span style="color: #9CDCFE">totalDt</span><span style="color: #CE9178">} sec</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span></code></pre></div></div></figure>
<p>Если попытаться протестировать его на генераторе <a target="_blank" rel="noopener" href="https://github.com/def-/nim-brainfuck/blob/master/examples/mandelbrot.b">множества Мандельброта</a>, можно заметить серьёзные проблемы со скоростью, вычисления занимают около 5 часов. Стоит попробовать его разогнать!</p>
<h2><span id="otklyuchenie-proverok-granic-i-ukazateley">Отключение проверок границ и указателей</span><a href="#otklyuchenie-proverok-granic-i-ukazateley" class="header-anchor">#</a></h2><p>Код на brainfuck - это простая числодробилка, ускорить которую можно, отключив все дополнительные проверки обращений к памяти.</p>
<p><em>Как отключать проверки, мне рассказал <a target="_blank" rel="noopener" href="https://github.com/borisbat">Борис Баткин</a> (так как интерпретатор nim делал один основных контрибьютеров языка, то его подсказки не отменяют честности сравнения — авторы находятся в одной “весовой категории” знания своего языка).</em></p>
<p>В первую очередь, можно заменить функцию <code>charcter_at</code>, которая <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/e9f4c486848a8985e4126e0fc2d04afbc6abd883/src/builtin/module_builtin_string.cpp#L26">проверяет</a>,что индекс меньше длины строки, на <code>character_uat</code>, которая не делает этой проверки.</p>
<p>Также отключается проверка ссылок на null макросом <code>[unsafe_deref]</code>.</p>
<p>Наконец, обращение к массиву можно выполнять не через разыменование ссылки, а через обращение по указателю:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">tape: </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint8</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">tape[</span><span style="color: #569CD6">index</span><span style="color: #E6E6E6">] </span><span style="color: #6A9955">// tape[check_range(index)] //медленно</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> ptape: </span><span style="color: #4EC9B0">uint8</span><span style="color: #E6E6E6">? </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(tape[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">])</span></span>
<span class="line"><span style="color: #E6E6E6">ptape[</span><span style="color: #569CD6">index</span><span style="color: #E6E6E6">] </span><span style="color: #6A9955">//check_not_null(ptape)[index] //быстрее, обращение без проверок</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">unsafe_deref</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #E6E6E6">ptape[</span><span style="color: #569CD6">index</span><span style="color: #E6E6E6">] </span><span style="color: #6A9955">//ptape[index] //еще быстрее, обращение без перепроверок указателя на nullptr</span></span></code></pre></div></div></figure>
<p>Переписанная версия кода:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">unsafe_deref</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">run</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">code</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">uint8</span><span style="color: #E6E6E6">?; </span><span style="color: #9CDCFE">lengthOfCode</span><span style="color: #E6E6E6">:</span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">tape</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">uint8</span><span style="color: #E6E6E6">?; </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">codePos, tapePos</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">; </span><span style="color: #9CDCFE">skip</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">bool</span><span style="color: #E6E6E6">): </span><span style="color: #4EC9B0">bool</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">		</span><span style="color: #C586C0">while</span><span style="color: #E6E6E6"> tapePos </span><span style="color: #D4D4D4">&gt;=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&amp;&amp;</span><span style="color: #E6E6E6"> codePos </span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6"> lengthOfCode</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> sym1  </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> int(code[</span><span style="color: #569CD6">codePos</span><span style="color: #E6E6E6">])</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> sym1 </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;[&#39;</span></span>
<span class="line"><span style="color: #E6E6E6">				</span><span style="color: #D4D4D4">++</span><span style="color: #E6E6E6">codePos</span></span>
<span class="line"><span style="color: #E6E6E6">				</span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> oldPos </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> codePos</span></span>
<span class="line"><span style="color: #E6E6E6">				</span><span style="color: #C586C0">while</span><span style="color: #E6E6E6"> run(code, lengthOfCode, tape, codePos, tapePos, tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> uint8(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">))</span></span>
<span class="line"><span style="color: #E6E6E6">					codePos </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> oldPos</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym1 </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;]&#39;</span></span>
<span class="line"><span style="color: #E6E6E6">				</span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">!=</span><span style="color: #E6E6E6"> uint8(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">!</span><span style="color: #E6E6E6">skip</span></span>
<span class="line"><span style="color: #E6E6E6">				</span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> sym  </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> int(code[</span><span style="color: #569CD6">codePos</span><span style="color: #E6E6E6">])</span></span>
<span class="line"><span style="color: #E6E6E6">				</span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;+&#39;</span><span style="color: #E6E6E6"> { tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(int(tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">]) </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">); }</span></span>
<span class="line"><span style="color: #E6E6E6">				</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;-&#39;</span><span style="color: #E6E6E6"> { tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(int(tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">]) </span><span style="color: #D4D4D4">-</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">); }</span></span>
<span class="line"><span style="color: #E6E6E6">				</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;&gt;&#39;</span><span style="color: #E6E6E6"> { </span><span style="color: #D4D4D4">++</span><span style="color: #E6E6E6">tapePos; }</span></span>
<span class="line"><span style="color: #E6E6E6">				</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;&lt;&#39;</span><span style="color: #E6E6E6"> { </span><span style="color: #D4D4D4">--</span><span style="color: #E6E6E6">tapePos; }</span></span>
<span class="line"><span style="color: #E6E6E6">				</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;.&#39;</span><span style="color: #E6E6E6"> { </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(int(tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">]) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> to_char); }</span></span>
<span class="line"><span style="color: #E6E6E6">				</span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;,&#39;</span><span style="color: #E6E6E6"> { tape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(getchar()); }</span></span>
<span class="line"><span style="color: #E6E6E6">				</span><span style="color: #C586C0">else</span><span style="color: #E6E6E6"> { }</span></span>
<span class="line"><span style="color: #E6E6E6">			</span><span style="color: #D4D4D4">++</span><span style="color: #E6E6E6">codePos</span></span>
<span class="line"><span style="color: #E6E6E6">		</span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">false</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">interpret</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">code</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">string</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> totalTime </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> ref_time_ticks()</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> tape: </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint8</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> codePos, tapePos : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #E6E6E6">	tape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">resize</span><span style="color: #E6E6E6">(</span><span style="color: #B5CEA8">1000000</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">		run(</span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint8</span><span style="color: #E6E6E6">?</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> code, </span><span style="color: #DCDCAA">length</span><span style="color: #E6E6E6">(code), </span><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(tape[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">]), codePos, tapePos, </span><span style="color: #C586C0">false</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> totalDt </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> double(get_time_usec(totalTime)) </span><span style="color: #D4D4D4">/</span><span style="color: #B5CEA8">1000000.0l</span><span style="color: #E6E6E6">f</span></span>
<span class="line"><span style="color: #E6E6E6">	to_log(LOG_INFO, </span><span style="color: #CE9178">&quot;total {</span><span style="color: #9CDCFE">totalDt</span><span style="color: #CE9178">} sec</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span></code></pre></div></div></figure>
<p>Такая версия интерпретатора всё ещё тормозная, но уже позволяет дождаться завершения выполнения кода:</p>
<figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">e:\src\daScript\bin\Release&gt;daScript.exe brainfuck_00.das</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAAAAAAAAAABBBBBBBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDEGFFEEEEDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAAAAAAAAABBBBBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDEEEFGIIGFFEEEDDDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAAAAAAABBBBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDEEEEFFFI KHGGGHGEDDDDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAAAAAABBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDEEEEEFFGHIMTKLZOGFEEDDDDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAAAAABBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDEEEEEEFGGHHIKPPKIHGFFEEEDDDDDDDDDCCCCCCCCCCBBBBBBBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAAAABBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDEEEEEEFFGHIJKS  X KHHGFEEEEEDDDDDDDDDCCCCCCCCCCBBBBBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAAABBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDEEEEEEFFGQPUVOTY   ZQL[MHFEEEEEEEDDDDDDDCCCCCCCCCCCBBBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAABBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDEEEEEFFFFFGGHJLZ         UKHGFFEEEEEEEEDDDDDCCCCCCCCCCCCBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAABBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDEEEEFFFFFFGGGGHIKP           KHHGGFFFFEEEEEEDDDDDCCCCCCCCCCCBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAABBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDEEEEEFGGHIIHHHHHIIIJKMR        VMKJIHHHGFFFFFFGSGEDDDDCCCCCCCCCCCCBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAABBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDEEEEEEFFGHK   MKJIJO  N R  X      YUSR PLV LHHHGGHIOJGFEDDDCCCCCCCCCCCCBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAABBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDEEEEEEEEEFFFFGH O    TN S                       NKJKR LLQMNHEEDDDCCCCCCCCCCCCBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAABBCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDEEEEEEEEEEEEFFFFFGHHIN                                 Q     UMWGEEEDDDCCCCCCCCCCCCBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAABBCCCCCCCCCCCCCCCCCCCCCCCCCDDDDEEEEEEEEEEEEEEEFFFFFFGHIJKLOT                                     [JGFFEEEDDCCCCCCCCCCCCCBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAABCCCCCCCCCCCCCCCCCCCCCCDDDDEEEEEEEEEEEEEEEEFFFFFFGGHYV RQU                                     QMJHGGFEEEDDDCCCCCCCCCCCCCBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAABCCCCCCCCCCCCCCCCCDDDDDDDEEFJIHFFFFFFFFFFFFFFGGGGGGHIJN                                            JHHGFEEDDDDCCCCCCCCCCCCCBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAABCCCCCCCCCCCDDDDDDDDDDEEEEFFHLKHHGGGGHHMJHGGGGGGHHHIKRR                                           UQ L HFEDDDDCCCCCCCCCCCCCCBB</span></span>
<span class="line"><span style="color: #E6E6E6">AABCCCCCCCCDDDDDDDDDDDEEEEEEFFFHKQMRKNJIJLVS JJKIIIIIIJLR                                               YNHFEDDDDDCCCCCCCCCCCCCBB</span></span>
<span class="line"><span style="color: #E6E6E6">AABCCCCCDDDDDDDDDDDDEEEEEEEFFGGHIJKOU  O O   PR LLJJJKL                                                OIHFFEDDDDDCCCCCCCCCCCCCCB</span></span>
<span class="line"><span style="color: #E6E6E6">AACCCDDDDDDDDDDDDDEEEEEEEEEFGGGHIJMR              RMLMN                                                 NTFEEDDDDDDCCCCCCCCCCCCCB</span></span>
<span class="line"><span style="color: #E6E6E6">AACCDDDDDDDDDDDDEEEEEEEEEFGGGHHKONSZ                QPR                                                NJGFEEDDDDDDCCCCCCCCCCCCCC</span></span>
<span class="line"><span style="color: #E6E6E6">ABCDDDDDDDDDDDEEEEEFFFFFGIPJIIJKMQ                   VX                                                 HFFEEDDDDDDCCCCCCCCCCCCCC</span></span>
<span class="line"><span style="color: #E6E6E6">ACDDDDDDDDDDEFFFFFFFGGGGHIKZOOPPS                                                                      HGFEEEDDDDDDCCCCCCCCCCCCCC</span></span>
<span class="line"><span style="color: #E6E6E6">ADEEEEFFFGHIGGGGGGHHHHIJJLNY                                                                        TJHGFFEEEDDDDDDDCCCCCCCCCCCCC</span></span>
<span class="line"><span style="color: #E6E6E6">A                                                                                                 PLJHGGFFEEEDDDDDDDCCCCCCCCCCCCC</span></span>
<span class="line"><span style="color: #E6E6E6">ADEEEEFFFGHIGGGGGGHHHHIJJLNY                                                                        TJHGFFEEEDDDDDDDCCCCCCCCCCCCC</span></span>
<span class="line"><span style="color: #E6E6E6">ACDDDDDDDDDDEFFFFFFFGGGGHIKZOOPPS                                                                      HGFEEEDDDDDDCCCCCCCCCCCCCC</span></span>
<span class="line"><span style="color: #E6E6E6">ABCDDDDDDDDDDDEEEEEFFFFFGIPJIIJKMQ                   VX                                                 HFFEEDDDDDDCCCCCCCCCCCCCC</span></span>
<span class="line"><span style="color: #E6E6E6">AACCDDDDDDDDDDDDEEEEEEEEEFGGGHHKONSZ                QPR                                                NJGFEEDDDDDDCCCCCCCCCCCCCC</span></span>
<span class="line"><span style="color: #E6E6E6">AACCCDDDDDDDDDDDDDEEEEEEEEEFGGGHIJMR              RMLMN                                                 NTFEEDDDDDDCCCCCCCCCCCCCB</span></span>
<span class="line"><span style="color: #E6E6E6">AABCCCCCDDDDDDDDDDDDEEEEEEEFFGGHIJKOU  O O   PR LLJJJKL                                                OIHFFEDDDDDCCCCCCCCCCCCCCB</span></span>
<span class="line"><span style="color: #E6E6E6">AABCCCCCCCCDDDDDDDDDDDEEEEEEFFFHKQMRKNJIJLVS JJKIIIIIIJLR                                               YNHFEDDDDDCCCCCCCCCCCCCBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAABCCCCCCCCCCCDDDDDDDDDDEEEEFFHLKHHGGGGHHMJHGGGGGGHHHIKRR                                           UQ L HFEDDDDCCCCCCCCCCCCCCBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAABCCCCCCCCCCCCCCCCCDDDDDDDEEFJIHFFFFFFFFFFFFFFGGGGGGHIJN                                            JHHGFEEDDDDCCCCCCCCCCCCCBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAABCCCCCCCCCCCCCCCCCCCCCCDDDDEEEEEEEEEEEEEEEEFFFFFFGGHYV RQU                                     QMJHGGFEEEDDDCCCCCCCCCCCCCBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAABBCCCCCCCCCCCCCCCCCCCCCCCCCDDDDEEEEEEEEEEEEEEEFFFFFFGHIJKLOT                                     [JGFFEEEDDCCCCCCCCCCCCCBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAABBCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDEEEEEEEEEEEEFFFFFGHHIN                                 Q     UMWGEEEDDDCCCCCCCCCCCCBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAABBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDEEEEEEEEEFFFFGH O    TN S                       NKJKR LLQMNHEEDDDCCCCCCCCCCCCBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAABBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDEEEEEEFFGHK   MKJIJO  N R  X      YUSR PLV LHHHGGHIOJGFEDDDCCCCCCCCCCCCBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAABBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDEEEEEFGGHIIHHHHHIIIJKMR        VMKJIHHHGFFFFFFGSGEDDDDCCCCCCCCCCCCBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAABBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDEEEEFFFFFFGGGGHIKP           KHHGGFFFFEEEEEEDDDDDCCCCCCCCCCCBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAABBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDEEEEEFFFFFGGHJLZ         UKHGFFEEEEEEEEDDDDDCCCCCCCCCCCCBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAAABBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDEEEEEEFFGQPUVOTY   ZQL[MHFEEEEEEEDDDDDDDCCCCCCCCCCCBBBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAAAABBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDEEEEEEFFGHIJKS  X KHHGFEEEEEDDDDDDDDDCCCCCCCCCCBBBBBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAAAAABBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDEEEEEEFGGHHIKPPKIHGFFEEEDDDDDDDDDCCCCCCCCCCBBBBBBBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAAAAAABBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDEEEEEFFGHIMTKLZOGFEEDDDDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAAAAAAABBBBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDEEEEFFFI KHGGGHGEDDDDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">AAAAAAAAAAAAAAABBBBBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDEEEFGIIGFFEEEDDDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBBBBBBB</span></span>
<span class="line"><span style="color: #E6E6E6">[I] total 564.99929999999994834 sec</span></span></code></pre></div></div></figure>
<p>564 секунды — в 30 раз быстрее первой версии, но всё ещё сильно медленнее интерпретатора на <code>nim</code>, который в релизной версии выполняется за 40 секунд.</p>
<h2><span id="ahead-of-time">Ahead-of-Time</span><a href="#ahead-of-time" class="header-anchor">#</a></h2><p>daScript умеет транспилироваться в C++ код, для сравнения с nim попробуем скомпилировать интерпретатор, без внесения каких-либо изменений в код.</p>
<figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">daScript.exe -aot brainfuck.das brainfuck.das.cpp</span></span></code></pre></div></div></figure>
<p>Полученный C++-файл проще всего подсунуть в пример <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/tutorial/tutorial02aot.cpp">tutorial02aot</a>, который настроен на использование AoT варианта кода. Скомпилированный файл можно запустить:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">e:\src\daScript\bin\Release</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">tutorial02aot</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">exe</span></span>
<span class="line"><span style="color: #E6E6E6">[I] total </span><span style="color: #B5CEA8">34.27342399999999856</span><span style="color: #E6E6E6"> sec</span></span></code></pre></div></div></figure>
<p>34 секунды — уже быстрее, чем nim, который сам по себе достаточно быстрый!</p>
<h2><span id="just-in-time">Just-in-Time</span><a href="#just-in-time" class="header-anchor">#</a></h2><p>Можно попробовать двигаться дальше, подключив экспериментальный модуль <a target="_blank" rel="noopener" href="https://github.com/borisbat/dasLLVM">dasLLVM</a>. Чтобы собрать его, необходимо:</p>
<ul>
<li>включить сборку модуля в cmake:</li>
</ul>
<figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">option(DAS_LLVM_DISABLED &quot;Disable dasLLVM (llvm bindings)&quot; OFF)</span></span></code></pre></div></div></figure>
<ul>
<li>собрать проект llvm, или скачать собранный (например, от <a target="_blank" rel="noopener" href="https://download.qt.io/development_releases/prebuilt/libclang/">qt</a>) и положить на уровень выше корневой директории проекта daScript, напрммер:</li>
</ul>
<figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">C:/dascript</span></span>
<span class="line"><span style="color: #E6E6E6">C:/libclang</span></span></code></pre></div></div></figure>
<ul>
<li>сгенерировать решение и пересобрать dascript:</li>
</ul>
<figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">generate_msvc_2019.bat</span></span></code></pre></div></div></figure>
<p>Теперь можно воспользоваться аннотацией <code>[jit]</code>, чтобы код функциии интерпретатора без AoT-компиляции перед первым выполнением компилировался с помощью <code>llvm-c</code>.</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">jit</span><span style="color: #E6E6E6">,unsafe_deref]</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">run</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">code</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">uint8</span><span style="color: #E6E6E6">?; </span><span style="color: #9CDCFE">lengthOfCode</span><span style="color: #E6E6E6">:</span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">tape</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">uint8</span><span style="color: #E6E6E6">?; </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">codePos, tapePos</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">; </span><span style="color: #9CDCFE">skip</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">bool</span><span style="color: #E6E6E6">): </span><span style="color: #4EC9B0">bool</span></span></code></pre></div></div></figure>
<figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">e:\src\daScript_my\bin\Release&gt;daScript.exe brainfuck_2_jit.das</span></span>
<span class="line"><span style="color: #E6E6E6">[I] total 22.66654300000000077 sec</span></span></code></pre></div></div></figure>
<p>22.6 секунды, еще лучше! Генерация daScript-кода в llvm-ассемблер быстрее, чем в C++ — генератор передаёт больше полезной для оптимизации о кода, а также, возможно, задействуется сила оптимизаций LLVM.</p>
<h2><span id="metaprogrammirovanie">Метапрограммирование</span><a href="#metaprogrammirovanie" class="header-anchor">#</a></h2><p>Можно двигаться дальше. Вместо того, чтобы писать функцию, которая интерпретирует любой код на brainfuck, можно написать макрос, который сгенерирует код конкретной функции в compile-time, и измерить время выполнения этой функции.</p>
<p>Можно использовать <a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/macros.html#astreadermacro">AstReaderMacro</a> — тип макроса, который обрабатывает отдельные символы. Синтаксис вызова такого макроса:</p>
<figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">% READER_MACRO_NAME ~ character_sequence %% //character_sequence будет передана на вход макросу</span></span></code></pre></div></div></figure>
<p>Шаблоны таких макросов можно посмотреть в модулях <code>json_boost</code> и <code>regex_boost</code></p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">module</span><span style="color: #E6E6E6"> brainfuck_macro </span><span style="color: #C586C0">shared</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">public</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">generateFunction</span><span style="color: #E6E6E6">(uniqueName, </span><span style="color: #9CDCFE">code</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> seqStr </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> string(code)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> blkArr : </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">ExpressionPtr</span><span style="color: #D4D4D4">&gt;&gt;</span><span style="color: #E6E6E6">; defer_delete(blkArr)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> blk : </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">ExpressionPtr</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">; defer_delete(blk)</span></span>
<span class="line"><span style="color: #E6E6E6">    blkArr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">emplace</span><span style="color: #E6E6E6">(blk)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    blkArr[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> tape: </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint8</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">; })</span></span>
<span class="line"><span style="color: #E6E6E6">    blkArr[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> tapePos : </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">; })</span></span>
<span class="line"><span style="color: #E6E6E6">    blkArr[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ tape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">resize</span><span style="color: #E6E6E6">(</span><span style="color: #B5CEA8">1000000</span><span style="color: #E6E6E6">); })</span></span>
<span class="line"><span style="color: #E6E6E6">    blkArr[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">ptape</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(tape[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">]); })</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> sym </span><span style="color: #C586C0">in</span><span style="color: #E6E6E6"> seqStr</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;+&#39;</span><span style="color: #E6E6E6">   { back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(int(ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">]) </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">); }); }</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;-&#39;</span><span style="color: #E6E6E6"> { back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(int(ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">]) </span><span style="color: #D4D4D4">-</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">); }); }</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;&gt;&#39;</span><span style="color: #E6E6E6"> { back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ </span><span style="color: #D4D4D4">++</span><span style="color: #E6E6E6">tapePos; }); } </span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;&lt;&#39;</span><span style="color: #E6E6E6"> { back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ </span><span style="color: #D4D4D4">--</span><span style="color: #E6E6E6">tapePos; }); }</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;.&#39;</span><span style="color: #E6E6E6"> { back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(int(ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">]) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> to_char); }); }</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;,&#39;</span><span style="color: #E6E6E6"> { back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(getchar()); }); }</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;[&#39;</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> blk1 : </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">ExpressionPtr</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">; defer_delete(blk1)</span></span>
<span class="line"><span style="color: #E6E6E6">            blkArr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">emplace</span><span style="color: #E6E6E6">(blk1)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;]&#39;</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> last </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> back(blkArr)</span></span>
<span class="line"><span style="color: #E6E6E6">            blkArr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> pop()</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> whileExpr </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> qmacro_expr </span><span style="color: #D4D4D4">&lt;|</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #C586C0">while</span><span style="color: #E6E6E6"> ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">!=</span><span style="color: #E6E6E6"> uint8(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">                    $b(last)</span></span>
<span class="line"><span style="color: #E6E6E6">            back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> whileExpr</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">else</span><span style="color: #E6E6E6"> { }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> fnArguments : </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">VariablePtr</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> fn </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> qmacro_function(uniqueName) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6"> ($a(fnArguments))</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">            $b(blkArr[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">])</span></span>
<span class="line"><span style="color: #E6E6E6">    defer_delete(fn)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> args:</span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">tuple</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">argname:</span><span style="color: #4EC9B0">string</span><span style="color: #E6E6E6">;argvalue:RttiValue</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">    fn </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> append_annotation(</span><span style="color: #CE9178">&quot;$&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;unsafe_deref&quot;</span><span style="color: #E6E6E6">, args)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//print(describe(fn))</span></span>
<span class="line"><span style="color: #E6E6E6">    compiling_module() </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> add_function(fn)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">reader_macro</span><span style="color: #E6E6E6">(name</span><span style="color: #D4D4D4">=</span><span style="color: #CE9178">&quot;bf&quot;</span><span style="color: #E6E6E6">)]</span></span>
<span class="line"><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> private </span><span style="color: #4EC9B0">BrainfuckReader</span><span style="color: #E6E6E6"> : </span><span style="color: #4EC9B0">AstReaderMacro</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">override </span><span style="color: #DCDCAA">accept</span><span style="color: #E6E6E6">( </span><span style="color: #9CDCFE">prog</span><span style="color: #E6E6E6">:ProgramPtr; </span><span style="color: #9CDCFE">mod</span><span style="color: #E6E6E6">:Module?; </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">expr</span><span style="color: #E6E6E6">:ExprReader?; </span><span style="color: #9CDCFE">ch</span><span style="color: #E6E6E6">:</span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">; </span><span style="color: #9CDCFE">info</span><span style="color: #E6E6E6">:LineInfo) : </span><span style="color: #4EC9B0">bool</span></span>
<span class="line"><span style="color: #E6E6E6">        append(expr</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">sequence, ch)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> ends_with(expr</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">sequence,</span><span style="color: #CE9178">&quot;%%&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> len </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">length</span><span style="color: #E6E6E6">(expr</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">sequence)</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #DCDCAA">resize</span><span style="color: #E6E6E6">(expr</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">sequence,len</span><span style="color: #D4D4D4">-</span><span style="color: #B5CEA8">2</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">false</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">else</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">true</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">override </span><span style="color: #DCDCAA">visit</span><span style="color: #E6E6E6">( </span><span style="color: #9CDCFE">prog</span><span style="color: #E6E6E6">:ProgramPtr; </span><span style="color: #9CDCFE">mod</span><span style="color: #E6E6E6">:Module?; </span><span style="color: #9CDCFE">expr</span><span style="color: #E6E6E6">:</span><span style="color: #C586C0">smart_ptr</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">ExprReader</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">) : ExpressionPtr</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> str </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> make_unique_private_name(</span><span style="color: #CE9178">&quot;bf`exec&quot;</span><span style="color: #E6E6E6">, expr</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">at)</span></span>
<span class="line"><span style="color: #E6E6E6">        generateFunction(str, expr</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">sequence)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> ftype </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> [[TypeDecl() at</span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6">expr</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">at, baseType</span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6">Type tFunction ]]</span></span>
<span class="line"><span style="color: #E6E6E6">        ftype</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">firstType </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> [[TypeDecl() at</span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6">expr</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">at, baseType</span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6">Type tVoid]]</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> funcPtr </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> [[ExprAddr() at</span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6">expr</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">at, target</span><span style="color: #D4D4D4">:=</span><span style="color: #E6E6E6">str, funcType </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> ftype]]</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> funcPtr</span></span></code></pre></div></div></figure>
<p>Тогда вызвать такой макрос можно так:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> brainfuck_macro</span></span>
<span class="line"><span style="color: #6A9955">//генерируем функцию</span></span>
<span class="line"><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> func </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">%</span><span style="color: #E6E6E6">bf~</span><span style="color: #D4D4D4">++++++++</span><span style="color: #E6E6E6">[</span><span style="color: #D4D4D4">&gt;++++</span><span style="color: #E6E6E6">[</span><span style="color: #D4D4D4">&gt;++&gt;+++&gt;+++&gt;+&lt;&lt;&lt;&lt;-</span><span style="color: #E6E6E6">]</span><span style="color: #D4D4D4">&gt;+&gt;+&gt;-&gt;&gt;+</span><span style="color: #E6E6E6">[</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">]</span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6">]</span><span style="color: #D4D4D4">&gt;&gt;.&gt;---.+++++++..+++.&gt;&gt;.&lt;-.&lt;.+++.------.--------.&gt;&gt;+.&gt;++.%%</span></span>
<span class="line"><span style="color: #6A9955">//вызываем сгенерированную функцию</span></span>
<span class="line"><span style="color: #DCDCAA">invoke</span><span style="color: #E6E6E6">(func)</span></span></code></pre></div></div></figure>
<p>Если раскомментировать строчку <code>print(describe(fn))</code> можно посмотреть на сгенерированное тело функции.</p>
<p>Например:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> func </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">%</span><span style="color: #E6E6E6">bf~[</span><span style="color: #D4D4D4">-&gt;+&lt;</span><span style="color: #E6E6E6">]</span><span style="color: #D4D4D4">%%</span></span>
<span class="line"><span style="color: #6A9955">//сгенерированный код</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">unsafe_deref</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">public</span><span style="color: #E6E6E6"> bf`exec_0xd_0xc</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> tape:</span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint8</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">-</span><span style="color: #C586C0">const</span><span style="color: #E6E6E6">                          </span><span style="color: #6A9955">//declare variables</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> tapePos:</span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">-</span><span style="color: #C586C0">const</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #DCDCAA">resize</span><span style="color: #E6E6E6">(tape,</span><span style="color: #B5CEA8">1000000</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> ptape:</span><span style="color: #4EC9B0">auto</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">-</span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(tape[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">while</span><span style="color: #E6E6E6"> ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">!=</span><span style="color: #E6E6E6"> uint8(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">)                      </span><span style="color: #6A9955">//[</span></span>
<span class="line"><span style="color: #E6E6E6">            ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(int(ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">]) </span><span style="color: #D4D4D4">-</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)   </span><span style="color: #6A9955">//-</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #D4D4D4">++</span><span style="color: #E6E6E6">tapePos                                         </span><span style="color: #6A9955">//&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">            ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(int(ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">]) </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)   </span><span style="color: #6A9955">//+</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #D4D4D4">--</span><span style="color: #E6E6E6">tapePos                                         </span><span style="color: #6A9955">//&lt;]</span></span>
<span class="line"><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> func </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> @@bf`exec_0xd_0xc </span><span style="color: #6A9955">//указатель на функцию</span></span></code></pre></div></div></figure>
<p>Для каждой функции генерируется уникальное имя, чтобы можно было создать несколько отдельных интерпретатов, и своя “лента” памяти. В дальнейшем, каждый отдельный символ brainfuck компилируется в одну или несколько ast-нод daScript, который затем могут быть просимулированы.</p>
<p>(Раздел <code>daScript</code> про симуляцию и устройство виртуальной машины daScript)<br><a href="/blog/2115627465/" title="Устройство интерпретаторов lua-jit и daScript">Устройство интерпретаторов lua-jit и daScript</a> </p>
<p>(Генерация кода с помощью <a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/reification.html">реификации выражений</a>)<br><a href="/blog/4046309382/" title="daScript macro - 2">daScript macro - 2</a></p>
<p>Если говорить о терминологии, то brainfuck можно рассматривать как <code>предметно-ориентированный язык (DSL)</code>. Переменные состояния tape и tapePos вместе составляют <code>семантическую модель</code> этого языка, которая настраивается с помощью DSL, а затем транслируется в синтаксическое дерево на <code>daScript</code> (в терминах Мартина Фаулера из книги “Предметно-ориентированные языки программирования”).</p>
<p>Время выполнения такой скомпилированной функции <strong>в режиме интерпретации</strong>:</p>
<figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">e:\src\daScript_my\bin\Release&gt;daScript.exe brainfuck.das</span></span>
<span class="line"><span style="color: #E6E6E6">[I] total 29.28014399999999995 sec</span></span></code></pre></div></div></figure>
<p>Это немного медленнее скомпилированной JiT-версии, но уже быстрее AoT версии интерпретатора.</p>
<h2><span id="macro-jit">Macro + JiT</span><a href="#macro-jit" class="header-anchor">#</a></h2><p>Дальше будет интереснее. Наша скомпилированная версия функции представляет собой по сути развёрнутую трассированную версию исполнения кода (и занимающую больше памяти). Попробуем применить к ней макрос [jit]:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">fn </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> append_annotation(</span><span style="color: #CE9178">&quot;$&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;unsafe_deref&quot;</span><span style="color: #E6E6E6">, args)</span></span>
<span class="line"><span style="color: #E6E6E6">fn </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> append_annotation(</span><span style="color: #CE9178">&quot;$&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;jit&quot;</span><span style="color: #E6E6E6">, args)</span></span></code></pre></div></div></figure>
<figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">e:\src\daScript_my\bin\Release&gt;daScript.exe brainfuck.das</span></span>
<span class="line"><span style="color: #E6E6E6">[I] total 0.85775599999999996 sec</span></span></code></pre></div></div></figure>
<p>0.85 секунды! (плюс около секунды на само время компиляции функции). llvm jit умеет сворачивать идущие подряд повторяющиеся операторы инкремента и декремента, за счёт чего получилось ускорение в 30 раз (и соотвествующее уменьшение размера функции).</p>
<p>Для сравнения — compile-time версия на nim работает ~3 секунды и тратит ~20 секунд на компиляцию (nim работает медленно в compile-time режиме).</p>
<h2><span id="optimizacii-brainfuck-gt-dascript-ast">Оптимизации Brainfuck -&gt; daScript AST</span><a href="#optimizacii-brainfuck-gt-dascript-ast" class="header-anchor">#</a></h2><p>Получается интересная цепочка преобразования кода:</p>
<figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">bf --&gt; (bf macro) --&gt; dascript ast --&gt; (dascript simulate - unsafe deref macro + optimizations) --&gt; dascript ast optimized --&gt; (llvm macro) --&gt; llvm native optimized code --&gt; (execute)</span></span></code></pre></div></div></figure>
<p>На каждом из шагов происходят серьёзные трансформации кода, которые могут включать оптимизации. Можно рассмотреть оптимизации в обратном порядке:</p>
<ul>
<li>llvm — бекэнд генерации кода оптимизирует байт-код, на этом этапе заметен эффект от сворачивания идущих подряд операций</li>
<li>dascript simulate — при симуляции ast-дерева выбираются оптимизированные частные версии нод, мелкие ноды могут “сплавляться” в более крупные, применяются кастомные макросы, трансформирующие дерево по различным правилам</li>
<li>bf macro — на данном уровне производится трансляция команд brainfuck в ноды dascript, пока без оптимизаций</li>
</ul>
<p>Оптимизации на стадиях трансформаций llvm были сделаны библиотекой из “комплекта” языка, на стадиях преобразования daScript — как встроенными в язык оптимизациями, так и добавленными для своего кода вручную. Можно теперь попробовать добавить пару оптимизаций на “стороне DSL”, т.е. в макрос трансформации <code>brainfuck-&gt;daScript</code>.</p>
<p>На данном этапе первую тупую и наивную реализацию уже получилось разогнать где-то в 20000 раз, и это отличный повод разогнать ещё немного :)</p>
<p>Можно выбрать несколько простых паттернов brainfuck кода и попробовать распознавать их и генерить более оптимальный код для этих частных случаев:</p>
<ul>
<li>цепочка повторяющихся операций. Например, “+++++” можно интерпретировать не как 5 отдельных инкрементов, а как одну операцию увеличения на 5. Эту свёртку делает llvm для версии <code>Macro+JiT</code>, но если сделать её в своём макросе, то она также ускорит и обычный режим интерпретации</li>
<li>паттерн [-] можно интерпретировать как очистку ячейки памяти одной операцией</li>
<li>[-&gt;+&lt;] - чуть более сложный паттерн, который часто встречается в примерах на brainfuck, “сложение двух ячеек с очисткой исходной”, может быть интерпретирован как 2 команды вместо цикла</li>
<li>можно продолжать обнаруживать и добавлять всё более сложные паттерны</li>
</ul>
<p>(Приём с отслеживанием паттернов подходит, естественно, не только для brainfuck-кода, но и для любых DSL)</p>
<p>“Продвинутая” версия макроса, отслеживающая перечисленные паттерны</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">seachRepeats</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">symIt</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">sym</span><span style="color: #E6E6E6">:</span><span style="color: #4EC9B0">int</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">; </span><span style="color: #9CDCFE">symbolToCheck</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> count </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">while</span><span style="color: #E6E6E6"> next(symIt, sym)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> symbolToCheck</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #D4D4D4">++</span><span style="color: #E6E6E6">count</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">else</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> count</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> count</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">match_reset</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">data</span><span style="color: #E6E6E6">: </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">int</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">length</span><span style="color: #E6E6E6">(data) </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">3</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&amp;&amp;</span><span style="color: #E6E6E6"> data[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;[&#39;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&amp;&amp;</span><span style="color: #E6E6E6"> data[</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;-&#39;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&amp;&amp;</span><span style="color: #E6E6E6"> data[</span><span style="color: #B5CEA8">2</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;]&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">match_add_right_reset</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">data</span><span style="color: #E6E6E6">: </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">int</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">length</span><span style="color: #E6E6E6">(data) </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">6</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&amp;&amp;</span><span style="color: #E6E6E6"> data[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;[&#39;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&amp;&amp;</span><span style="color: #E6E6E6"> data[</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;-&#39;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&amp;&amp;</span><span style="color: #E6E6E6"> data[</span><span style="color: #B5CEA8">2</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;&gt;&#39;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&amp;&amp;</span><span style="color: #E6E6E6"> data[</span><span style="color: #B5CEA8">3</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;+&#39;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&amp;&amp;</span><span style="color: #E6E6E6"> data[</span><span style="color: #B5CEA8">4</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;&lt;&#39;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&amp;&amp;</span><span style="color: #E6E6E6"> data[</span><span style="color: #B5CEA8">5</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;]&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">generateFunction</span><span style="color: #E6E6E6">(uniqueName, </span><span style="color: #9CDCFE">code</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> seqStr </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> string(code)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> blkArr : </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">ExpressionPtr</span><span style="color: #D4D4D4">&gt;&gt;</span><span style="color: #E6E6E6">; defer_delete(blkArr)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> blk : </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">ExpressionPtr</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">; defer_delete(blk)</span></span>
<span class="line"><span style="color: #E6E6E6">    blkArr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">emplace</span><span style="color: #E6E6E6">(blk)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> cyclePatternChecker:</span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">int</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> initBlock </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> quote() </span><span style="color: #D4D4D4">&lt;|</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> tape: </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint8</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> tapePos : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #E6E6E6">        tape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">resize</span><span style="color: #E6E6E6">(</span><span style="color: #B5CEA8">1000000</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> ptape </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(tape[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">])</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//blkArr[0] |&gt; emplace_new &lt;| initBlock</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> _block </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #C586C0">smart_ptr</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">ExprBlock</span><span style="color: #D4D4D4">&gt;&gt;</span><span style="color: #E6E6E6">(</span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #C586C0">smart_ptr</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">ExprMakeBlock</span><span style="color: #D4D4D4">&gt;&gt;</span><span style="color: #E6E6E6"> initBlock)</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">_block</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> blockItem </span><span style="color: #C586C0">in</span><span style="color: #E6E6E6"> _block</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">list</span></span>
<span class="line"><span style="color: #E6E6E6">            blkArr[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> blockItem</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> symIt </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">unsafe</span><span style="color: #E6E6E6">(each(seqStr))</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> sym : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> repeat </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">false</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> count : </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">while</span><span style="color: #E6E6E6"> repeat </span><span style="color: #D4D4D4">||</span><span style="color: #E6E6E6"> next(symIt, sym)</span></span>
<span class="line"><span style="color: #E6E6E6">        repeat </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">false</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;+&#39;</span></span>
<span class="line"><span style="color: #E6E6E6">            cyclePatternChecker </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">push</span><span style="color: #E6E6E6">(sym)</span></span>
<span class="line"><span style="color: #E6E6E6">            repeat </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">true</span></span>
<span class="line"><span style="color: #E6E6E6">            count </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> seachRepeats(symIt, sym, </span><span style="color: #CE9178">&#39;+&#39;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">            back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(int(ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">]) </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> $v(count)); })</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;-&#39;</span></span>
<span class="line"><span style="color: #E6E6E6">            cyclePatternChecker </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">push</span><span style="color: #E6E6E6">(sym)</span></span>
<span class="line"><span style="color: #E6E6E6">            repeat </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">true</span></span>
<span class="line"><span style="color: #E6E6E6">            count </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> seachRepeats(symIt, sym, </span><span style="color: #CE9178">&#39;-&#39;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">            back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(int(ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">]) </span><span style="color: #D4D4D4">-</span><span style="color: #E6E6E6"> $v(count)); })</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;&gt;&#39;</span></span>
<span class="line"><span style="color: #E6E6E6">            cyclePatternChecker </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">push</span><span style="color: #E6E6E6">(sym)</span></span>
<span class="line"><span style="color: #E6E6E6">            repeat </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">true</span></span>
<span class="line"><span style="color: #E6E6E6">            count </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> seachRepeats(symIt, sym, </span><span style="color: #CE9178">&#39;&gt;&#39;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">            back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ tapePos </span><span style="color: #D4D4D4">+=</span><span style="color: #E6E6E6">  $v(count); })</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;&lt;&#39;</span></span>
<span class="line"><span style="color: #E6E6E6">            cyclePatternChecker </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">push</span><span style="color: #E6E6E6">(sym)</span></span>
<span class="line"><span style="color: #E6E6E6">            repeat </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">true</span></span>
<span class="line"><span style="color: #E6E6E6">            count </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> seachRepeats(symIt, sym, </span><span style="color: #CE9178">&#39;&lt;&#39;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">            back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ tapePos </span><span style="color: #D4D4D4">-=</span><span style="color: #E6E6E6"> $v(count); })</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;.&#39;</span><span style="color: #E6E6E6"> { back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(int(ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">]) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> to_char); }); }</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;,&#39;</span><span style="color: #E6E6E6"> { back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(getchar()); }); }</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;[&#39;</span></span>
<span class="line"><span style="color: #E6E6E6">            cyclePatternChecker </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">clear</span></span>
<span class="line"><span style="color: #E6E6E6">            cyclePatternChecker </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">push</span><span style="color: #E6E6E6">(sym)</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> blk1 : </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">ExpressionPtr</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">; defer_delete(blk1)</span></span>
<span class="line"><span style="color: #E6E6E6">            blkArr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">emplace</span><span style="color: #E6E6E6">(blk1)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> sym </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&#39;]&#39;</span></span>
<span class="line"><span style="color: #E6E6E6">            cyclePatternChecker </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">push</span><span style="color: #E6E6E6">(sym)</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> match_reset(cyclePatternChecker)</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #6A9955">//match [-]</span></span>
<span class="line"><span style="color: #E6E6E6">                blkArr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> pop()</span></span>
<span class="line"><span style="color: #E6E6E6">                back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">); })</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">elif</span><span style="color: #E6E6E6"> match_add_right_reset(cyclePatternChecker)</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #6A9955">//match [-&gt;+&lt;]</span></span>
<span class="line"><span style="color: #E6E6E6">                blkArr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> pop()</span></span>
<span class="line"><span style="color: #E6E6E6">                back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">+$v(count)] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(int(ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">+$v(count)]) </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> int(ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">])); })</span></span>
<span class="line"><span style="color: #E6E6E6">                back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> qmacro_expr( ${ ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> uint8(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">); })</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">else</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #6A9955">//usual cycle</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> last </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> back(blkArr)</span></span>
<span class="line"><span style="color: #E6E6E6">                blkArr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> pop()</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> whileExpr </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> qmacro_expr </span><span style="color: #D4D4D4">&lt;|</span></span>
<span class="line"><span style="color: #E6E6E6">                    </span><span style="color: #C586C0">while</span><span style="color: #E6E6E6"> ptape[</span><span style="color: #569CD6">tapePos</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">!=</span><span style="color: #E6E6E6"> uint8(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">                        $b(last)</span></span>
<span class="line"><span style="color: #E6E6E6">                back(blkArr) </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> emplace_new </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> whileExpr</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">            cyclePatternChecker </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">clear</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">else</span><span style="color: #E6E6E6"> { }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> fnArguments : </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">VariablePtr</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> fn </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> qmacro_function(uniqueName) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6"> ($a(fnArguments))</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">            $b(blkArr[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">])</span></span>
<span class="line"><span style="color: #E6E6E6">    defer_delete(fn)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> args:</span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">tuple</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">argname:</span><span style="color: #4EC9B0">string</span><span style="color: #E6E6E6">;argvalue:RttiValue</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">    fn </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> append_annotation(</span><span style="color: #CE9178">&quot;$&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;jit&quot;</span><span style="color: #E6E6E6">, args)</span></span>
<span class="line"><span style="color: #E6E6E6">    fn </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> append_annotation(</span><span style="color: #CE9178">&quot;$&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;unsafe_deref&quot;</span><span style="color: #E6E6E6">, args)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//print(describe(fn))</span></span>
<span class="line"><span style="color: #E6E6E6">    compiling_module() </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> add_function(fn)</span></span></code></pre></div></div></figure>
<p>Результат:</p>
<figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">e:\src\daScript_my\bin\Release&gt;daScript.exe brainfuck.das</span></span>
<span class="line"><span style="color: #E6E6E6">[I] total 0.70142899999999999 sec</span></span></code></pre></div></div></figure>
<p>Еще на 17% быстрее<br><em>Из замеров явно стоило бы еще вынести print</em></p>
<h2><span id="nemnogo-vyvodov">Немного выводов</span><a href="#nemnogo-vyvodov" class="header-anchor">#</a></h2><ul>
<li>Основа оптимизации — написание грамотного кода на основном языке.</li>
<li>Техники JiT-компиляции (особенно в сочетании с кодогенерацией или замерами hot участков) могут давать крутые результаты, в том числе превосходящие статическую компиляцию</li>
<li>Организация цепочки преобразований кода в одной среде НАМНОГО удобнее, чем в разных (какой-нибудь вариант “кодоген на python” + макросы/шаблоны + код на C++” - мрак с отладкой). Особенно для более длинных цепочек.</li>
<li>Нормальные макросы = нормальная отладка и скорость компиляции DSL.</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/spiiin/dascript_brainfuck">Код примеров</a></p>
<p><em>update от 14.01.2023</em><br><em><a target="_blank" rel="noopener" href="https://tratt.net/laurie/blog/2023/compiled_and_interpreted_languages_two_ways_of_saying_tomato.html">Compiled and Interpreted Languages: Two Ways of Saying Tomato</a> - похожие замеры на rust</em></p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"Ov23liG1mZbiQOIdi91X","clientSecret":"e05812685eb741a752982b89dcf6f5b58dc10251","repo":"spiiin.github.io","owner":"spiiin","admin":["spiiin"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/1976052536/">Позже</a><a class="pagination__link pagination__next" href="/blog/1601029690/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div><!-- hexo injector body_end start -->
  <script>
  const CODE_CONFIG = {
    beautify: undefined,
    highlightCopy: undefined,
    highlightLang: undefined,
    highlightHeightLimit: undefined,
    isHighlightShrink: undefined,
    copy: {
      success: 'undefined',
      error: 'undefined',
      noSupport: 'undefined',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body></html>