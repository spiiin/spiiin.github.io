<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | daScript: обобщенное программирование</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,0.1),rgba(40,44,52,0.9))}</style><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/3914071471/">Позже</a><a class="pagination__link pagination__next" href="/blog/1023396573/">Раньше</a></div><article class="article post"><h3 class="article__title">daScript: обобщенное программирование</h3><div class="article__date metadata"><div class="post-info">2023/01/21</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/longread/">longread</a><a class="article__tags__link metadata" href="/tags/dascript/">dascript</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>Обобщенное программирование — одна из серых, но важных и интересных сторон daScript. “Серость” темы связана с тем, что, во-первых, система типов не очень детально описана в документации, во-вторых — в рассуждениях о типизации можно от практики быстро уйти в дебри академических терминов, в-третьих, тема плохо укладывается в голову C++-программисту.</p>
<p>Поддержка обобщенного программирования в языке, если “на пальцах” — совокупность способов вызывать одну функцию для разных типов.</p>
<h2><span id="peregruzka-funkciy">Перегрузка функций</span><a href="#peregruzka-funkciy" class="header-anchor">#</a></h2><p>Перегруженные функции (ad-hoc полиморфизм) — простейший способ определить функцию для двух различных типов</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    func(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    func(</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">)</span></span></code></pre></div></div></figure>
<p><strong><code>Константность</code></strong></p>
<p>Напечатаем тип параметра-аргумента:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #6A9955">//Output:</span></span>
<span class="line"><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">const</span></span></code></pre></div></div></figure></p>
<p>По умолчанию к типу был добавлен спецификатор <code>const</code>, который не позволяет поменять значение аргумента. Его можно убрать, добавив ключевое слово <code>var</code>:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #6A9955">//Output</span></span>
<span class="line"><span style="color: #4EC9B0">int</span></span></code></pre></div></div></figure></p>
<p>При выборе перегрузки, константная и неконстантная версия, в отличие от C++, не имеют приоритета друг перед другом и при нахождении двух вариантов функции <code>daScript</code> выдаст ошибку (<a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/functions.html#function-overloading">Правила выбора функции</a>).<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a: </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #E6E6E6">func(a)</span></span>
<span class="line"><span style="color: #6A9955">//Output</span></span>
<span class="line"><span style="color: #B5CEA8">30304</span><span style="color: #E6E6E6">: too many matching functions or generics func</span></span>
<span class="line"><span style="color: #E6E6E6">candidates:</span></span>
<span class="line"><span style="color: #E6E6E6">        func ( a : </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> ) : </span><span style="color: #4EC9B0">void</span><span style="color: #E6E6E6"> at generics</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">das:</span><span style="color: #B5CEA8">3</span><span style="color: #E6E6E6">:</span><span style="color: #B5CEA8">4</span><span style="color: #E6E6E6"> </span><span style="color: #6A9955">//принимает int и int const</span></span>
<span class="line"><span style="color: #E6E6E6">        func ( a : </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">-</span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> ) : </span><span style="color: #4EC9B0">void</span><span style="color: #E6E6E6"> at generics</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">das:</span><span style="color: #B5CEA8">9</span><span style="color: #E6E6E6">:</span><span style="color: #B5CEA8">4</span><span style="color: #E6E6E6"> </span><span style="color: #6A9955">//-const читается как &quot;удалить у типа спецификатор const&quot;</span></span></code></pre></div></div></figure></p>
<p>Для того, чтобы daScript различил функции, можно добавить <a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/generic_programming.html#type-contracts-and-type-operations">спецификатор типа</a> <code>== const</code> (“константность аргумента должна совпадать).<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">==</span><span style="color: #569CD6">const</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">==</span><span style="color: #569CD6">const</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a: </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #E6E6E6">    func(a)</span></span>
<span class="line"><span style="color: #E6E6E6">    func(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #6A9955">//Output:</span></span>
<span class="line"><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">==</span><span style="color: #C586C0">const</span></span>
<span class="line"><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">==</span><span style="color: #C586C0">const</span></span></code></pre></div></div></figure></p>
<p><strong><code>Ссылки</code></strong></p>
<p>В предыдущем примере аргумент передавался по значению, поэтому даже <code>var int</code> не позволяет изменить переданную переменную (меняется <strong>значение аргумента</strong>, а не оригинальная переменная). Возможно передать аргумент по ссылке:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">42</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a: </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #E6E6E6">    func(a)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #6A9955">//Output: 42</span></span></code></pre></div></div></figure></p>
<p><strong> Все непримитивные типы передаются по ссылке, независимо от того, был ли описан аргумент со спецификатором <code>&amp;</code> или без него. </strong></p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> A</span></span>
<span class="line"><span style="color: #E6E6E6">    a : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">arg </span><span style="color: #E6E6E6">: A)</span></span>
<span class="line"><span style="color: #E6E6E6">    arg</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">42</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">arg</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a : A</span></span>
<span class="line"><span style="color: #E6E6E6">    func(a)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #6A9955">//Output</span></span>
<span class="line"><span style="color: #E6E6E6">A</span></span>
<span class="line"><span style="color: #E6E6E6">[[ </span><span style="color: #B5CEA8">42</span><span style="color: #E6E6E6">]]</span></span></code></pre></div></div></figure>
<p><em>(причём можно описать 2 перегруженные функции с аргуметами типа A и A&amp;, несмотря на то, что для структур семантически это будет идентичная запись)</em></p>
<p>При этом, как и с константностью, компилятор не различает приоритета перегрузки функций с аргументом-ссылкой и значением, и выдаёт ошибку неоднозначности разрешения перегрузки.</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">pass</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    func(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//ok</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a: </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #E6E6E6">    func(a) </span><span style="color: #6A9955">//30304: too many matching functions or generics func</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #6A9955">//candidates:</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #6A9955">//func ( a : int -const ) : void at generics.das:1:4</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #6A9955">//func ( a : int&amp; -const ) : void at generics.das:3:4</span></span></code></pre></div></div></figure>
<p><strong><code>Контракты</code></strong></p>
<p>Макросы работают раньше разрешения перегрузки, что позволяет реализовать паттерн <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/e7992b384dad13c1a201f9eee1c6a6ae1e0cf8b8/daslib/contracts.das">contracts</a> — произвольную функцию, которая предварительно проверяет тип аргументов:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> daslib</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">contracts</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #D4D4D4">!</span><span style="color: #E6E6E6">expect_ref(arg)]</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">arg </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">arg</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">expect_ref</span><span style="color: #E6E6E6">(arg)]</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">arg </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">arg</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a: </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #E6E6E6">    func(a)</span></span>
<span class="line"><span style="color: #E6E6E6">    func(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #6A9955">//Output:</span></span>
<span class="line"><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #6A9955">//must be int&amp;</span></span>
<span class="line"><span style="color: #4EC9B0">int</span></span></code></pre></div></div></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/test/misc/contracts_example.das">https://github.com/GaijinEntertainment/daScript/blob/master/examples/test/misc/contracts_example.das</a><br><em>вывод typeinfo, кажется, содержит <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/issues/393">баг</a></em></p>
<p><strong><code>Временные ссылки</code></strong></p>
<p>Кроме обычных ссылок в daScript есть временные ссылки, которые позволяют работать с объектами из C++-кода внутри блоков. Временная ссылка доступна только внутри блока, и не может быть сохранена вне его (но может быть передана в другую функцию, принимающую временные объекты).</p>
<p>Рассмотрим для примера C++ тип <code>Color</code> из <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/tutorial/tutorial03.cpp#L15">туториала к daScript</a>. Для него создаётся daScript-обёртка, в которую можно добавить декларацию конструктора и инициализатора с помощью паттерна <code>using</code> — в этом случае можно создать временную ссылку на тип, которая будет доступна только внутри блока: </p>
<figure class="shiki cpp"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//cpp</span></span>
<span class="line"><span style="color: #DCDCAA">Module_Tutorial03</span><span style="color: #E6E6E6">() : </span><span style="color: #DCDCAA">Module</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;tutorial_03&quot;</span><span style="color: #E6E6E6">) {</span><span style="color: #6A9955">   // module name, when used from das file</span></span>
<span class="line"><span style="color: #E6E6E6">    ModuleLibrary lib;</span></span>
<span class="line"><span style="color: #E6E6E6">    ...</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">addCtorAndUsing</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">Color</span><span style="color: #E6E6E6">&gt;(</span><span style="color: #D4D4D4">*</span><span style="color: #569CD6">this</span><span style="color: #E6E6E6">, lib, </span><span style="color: #CE9178">&quot;Color&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;Color&quot;</span><span style="color: #E6E6E6">);</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span></code></pre></div></div></figure>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//das</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> tutorial_03</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">printColor</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">c </span><span style="color: #E6E6E6">: Color) </span><span style="color: #6A9955">//same as Color&amp; as c is struct</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">c</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">printColor</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">c </span><span style="color: #E6E6E6">: Color#)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">c</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> test</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> c </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[Color]]</span></span>
<span class="line"><span style="color: #E6E6E6">    printColor(c)</span></span>
<span class="line"><span style="color: #E6E6E6">    using() </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">c_temp </span><span style="color: #E6E6E6">: Color#)</span></span>
<span class="line"><span style="color: #E6E6E6">        printColor(c_temp)</span></span>
<span class="line"><span style="color: #6A9955">//Output</span></span>
<span class="line"><span style="color: #E6E6E6">tutorial_03::Color </span><span style="color: #C586C0">const</span></span>
<span class="line"><span style="color: #E6E6E6">tutorial_03::Color </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6">#</span></span></code></pre></div></div></figure>
<p><strong>Если тип нельзя <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/commit/9521fdba38c4f5ea422450c6b4979cc2808f58ef">скопировать или переместить</a>, то <code>using</code> не будет не будет создавать временный тип — аргумент и так не сможет покинуть блок</strong></p>
<p>Чаще всего нет необходимости в раздельной обработке обычных и временных ссылок, в этом случае можно добавить к типу аргумента спецификатор <code>implicit</code>:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">printColor</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">c</span><span style="color: #E6E6E6">:Color </span><span style="color: #C586C0">implicit</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">c</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #6A9955">//Output</span></span>
<span class="line"><span style="color: #E6E6E6">tutorial_03::Color </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">implicit</span></span>
<span class="line"><span style="color: #E6E6E6">tutorial_03::Color </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">implicit</span></span></code></pre></div></div></figure>
<p>Небольшое отличие в том, как будет трактоваться аргумент:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">printColor</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">c</span><span style="color: #E6E6E6">:Color </span><span style="color: #C586C0">implicit</span><span style="color: #E6E6E6">)    </span><span style="color: #6A9955">// accepts Color and Color#, a will be treated as Color</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">printColor</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">c</span><span style="color: #E6E6E6">:Color# </span><span style="color: #C586C0">implicit</span><span style="color: #E6E6E6">)   </span><span style="color: #6A9955">// accepts Color and Color#, a will be treated as Color#</span></span></code></pre></div></div></figure></p>
<p><strong><code>Указатели</code></strong></p>
<p>Как и в C++, указатели — это ссылки, которые могут указывать на <code>null</code>, также имеют чуть другую семантику, что позволяет уже без шаманства иметь перегрузки для значения и указателя.</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> daslib</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">safe_addr</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">?)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a: </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a_ptr: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">? </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> safe_addr(a)</span></span>
<span class="line"><span style="color: #E6E6E6">    func(a)</span></span>
<span class="line"><span style="color: #E6E6E6">    func(a_ptr)</span></span>
<span class="line"><span style="color: #6A9955">//Output</span></span>
<span class="line"><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">?</span></span></code></pre></div></div></figure>
<p><strong><code>Приведение базовых типов</code></strong></p>
<p>Базовые типы не приводятся друг другу неявно, требуется явный вызов конструктора типа (<em>Explicit is better than implicit</em>).</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">) {}</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">) {}</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int4</span><span style="color: #E6E6E6">) {}</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">bool</span><span style="color: #E6E6E6">) {}</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">uint</span><span style="color: #E6E6E6">) {}</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int64</span><span style="color: #E6E6E6">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    func(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//int</span></span>
<span class="line"><span style="color: #E6E6E6">    func(float(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)); func(</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//float</span></span>
<span class="line"><span style="color: #E6E6E6">    func(int4(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)) </span><span style="color: #6A9955">//int4</span></span>
<span class="line"><span style="color: #E6E6E6">    func(</span><span style="color: #C586C0">true</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//bool</span></span>
<span class="line"><span style="color: #E6E6E6">    func(uint(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)); func(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">u); func(</span><span style="color: #B5CEA8">0x1</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//uint</span></span>
<span class="line"><span style="color: #E6E6E6">    func(int64(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)); func(</span><span style="color: #B5CEA8">1l</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//int64</span></span></code></pre></div></div></figure>
<p><strong><code>Приведение классов/структур</code></strong></p>
<p>Для типов, поддерживающих наследование, неявно выполняется приведение указателей и ссылок от дочернего к родительскомму типу (<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Liskov_substitution_principle">LSP</a>).</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> A </span></span>
<span class="line"><span style="color: #E6E6E6">    a : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">struct</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">B</span><span style="color: #E6E6E6"> : </span><span style="color: #4EC9B0">A</span></span>
<span class="line"><span style="color: #E6E6E6">    b : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: A)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a : A</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> b : B</span></span>
<span class="line"><span style="color: #E6E6E6">    func(a)</span></span>
<span class="line"><span style="color: #E6E6E6">    func(b)</span></span>
<span class="line"><span style="color: #6A9955">//Output:</span></span>
<span class="line"><span style="color: #E6E6E6">A </span><span style="color: #C586C0">const</span></span>
<span class="line"><span style="color: #E6E6E6">A </span><span style="color: #C586C0">const</span></span></code></pre></div></div></figure>
<p>Приведение типов структур (<code>cast/upcast/reinterpret</code>):<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a : A</span></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> b : B</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> refA : A</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> a</span></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> refB : B</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> b</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//downcast, safe</span></span>
<span class="line"><span style="color: #E6E6E6">refA </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">cast</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">A</span><span style="color: #D4D4D4">&amp;&gt;</span><span style="color: #E6E6E6"> refB </span></span>
<span class="line"><span style="color: #6A9955">//upcase, unsafe</span></span>
<span class="line"><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">    refB </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">upcast</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">B</span><span style="color: #D4D4D4">&amp;&gt;</span><span style="color: #E6E6E6"> refA</span></span>
<span class="line"><span style="color: #6A9955">//reinterpret cast, VERY unsafe, can cast any</span></span>
<span class="line"><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">    refA </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">A</span><span style="color: #D4D4D4">&amp;&gt;</span><span style="color: #E6E6E6">(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//will crash</span></span></code></pre></div></div></figure></p>
<p><strong>При выборе перегрузки функции выбирается та, для которой нужно выполнить наименьшее количество преобразований (при равном количестве daScript выдаст ошибку неоднозначности выбора)</strong></p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> A </span></span>
<span class="line"><span style="color: #E6E6E6">    a : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">struct</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">B</span><span style="color: #E6E6E6"> : </span><span style="color: #4EC9B0">A</span></span>
<span class="line"><span style="color: #E6E6E6">    b: </span><span style="color: #4EC9B0">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: A?)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;a: {</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">b </span><span style="color: #E6E6E6">: B?)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;b: {</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">b</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func4</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a,b,c,d</span><span style="color: #E6E6E6">: A?)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;AAAA</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func4</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a,b,c</span><span style="color: #E6E6E6">: A?; </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">d</span><span style="color: #E6E6E6">: B?)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;AAAB</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func4</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a,b </span><span style="color: #E6E6E6">: A?; </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">c</span><span style="color: #E6E6E6">: B?; </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">d</span><span style="color: #E6E6E6">: A?)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;AABA</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func4</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a,b,c,d</span><span style="color: #E6E6E6">: B?)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;BBBB</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//simple cases</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> refA </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> A()</span></span>
<span class="line"><span style="color: #E6E6E6">    func(refA) </span><span style="color: #6A9955">//a: A?</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> refB </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> B()</span></span>
<span class="line"><span style="color: #E6E6E6">    func(refB) </span><span style="color: #6A9955">//b: B?</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> refAB </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">cast</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">A?</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> B()</span></span>
<span class="line"><span style="color: #E6E6E6">    func(refAB) </span><span style="color: #6A9955">//a: A?</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//advanced cases</span></span>
<span class="line"><span style="color: #E6E6E6">    func4(refA, refA, refA, refA) </span><span style="color: #6A9955">//shortest LSP to AAAA = 0</span></span>
<span class="line"><span style="color: #E6E6E6">    func4(refA, refA, refA, refB) </span><span style="color: #6A9955">//shortest LSP to AAAB = 0</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//func4(refA, refA, refB, refB) //shortest LSP to AAAB/AABA = 1, conflict error</span></span>
<span class="line"><span style="color: #E6E6E6">    func4(refA, refB, refB, refA) </span><span style="color: #6A9955">//shortest LSP to AABA = 1</span></span>
<span class="line"><span style="color: #E6E6E6">    func4(refB, refB, refB, refB) </span><span style="color: #6A9955">//shortest LSP to BBBB = 0</span></span></code></pre></div></div></figure>
<p><strong><code>explicit</code></strong></p>
<p>Для того, чтобы отключить LSP приведение типа аргумента, можно добавить ключевое слово <code>explicit</code>. Так </p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> A </span></span>
<span class="line"><span style="color: #E6E6E6">    a : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">struct</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">B</span><span style="color: #E6E6E6"> : </span><span style="color: #4EC9B0">A</span></span>
<span class="line"><span style="color: #E6E6E6">    b : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: A </span><span style="color: #C586C0">explicit</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a : A</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> b : B</span></span>
<span class="line"><span style="color: #E6E6E6">    func(a)   </span><span style="color: #6A9955">//A</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//func(b) //invalid argument a (0). expecting A explicit -const, passing B&amp; -const</span></span></code></pre></div></div></figure>
<p><strong><code>Приведение generic-типов</code></strong></p>
<p>В документации не описана работа с generic-типами (и не дано общее определение для них, также пока отсутствует возможность создания своих типов), но поиском по коду находятся такие встроенные типы (исключая те, которые связаны с оператором typeinfo и кастами):</p>
<figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">Функциональные объекты:</span></span>
<span class="line"><span style="color: #E6E6E6">block</span></span>
<span class="line"><span style="color: #E6E6E6">function</span></span>
<span class="line"><span style="color: #E6E6E6">lambda</span></span>
<span class="line"><span style="color: #E6E6E6"></span></span>
<span class="line"><span style="color: #E6E6E6">Коллекции:</span></span>
<span class="line"><span style="color: #E6E6E6">array</span></span>
<span class="line"><span style="color: #E6E6E6">table&lt;key&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">table&lt;key, value&gt;</span></span>
<span class="line"><span style="color: #E6E6E6"></span></span>
<span class="line"><span style="color: #E6E6E6">iterator</span></span>
<span class="line"><span style="color: #E6E6E6">generator</span></span>
<span class="line"><span style="color: #E6E6E6">smart_ptr</span></span>
<span class="line"><span style="color: #E6E6E6">tuple</span></span>
<span class="line"><span style="color: #E6E6E6">variant</span></span></code></pre></div></div></figure>
<p>Для таких типов, возможно явное LSP-приведение для типов их аргументов (<code>ковариантность</code>). Пример для функций:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> A </span></span>
<span class="line"><span style="color: #E6E6E6">    a : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">struct</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">B</span><span style="color: #E6E6E6"> : </span><span style="color: #4EC9B0">A</span></span>
<span class="line"><span style="color: #E6E6E6">    b : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func1</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: A)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;a</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func2</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">b </span><span style="color: #E6E6E6">: B)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;b</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">highOrder</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">func</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">function</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">(</span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a:</span><span style="color: #9CDCFE">A</span><span style="color: #E6E6E6">):</span><span style="color: #4EC9B0">void</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">invoke</span><span style="color: #E6E6E6">(func, [[B]])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    highOrder(@@func1)</span></span>
<span class="line"><span style="color: #E6E6E6">    highOrder(</span><span style="color: #C586C0">cast</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">function</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">(</span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a:A):</span><span style="color: #4EC9B0">void</span><span style="color: #D4D4D4">&gt;&gt;</span><span style="color: #E6E6E6"> @@func2) </span><span style="color: #6A9955">//возможно привести тип function&lt;(var b:B):void&gt; к function&lt;(var a:A):void&gt;</span></span></code></pre></div></div></figure>
<h2><span id="generic-funkcii">Generic-функции</span><a href="#generic-funkcii" class="header-anchor">#</a></h2><p>Вернёмся к самому первому примеру — если мы хотим написать функцию, семантически одинаково обрабатывающую различные типы (например, выводящую значение типа с помощью функции <code>print</code>) для типов. Чтобы не реализовывать её для каждого нового типа, в языках программирования используется понятие generic-функций, которые могут производить конкретные функции для новых типов автоматически.</p>
<p><a target="_blank" rel="noopener" href="https://habr.com/ru/company/piter/blog/656377/">Обзор реализаций в языках</a>.</p>
<p>Шаблонные функции в C++ производят код конкретных функций на уровне текста, который отдаётся компилятору (если не ошибаюсь, компилятор visual studio в этом плане действительно генерирует полные копии, не остлеживаю возможных повторов, чтобы иметь больше простора для частных оптимизаций функции под конкретные типы, а clang чуть раньше начинает отслеживать потенциально идентичные реализации для экономии памяти).</p>
<p>Другой возможный вариант реализации в Java — “изображать” generic на высоком уровне для контроля типов, но оставлять одну реализацию (все объекты передаются по ссылке, добавляется overhead при работе с value-типами по боксингу/анбоксингу в обёртку).</p>
<p>Третий путь из C# — добавить поддержку generic-функций в виртуальную машину, в этом случае возможна комбинированная реализация — value-типы получают свои сгенерированные копии функций, а reference-типы — общую функцию. Также возможно инстанцировать новые версии функций в runtime. daScript близок к такому типу реализации generic-функций.</p>
<p><strong><code>Автоматический вывод типов</code></strong></p>
<p>Если не указан тип аргумента функции, daScript выводит его автоматически, пример функции id принимающей аргумент любого типа и возвращающий его:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">options</span><span style="color: #E6E6E6"> log</span><span style="color: #D4D4D4">=</span><span style="color: #C586C0">true</span><span style="color: #E6E6E6">, optimize</span><span style="color: #D4D4D4">=</span><span style="color: #C586C0">false</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> S1</span></span>
<span class="line"><span style="color: #E6E6E6">    a: </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> S2</span></span>
<span class="line"><span style="color: #E6E6E6">    a: </span><span style="color: #4EC9B0">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">id</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">T</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> T</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> id(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> b </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> id(</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> c </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> id([[S1]])</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> d </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> id([[S2]])</span></span>
<span class="line"><span style="color: #6A9955">//Output</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> `id ( T:</span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">explicit</span><span style="color: #E6E6E6"> ) : </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">const</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> T</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> `id ( T:</span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">explicit</span><span style="color: #E6E6E6"> ) : </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">const</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> T</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> `id ( T:S1 </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">explicit</span><span style="color: #E6E6E6"> ) : S1 </span><span style="color: #C586C0">const</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> T</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> `id ( T:S2 </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">explicit</span><span style="color: #E6E6E6"> ) : S2 </span><span style="color: #C586C0">const</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> T</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">public</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> a:</span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> __::`id(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> b:</span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> __::`id(</span><span style="color: #B5CEA8">1f</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> c:S1 </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> __::`id([[S1 ]])</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> d:S2 </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> __::`id([[S2 ]])</span></span></code></pre></div></div></figure>
<p>По выводу текста сгенерированной программы понятна реализация. Символы подчёркивания перед именем функции <code>__::id</code> означают “взять реализацию функции только из текущего модуля” (<a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/modules.html#module-function-visibility">линк</a>), идея будет рассмотрена далее.</p>
<p>Большая часть фич, связанных с generic-функциями, связана с тем, чтобы так или иначе задать или использовать информацию о типах.</p>
<p><strong><code>auto</code></strong></p>
<p>Определение для id более развернуто выглядит так:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">id</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6">:</span><span style="color: #4EC9B0">auto</span><span style="color: #E6E6E6">): </span><span style="color: #4EC9B0">auto</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> a</span></span></code></pre></div></div></figure></p>
<p>Такая форма синтаксиса позволяет задать для каждого из выводимых типов псевдоним, который можно использовать для сравнения типа или получения rtti информации. Несколько примеров:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//print typename</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: auto(T))</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">T</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//generic sum, a and b must be same type</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">sum</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a, b </span><span style="color: #E6E6E6">: auto(T))</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> a </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> b</span></span></code></pre></div></div></figure>
<p><strong><code>Использование типа в качестве аргумента</code></strong></p>
<p>Можно передать информацию о типе в качестве аргумента шаблона, как обычный <code>auto</code> аргумент.</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//generic linear interpolation between int types via cast to float type</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">lerpi</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a, b </span><span style="color: #E6E6E6">: auto(IntType); </span><span style="color: #9CDCFE">part </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">; </span><span style="color: #9CDCFE">tempCastType </span><span style="color: #E6E6E6">: auto(CastType))</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> IntType(CastType(a) </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> CastType(b </span><span style="color: #D4D4D4">-</span><span style="color: #E6E6E6"> a) </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6"> part)</span></span>
<span class="line"><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{lerpi(int2(</span><span style="color: #B5CEA8">0</span><span style="color: #CE9178">, </span><span style="color: #B5CEA8">0</span><span style="color: #CE9178">), int2(</span><span style="color: #B5CEA8">4</span><span style="color: #CE9178">, </span><span style="color: #B5CEA8">4</span><span style="color: #CE9178">), </span><span style="color: #B5CEA8">0.5f</span><span style="color: #CE9178">, </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">float2</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">// (2,2)</span></span>
<span class="line"><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{lerpi(int3(</span><span style="color: #B5CEA8">1</span><span style="color: #CE9178">, </span><span style="color: #B5CEA8">2</span><span style="color: #CE9178">, </span><span style="color: #B5CEA8">3</span><span style="color: #CE9178">), int3(</span><span style="color: #B5CEA8">2</span><span style="color: #CE9178">, </span><span style="color: #B5CEA8">4</span><span style="color: #CE9178">, </span><span style="color: #B5CEA8">7</span><span style="color: #CE9178">), </span><span style="color: #B5CEA8">0.5f</span><span style="color: #CE9178">, </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">float3</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">// (1,3,5)</span></span></code></pre></div></div></figure>
<p>Для того, чтобы тип не передавался в runtime, существует макрос <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/daslib/templates.das#L41">template</a>, который в compile-time убирает такие аргументы.</p>
<p><strong><code>Шаблоны для auto</code></strong></p>
<p>Различные формы <a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/generic_programming.html#type-contracts-and-type-operations">ограчений</a> для типов аргументов auto. Примеры из доки</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">( </span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">auto</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">)           </span><span style="color: #6A9955">// accepts any type, passed by reference</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">( </span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">auto</span><span style="color: #E6E6E6">[])          </span><span style="color: #6A9955">// accepts static array of any type of any size</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">( </span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">auto</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">-</span><span style="color: #569CD6">const</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">)  </span><span style="color: #6A9955">// matches any array, with non-const elements</span></span>
<span class="line"><span style="color: #6A9955">//some tests</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">tuple</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">auto</span><span style="color: #E6E6E6">; </span><span style="color: #9CDCFE">auto</span><span style="color: #E6E6E6">; auto&gt;) </span><span style="color: #6A9955">//tuple of 3 elements, any type</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">function</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">(a : </span><span style="color: #9CDCFE">auto</span><span style="color: #E6E6E6">) : </span><span style="color: #4EC9B0">auto</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//any function with 1 argument</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6">: </span><span style="color: #C586C0">table</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">; auto&gt;) </span><span style="color: #6A9955">//any tables with int keys</span></span></code></pre></div></div></figure>
<p>Еще раз приведу <a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/functions.html#function-overloading">ссылку</a> на правила выбора функций при наличии нескольких специализаций и перегрузок.</p>
<p><strong><code>Контракты</code></strong></p>
<p>Так же, как и к аргументам обычным функциям, к аргументам generic-функциям могут быть применены контракты, позволяющие в более общем виде описать ограничения для типа аргумента. Именно c generic-функциями видна вся мощь контрактов.</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> daslib</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">contracts</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//accept any functions</span></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">expect_any_function</span><span style="color: #E6E6E6">(a)]</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6">: auto(T))</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">T</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//accept any tuples</span></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">expect_any_tuple</span><span style="color: #E6E6E6">(a)]</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">bar</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6">:auto(T))</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">T</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    foo(@@(a : </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">) </span><span style="color: #D4D4D4">=&gt;</span><span style="color: #E6E6E6"> a)                       </span><span style="color: #6A9955">//function&lt;(a:int const):int const&gt; const</span></span>
<span class="line"><span style="color: #E6E6E6">    foo(@@(a : </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">; b: </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">) </span><span style="color: #D4D4D4">=&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&quot;hello world&quot;</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//function&lt;(a:int const;b:float const):string const&gt; const</span></span>
<span class="line"><span style="color: #E6E6E6">    bar([[</span><span style="color: #4EC9B0">auto</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> ,</span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;test&quot;</span><span style="color: #E6E6E6">]])               </span><span style="color: #6A9955">//tuple&lt;int;float;string&gt; const</span></span>
<span class="line"><span style="color: #E6E6E6">    bar([[</span><span style="color: #4EC9B0">auto</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">]])                          </span><span style="color: #6A9955">//tuple&lt;int;int&gt; const</span></span></code></pre></div></div></figure>
<p>Контракты для одного аргумента могут комбинироваться с помощью операторов !, &amp;&amp;, || и ^^</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> daslib</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">contracts</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">expect_any_function</span><span style="color: #E6E6E6">(arg) || expect_any_tuple(arg)]</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func_or_tuple</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">arg </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">auto</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">arg</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//expect_any_array разрешает любые массивы, expect_dim - статические массивы</span></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">expect_any_array</span><span style="color: #E6E6E6">(arg) &amp;&amp; !expect_dim(arg)]</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">array_and_notdim</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">arg </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">auto</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">arg</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    func_or_tuple(@@(a : </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">) </span><span style="color: #D4D4D4">=&gt;</span><span style="color: #E6E6E6"> a)</span></span>
<span class="line"><span style="color: #E6E6E6">    func_or_tuple([[</span><span style="color: #4EC9B0">auto</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">2.0</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;3&quot;</span><span style="color: #E6E6E6">]])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    array_and_notdim([{ </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">[] </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">;</span><span style="color: #B5CEA8">2</span><span style="color: #E6E6E6">;</span><span style="color: #B5CEA8">3</span><span style="color: #E6E6E6"> }]) </span><span style="color: #6A9955">//array&lt;int&gt; allowed</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//array_and_notdim([[ int[] 1;2;3 ]]) //int4[2] not allowed</span></span></code></pre></div></div></figure>
<p><strong><code>Сумма типов</code></strong></p>
<p>Еще один способ задать ограничения для типа — перечислить разрешенные типы через символ <code>|</code> (<a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/generic_programming.html#options">options</a> в доках):</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">|</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">|</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">string</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//accept int or float or string</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">|</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">float</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//array of int of array of float</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">function</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">(a : </span><span style="color: #9CDCFE">auto</span><span style="color: #E6E6E6">) : </span><span style="color: #4EC9B0">auto</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">|</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">function</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">(a, b : </span><span style="color: #4EC9B0">auto</span><span style="color: #E6E6E6">) : </span><span style="color: #4EC9B0">auto</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//accept any function with 1 or 2 arguments</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6"> (</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: Bar </span><span style="color: #C586C0">explicit</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">|</span><span style="color: #E6E6E6"> Foo)   </span><span style="color: #6A9955">// accept exactly Bar or anything inherited from Foo</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6"> (</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: Foo </span><span style="color: #D4D4D4">|</span><span style="color: #E6E6E6"> #) </span><span style="color: #6A9955">//accept Foo and Foo#, looks like this short syntax only works with #</span></span></code></pre></div></div></figure>
<p>Порядок проверки соответствия опций — слева направо:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">auto</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">|</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">int</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">) { a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">84</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">bar</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">|</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">auto</span><span style="color: #E6E6E6">) { a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">42</span><span style="color: #E6E6E6">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a: </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #E6E6E6">    foo(a) </span><span style="color: #6A9955">// match foo(auto)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">// a == 0</span></span>
<span class="line"><span style="color: #E6E6E6">    bar(a) </span><span style="color: #6A9955">// match bar(int&amp;)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">// a == 42</span></span></code></pre></div></div></figure>
<p><strong><code>static_if</code></strong></p>
<p>Проверка наличия методов или полей структуры выполняется в момент инстанцирования generic-функции</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> S</span></span>
<span class="line"><span style="color: #E6E6E6">    a : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">s</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    s</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">42</span><span style="color: #E6E6E6"> </span><span style="color: #6A9955">//not check if s has field</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> s : S</span></span>
<span class="line"><span style="color: #E6E6E6">    foo(s) </span><span style="color: #6A9955">//ok</span></span></code></pre></div></div></figure>
<p>Ошибка возникнет только в момент инстанциирования <code>foo</code> со структурой, не имеющей поля <code>a</code>. Проверить наличие полей или другую информацию о типе в время компиляции можно с помощью оператора <code>static_if</code>:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> S</span></span>
<span class="line"><span style="color: #E6E6E6">    a : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> T</span></span>
<span class="line"><span style="color: #E6E6E6">    a : </span><span style="color: #4EC9B0">float4</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">s</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">static_if</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">typeinfo</span><span style="color: #E6E6E6">(has_field</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">a</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> s) </span><span style="color: #D4D4D4">&amp;&amp;</span><span style="color: #E6E6E6"> (</span><span style="color: #C586C0">typeinfo</span><span style="color: #E6E6E6">(typename s</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">a) </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">typeinfo</span><span style="color: #E6E6E6">(typename </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">-</span><span style="color: #C586C0">const</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">))</span></span>
<span class="line"><span style="color: #E6E6E6">        s</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">42</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> s : S</span></span>
<span class="line"><span style="color: #E6E6E6">foo(s) </span><span style="color: #6A9955">//ok</span></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> t: T</span></span>
<span class="line"><span style="color: #E6E6E6">foo(t) </span><span style="color: #6A9955">//also ok, but do nothing</span></span></code></pre></div></div></figure>
<p><strong><code>Вызываемые макросы</code></strong></p>
<p>Более сложные конструкции вроде “вызвать конструктор того же типа, что и поле структуры <code>s.a</code> можно выразить с помощью макросов</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//generics macro</span></span>
<span class="line"><span style="color: #C586C0">module</span><span style="color: #E6E6E6"> generics_macro </span><span style="color: #C586C0">shared</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">private</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">call_macro</span><span style="color: #E6E6E6">(name</span><span style="color: #D4D4D4">=</span><span style="color: #CE9178">&quot;convert_to&quot;</span><span style="color: #E6E6E6">)]  </span><span style="color: #6A9955">// convert_to(convertType, arg)</span></span>
<span class="line"><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">ApplyMacro</span><span style="color: #E6E6E6"> : </span><span style="color: #4EC9B0">AstCallMacro</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//! convert_to(&quot;float4&quot;, 42) -&gt; float4(42)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">override </span><span style="color: #DCDCAA">visit</span><span style="color: #E6E6E6"> ( </span><span style="color: #9CDCFE">prog</span><span style="color: #E6E6E6">:ProgramPtr; </span><span style="color: #9CDCFE">mod</span><span style="color: #E6E6E6">:Module?; </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">expr</span><span style="color: #E6E6E6">:</span><span style="color: #C586C0">smart_ptr</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">ExprCallMacro</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> ) : ExpressionPtr</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> exprConstStr </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">unsafe</span><span style="color: #E6E6E6">(</span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">smart_ptr</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">ast::ExprConstString</span><span style="color: #D4D4D4">&gt;&amp;&gt;</span><span style="color: #E6E6E6"> expr</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">arguments[</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">])</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> call </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> [[ExprCall() name</span><span style="color: #D4D4D4">:=</span><span style="color: #E6E6E6">exprConstStr</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">value, at</span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6">expr</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">at]]</span></span>
<span class="line"><span style="color: #E6E6E6">        emplace_new(call</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">arguments, clone_expression(expr</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">arguments[</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">]))</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> call</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//</span></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> generics_macro</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">foo</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">s</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">static_if</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">typeinfo</span><span style="color: #E6E6E6">(has_field</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">a</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> s)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">static_if</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">typeinfo</span><span style="color: #E6E6E6">(has_field</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">a</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> s)</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">static_if</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">typeinfo</span><span style="color: #E6E6E6">(typename s</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">a) </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">typeinfo</span><span style="color: #E6E6E6">(typename </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">-</span><span style="color: #C586C0">const</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">                s</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">42</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">else</span></span>
<span class="line"><span style="color: #E6E6E6">                s</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> convert_to(</span><span style="color: #C586C0">typeinfo</span><span style="color: #E6E6E6">(typename s</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">a), </span><span style="color: #B5CEA8">42</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">// --&gt; s.a = float4(42)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> t : T</span></span>
<span class="line"><span style="color: #E6E6E6">foo(t)</span></span>
<span class="line"><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #9CDCFE">t</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//Output:</span></span>
<span class="line"><span style="color: #E6E6E6">[[ </span><span style="color: #B5CEA8">42</span><span style="color: #E6E6E6">,</span><span style="color: #B5CEA8">42</span><span style="color: #E6E6E6">,</span><span style="color: #B5CEA8">42</span><span style="color: #E6E6E6">,</span><span style="color: #B5CEA8">42</span><span style="color: #E6E6E6">]]</span></span></code></pre></div></div></figure>
<p><strong><code>[generic]</code></strong></p>
<p>daScript распознаёт обычные или generic-функции по синтаксису, но можно также явно обозначить функцию как generic:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">options</span><span style="color: #E6E6E6"> log</span><span style="color: #D4D4D4">=</span><span style="color: #C586C0">true</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">generic</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">()</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;hello&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    func()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//Output:</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">private</span><span style="color: #E6E6E6"> `func</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;hello&quot;</span><span style="color: #E6E6E6">,__context__)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">// [modify_external]</span></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">public</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">        __::`func()</span></span></code></pre></div></div></figure>
<p>В таком случае вызов <code>func</code> будет преобразован в <code>__::</code>func` - вызов версии функции только из текущего модуля. Это используется в <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/87ab585fc3704896bff3eea71ab87e29f772be94/src/builtin/fio.das#L10">некоторых функциях</a> стандартной библиотеки daslib, потому что если компилятор знает, что функция находится в том же модуле, что и вызывающий код, то может её оптимизировать — при AoT-компиляции генериуется не полноценный вызов через ABI (который может вести в другой не-AoT daScript модуль), а прямой вызов, что быстрее.</p>
<p><strong><code>[instance_function]</code></strong></p>
<p>С помощью макроса <code>[instance_function]</code> можно попросить явно специализировать generic-функцию с определенными типами:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> daslib</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">instance_function</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a </span><span style="color: #E6E6E6">: auto(TT))</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">typename</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">a</span><span style="color: #CE9178"> )}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">instance_function</span><span style="color: #E6E6E6">(func, TT </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&quot;int const&quot;</span><span style="color: #E6E6E6">)]</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">print_int</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    print_int(</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)</span></span></code></pre></div></div></figure>
<p><strong><code>Видимость модулей</code></strong></p>
<p>Для generic функций, которые подразумевают переопределение для новых кастомных типов в других модулях, необходимо добавлять префикс <code>_::</code> или <code>__::</code>, чтобы обозначить, что функций должна искаться в том модуле, который её вызывает.</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//module1.das</span></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">call_func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">a</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    _::func(a) </span><span style="color: #6A9955">//func will be declared somewhere later</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//main.das</span></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> module1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> S</span></span>
<span class="line"><span style="color: #E6E6E6">    a: </span><span style="color: #4EC9B0">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">func</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">s</span><span style="color: #E6E6E6">: S)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #9CDCFE">s</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">call_func(s) </span><span style="color: #6A9955">//module1::call_func will see and call main::func()</span></span></code></pre></div></div></figure>
<p><code>__::</code> — подразумевает возможность определения функции только в том же модуле, что и вызывающий код (main)<br><code>_::</code> — допускает определение как в том же модуле, что и вызывающий код, так и в других модулях (main, module1 или другие модули)</p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"Ov23liG1mZbiQOIdi91X","clientSecret":"e05812685eb741a752982b89dcf6f5b58dc10251","repo":"spiiin.github.io","owner":"spiiin","admin":["spiiin"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/3914071471/">Позже</a><a class="pagination__link pagination__next" href="/blog/1023396573/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div><!-- hexo injector body_end start -->
  <script>
  const CODE_CONFIG = {
    beautify: undefined,
    highlightCopy: undefined,
    highlightLang: undefined,
    highlightHeightLimit: undefined,
    isHighlightShrink: undefined,
    copy: {
      success: 'undefined',
      error: 'undefined',
      noSupport: 'undefined',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body></html>