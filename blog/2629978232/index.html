<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | daScript: обобщенное программирование</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/3914071471/">Позже</a><a class="pagination__link pagination__next" href="/blog/1023396573/">Раньше</a></div><article class="article post"><h3 class="article__title">daScript: обобщенное программирование</h3><div class="article__date metadata"><div class="post-info">2023/01/21</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/dascript/">dascript</a><a class="article__tags__link metadata" href="/tags/longread/">longread</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>Обобщенное программирование — одна из серых, но важных и интересных сторон daScript. “Серость” темы связана с тем, что, во-первых, система типов не очень детально описана в документации, во-вторых — в рассуждениях о типизации можно от практики быстро уйти в дебри академических терминов, в-третьих, тема плохо укладывается в голову C++-программисту.</p>
<p>Поддержка обобщенного программирования в языке, если “на пальцах” — совокупность способов вызывать одну функцию для разных типов.</p>
<h2 id="Перегрузка-функций"><a href="#Перегрузка-функций" class="headerlink" title="Перегрузка функций"></a>Перегрузка функций</h2><p>Перегруженные функции (ad-hoc полиморфизм) — простейший способ определить функцию для двух различных типов</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">)</span></div></div>
<p><strong><code>Константность</code></strong></p>
<p>Напечатаем тип параметра-аргумента:<br><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #6a9955;">//Output:</span></div><div><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">const</span></div></div></p>
<p>По умолчанию к типу был добавлен спецификатор <code>const</code>, который не позволяет поменять значение аргумента. Его можно убрать, добавив ключевое слово <code>var</code>:<br><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #6a9955;">//Output</span></div><div><span style="color: #4ec9b0;">int</span></div></div></p>
<p>При выборе перегрузки, константная и неконстантная версия, в отличие от C++, не имеют приоритета друг перед другом и при нахождении двух вариантов функции <code>daScript</code> выдаст ошибку (<a href="https://dascript.org/doc/reference/language/functions.html#function-overloading" target="_blank" rel="noopener">Правила выбора функции</a>).<br><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a: </span><span style="color: #4ec9b0;">int</span></div><div><span style="color: #d4d4d4;">func(a)</span></div><div><span style="color: #6a9955;">//Output</span></div><div><span style="color: #b5cea8;">30304</span><span style="color: #d4d4d4;">: too many matching functions or generics func</span></div><div><span style="color: #d4d4d4;">candidates:</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; func ( a : </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> ) : </span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;"> at generics.das:</span><span style="color: #b5cea8;">3</span><span style="color: #d4d4d4;">:</span><span style="color: #b5cea8;">4</span><span style="color: #d4d4d4;"> </span><span style="color: #6a9955;">//принимает int и int const</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; func ( a : </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> -</span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> ) : </span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;"> at generics.das:</span><span style="color: #b5cea8;">9</span><span style="color: #d4d4d4;">:</span><span style="color: #b5cea8;">4</span><span style="color: #d4d4d4;"> </span><span style="color: #6a9955;">//-const читается как "удалить у типа спецификатор const"</span></div></div></p>
<p>Для того, чтобы daScript различил функции, можно добавить <a href="https://dascript.org/doc/reference/language/generic_programming.html#type-contracts-and-type-operations" target="_blank" rel="noopener">спецификатор типа</a> <code>== const</code> (“константность аргумента должна совпадать).<br><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> ==</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> ==</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a: </span><span style="color: #4ec9b0;">int</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(a)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #6a9955;">//Output:</span></div><div><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> ==</span><span style="color: #c586c0;">const</span></div><div><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> ==</span><span style="color: #c586c0;">const</span></div></div></p>
<p><strong><code>Ссылки</code></strong></p>
<p>В предыдущем примере аргумент передавался по значению, поэтому даже <code>var int</code> не позволяет изменить переданную переменную (меняется <strong>значение аргумента</strong>, а не оригинальная переменная). Возможно передать аргумент по ссылке:<br><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&amp;)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a = </span><span style="color: #b5cea8;">42</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a: </span><span style="color: #4ec9b0;">int</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(a)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #6a9955;">//Output: 42</span></div></div></p>
<p><strong> Все непримитивные типы передаются по ссылке, независимо от того, был ли описан аргумент со спецификатором <code>&amp;</code> или без него. </strong></p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> A</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a : </span><span style="color: #4ec9b0;">int</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">arg </span><span style="color: #d4d4d4;">: A)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; arg.a = </span><span style="color: #b5cea8;">42</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">arg</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a : A</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(a)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #6a9955;">//Output</span></div><div><span style="color: #d4d4d4;">A</span></div><div><span style="color: #d4d4d4;">[[ </span><span style="color: #b5cea8;">42</span><span style="color: #d4d4d4;">]]</span></div></div>
<p><em>(причём можно описать 2 перегруженные функции с аргуметами типа A и A&amp;, несмотря на то, что для структур семантически это будет идентичная запись)</em></p>
<p>При этом, как и с константностью, компилятор не различает приоритета перегрузки функций с аргументом-ссылкой и значением, и выдаёт ошибку неоднозначности разрешения перегрузки.</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">pass</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&amp;)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">pass</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">//ok</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a: </span><span style="color: #4ec9b0;">int</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(a) </span><span style="color: #6a9955;">//30304: too many matching functions or generics func</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//candidates:</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//func ( a : int -const ) : void at generics.das:1:4</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//func ( a : int&amp; -const ) : void at generics.das:3:4</span></div></div>
<p><strong><code>Контракты</code></strong></p>
<p>Макросы работают раньше разрешения перегрузки, что позволяет реализовать паттерн <a href="https://github.com/GaijinEntertainment/daScript/blob/e7992b384dad13c1a201f9eee1c6a6ae1e0cf8b8/daslib/contracts.das" target="_blank" rel="noopener">contracts</a> — произвольную функцию, которая предварительно проверяет тип аргументов:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> daslib/contracts</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">!expect_ref</span><span style="color: #d4d4d4;">(arg)]</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">arg </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">arg</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">expect_ref</span><span style="color: #d4d4d4;">(arg)]</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">arg </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&amp;)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">arg</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a: </span><span style="color: #4ec9b0;">int</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(a)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #6a9955;">//Output:</span></div><div><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #6a9955;">//must be int&amp;</span></div><div><span style="color: #4ec9b0;">int</span></div></div>
<p><a href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/test/misc/contracts_example.das" target="_blank" rel="noopener">https://github.com/GaijinEntertainment/daScript/blob/master/examples/test/misc/contracts_example.das</a><br><em>вывод typeinfo, кажется, содержит <a href="https://github.com/GaijinEntertainment/daScript/issues/393" target="_blank" rel="noopener">баг</a></em></p>
<p><strong><code>Временные ссылки</code></strong></p>
<p>Кроме обычных ссылок в daScript есть временные ссылки, которые позволяют работать с объектами из C++-кода внутри блоков. Временная ссылка доступна только внутри блока, и не может быть сохранена вне его (но может быть передана в другую функцию, принимающую временные объекты).</p>
<p>Рассмотрим для примера C++ тип <code>Color</code> из <a href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/tutorial/tutorial03.cpp#L15" target="_blank" rel="noopener">туториала к daScript</a>. Для него создаётся daScript-обёртка, в которую можно добавить декларацию конструктора и инициализатора с помощью паттерна <code>using</code> — в этом случае можно создать временную ссылку на тип, которая будет доступна только внутри блока: </p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//cpp</span></span><br><span class="line">Module_Tutorial03() : Module(<span class="string">"tutorial_03"</span>) &#123;   <span class="comment">// module name, when used from das file</span></span><br><span class="line">    ModuleLibrary lib;</span><br><span class="line">    ...</span><br><span class="line">    addCtorAndUsing&lt;Color&gt;(*<span class="keyword">this</span>, lib, <span class="string">"Color"</span>, <span class="string">"Color"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #6a9955;">//das</span></div><br><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> tutorial_03</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">printColor</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">c </span><span style="color: #d4d4d4;">: Color) </span><span style="color: #6a9955;">//same as Color&amp; as c is struct</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">c</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">printColor</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">c </span><span style="color: #d4d4d4;">: Color#)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">c</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> test</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> c = [[Color]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; printColor(c)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; using() &lt;| </span><span style="color: #569cd6;">$</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">c_temp </span><span style="color: #d4d4d4;">: Color#)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; printColor(c_temp)</span></div><div><span style="color: #6a9955;">//Output</span></div><div><span style="color: #d4d4d4;">tutorial_03::Color </span><span style="color: #c586c0;">const</span></div><div><span style="color: #d4d4d4;">tutorial_03::Color </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;">#</span></div></div>
<p><strong>Если тип нельзя <a href="https://github.com/GaijinEntertainment/daScript/commit/9521fdba38c4f5ea422450c6b4979cc2808f58ef" target="_blank" rel="noopener">скопировать или переместить</a>, то <code>using</code> не будет не будет создавать временный тип — аргумент и так не сможет покинуть блок</strong></p>
<p>Чаще всего нет необходимости в раздельной обработке обычных и временных ссылок, в этом случае можно добавить к типу аргумента спецификатор <code>implicit</code>:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">printColor</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">c</span><span style="color: #d4d4d4;">:Color </span><span style="color: #c586c0;">implicit</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">c</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #6a9955;">//Output</span></div><div><span style="color: #d4d4d4;">tutorial_03::Color </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">implicit</span></div><div><span style="color: #d4d4d4;">tutorial_03::Color </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">implicit</span></div></div>
<p>Небольшое отличие в том, как будет трактоваться аргумент:<br><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">printColor</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">c</span><span style="color: #d4d4d4;">:Color </span><span style="color: #c586c0;">implicit</span><span style="color: #d4d4d4;">) &#160; &#160;</span><span style="color: #6a9955;">// accepts Color and Color#, a will be treated as Color</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">printColor</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">c</span><span style="color: #d4d4d4;">:Color# </span><span style="color: #c586c0;">implicit</span><span style="color: #d4d4d4;">) &#160; </span><span style="color: #6a9955;">// accepts Color and Color#, a will be treated as Color#</span></div></div></p>
<p><strong><code>Указатели</code></strong></p>
<p>Как и в C++, указатели — это ссылки, которые могут указывать на <code>null</code>, также имеют чуть другую семантику, что позволяет уже без шаманства иметь перегрузки для значения и указателя.</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> daslib/safe_addr</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">?)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a: </span><span style="color: #4ec9b0;">int</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a_ptr: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">? = safe_addr(a)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(a)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(a_ptr)</span></div><div><span style="color: #6a9955;">//Output</span></div><div><span style="color: #4ec9b0;">int</span></div><div><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">?</span></div></div>
<p><strong><code>Приведение базовых типов</code></strong></p>
<p>Базовые типы не приводятся друг другу неявно, требуется явный вызов конструктора типа (<em>Explicit is better than implicit</em>).</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">) {}</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">) {}</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int4</span><span style="color: #d4d4d4;">) {}</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">bool</span><span style="color: #d4d4d4;">) {}</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">uint</span><span style="color: #d4d4d4;">) {}</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int64</span><span style="color: #d4d4d4;">) {}</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">//int</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(float(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">)); func(</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">//float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(int4(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">)) </span><span style="color: #6a9955;">//int4</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(</span><span style="color: #c586c0;">true</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">//bool</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(uint(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">)); func(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">u); func(</span><span style="color: #b5cea8;">0x1</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">//uint</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(int64(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">)); func(</span><span style="color: #b5cea8;">1l</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">//int64</span></div></div>
<p><strong><code>Приведение классов/структур</code></strong></p>
<p>Для типов, поддерживающих наследование, неявно выполняется приведение указателей и ссылок от дочернего к родительскомму типу (<a href="https://en.wikipedia.org/wiki/Liskov_substitution_principle" target="_blank" rel="noopener">LSP</a>).</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> A </span></div><div><span style="color: #d4d4d4;">&#160; &#160; a : </span><span style="color: #4ec9b0;">int</span></div><br><div><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">B</span><span style="color: #d4d4d4;"> : </span><span style="color: #4ec9b0;">A</span></div><div><span style="color: #d4d4d4;">&#160; &#160; b : </span><span style="color: #4ec9b0;">int</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: A)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a : A</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> b : B</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(a)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(b)</span></div><div><span style="color: #6a9955;">//Output:</span></div><div><span style="color: #d4d4d4;">A </span><span style="color: #c586c0;">const</span></div><div><span style="color: #d4d4d4;">A </span><span style="color: #c586c0;">const</span></div></div>
<p>Приведение типов структур (<code>cast/upcast/reinterpret</code>):<br><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a : A</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> b : B</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> refA : A&amp; = a</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> refB : B&amp; = b</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//downcast, safe</span></div><div><span style="color: #d4d4d4;">&#160; &#160; refA = </span><span style="color: #c586c0;">cast</span><span style="color: #d4d4d4;">&lt;A&amp;&gt; refB </span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//upcase, unsafe</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">unsafe</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; refB = </span><span style="color: #c586c0;">upcast</span><span style="color: #d4d4d4;">&lt;B&amp;&gt; refA</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//reinterpret cast, VERY unsafe, can cast any</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">unsafe</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; refA = </span><span style="color: #c586c0;">reinterpret</span><span style="color: #d4d4d4;">&lt;A&amp;&gt;(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">//will crash</span></div></div></p>
<p><strong>При выборе перегрузки функции выбирается та, для которой нужно выполнить наименьшее количество преобразований (при равном количестве daScript выдаст ошибку неоднозначности выбора)</strong></p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> A </span></div><div><span style="color: #d4d4d4;">&#160; &#160; a : </span><span style="color: #4ec9b0;">int</span></div><br><div><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">B</span><span style="color: #d4d4d4;"> : </span><span style="color: #4ec9b0;">A</span></div><div><span style="color: #d4d4d4;">&#160; &#160; b: </span><span style="color: #4ec9b0;">int</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: A?)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"a: {</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">b </span><span style="color: #d4d4d4;">: B?)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"b: {</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">b</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func4</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a,b,c,d</span><span style="color: #d4d4d4;">: A?)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"AAAA</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func4</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a,b,c</span><span style="color: #d4d4d4;">: A?; </span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">d</span><span style="color: #d4d4d4;">: B?)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"AAAB</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func4</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a,b </span><span style="color: #d4d4d4;">: A?; </span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">c</span><span style="color: #d4d4d4;">: B?; </span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">d</span><span style="color: #d4d4d4;">: A?)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"AABA</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func4</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a,b,c,d</span><span style="color: #d4d4d4;">: B?)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"BBBB</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//simple cases</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> refA = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> A()</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(refA) </span><span style="color: #6a9955;">//a: A?</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> refB = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> B()</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(refB) </span><span style="color: #6a9955;">//b: B?</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> refAB = </span><span style="color: #c586c0;">cast</span><span style="color: #d4d4d4;">&lt;A?&gt; </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> B()</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(refAB) </span><span style="color: #6a9955;">//a: A?</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//advanced cases</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func4(refA, refA, refA, refA) </span><span style="color: #6a9955;">//shortest LSP to AAAA = 0</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func4(refA, refA, refA, refB) </span><span style="color: #6a9955;">//shortest LSP to AAAB = 0</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//func4(refA, refA, refB, refB) //shortest LSP to AAAB/AABA = 1, conflict error</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func4(refA, refB, refB, refA) </span><span style="color: #6a9955;">//shortest LSP to AABA = 1</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func4(refB, refB, refB, refB) </span><span style="color: #6a9955;">//shortest LSP to BBBB = 0</span></div></div>
<p><strong><code>explicit</code></strong></p>
<p>Для того, чтобы отключить LSP приведение типа аргумента, можно добавить ключевое слово <code>explicit</code>. Так </p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> A </span></div><div><span style="color: #d4d4d4;">&#160; &#160; a : </span><span style="color: #4ec9b0;">int</span></div><br><div><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">B</span><span style="color: #d4d4d4;"> : </span><span style="color: #4ec9b0;">A</span></div><div><span style="color: #d4d4d4;">&#160; &#160; b : </span><span style="color: #4ec9b0;">int</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: A </span><span style="color: #c586c0;">explicit</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a : A</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> b : B</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func(a) &#160; </span><span style="color: #6a9955;">//A</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//func(b) //invalid argument a (0). expecting A explicit -const, passing B&amp; -const</span></div></div>
<p><strong><code>Приведение generic-типов</code></strong></p>
<p>В документации не описана работа с generic-типами (и не дано общее определение для них, также пока отсутствует возможность создания своих типов), но поиском по коду находятся такие встроенные типы (исключая те, которые связаны с оператором typeinfo и кастами):</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Функциональные объекты:</span><br><span class="line">block</span><br><span class="line">function</span><br><span class="line">lambda</span><br><span class="line"></span><br><span class="line">Коллекции:</span><br><span class="line">array</span><br><span class="line">table&lt;key&gt;</span><br><span class="line">table&lt;key, value&gt;</span><br><span class="line"></span><br><span class="line">iterator</span><br><span class="line">generator</span><br><span class="line">smart_ptr</span><br><span class="line">tuple</span><br><span class="line">variant</span><br></pre></td></tr></table></figure>
<p>Для таких типов, возможно явное LSP-приведение для типов их аргументов (<code>ковариантность</code>). Пример для функций:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> A </span></div><div><span style="color: #d4d4d4;">&#160; &#160; a : </span><span style="color: #4ec9b0;">int</span></div><br><div><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">B</span><span style="color: #d4d4d4;"> : </span><span style="color: #4ec9b0;">A</span></div><div><span style="color: #d4d4d4;">&#160; &#160; b : </span><span style="color: #4ec9b0;">int</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func1</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: A)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"a</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func2</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">b </span><span style="color: #d4d4d4;">: B)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"b</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">highOrder</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">func</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">function</span><span style="color: #d4d4d4;">&lt;(</span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a:</span><span style="color: #9cdcfe;">A</span><span style="color: #d4d4d4;">):</span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;">&gt;)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">invoke</span><span style="color: #d4d4d4;">(func, [[B]])</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; highOrder(@@func1)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; highOrder(</span><span style="color: #c586c0;">cast</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">function</span><span style="color: #d4d4d4;">&lt;(</span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a:A):</span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;">&gt;&gt; @@func2) </span><span style="color: #6a9955;">//возможно привести тип function&lt;(var b:B):void&gt; к function&lt;(var a:A):void&gt;</span></div></div>
<h2 id="Generic-функции"><a href="#Generic-функции" class="headerlink" title="Generic-функции"></a>Generic-функции</h2><p>Вернёмся к самому первому примеру — если мы хотим написать функцию, семантически одинаково обрабатывающую различные типы (например, выводящую значение типа с помощью функции <code>print</code>) для типов. Чтобы не реализовывать её для каждого нового типа, в языках программирования используется понятие generic-функций, которые могут производить конкретные функции для новых типов автоматически.</p>
<p><a href="https://habr.com/ru/company/piter/blog/656377/" target="_blank" rel="noopener">Обзор реализаций в языках</a>.</p>
<p>Шаблонные функции в C++ производят код конкретных функций на уровне текста, который отдаётся компилятору (если не ошибаюсь, компилятор visual studio в этом плане действительно генерирует полные копии, не остлеживаю возможных повторов, чтобы иметь больше простора для частных оптимизаций функции под конкретные типы, а clang чуть раньше начинает отслеживать потенциально идентичные реализации для экономии памяти).</p>
<p>Другой возможный вариант реализации в Java — “изображать” generic на высоком уровне для контроля типов, но оставлять одну реализацию (все объекты передаются по ссылке, добавляется overhead при работе с value-типами по боксингу/анбоксингу в обёртку).</p>
<p>Третий путь из C# — добавить поддержку generic-функций в виртуальную машину, в этом случае возможна комбинированная реализация — value-типы получают свои сгенерированные копии функций, а reference-типы — общую функцию. Также возможно инстанцировать новые версии функций в runtime. daScript близок к такому типу реализации generic-функций.</p>
<p><strong><code>Автоматический вывод типов</code></strong></p>
<p>Если не указан тип аргумента функции, daScript выводит его автоматически, пример функции id принимающей аргумент любого типа и возвращающий его:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">options</span><span style="color: #d4d4d4;"> log=</span><span style="color: #c586c0;">true</span><span style="color: #d4d4d4;">, optimize=</span><span style="color: #c586c0;">false</span></div><br><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> S1</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a: </span><span style="color: #4ec9b0;">int</span></div><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> S2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a: </span><span style="color: #4ec9b0;">int</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">id</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">T</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> T</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> a = id(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> b = id(</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> c = id([[S1]])</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> d = id([[S2]])</span></div><div><span style="color: #6a9955;">//Output</span></div><br><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> `id ( T:</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">explicit</span><span style="color: #d4d4d4;"> ) : </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">const</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> T</span></div><br><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> `id ( T:</span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">explicit</span><span style="color: #d4d4d4;"> ) : </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">const</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> T</span></div><br><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> `id ( T:S1 </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">explicit</span><span style="color: #d4d4d4;"> ) : S1 </span><span style="color: #c586c0;">const</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> T</span></div><br><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> `id ( T:S2 </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">explicit</span><span style="color: #d4d4d4;"> ) : S2 </span><span style="color: #c586c0;">const</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> T</span></div><br><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">public</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> a:</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> = __::`id(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> b:</span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> = __::`id(</span><span style="color: #b5cea8;">1f</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> c:S1 </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> = __::`id([[S1 ]])</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> d:S2 </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> = __::`id([[S2 ]])</span></div></div>
<p>По выводу текста сгенерированной программы понятна реализация. Символы подчёркивания перед именем функции <code>__::id</code> означают “взять реализацию функции только из текущего модуля” (<a href="https://dascript.org/doc/reference/language/modules.html#module-function-visibility" target="_blank" rel="noopener">линк</a>), идея будет рассмотрена далее.</p>
<p>Большая часть фич, связанных с generic-функциями, связана с тем, чтобы так или иначе задать или использовать информацию о типах.</p>
<p><strong><code>auto</code></strong></p>
<p>Определение для id более развернуто выглядит так:<br><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">id</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">:</span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;">): </span><span style="color: #4ec9b0;">auto</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> a</span></div></div></p>
<p>Такая форма синтаксиса позволяет задать для каждого из выводимых типов псевдоним, который можно использовать для сравнения типа или получения rtti информации. Несколько примеров:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #6a9955;">//print typename</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: auto(T))</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">T</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #6a9955;">//generic sum, a and b must be same type</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">sum</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a, b </span><span style="color: #d4d4d4;">: auto(T))</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> a + b</span></div></div>
<p><strong><code>Использование типа в качестве аргумента</code></strong></p>
<p>Можно передать информацию о типе в качестве аргумента шаблона, как обычный <code>auto</code> аргумент.</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #6a9955;">//generic linear interpolation between int types via cast to float type</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">lerpi</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a, b </span><span style="color: #d4d4d4;">: auto(IntType); </span><span style="color: #9cdcfe;">part </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">; </span><span style="color: #9cdcfe;">tempCastType </span><span style="color: #d4d4d4;">: auto(CastType))</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> IntType(CastType(a) + CastType(b - a) * part)</span></div><div><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{lerpi(int2(</span><span style="color: #b5cea8;">0</span><span style="color: #ce9178;">, </span><span style="color: #b5cea8;">0</span><span style="color: #ce9178;">), int2(</span><span style="color: #b5cea8;">4</span><span style="color: #ce9178;">, </span><span style="color: #b5cea8;">4</span><span style="color: #ce9178;">), </span><span style="color: #b5cea8;">0.5f</span><span style="color: #ce9178;">, </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">float2</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">// (2,2)</span></div><div><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{lerpi(int3(</span><span style="color: #b5cea8;">1</span><span style="color: #ce9178;">, </span><span style="color: #b5cea8;">2</span><span style="color: #ce9178;">, </span><span style="color: #b5cea8;">3</span><span style="color: #ce9178;">), int3(</span><span style="color: #b5cea8;">2</span><span style="color: #ce9178;">, </span><span style="color: #b5cea8;">4</span><span style="color: #ce9178;">, </span><span style="color: #b5cea8;">7</span><span style="color: #ce9178;">), </span><span style="color: #b5cea8;">0.5f</span><span style="color: #ce9178;">, </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">float3</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">// (1,3,5)</span></div></div>
<p>Для того, чтобы тип не передавался в runtime, существует макрос <a href="https://github.com/GaijinEntertainment/daScript/blob/master/daslib/templates.das#L41" target="_blank" rel="noopener">template</a>, который в compile-time убирает такие аргументы.</p>
<p><strong><code>Шаблоны для auto</code></strong></p>
<p>Различные формы <a href="https://dascript.org/doc/reference/language/generic_programming.html#type-contracts-and-type-operations" target="_blank" rel="noopener">ограчений</a> для типов аргументов auto. Примеры из доки</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">( </span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;">&amp;) &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">// accepts any type, passed by reference</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">( </span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;">[]) &#160; &#160; &#160; &#160; &#160;</span><span style="color: #6a9955;">// accepts static array of any type of any size</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">( </span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #c586c0;">array</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;"> -</span><span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&gt;) &#160;</span><span style="color: #6a9955;">// matches any array, with non-const elements</span></div><div><span style="color: #6a9955;">//some tests</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">tuple</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;">; </span><span style="color: #9cdcfe;">auto</span><span style="color: #d4d4d4;">; auto&gt;) </span><span style="color: #6a9955;">//tuple of 3 elements, any type</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">function</span><span style="color: #d4d4d4;">&lt;(a : </span><span style="color: #9cdcfe;">auto</span><span style="color: #d4d4d4;">) : </span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;">&gt;) </span><span style="color: #6a9955;">//any function with 1 argument</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">: </span><span style="color: #c586c0;">table</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">; auto&gt;) </span><span style="color: #6a9955;">//any tables with int keys</span></div></div>
<p>Еще раз приведу <a href="https://dascript.org/doc/reference/language/functions.html#function-overloading" target="_blank" rel="noopener">ссылку</a> на правила выбора функций при наличии нескольких специализаций и перегрузок.</p>
<p><strong><code>Контракты</code></strong></p>
<p>Так же, как и к аргументам обычным функциям, к аргументам generic-функциям могут быть применены контракты, позволяющие в более общем виде описать ограничения для типа аргумента. Именно c generic-функциями видна вся мощь контрактов.</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> daslib/contracts</span></div><br><div><span style="color: #6a9955;">//accept any functions</span></div><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">expect_any_function</span><span style="color: #d4d4d4;">(a)]</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">: auto(T))</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">T</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #6a9955;">//accept any tuples</span></div><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">expect_any_tuple</span><span style="color: #d4d4d4;">(a)]</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">bar</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">:auto(T))</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">T</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; foo(@@(a : </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">) =&gt; a) &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//function&lt;(a:int const):int const&gt; const</span></div><div><span style="color: #d4d4d4;">&#160; &#160; foo(@@(a : </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">; b: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">) =&gt; </span><span style="color: #ce9178;">"hello world"</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">//function&lt;(a:int const;b:float const):string const&gt; const</span></div><div><span style="color: #d4d4d4;">&#160; &#160; bar([[</span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;"> ,</span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">, </span><span style="color: #ce9178;">"test"</span><span style="color: #d4d4d4;">]]) &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//tuple&lt;int;float;string&gt; const</span></div><div><span style="color: #d4d4d4;">&#160; &#160; bar([[</span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">]]) &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #6a9955;">//tuple&lt;int;int&gt; const</span></div></div>
<p>Контракты для одного аргумента могут комбинироваться с помощью операторов !, &amp;&amp;, || и ^^</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> daslib/contracts</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">expect_any_function</span><span style="color: #d4d4d4;">(arg) || expect_any_tuple(arg)]</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func_or_tuple</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">arg </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">arg</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #6a9955;">//expect_any_array разрешает любые массивы, expect_dim - статические массивы</span></div><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">expect_any_array</span><span style="color: #d4d4d4;">(arg) &amp;&amp; !expect_dim(arg)]</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">array_and_notdim</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">arg </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">arg</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func_or_tuple(@@(a : </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">) =&gt; a)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func_or_tuple([[</span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2.0</span><span style="color: #d4d4d4;">, </span><span style="color: #ce9178;">"3"</span><span style="color: #d4d4d4;">]])</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; array_and_notdim([</span><span style="color: #569cd6;">{</span><span style="color: #d4d4d4;"> int[] </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">;</span><span style="color: #b5cea8;">2</span><span style="color: #d4d4d4;">;</span><span style="color: #b5cea8;">3</span><span style="color: #d4d4d4;"> }]) </span><span style="color: #6a9955;">//array&lt;int&gt; allowed</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//array_and_notdim([[ int[] 1;2;3 ]]) //int4[2] not allowed</span></div></div>
<p><strong><code>Сумма типов</code></strong></p>
<p>Еще один способ задать ограничения для типа — перечислить разрешенные типы через символ <code>|</code> (<a href="https://dascript.org/doc/reference/language/generic_programming.html#options" target="_blank" rel="noopener">options</a> в доках):</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> | </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;"> | </span><span style="color: #4ec9b0;">string</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">//accept int or float or string</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #c586c0;">array</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> | </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">&gt;) </span><span style="color: #6a9955;">//array of int of array of float</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">function</span><span style="color: #d4d4d4;">&lt;(a : </span><span style="color: #9cdcfe;">auto</span><span style="color: #d4d4d4;">) : </span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;">&gt; | </span><span style="color: #4ec9b0;">function</span><span style="color: #d4d4d4;">&lt;(a, b : </span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;">) : </span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;">&gt;) </span><span style="color: #6a9955;">//accept any function with 1 or 2 arguments</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: Bar </span><span style="color: #c586c0;">explicit</span><span style="color: #d4d4d4;"> | Foo) &#160; </span><span style="color: #6a9955;">// accept exactly Bar or anything inherited from Foo</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: Foo | #) </span><span style="color: #6a9955;">//accept Foo and Foo#, looks like this short syntax only works with #</span></div></div>
<p>Порядок проверки соответствия опций — слева направо:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;"> | </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&amp;) { a = </span><span style="color: #b5cea8;">84</span><span style="color: #d4d4d4;">; }</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">bar</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">&amp; | </span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;">) { a = </span><span style="color: #b5cea8;">42</span><span style="color: #d4d4d4;">; }</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a: </span><span style="color: #4ec9b0;">int</span></div><div><span style="color: #d4d4d4;">&#160; &#160; foo(a) </span><span style="color: #6a9955;">// match foo(auto)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">// a == 0</span></div><div><span style="color: #d4d4d4;">&#160; &#160; bar(a) </span><span style="color: #6a9955;">// match bar(int&amp;)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">// a == 42</span></div></div>
<p><strong><code>static_if</code></strong></p>
<p>Проверка наличия методов или полей структуры выполняется в момент инстанцирования generic-функции</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> S</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a : </span><span style="color: #4ec9b0;">int</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">s</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; s.a = </span><span style="color: #b5cea8;">42</span><span style="color: #d4d4d4;"> </span><span style="color: #6a9955;">//not check if s has field</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> s : S</span></div><div><span style="color: #d4d4d4;">&#160; &#160; foo(s) </span><span style="color: #6a9955;">//ok</span></div></div>
<p>Ошибка возникнет только в момент инстанциирования <code>foo</code> со структурой, не имеющей поля <code>a</code>. Проверить наличие полей или другую информацию о типе в время компиляции можно с помощью оператора <code>static_if</code>:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> S</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a : </span><span style="color: #4ec9b0;">int</span></div><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> T</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a : </span><span style="color: #4ec9b0;">float4</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">s</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">static_if</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">typeinfo</span><span style="color: #d4d4d4;">(has_field&lt;a&gt; s) &amp;&amp; (</span><span style="color: #c586c0;">typeinfo</span><span style="color: #d4d4d4;">(typename s.a) == </span><span style="color: #c586c0;">typeinfo</span><span style="color: #d4d4d4;">(typename </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> -</span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;">&gt;))</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; s.a = </span><span style="color: #b5cea8;">42</span></div><br><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> s : S</span></div><div><span style="color: #d4d4d4;">foo(s) </span><span style="color: #6a9955;">//ok</span></div><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> t: T</span></div><div><span style="color: #d4d4d4;">foo(t) </span><span style="color: #6a9955;">//also ok, but do nothing</span></div></div>
<p><strong><code>Вызываемые макросы</code></strong></p>
<p>Более сложные конструкции вроде “вызвать конструктор того же типа, что и поле структуры <code>s.a</code> можно выразить с помощью макросов</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #6a9955;">//generics macro</span></div><div><span style="color: #c586c0;">module</span><span style="color: #d4d4d4;"> generics_macro </span><span style="color: #c586c0;">shared</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">private</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">call_macro</span><span style="color: #d4d4d4;">(name=</span><span style="color: #ce9178;">"convert_to"</span><span style="color: #d4d4d4;">)] &#160;</span><span style="color: #6a9955;">// convert_to(convertType, arg)</span></div><div><span style="color: #569cd6;">class</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">ApplyMacro</span><span style="color: #d4d4d4;"> : </span><span style="color: #4ec9b0;">AstCallMacro</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//! convert_to("float4", 42) -&gt; float4(42)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">def override</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">visit</span><span style="color: #d4d4d4;"> ( </span><span style="color: #9cdcfe;">prog</span><span style="color: #d4d4d4;">:ProgramPtr; </span><span style="color: #9cdcfe;">mod</span><span style="color: #d4d4d4;">:Module?; </span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">expr</span><span style="color: #d4d4d4;">:</span><span style="color: #c586c0;">smart_ptr</span><span style="color: #d4d4d4;">&lt;ExprCallMacro&gt; ) : ExpressionPtr</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> exprConstStr &lt;- </span><span style="color: #c586c0;">unsafe</span><span style="color: #d4d4d4;">(</span><span style="color: #c586c0;">reinterpret</span><span style="color: #d4d4d4;">&lt; </span><span style="color: #c586c0;">smart_ptr</span><span style="color: #d4d4d4;">&lt;ast::ExprConstString&gt;&amp;&gt; expr.arguments[</span><span style="color: #569cd6;">0</span><span style="color: #d4d4d4;">])</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> call &lt;- </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[ExprCall() name:=exprConstStr.value, at=expr.at]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; emplace_new(call.arguments, clone_expression(expr.arguments[</span><span style="color: #569cd6;">1</span><span style="color: #d4d4d4;">]))</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> &lt;- call</span></div><br><div><span style="color: #6a9955;">//</span></div><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> generics_macro</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">foo</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">s</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">static_if</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">typeinfo</span><span style="color: #d4d4d4;">(has_field&lt;a&gt; s)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">static_if</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">typeinfo</span><span style="color: #d4d4d4;">(has_field&lt;a&gt; s)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">static_if</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">typeinfo</span><span style="color: #d4d4d4;">(typename s.a) == </span><span style="color: #c586c0;">typeinfo</span><span style="color: #d4d4d4;">(typename </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> -</span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;">&gt;)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; s.a = </span><span style="color: #b5cea8;">42</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">else</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; s.a = convert_to(</span><span style="color: #c586c0;">typeinfo</span><span style="color: #d4d4d4;">(typename s.a), </span><span style="color: #b5cea8;">42</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">// --&gt; s.a = float4(42)</span></div><br><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> t : T</span></div><div><span style="color: #d4d4d4;">foo(t)</span></div><div><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">t</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #6a9955;">//Output:</span></div><div><span style="color: #d4d4d4;">[[ </span><span style="color: #b5cea8;">42</span><span style="color: #d4d4d4;">,</span><span style="color: #b5cea8;">42</span><span style="color: #d4d4d4;">,</span><span style="color: #b5cea8;">42</span><span style="color: #d4d4d4;">,</span><span style="color: #b5cea8;">42</span><span style="color: #d4d4d4;">]]</span></div></div>
<p><strong><code>[generic]</code></strong></p>
<p>daScript распознаёт обычные или generic-функции по синтаксису, но можно также явно обозначить функцию как generic:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">options</span><span style="color: #d4d4d4;"> log=</span><span style="color: #c586c0;">true</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">generic</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">()</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"hello"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; func()</span></div><br><div><span style="color: #6a9955;">//Output:</span></div><br><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">private</span><span style="color: #d4d4d4;"> `func</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"hello"</span><span style="color: #d4d4d4;">,__context__)</span></div><br><div><span style="color: #6a9955;">// [modify_external]</span></div><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">public</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; __::`func()</span></div></div>
<p>В таком случае вызов <code>func</code> будет преобразован в <code>__::</code>func` - вызов версии функции только из текущего модуля. Это используется в <a href="https://github.com/GaijinEntertainment/daScript/blob/87ab585fc3704896bff3eea71ab87e29f772be94/src/builtin/fio.das#L10" target="_blank" rel="noopener">некоторых функциях</a> стандартной библиотеки daslib, потому что если компилятор знает, что функция находится в том же модуле, что и вызывающий код, то может её оптимизировать — при AoT-компиляции генериуется не полноценный вызов через ABI (который может вести в другой не-AoT daScript модуль), а прямой вызов, что быстрее.</p>
<p><strong><code>[instance_function]</code></strong></p>
<p>С помощью макроса <code>[instance_function]</code> можно попросить явно специализировать generic-функцию с определенными типами:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> daslib/instance_function</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a </span><span style="color: #d4d4d4;">: auto(TT))</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">typename</span><span style="color: #ce9178;"> </span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;"> )}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">instance_function</span><span style="color: #d4d4d4;">(func, TT = </span><span style="color: #ce9178;">"int const"</span><span style="color: #d4d4d4;">)]</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">print_int</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">) {}</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; print_int(</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">)</span></div></div>
<p><strong><code>Видимость модулей</code></strong></p>
<p>Для generic функций, которые подразумевают переопределение для новых кастомных типов в других модулях, необходимо добавлять префикс <code>_::</code> или <code>__::</code>, чтобы обозначить, что функций должна искаться в том модуле, который её вызывает.</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #6a9955;">//module1.das</span></div><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">call_func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; _::func(a) </span><span style="color: #6a9955;">//func will be declared somewhere later</span></div><br><div><span style="color: #6a9955;">//main.das</span></div><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> module1</span></div><br><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> S</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a: </span><span style="color: #4ec9b0;">int</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">func</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">s</span><span style="color: #d4d4d4;">: S)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">s</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">call_func(s) </span><span style="color: #6a9955;">//module1::call_func will see and call main::func()</span></div></div>
<p><code>__::</code> — подразумевает возможность определения функции только в том же модуле, что и вызывающий код (main)<br><code>_::</code> — допускает определение как в том же модуле, что и вызывающий код, так и в других модулях (main, module1 или другие модули)</p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/3914071471/">Позже</a><a class="pagination__link pagination__next" href="/blog/1023396573/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>