<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | F# in imaginery world</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,0.1),rgba(40,44,52,0.9))}</style><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__next" href="/blog/106426514/">Раньше</a></div><article class="article post"><h3 class="article__title">F# in imaginery world</h3><div class="article__date metadata"><div class="post-info">2024/12/30</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/fsharp/">fsharp</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>1 - <a href="/blog/28461/" title="Python in imaginary world">(2009) Python in imaginary world</a><br>2 - <a href="/blog/3351183716/" title="Scala in imaginary world">(2015) Scala in imaginary world</a><br>3 - <a href="/blog/1808122922/" title="Nim in imaginary world">(2021) Nim in imaginary world</a><br>4 - <a href="/blog/1160489034/" title="daScript in imaginery world">(2022) daScript in imaginery world</a><br>5 - <a href="/blog/3605719908/" title="AI in imaginery world">(2023) AI in imaginery world</a></p>
<p>Ещё один язык — еще один подход к решению пазла из <code>James Bond Jr</code>!<br><a target="_blank" rel="noopener" href="https://github.com/spiiin/james_bond_jr_problem/tree/main/fsharp">https://github.com/spiiin/james_bond_jr_problem/tree/main/fsharp</a></p>
<div class="toc">

<!-- toc -->
<ul>
<li><a href="#f-yazyk-dlya-poliglotov">F# — язык для полиглотов</a></li>
<li><a href="#pervaya-versiya">Первая версия</a></li>
<li><a href="#chut-bolee-bystraya-versiya">Чуть более быстрая версия</a></li>
<li><a href="#parallelnaya-versiya">Параллельная версия</a></li>
<li><a href="#chut-refaktoringa">Чуть рефакторинга</a></li>
<li><a href="#compile-time-versiya">Compile-time версия</a></li>
<li><a href="#gpu-compiled-time-versiya">GPU compiled-time версия</a></li>
<li><a href="#vizualizaciya-resheniya">Визуализация решения</a></li>
</ul>
<!-- tocstop -->
</div>

<h2><span id="f-yazyk-dlya-poliglotov">F# — язык для полиглотов</span><a href="#f-yazyk-dlya-poliglotov" class="header-anchor">#</a></h2><p>С одной стороны, для изучения функционального программирования проще выучить какой-нибудь ML-язык.<br>С другой — он всё же существует на платформе .NET, и взаимодействует с библиотеками, так что нужно ориентироваться и в C#.<br>С третьей — его можно применять как транспилер (<a target="_blank" rel="noopener" href="https://fable.io/">Fable</a>) в другие языки (JavaScript/Python/Rust), что требует хорошего знания синтаксиса этих языков.<br>С четвёртой — если использовать его для тестирования передовых академических функциональных приёмов программирования, то заодно удобно уметь читать код на lisp/haskell/других вариантах ml.<br>С пятой — F# можно использовать для создания мини-языков (<a target="_blank" rel="noopener" href="https://vimeo.com/97315970">Domain Specific Languages, the functional way</a>)</p>
<p>Я использую “задачку Джеймса Бонда” как одно из первых упражнений при изучении языка, чтобы потыкать его фичи. Для F# это — лаконичность кода, параллельные вычисления, использования инструментария .net для профилирования, провайдеры типов и цитирование кода/транспиляция в gpu-код, ну и немного идиом функционального программирования.</p>
<h2><span id="pervaya-versiya">Первая версия</span><a href="#pervaya-versiya" class="header-anchor">#</a></h2><p>Первая особенность — лаконичность, по количеству строк он попадает в одну категорию со <code>Scala</code>:<br><a target="_blank" rel="noopener" href="https://github.com/spiiin/james_bond_jr_problem/blob/main/fsharp/james_bond_jr_fsharp/1-james_bond_fsharp_slow.fs">1-james_bond_fsharp_slow.fs</a></p>
<p>Особенности синтаксиса:</p>
<p><strong><code>- Паттерн-матчинг везде</code></strong><br>Используется не только в явном <code>match</code>, но и например, в определении локальной переменной или в аргументах функции<br><figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">(</span><span style="color: #9CDCFE">State es</span><span style="color: #569CD6">)</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> endState </span><span style="color: #C586C0">in</span><span style="color: #E6E6E6"> es </span><span style="color: #6A9955">//inplaced pattern-matching with captured endState</span></span>
<span class="line"><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">filterNumbers</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">function</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">|</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">|</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">2</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">|</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">3</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">-&gt;</span><span style="color: #E6E6E6"> printfn </span><span style="color: #CE9178">&quot;Found 1, 2, or 3!&quot;</span></span></code></pre></div></div></figure></p>
<p>Можно расширять <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/fsharp/language-reference/active-patterns">кастомными паттернами</a></p>
<p><strong><code>- Computational expressions</code></strong><br>Можно “выворачивать” нелинейный код в линейный с помощью <a target="_blank" rel="noopener" href="https://fsharpforfunandprofit.com/posts/computation-expressions-intro/">вычислительных выражений</a>.</p>
<figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">seq</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">{</span></span>
<span class="line"><span style="color: #E6E6E6">   </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> List.isEmpty paths </span><span style="color: #C586C0">then</span></span>
<span class="line"><span style="color: #E6E6E6">       </span><span style="color: #C586C0">yield</span><span style="color: #569CD6">!</span><span style="color: #E6E6E6"> Seq.empty</span></span>
<span class="line"><span style="color: #E6E6E6">   </span><span style="color: #C586C0">else</span></span>
<span class="line"><span style="color: #E6E6E6">       </span><span style="color: #569CD6">//..</span><span style="color: #E6E6E6">. calculate more dfs moves</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">       </span><span style="color: #C586C0">yield</span><span style="color: #E6E6E6"> sortedPaths</span></span>
<span class="line"><span style="color: #E6E6E6">       </span><span style="color: #C586C0">yield</span><span style="color: #569CD6">!</span><span style="color: #E6E6E6"> next</span><span style="color: #569CD6">_</span><span style="color: #E6E6E6">search</span><span style="color: #569CD6">_</span><span style="color: #E6E6E6">step more explored endState</span></span>
<span class="line"><span style="color: #569CD6">}</span></span></code></pre></div></div></figure>
<p><code>seq</code> — не вшитый в язык генератор, а объект, который можно написать самому. Как и другие типы вычислений — <code>кастомные корутины, асинхронные вычисления, продолжения, вычисления с возвратом, linq-выражения</code>, etc. В первом приближении, можно рассматривать вычислительные выражения, как способ перегрузить стандартный синтаксис языка.</p>
<h2><span id="chut-bolee-bystraya-versiya">Чуть более быстрая версия</span><a href="#chut-bolee-bystraya-versiya" class="header-anchor">#</a></h2><p>Наивно написанный код работает около 7 секунд. Он возвращает первое найденное решение задачи, не всегда оптимальное. С помощью ИИ перебирая алгоритмы на Python, я знал, что кроме первого найденного решения в 9 ходов существует и решение в 8 ходов, поэтому добавил отбрасывание неоптимальных решений. Такое решение нашлось за 85 секунд. Я убрал явный мусор, и разогнал его до 14 секунд.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/spiiin/james_bond_jr_problem/blob/main/fsharp/james_bond_jr_fsharp/6-james_bond_fsharp_slow_only_8_custom_hash.fs">6-james_bond_fsharp_slow_only_8_custom_hash.fs</a></p>
<ul>
<li>закешировать значение функции оценки</li>
<li>заменить тормозные структуры более быстрыми (в F# списки иммутабельны, так что могут шарить свои хвосты, дальше можно было бы заменять массивом)</li>
<li>написать свою функцию хеширования взамен тормозной дефолтной</li>
</ul>
<p>В целом, можно разойтись в оптимизациях достаточно <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=KMR2y1vcO-s&amp;list=PLqWncHdBPoD4-d_VSZ0MB0IBKQY0rwYLd">далеко</a>, но как можно посмотреть в конце плейлиста, в случаях скорости лучше сразу проектировать код в data oriented, что уже за пределами первого подхода к языку.</p>
<p>Вместо этого, можно попробовать пойти другим путём, применяя оптимизации, которые специфичны для функционального программирования или F# в частности.</p>
<h2><span id="parallelnaya-versiya">Параллельная версия</span><a href="#parallelnaya-versiya" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://github.com/spiiin/james_bond_jr_problem/blob/main/fsharp/james_bond_jr_fsharp/7-james_bond_fsharp_slow_only_8_pseq.fs">7-james_bond_fsharp_slow_only_8_pseq.fs</a></p>
<p>В теории, написанный в функциональном стиле код можно распараллелить с минимальными усилиями. Лёгким движением меняет <code>Seq</code> на <code>PSeq</code> и добавляем в конвейер обработки <code>withDegreeOfParallelism</code>:</p>
<figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">more</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span></span>
<span class="line"><span style="color: #E6E6E6">    sortedPaths</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">|&gt;</span><span style="color: #E6E6E6"> PSeq.withDegreeOfParallelism Environment.ProcessorCount </span><span style="color: #6A9955">// &lt;-- 1</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">|&gt;</span><span style="color: #E6E6E6"> PSeq.collect </span><span style="color: #569CD6">(fun</span><span style="color: #9CDCFE"> path </span><span style="color: #569CD6">-&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">        moves</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">|&gt;</span><span style="color: #E6E6E6"> Seq.map </span><span style="color: #569CD6">(fun</span><span style="color: #9CDCFE"> move </span><span style="color: #569CD6">-&gt;</span><span style="color: #E6E6E6"> path.Extend</span><span style="color: #569CD6">(</span><span style="color: #E6E6E6">move</span><span style="color: #569CD6">,</span><span style="color: #E6E6E6"> endState</span><span style="color: #569CD6">,</span><span style="color: #E6E6E6"> rate</span><span style="color: #569CD6">))</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">|&gt;</span><span style="color: #E6E6E6"> Seq.filter filterPath</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">|&gt;</span><span style="color: #E6E6E6"> Seq.toList</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">more</span></span>
<span class="line"><span style="color: #569CD6">|&gt;</span><span style="color: #E6E6E6"> PSeq.withDegreeOfParallelism Environment.ProcessorCount </span><span style="color: #6A9955">// &lt;-- 2</span></span>
<span class="line"><span style="color: #569CD6">|&gt;</span><span style="color: #E6E6E6"> PSeq.iter </span><span style="color: #569CD6">(fun</span><span style="color: #9CDCFE"> path </span><span style="color: #569CD6">-&gt;</span><span style="color: #E6E6E6"> explored.TryAdd</span><span style="color: #569CD6">(</span><span style="color: #E6E6E6">path.State</span><span style="color: #569CD6">,</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">())</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">|&gt;</span><span style="color: #E6E6E6"> ignore</span><span style="color: #569CD6">)</span></span></code></pre></div></div></figure>
<p>Почти получилось — программа падает на <code>explored.TryAdd</code> в словарь. Для исправления нужно использовать thread-safe <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2?view=net-9.0">ConcurrentDictionary</a>.</p>
<p>Это не самый оптимальный способ, можно изменить алгоритм и структуры данных (<a target="_blank" rel="noopener" href="https://medium.com/analytics-vidhya/parallel-a-search-on-gpu-ceb3bfe2cf51">Parallel A* Search</a>), но зато потребовалось изменение всего трёх строк, для игрушечной задачки сойдёт. Время поиска сократилось с 14 до 8 секунд.</p>
<p>Напоследок можно улучшить саму функцию оценки позиции на поле. Простейшее улучшение — “оцениваем не только элементы на своих местах, но и те, которым остался 1 шаг до своего места” ускоряет поиск с 8 до 1.5 секунд.<br><a target="_blank" rel="noopener" href="https://github.com/spiiin/james_bond_jr_problem/blob/main/fsharp/james_bond_jr_fsharp/9.5-james_bond_fsharp_slow_only_8_better_rate_5000_arr.fs">9.5-james_bond_fsharp_slow_only_8_better_rate_5000_arr.fs</a></p>
<p>Такой код уже показывает относительно равномерное “размазывание” производительности в профайлере:<br><a href="/blog/4106514811/fsharp_1.png"><img src="/blog/4106514811/fsharp_1_small.png" alt></a><br><em>что значит, что его пора было бы выбросить и переписать нормально</em></p>
<h2><span id="chut-refaktoringa">Чуть рефакторинга</span><a href="#chut-refaktoringa" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://github.com/spiiin/james_bond_jr_problem/blob/main/fsharp/james_bond_jr_fsharp/10-james_bond_fsharp_slow_only_8_refactor_reader.fs">10-james_bond_fsharp_slow_only_8_refactor_reader.fs</a></p>
<figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">let rec</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">nextSearchStep </span><span style="color: #569CD6">(</span><span style="color: #9CDCFE">paths</span><span style="color: #569CD6">:</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">Path array</span><span style="color: #569CD6">)</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span></span>
<span class="line"><span style="color: #E6E6E6">    Reader.reader </span><span style="color: #569CD6">{</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">let!</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">{</span><span style="color: #E6E6E6"> TransformPaths </span><span style="color: #569CD6">=</span><span style="color: #9CDCFE"> transformPaths</span><span style="color: #569CD6">;</span><span style="color: #E6E6E6"> FilterPath </span><span style="color: #569CD6">=</span><span style="color: #9CDCFE"> filterPath</span><span style="color: #569CD6">;</span><span style="color: #E6E6E6"> Rate </span><span style="color: #569CD6">=</span><span style="color: #9CDCFE"> rate</span><span style="color: #569CD6">;</span><span style="color: #E6E6E6"> Explored </span><span style="color: #569CD6">=</span><span style="color: #9CDCFE"> explored</span><span style="color: #569CD6">;</span><span style="color: #E6E6E6"> EndState </span><span style="color: #569CD6">=</span><span style="color: #9CDCFE"> endState </span><span style="color: #569CD6">}</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> Reader.ask</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">//..</span><span style="color: #E6E6E6">.</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">}</span></span></code></pre></div></div></figure>
<p>С помощью монады <a target="_blank" rel="noopener" href="https://github.com/fsprojects/FSharpx.Extras/blob/master/src/FSharpx.Extras/ComputationExpressions/Reader.fs">Reader</a> можно:</p>
<ul>
<li>спрятать настраиваемые аргументы функции в сам тип вычисления</li>
<li>убрать жёстко заданный порядок выполнения кода, вместо этого передать настройку способа вычислений вызывающей стороне<br><em>(у меня тут “ненастоящая” монада, без такого разделения, это тоже как-то не уложилось в первый подход к языку)</em></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://fsharpforfunandprofit.com/posts/dependencies/">Six approaches to dependency injection</a> — про этот <code>Reader</code>, а такж паттерн <code>Interpreter на Free monads</code><br><a target="_blank" rel="noopener" href="https://medium.com/@dogwith1eye/prefer-continuations-to-api-classes-in-f-15126581be92">Prefer Continuations to API Classes in F#</a></p>
<p>Более глобально про идиомы и организацию кода на F#<br><a target="_blank" rel="noopener" href="https://fsharpforfunandprofit.com/fppatterns/">Functional Programming Design Patterns</a><br><a target="_blank" rel="noopener" href="https://tomasp.net/blog/2015/library-layers/">Library patterns Multiple levels of abstraction</a><br><a target="_blank" rel="noopener" href="https://tomasp.net/blog/2015/library-frameworks/">Library patterns Why frameworks are evil</a></p>
<h2><span id="compile-time-versiya">Compile-time версия</span><a href="#compile-time-versiya" class="header-anchor">#</a></h2><p>F# не поддерживает произвольных compile-time вычислений, но, как и во многом другом, предлагает свой путь — <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/fsharp/tutorials/type-providers/">Type Providers</a>. Провайдеры типов предоставляют хук компилятора на запрос какого-либо типа. Т.е. тут даже не <code>Compile-Time</code>, а <code>Intellisense-Time</code> вычисления.</p>
<p>Провайдер типов должен находится в отдельной .Net-сборке, к которой будет обращаться компилятор из основной программы. Для написания и тестирования сборки с провайдерами типов лучше использовать интерактивную основную программу, а не работать из IDE, потому что сама IDE может блочить сборку с провайдером типом (для генерации всплывающих подсказок о типе). Удобно использовать <a target="_blank" rel="noopener" href="https://github.com/dotnet/interactive">Jupyter Lab</a></p>
<p><a href="/blog/4106514811/jupyter_type_provider.png"><img src="/blog/4106514811/jupyter_type_provider_small.png" alt></a><br><a target="_blank" rel="noopener" href="https://github.com/spiiin/james_bond_jr_problem/blob/main/fsharp/james_bond_jr_fsharp_typeprovider/jupyter_rate_provider.ipynb">jupyter_rate_provider.ipynb</a></p>
<p><code>Type Providers</code> бывают двух типов — <code>erased</code> создают ограниченное количество типов, а <code>generative</code> позволяют сгенерировать типы по запросу.</p>
<p>Теперь код решения задачи выглядит так:</p>
<figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">open</span><span style="color: #E6E6E6"> MyProvider2</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//создаём тип, содержащий ответ</span></span>
<span class="line"><span style="color: #569CD6">type</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">RateType</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> MyProvider2.RateProvider</span><span style="color: #569CD6">&lt;</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #CE9178">&quot;1; 2; 2; 1; 3; 4; 4; 3; 3; 4; 4; 3; 2; 4; 4; 2&quot;</span><span style="color: #569CD6">,</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #CE9178">&quot;4; 3; 4; 2; 3; 1; 2; 4; 4; 2; 4; 3; 2; 4; 3; 1&quot;</span></span>
<span class="line"><span style="color: #569CD6">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rateInstance</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> RateType</span><span style="color: #569CD6">()</span></span>
<span class="line"><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">prop</span><span style="color: #569CD6">:</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">string </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> rateInstance.Property</span><span style="color: #569CD6">;</span></span>
<span class="line"><span style="color: #E6E6E6">printfn $</span><span style="color: #CE9178">&quot;{prop}&quot;</span></span></code></pre></div></div></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/spiiin/james_bond_jr_problem/blob/main/fsharp/james_bond_jr_fsharp_typeprovider/ConsoleApp1/Program.fs">TypeProviderSolution.fs</a><br><em>F# не позволяет передать массив чисел в качестве аргумента провайдеру типов, поэтому передаётся строка</em></p>
<p>Сборка с провайдерами типов подключается только во время компиляции, сама программа теперь не нуждается в параллельных коллекциях и запуске процессов.</p>
<h2><span id="gpu-compiled-time-versiya">GPU compiled-time версия</span><a href="#gpu-compiled-time-versiya" class="header-anchor">#</a></h2><p>Можно пойти ещё дальше. Из одного провайдера типов вызвать следующий.</p>
<p>Например, провайдер типов может запросить предпросчитанные значения функции оценки для всех возможных состояний игрового поля.<br>Состояний для разных вариантов поля существует ~10-100 миллионов. Если попытаться заставить посчитать функцию оценки для каждого в провайдере типов на CPU, можно уронить компилятор (после пары минут размышлений). Но если задействовать видеокарту — рассчёт займёт около 7-8 секунд.</p>
<p>В чистом виде это больное решение, так как пришивает зависимость компиляции от видеокарты. Но позволяет взглянуть на программу под новым углом — как на конфигурируемую систему сборки самой себя. В том числе — асинхронной сборки, которая может начать рассчёты ещё во время написания программы (например, провайдер типов может запустить фоновый рассчёт на видеокарте во время объявления типа, чтобы к моменту <strong>НАЧАЛА</strong> компиляции уже иметь результат).</p>
<p>Существует несколько библиотек, которые позволяют генерировать из F#-кода код, пригодный для выполнения на GPU:</p>
<ul>
<li>зацитировать код в выражение и транспилировать его в текстовый код на языках для gpgpu</li>
<li>зацитировать код в выражение и отдать само выражение альтернативной программе</li>
<li>собрать специальную сборку с il-кодом, и разобрать его альтернативным компилятором<br><a target="_blank" rel="noopener" href="https://ilgpu.net/">ilgpu</a>, <a target="_blank" rel="noopener" href="https://developer.nvidia.com/blog/accelerate-net-applications-alea-gpu/">Alea.GPU</a>, <a target="_blank" rel="noopener" href="https://github.com/gsvgit/Brahma.FSharp">Brahma.FSharp</a>, <a target="_blank" rel="noopener" href="https://www.fshade.org/">FShade</a><br><em>правда, любой из трёх подходов требует изменений функции rate, что естественно для кода, который будет выполняться в совершенно другой среде</em></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/fsharp/language-reference/code-quotations">Code quotations</a> — цитирование выражений.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/spiiin/james_bond_jr_problem/blob/main/fsharp/james_bond_jr_fsharp_gpu/TryBrahmaFSharp.fs">BrahmaFSharp.fs</a> — proof of concept такого решения. Не удалось нормально собрать провайдер типов из-за конфликта зависимостей версий библиотеки (который скорее всего можно решить чёрной .net магией remap assemblies versions, другие провайдеры типов как-то это побеждают). Так что в виде утилиты командной строки, которую может запустить провайдер типов.</p>
<p>Функция для вычисления на gpu, без использования .net коллекций:</p>
<figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rateKernel </span><span style="color: #569CD6">(</span><span style="color: #9CDCFE">clContext</span><span style="color: #569CD6">:</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">ClContext</span><span style="color: #569CD6">)</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">workGroupSize </span><span style="color: #569CD6">=</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">kernel</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">&lt;@</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #569CD6">fun</span><span style="color: #9CDCFE"> </span><span style="color: #569CD6">(</span><span style="color: #9CDCFE">range</span><span style="color: #569CD6">:</span><span style="color: #4EC9B0"> Range1D</span><span style="color: #569CD6">)</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">(</span><span style="color: #9CDCFE">endState</span><span style="color: #569CD6">: </span><span style="color: #4EC9B0">ClArray</span><span style="color: #569CD6">&lt;</span><span style="color: #4EC9B0">int</span><span style="color: #569CD6">&gt;)</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">(</span><span style="color: #9CDCFE">packedPerms</span><span style="color: #569CD6">: </span><span style="color: #4EC9B0">ClArray</span><span style="color: #569CD6">&lt;</span><span style="color: #4EC9B0">int</span><span style="color: #569CD6">&gt;)</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">(</span><span style="color: #9CDCFE">ratings</span><span style="color: #569CD6">: </span><span style="color: #4EC9B0">ClArray</span><span style="color: #569CD6">&lt;</span><span style="color: #4EC9B0">int</span><span style="color: #569CD6">&gt;)</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">-&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">getWrapDistance a b size </span><span style="color: #569CD6">=</span></span>
<span class="line"><span style="color: #E6E6E6">                    min </span><span style="color: #569CD6">((</span><span style="color: #E6E6E6">a </span><span style="color: #569CD6">-</span><span style="color: #E6E6E6"> b </span><span style="color: #569CD6">+</span><span style="color: #E6E6E6"> size</span><span style="color: #569CD6">)</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">%</span><span style="color: #E6E6E6"> size</span><span style="color: #569CD6">)</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">((</span><span style="color: #E6E6E6">b </span><span style="color: #569CD6">-</span><span style="color: #E6E6E6"> a </span><span style="color: #569CD6">+</span><span style="color: #E6E6E6"> size</span><span style="color: #569CD6">)</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">%</span><span style="color: #E6E6E6"> size</span><span style="color: #569CD6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">unpack </span><span style="color: #569CD6">(</span><span style="color: #9CDCFE">packedValue</span><span style="color: #569CD6">:</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">int</span><span style="color: #569CD6">)</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">(</span><span style="color: #9CDCFE">output</span><span style="color: #569CD6">:</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">int</span><span style="color: #569CD6">[])</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span></span>
<span class="line"><span style="color: #E6E6E6">                    </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> i </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">to</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">15</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #E6E6E6">                        output.</span><span style="color: #569CD6">[</span><span style="color: #E6E6E6">i</span><span style="color: #569CD6">]</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">&lt;-</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">((</span><span style="color: #E6E6E6">packedValue </span><span style="color: #569CD6">&gt;&gt;&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">(</span><span style="color: #E6E6E6">i </span><span style="color: #569CD6">*</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">2</span><span style="color: #569CD6">))</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">&amp;&amp;&amp;</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0b11</span><span style="color: #569CD6">)</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #569CD6">let mutable</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">total</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">id</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> range.GlobalID0</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">baseIdx</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> id </span><span style="color: #569CD6">*</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">16</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">packedPermutation</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> packedPerms.</span><span style="color: #569CD6">[</span><span style="color: #E6E6E6">id</span><span style="color: #569CD6">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">perms</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> Array.zeroCreate </span><span style="color: #B5CEA8">16</span></span>
<span class="line"><span style="color: #E6E6E6">                unpack packedPermutation perms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> i </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">to</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">15</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #E6E6E6">                    </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> perms.</span><span style="color: #569CD6">[</span><span style="color: #E6E6E6">baseIdx </span><span style="color: #569CD6">+</span><span style="color: #E6E6E6"> i</span><span style="color: #569CD6">]</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">&lt;&gt;</span><span style="color: #E6E6E6"> endState.</span><span style="color: #569CD6">[</span><span style="color: #E6E6E6">i</span><span style="color: #569CD6">]</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">then</span></span>
<span class="line"><span style="color: #E6E6E6">                        </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">row</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> i </span><span style="color: #569CD6">/</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">4</span></span>
<span class="line"><span style="color: #E6E6E6">                        </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">col</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> i </span><span style="color: #569CD6">%</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">4</span></span>
<span class="line"><span style="color: #E6E6E6">                        </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">target</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> endState.</span><span style="color: #569CD6">[</span><span style="color: #E6E6E6">i</span><span style="color: #569CD6">]</span></span>
<span class="line"><span style="color: #E6E6E6">                        </span><span style="color: #569CD6">let mutable</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rowShifts</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">9999</span></span>
<span class="line"><span style="color: #E6E6E6">                        </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> j </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">to</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">3</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #E6E6E6">                            </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> perms.</span><span style="color: #569CD6">[</span><span style="color: #E6E6E6">baseIdx </span><span style="color: #569CD6">+</span><span style="color: #E6E6E6"> row </span><span style="color: #569CD6">*</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">4</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">+</span><span style="color: #E6E6E6"> j</span><span style="color: #569CD6">]</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> target </span><span style="color: #C586C0">then</span></span>
<span class="line"><span style="color: #E6E6E6">                                rowShifts </span><span style="color: #569CD6">&lt;-</span><span style="color: #E6E6E6"> min rowShifts </span><span style="color: #569CD6">(</span><span style="color: #E6E6E6">getWrapDistance j col </span><span style="color: #B5CEA8">4</span><span style="color: #569CD6">)</span></span>
<span class="line"><span style="color: #E6E6E6">                        </span><span style="color: #569CD6">let mutable</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">colShifts</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">9999</span></span>
<span class="line"><span style="color: #E6E6E6">                        </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> j </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">to</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">3</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #E6E6E6">                            </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> perms.</span><span style="color: #569CD6">[</span><span style="color: #E6E6E6">baseIdx </span><span style="color: #569CD6">+</span><span style="color: #E6E6E6"> j </span><span style="color: #569CD6">*</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">4</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">+</span><span style="color: #E6E6E6"> col</span><span style="color: #569CD6">]</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> target </span><span style="color: #C586C0">then</span></span>
<span class="line"><span style="color: #E6E6E6">                                colShifts </span><span style="color: #569CD6">&lt;-</span><span style="color: #E6E6E6"> min colShifts </span><span style="color: #569CD6">(</span><span style="color: #E6E6E6">getWrapDistance j row </span><span style="color: #B5CEA8">4</span><span style="color: #569CD6">)</span></span>
<span class="line"><span style="color: #E6E6E6">                        </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">shift</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span></span>
<span class="line"><span style="color: #E6E6E6">                            </span><span style="color: #C586C0">match</span><span style="color: #E6E6E6"> rowShifts</span><span style="color: #569CD6">,</span><span style="color: #E6E6E6"> colShifts </span><span style="color: #C586C0">with</span></span>
<span class="line"><span style="color: #E6E6E6">                            </span><span style="color: #569CD6">|</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">9999</span><span style="color: #569CD6">,</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">9999</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">-&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">2</span></span>
<span class="line"><span style="color: #E6E6E6">                            </span><span style="color: #569CD6">|</span><span style="color: #E6E6E6"> rs</span><span style="color: #569CD6">,</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">9999</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">-&gt;</span><span style="color: #E6E6E6"> rs</span></span>
<span class="line"><span style="color: #E6E6E6">                            </span><span style="color: #569CD6">|</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">9999</span><span style="color: #569CD6">,</span><span style="color: #E6E6E6"> cs </span><span style="color: #569CD6">-&gt;</span><span style="color: #E6E6E6"> cs</span></span>
<span class="line"><span style="color: #E6E6E6">                            </span><span style="color: #569CD6">|</span><span style="color: #E6E6E6"> rs</span><span style="color: #569CD6">,</span><span style="color: #E6E6E6"> cs </span><span style="color: #569CD6">-&gt;</span><span style="color: #E6E6E6"> min rs cs</span></span>
<span class="line"><span style="color: #E6E6E6">                        total </span><span style="color: #569CD6">&lt;-</span><span style="color: #E6E6E6"> total </span><span style="color: #569CD6">+</span><span style="color: #E6E6E6"> shift</span></span>
<span class="line"><span style="color: #E6E6E6">                ratings.</span><span style="color: #569CD6">[</span><span style="color: #E6E6E6">id</span><span style="color: #569CD6">]</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">&lt;-</span><span style="color: #E6E6E6"> total</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #569CD6">@&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    clContext.Compile kernel</span></span></code></pre></div></div></figure>
<h2><span id="vizualizaciya-resheniya">Визуализация решения</span><a href="#vizualizaciya-resheniya" class="header-anchor">#</a></h2><p>Напоследок, простая часть. Для визуализации можно использовать <a target="_blank" rel="noopener" href="https://funcui.avaloniaui.net/">FuncUI</a>, декларативную надстройку над <a target="_blank" rel="noopener" href="https://avaloniaui.net/">AvaloniaUI</a>.<br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=tUViEf8WB5M">Don Syme - Functional UI, Functional Apps</a></p>
<figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">colorIndicesList</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">..</span><span style="color: #E6E6E6">. </span><span style="color: #6A9955">//answer steps</span></span>
<span class="line"><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">currentIndex</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> ctx.useState</span><span style="color: #569CD6">(</span><span style="color: #B5CEA8">0</span><span style="color: #569CD6">)</span><span style="color: #E6E6E6"> </span><span style="color: #6A9955">//reactive binding</span></span>
<span class="line"><span style="color: #6A9955">//grid for 4x4 color rectangles</span></span>
<span class="line"><span style="color: #E6E6E6">Grid.create </span><span style="color: #569CD6">[</span></span>
<span class="line"><span style="color: #E6E6E6">    Grid.rowDefinitions </span><span style="color: #CE9178">&quot;64,64,64,64&quot;</span></span>
<span class="line"><span style="color: #E6E6E6">    Grid.columnDefinitions </span><span style="color: #CE9178">&quot;64,64,64,64&quot;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">indices</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> colorIndicesList.</span><span style="color: #569CD6">[</span><span style="color: #E6E6E6">currentIndex.Current</span><span style="color: #569CD6">]</span></span>
<span class="line"><span style="color: #E6E6E6">    Grid.children </span><span style="color: #569CD6">[</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> row </span><span style="color: #C586C0">in</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">..</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">3</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> col </span><span style="color: #C586C0">in</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">..</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">3</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">index</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> indices.</span><span style="color: #569CD6">[</span><span style="color: #E6E6E6">row </span><span style="color: #569CD6">*</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">4</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">+</span><span style="color: #E6E6E6"> col</span><span style="color: #569CD6">]</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #569CD6">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">color</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">=</span><span style="color: #E6E6E6"> colors.</span><span style="color: #569CD6">[</span><span style="color: #E6E6E6">index </span><span style="color: #569CD6">-</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1</span><span style="color: #569CD6">]</span></span>
<span class="line"><span style="color: #E6E6E6">                Rectangle.create </span><span style="color: #569CD6">[</span></span>
<span class="line"><span style="color: #E6E6E6">                    Grid.row row</span></span>
<span class="line"><span style="color: #E6E6E6">                    Grid.column col</span></span>
<span class="line"><span style="color: #E6E6E6">                    Rectangle.fill </span><span style="color: #569CD6">(</span><span style="color: #E6E6E6">SolidColorBrush</span><span style="color: #569CD6">(</span><span style="color: #E6E6E6">color</span><span style="color: #569CD6">))</span></span>
<span class="line"><span style="color: #E6E6E6">                    Rectangle.stroke </span><span style="color: #569CD6">(</span><span style="color: #E6E6E6">SolidColorBrush Colors.Black</span><span style="color: #569CD6">)</span></span>
<span class="line"><span style="color: #E6E6E6">                    Rectangle.strokeThickness </span><span style="color: #B5CEA8">4.0</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #569CD6">]</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">]</span></span>
<span class="line"><span style="color: #569CD6">]</span></span></code></pre></div></div></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/spiiin/james_bond_jr_problem/blob/main/fsharp/james_bond_jr_visualize/Program.fs">Visualize.fs</a></p>
<p><img src="/blog/4106514811/visualize_small.png" alt></p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"Ov23liG1mZbiQOIdi91X","clientSecret":"e05812685eb741a752982b89dcf6f5b58dc10251","repo":"spiiin.github.io","owner":"spiiin","admin":["spiiin"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__next" href="/blog/106426514/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div><!-- hexo injector body_end start -->
  <script>
  const CODE_CONFIG = {
    beautify: undefined,
    highlightCopy: undefined,
    highlightLang: undefined,
    highlightHeightLimit: undefined,
    isHighlightShrink: undefined,
    copy: {
      success: 'undefined',
      error: 'undefined',
      noSupport: 'undefined',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body></html>