<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | daScript: ООП и всякое</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/2629978232/">Позже</a><a class="pagination__link pagination__next" href="/blog/2975166623/">Раньше</a></div><article class="article post"><h3 class="article__title">daScript: ООП и всякое</h3><div class="article__date metadata"><div class="post-info">2023/01/12</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/dascript/">dascript</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><h1 id="Структуры"><a href="#Структуры" class="headerlink" title="Структуры"></a>Структуры</h1><h2 id="Структуры-daScript-наследование"><a href="#Структуры-daScript-наследование" class="headerlink" title="Структуры daScript, наследование"></a>Структуры daScript, наследование</h2><p><a href="https://dascript.org/doc/reference/language/structs.html#struct-declaration" target="_blank" rel="noopener">https://dascript.org/doc/reference/language/structs.html#struct-declaration</a></p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> V2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; x : </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;"> = -</span><span style="color: #b5cea8;">1.0f</span></div><div><span style="color: #d4d4d4;">&#160; &#160; y : </span><span style="color: #4ec9b0;">float</span></div><br><div><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">V3</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">V2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; z = </span><span style="color: #b5cea8;">3.0f</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> a : V3</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"a = {</span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> b = V3()</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"b = {</span><span style="color: #9cdcfe;">b</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> c = [[V3 y = </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"c = {</span><span style="color: #9cdcfe;">c</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> d = [[V3() y = </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"d = {</span><span style="color: #9cdcfe;">d</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> e = [[V3() y = </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">, x = </span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"e = {</span><span style="color: #9cdcfe;">e</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> pd = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[V3() y = </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"pd = {</span><span style="color: #9cdcfe;">pd</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #6a9955;">//Output:</span></div><div><span style="color: #d4d4d4;">a = [[ </span><span style="color: #b5cea8;">0.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">0.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">0.000000000</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">b = [[ -</span><span style="color: #b5cea8;">1.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">0.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">3.000000000</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">c = [[ </span><span style="color: #b5cea8;">0.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">2.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">0.000000000</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">d = [[ -</span><span style="color: #b5cea8;">1.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">2.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">3.000000000</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">e = [[ </span><span style="color: #b5cea8;">1.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">2.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">3.000000000</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">pd = [[ -</span><span style="color: #b5cea8;">1.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">2.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">3.000000000</span><span style="color: #d4d4d4;">]]</span></div></div>
<p>a,b,c,d,e - структуры, размещенные на стеке. В зависимости от способа объявления можно пропускать инициализацию полей по умолчанию — круглые скобки в объявлении добавляют код инициализации (в порядке от родительской структуры к дочерним). Синтаксис с квадратными скобками позволяет изменить значения отдельных полей. Неинициализированные явно или по умолчанию поля инициализируются нулями — получить в качестве значений неинициализированный мусор нельзя.</p>
<p>Ещё несколько примеров комбинаций синтаксиса инициализации, в первом случае создаётся структура, во втором — массив структур, в третьем — итератор<br><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #6a9955;">//where clause: post init function</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> f = [[V3 </span><span style="color: #c586c0;">where</span><span style="color: #d4d4d4;"> </span><span style="color: #569cd6;">$</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">self</span><span style="color: #d4d4d4;">) {</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; self.x = </span><span style="color: #b5cea8;">11.0f</span><span style="color: #d4d4d4;">;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; self.y = </span><span style="color: #b5cea8;">11.0f</span><span style="color: #d4d4d4;">;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; self.z = </span><span style="color: #b5cea8;">11.0f</span><span style="color: #d4d4d4;">;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; }]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//array initialization, g_arr: V3[2]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> g_arr = [[V3 </span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; x=</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, y=</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, z=</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; x=</span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">, y=</span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">, z=</span><span style="color: #b5cea8;">2.0f</span></div><div><span style="color: #d4d4d4;">&#160; &#160; ]]</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//array comprehesion, h_arr : iterator&lt;V3&gt;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> h_iter &lt;- [[ </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> i </span><span style="color: #c586c0;">in</span><span style="color: #d4d4d4;"> range(</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">10</span><span style="color: #d4d4d4;">); [[V3 x=float(i), y=float(i), z=float(i)]]; </span><span style="color: #c586c0;">where</span><span style="color: #d4d4d4;"> (i&amp;</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">)==</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;"> ]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> g_iter &lt;- [[ </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> i </span><span style="color: #c586c0;">in</span><span style="color: #d4d4d4;"> range(</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">10</span><span style="color: #d4d4d4;">); </span><span style="color: #dcdcaa;">invoke</span><span style="color: #d4d4d4;">({ </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">fi</span><span style="color: #d4d4d4;"> = float(i); </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> [[V3 x=fi, </span><span style="color: #9cdcfe;">y</span><span style="color: #d4d4d4;">=fi, </span><span style="color: #9cdcfe;">z</span><span style="color: #d4d4d4;">=fi]]; }); </span><span style="color: #c586c0;">where</span><span style="color: #d4d4d4;"> (i&amp;</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">)==</span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;"> ]] </span><span style="color: #6a9955;">// same</span></div></div></p>
<p>pd - указатель на структуру, размещенную в куче. Сама структура может быть инициализирована любым из перечисленных выше способов.</p>
<h2 id="Финализаторы"><a href="#Финализаторы" class="headerlink" title="Финализаторы"></a>Финализаторы</h2><p><a href="https://dascript.org/doc/reference/language/finalizers.html#finalizers" target="_blank" rel="noopener">https://dascript.org/doc/reference/language/finalizers.html#finalizers</a></p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> d = [[V3() y = </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"d = {</span><span style="color: #9cdcfe;">d</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">delete</span><span style="color: #d4d4d4;"> d</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"d = {</span><span style="color: #9cdcfe;">d</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> pd = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[V3() y = </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"pd = {</span><span style="color: #9cdcfe;">pd</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">unsafe</span><span style="color: #d4d4d4;"> { </span><span style="color: #c586c0;">delete</span><span style="color: #d4d4d4;"> pd; }</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"pd = {</span><span style="color: #9cdcfe;">pd</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//Output</span></div><div><span style="color: #d4d4d4;">&#160; &#160; d = [[ -</span><span style="color: #b5cea8;">1.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">2.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">3.000000000</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; d = [[ </span><span style="color: #b5cea8;">0.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">0.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">0.000000000</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; pd = [[ -</span><span style="color: #b5cea8;">1.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">2.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">3.000000000</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; pd = </span><span style="color: #c586c0;">null</span></div></div>
<p>Финализатор по умолчанию для структуры зануляет память (в порядке от потомков к родителям, при необходимости зовёт финализаторы для членов структуры в порядке объявления). Для указателей — после зануления полей структуры дополнительно меняет адрес указателя на null. Финализаторы для структур и классов зовутся вручную. Финализаторы не освобождают память, на которую указывает объект.</p>
<h2 id="Освобождение-памяти"><a href="#Освобождение-памяти" class="headerlink" title="Освобождение памяти"></a>Освобождение памяти</h2><p>Модель памяти по умолчанию в daScript не подразумевает очистки памяти в ходе выполнения скрипта, за очистку отвечает хост-приложение, которое может просто освободить всю память контекста целиком — пересоздание контекстов by design быстро и эффективно, так что такой способ предпочтительный.</p>
<p>Но можно настроить поведение контекста опцией <code>persistent_heap</code>:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">options</span><span style="color: #d4d4d4;"> persistent_heap = </span><span style="color: #c586c0;">true</span></div><br><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> pd = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[V3() y = </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> pd2 = pd</span></div><div><span style="color: #c586c0;">unsafe</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"addr(pd) = {</span><span style="color: #c586c0;">reinterpret</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">uint</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">pd</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"addr(pd2) = {</span><span style="color: #c586c0;">reinterpret</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">uint</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">pd2</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">delete</span><span style="color: #d4d4d4;"> pd</span></div><div><span style="color: #d4d4d4;">pd2.x = </span><span style="color: #b5cea8;">33.0f</span></div><div><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"pd2 = {</span><span style="color: #9cdcfe;">pd2</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #6a9955;">//Output</span></div><div><span style="color: #c586c0;">addr</span><span style="color: #d4d4d4;">(pd) = </span><span style="color: #b5cea8;">0xf1909e10</span></div><div><span style="color: #c586c0;">addr</span><span style="color: #d4d4d4;">(pd2) = </span><span style="color: #b5cea8;">0xf1909e10</span></div><div><span style="color: #d4d4d4;">pd2 = [[ </span><span style="color: #b5cea8;">33.000000000</span><span style="color: #d4d4d4;">; -</span><span style="color: #b5cea8;">431602080.000000000</span><span style="color: #d4d4d4;">; -</span><span style="color: #b5cea8;">431602080.000000000</span><span style="color: #d4d4d4;">]] </span><span style="color: #6a9955;">//мусор</span></div></div>
<p>Я включил опцию <code>DAS_SANITIZER</code> при сборке daScript, чтобы после освобождения объектов в случае с persistent_heap память перезаписывалась мусорными значениями (0xCD, -431602080 если интерпретировать 0xCDCDCDCD как float-значение). В данном случае программа по счастливому стечению обстоятельств не упала, но благодаря санитайзеру видно, что указатель pd2 после удаления pd стал висячим — указывает на свободную память, которая могла бы быть выделена другому объекту (объекту daScript того же контекста в случае <code>persistent_heap=false</code>, или любому другому объекту хост-приложения с <code>persistent_heap=true</code>).</p>
<p>Более “злобный” вариант примера:<br><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> pd = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[V3() y = </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> pd2 = pd</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">unsafe</span><span style="color: #d4d4d4;"> { </span><span style="color: #c586c0;">delete</span><span style="color: #d4d4d4;"> pd; }</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> pd3 = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[V3() x = </span><span style="color: #b5cea8;">33.0f</span><span style="color: #d4d4d4;">, y = </span><span style="color: #b5cea8;">33.0f</span><span style="color: #d4d4d4;">, z = </span><span style="color: #b5cea8;">33.0f</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; pd2.x = -</span><span style="color: #b5cea8;">100.0f</span><span style="color: #d4d4d4;"> </span><span style="color: #6a9955;">// &lt;----- kaboom!</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"pd2 = {</span><span style="color: #9cdcfe;">pd2</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"pd3 = {</span><span style="color: #9cdcfe;">pd3</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//Output</span></div><div><span style="color: #d4d4d4;">&#160; &#160; pd2 = [[ -</span><span style="color: #b5cea8;">100.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">33.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">33.000000000</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; pd3 = [[ -</span><span style="color: #b5cea8;">100.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">33.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">33.000000000</span><span style="color: #d4d4d4;">]]</span></div></div><br>После освобождения память на которую указывали pd и pd2 была повторно отдана новому объекту, на который указывает pd3. Этот объект теперь может поменяться через указатель pd2. Должно быть понятно, насколько unsafe операция удаления — код стал насколько же опасным (но и настолько же быстрым), как и код на языке си.</p>
<h2 id="Кастомные-финализаторы"><a href="#Кастомные-финализаторы" class="headerlink" title="Кастомные финализаторы"></a>Кастомные финализаторы</h2><p>Финализатор можно переопределить, пример: финализатор для структуры V2</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">finalize</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">v </span><span style="color: #d4d4d4;">: V2)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"kill V2 {</span><span style="color: #9cdcfe;">v</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> d = [[ V3 x = </span><span style="color: #b5cea8;">11.0f</span><span style="color: #d4d4d4;">, y = </span><span style="color: #b5cea8;">22.0f</span><span style="color: #d4d4d4;">, z = </span><span style="color: #b5cea8;">33.0f</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #c586c0;">delete</span><span style="color: #d4d4d4;"> d</span></div><div><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"d = {</span><span style="color: #9cdcfe;">d</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #6a9955;">//Output</span></div><div><span style="color: #d4d4d4;">kill V2 [[ </span><span style="color: #b5cea8;">11.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">22.000000000</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">d = [[ </span><span style="color: #b5cea8;">11.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">22.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">33.000000000</span><span style="color: #d4d4d4;">]]</span></div></div>
<p>Вместо финализатора зануления по умолчанию вызывается функция, логгирующая поле. Также можно заметить неочевидную вещь (если думать о финализаторах как о деструкторах, но лучше не думать) — финализаторы не зовутся в порядке от потомков к предкам, а как работают как обычные функции, daScript нашёл подходящую функцию, принимающую тип V2, и не вызвал зануления также и у поля z - т.е. финализатор родительской структуры “подошёл” к дочерней.</p>
<p>Более похожий на порядок вызова деструкторов в C/C++ код<br><blockquote><p>(<strong>ещё раз, финализаторы — это не деструкторы, они вызываются только при явном вызове оператора delete!</strong>)</p>
</blockquote></p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">finalize</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">v </span><span style="color: #d4d4d4;">: V2 </span><span style="color: #c586c0;">explicit</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"kill V2 {</span><span style="color: #9cdcfe;">v</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">finalize</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">v </span><span style="color: #d4d4d4;">: V3 </span><span style="color: #c586c0;">explicit</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; finalize(</span><span style="color: #c586c0;">cast</span><span style="color: #d4d4d4;">&lt;V2&gt; v)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"kill V3 {</span><span style="color: #9cdcfe;">v</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> d = [[ V3 x = </span><span style="color: #b5cea8;">11.0f</span><span style="color: #d4d4d4;">, y = </span><span style="color: #b5cea8;">22.0f</span><span style="color: #d4d4d4;">, z = </span><span style="color: #b5cea8;">33.0f</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">delete</span><span style="color: #d4d4d4;"> d</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"d = {</span><span style="color: #9cdcfe;">d</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #6a9955;">//Output</span></div><div><span style="color: #d4d4d4;">kill V2 [[ </span><span style="color: #b5cea8;">11.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">22.000000000</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">kill V3 [[ </span><span style="color: #b5cea8;">11.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">22.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">33.000000000</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #d4d4d4;">d = [[ </span><span style="color: #b5cea8;">11.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">22.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">33.000000000</span><span style="color: #d4d4d4;">]]</span></div></div>
<p>daScript не позволяет каст к дочерним типам <code>explicit</code>-аргументов.</p>
<p>Вместо перегрузки <code>finalize</code> можно перегрузить <code>def operator delete(var v : V2 explicit)</code> — семантически более точно описывает, что для структур код финализатора будет вызван только в момент явного вызова оператора <code>delete</code>.</p>
<h2 id="Методы"><a href="#Методы" class="headerlink" title="Методы"></a>Методы</h2><p>Методы не могут быть объявлены при объявлении структур, но структуры могут хранить указатели на функции</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> V2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; x : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; y : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; set = @@set</span></div><br><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a = V2()</span></div><div><span style="color: #d4d4d4;">a |&gt; set(</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">//call function via pipe syntax</span></div><div><span style="color: #dcdcaa;">invoke</span><span style="color: #d4d4d4;">(a.set, a, </span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">) &#160;</span><span style="color: #6a9955;">// exactly same thing as above</span></div><div><span style="color: #d4d4d4;">a-&gt;set(</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">) &#160;</span><span style="color: #6a9955;">// this one can call something else, if overridden in derived class.</span></div></div>
<p>Потомок может переопределить функцию</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> V2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; x : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; y : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; set = @@set</span></div><div><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">V3</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">V2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; z : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">override</span><span style="color: #d4d4d4;"> set = </span><span style="color: #c586c0;">cast</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;">&gt; @@set_v3</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">set</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">thisV</span><span style="color: #d4d4d4;">: V2; </span><span style="color: #9cdcfe;">X, Y</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">with</span><span style="color: #d4d4d4;"> thisV</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; x = X</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; y = Y</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">set_v3</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">thisV</span><span style="color: #d4d4d4;">: V3; </span><span style="color: #9cdcfe;">X, Y</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; set(</span><span style="color: #c586c0;">cast</span><span style="color: #d4d4d4;">&lt;V2&gt; thisV, X, Y)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">with</span><span style="color: #d4d4d4;"> thisV</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; z = </span><span style="color: #b5cea8;">3.0f</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a = V3()</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a |&gt; set_v3(</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">//non virtual call</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">invoke</span><span style="color: #d4d4d4;">(a.set, a, </span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">) &#160;</span><span style="color: #6a9955;">// exactly same thing as above</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a-&gt;set(</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">) &#160;</span><span style="color: #6a9955;">// this one can call something else, if overridden in derived class.</span></div></div>
<p>(<a href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/test/unit_tests/override.das" target="_blank" rel="noopener">https://github.com/GaijinEntertainment/daScript/blob/master/examples/test/unit_tests/override.das</a>)</p>
<p>daScript позволяет создать две перегрузки функции set (а не определять дополнительное имя <code>set_v3</code>), принимающие V2 и V3, тогда можно переписать пример без использования дополнительного имени, с уточнением типа функции set перед кастом и последующим автоматическим приведением этого указателя к правильному типу, определённому в V2:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> V2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; x : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; y : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; set = @@&lt;(</span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> thisV: V2; X, Y: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">):</span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;">&gt; set</span></div><div><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">V3</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">V2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; z : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">override</span><span style="color: #d4d4d4;"> set = </span><span style="color: #c586c0;">cast</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">auto</span><span style="color: #d4d4d4;">&gt; @@&lt;(</span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> thisV: V3; X, Y: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">):</span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;">&gt; set </span><span style="color: #6a9955;">//&lt;------ cast</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">set</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">thisV</span><span style="color: #d4d4d4;">: V2 </span><span style="color: #c586c0;">explicit</span><span style="color: #d4d4d4;">; </span><span style="color: #9cdcfe;">X, Y</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">with</span><span style="color: #d4d4d4;"> thisV</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; x = X</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; y = Y</span></div><br><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">set</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">var</span><span style="color: #d4d4d4;"> </span><span style="color: #9cdcfe;">thisV</span><span style="color: #d4d4d4;">: V3; </span><span style="color: #9cdcfe;">X, Y</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; set(</span><span style="color: #c586c0;">cast</span><span style="color: #d4d4d4;">&lt;V2&gt; thisV, X, Y)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">with</span><span style="color: #d4d4d4;"> thisV</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; z = </span><span style="color: #b5cea8;">3.0f</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a = V3()</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a |&gt; set(</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">//virtual call</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">invoke</span><span style="color: #d4d4d4;">(a.set, a, </span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">) &#160;</span><span style="color: #6a9955;">// exactly same thing as above</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a-&gt;set(</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div></div>
<p>Здесь <code>explicit</code> в первом объявлении свободной функции <code>set</code> позволяет сделать некоторую магию — несмотря на то, что эта функция “пропускает” только указатели на V2, это позволяет однозначно выделить эту функцию в приведении <code>set = @@&lt;(var thisV: V2; X, Y: float):void&gt; set</code> среди двух прегруженных (иначе возникла бы неоднозначность — обе приводились бы с одинаковым приоритетом, и daScript выдавал бы ошибку). Но при этом сигнатура функции <code>V2&#39;set</code> уже не содержит этого <code>explicit</code> (её тип выводится автоматически по правой части выражения, где явно указана сигнатура без <code>explicit</code>). Таким образом <code>V2&#39;set</code> работает как виртуальная функция — может принимать первым аргументом как <code>V2</code>, так и её потомков, которые не переопределили функцию.</p>
<h1 id="Классы"><a href="#Классы" class="headerlink" title="Классы"></a>Классы</h1><p><a href="https://dascript.org/doc/reference/language/classes.html#classes" target="_blank" rel="noopener">https://dascript.org/doc/reference/language/classes.html#classes</a></p>
<p>Классы в daScript — это структуры “на стероидах”. Немного отличий:</p>
<ul>
<li>Класс может быть отнаследован от структуры, но структура не может быть унаследована от класса (связано с тем, что классы могут иметь инициализаторы)</li>
<li>Объявление локального класса на стеке небезопасно (требует явного unsafe)</li>
</ul>
<p>Методы <a href="https://dascript.org/doc/reference/language/structs.html#structure-function-members" target="_blank" rel="noopener">реализованы</a> как указатели на функции, но с возможностью объявлять их в теле класса и переопределять с помощью ключевого слова <code>override</code> без явного каста типа метода, как было со структурами</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> V2</span><br><span class="line">    x : float</span><br><span class="line">    y : float</span><br><span class="line">    def set(X, Y: float)</span><br><span class="line">        x = X</span><br><span class="line">        y = Y</span><br><span class="line"><span class="keyword">class</span> V3: V2</span><br><span class="line">    z : float</span><br><span class="line">    def <span class="keyword">override</span> set(X, Y: float)</span><br><span class="line">        V2`set(self, X, Y)</span><br><span class="line">        z = <span class="number">3.0</span>f</span><br><span class="line"></span><br><span class="line">[export]</span><br><span class="line">def main</span><br><span class="line">    var a = <span class="keyword">new</span> V3()</span><br><span class="line">    a-&gt;set(<span class="number">1.0</span>f, <span class="number">2.0</span>f) <span class="comment">//V3`set(*a, 1.0f, 2.0f)</span></span><br><span class="line">    print(<span class="string">"a = &#123;a&#125;\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Output</span></span><br><span class="line">a = [[ 0x29990d19b90; V3'__finalize/*V3'__finalize S&lt;::V3&gt;*/; 1.000000000; 2.000000000; V3`set/*V3`set S&lt;::V3&gt; Cf Cf*/; 3.000000000]]</span><br></pre></td></tr></table></figure>
<p>Можно заметить, что имя объявленной внутри класса-функции манглится с помощью префикса-имени класса (<code>set -&gt; V2&#39;set</code>). Также внутри метода доступен указатель <code>self</code>, неявно передаваемый первым аргументов в методы класса.</p>
<p>Стоит более детально рассмотреть вывод результата.</p>
<h2 id="Порядок-полей-объекта-в-памяти"><a href="#Порядок-полей-объекта-в-памяти" class="headerlink" title="Порядок полей объекта в памяти"></a>Порядок полей объекта в памяти</h2><p><a href="https://dascript.org/doc/reference/language/classes.html#implementation-details" target="_blank" rel="noopener">https://dascript.org/doc/reference/language/classes.html#implementation-details</a></p>
<p>Содержимое <code>a</code>:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a &#x3D; [[</span><br><span class="line">    0x29990d19b90; &#x2F;&#x2F;указатель на rtti информацию</span><br><span class="line">    V3&#39;__finalize&#x2F;*V3&#39;__finalize S&lt;::V3&gt;*&#x2F;;  &#x2F;&#x2F;указатель на функцию-финализатор</span><br><span class="line">    1.000000000; &#x2F;&#x2F;x</span><br><span class="line">    2.000000000; &#x2F;&#x2F;y</span><br><span class="line">    V3&#96;set&#x2F;*V3&#96;set S&lt;::V3&gt; Cf Cf*&#x2F;; &#x2F;&#x2F;указатель на виртуальную функцию set</span><br><span class="line">    3.000000000 &#x2F;&#x2F;z</span><br><span class="line">]]</span><br></pre></td></tr></table></figure></p>
<p>Комментарии после имён функций — замангленное имя функции и её сигнатуры (аргументы и результаты). </p>
<blockquote><p>Расположение в памяти серьёзно отличается от C++ — указатели на виртуальные функции хранятся не в отдельной таблице (vtable), а в каждом объекте класса в том порядке, в котором были объявлены функции. Это позволяет убрать один уровень индирекции при вызове функций (не нужно идти за адресом в виртуальную таблицу) и изменять адреса функций динамически для каждого отдельного объекта, но увеличивает расходы памяти на хранение указателей, и также может повлиять на выравнивание и padding между полями.</p>
</blockquote>
<p>Тем не менее, для модификации порядка данных структур возможно написать собственный макрос, который будет хранить функции в самостоятельно сгенерированной таблице или выносить указатели на функции в конец структуры.<br><a href="/blog/1547564887/" title="daScript macro">daScript macro</a> — пример макроса перестановки порядка полей при определении структур</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">class</span><span style="color: #d4d4d4;"> V2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; x : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; y : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">set</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">X, Y</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; x = X</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; y = Y</span></div><div><span style="color: #569cd6;">class</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">V3</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">V2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; z : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">def override</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">set</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">X, Y</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; V2`set(self, X, Y)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; z = </span><span style="color: #b5cea8;">3.0f</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> V3()</span></div><div><span style="color: #d4d4d4;">&#160; &#160; a-&gt;set(</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">) </span><span style="color: #6a9955;">//V3`set(*a, 1.0f, 2.0f)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"a = {</span><span style="color: #9cdcfe;">a</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><br><div><span style="color: #6a9955;">//Output</span></div><div><span style="color: #d4d4d4;">a = [[ </span><span style="color: #b5cea8;">0x29990d19b90</span><span style="color: #d4d4d4;">; V3</span><span style="color: #ce9178;">'__finalize/*V3'</span><span style="color: #d4d4d4;">__finalize S&lt;::V3&gt;*/; </span><span style="color: #b5cea8;">1.000000000</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">2.000000000</span><span style="color: #d4d4d4;">; V3`set</span><span style="color: #6a9955;">/*V3`set S&lt;::V3&gt; Cf Cf*/</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">3.000000000</span><span style="color: #d4d4d4;">]]</span></div></div>
<p>Существует также макрос <code>[cpp_layout]</code>, который не меняет порядок членов класса/структуры, но добавляет дополнительное правило выравнивания, как делают С/C++ — в конце родительской структуры будет оставлено пространство для её выравнивания по максимальному выравниванию членов структуры — например, если добавить в конце V2 поле на 4 байта <code>padding: uint8[4]</code>, то из-за выравнивания структуры в 8 байт (из-за указателей на 64-битной платформе), поле z, будет добавлено с отступом в 8 байт (без макроса daScript без проблем “встраивает” это поле сразу за 4-байтным отступом).</p>
<h2 id="Переопределение-метода-в-экземпляре-класса"><a href="#Переопределение-метода-в-экземпляре-класса" class="headerlink" title="Переопределение метода в экземпляре класса"></a>Переопределение метода в экземпляре класса</h2><p>Как было замеченно выше, каждый экземпляр класса/структуры хранит собственные копии указателей на функции, так что можно переопределить метод не на уровне класса-потомка, а в экземпляре класса (в пост-инициализаторе, или в любой момент после создания):<br><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">unsafe</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span></div><div><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">sizeof(a) = {</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">sizeof</span><span style="color: #ce9178;"> </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">V3</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span></div><div><span style="color: #ce9178;">offset __rtti &#160; &#160; &#160;= {</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">offsetof</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">__rtti</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;"> </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">V3</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">)} {</span><span style="color: #c586c0;">reinterpret</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">uint</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;"> &#160;</span><span style="color: #c586c0;">addr</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">__rtti</span><span style="color: #ce9178;">)} </span></div><div><span style="color: #ce9178;">offset __finalize &#160;= {</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">offsetof</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">__finalize</span><span style="color: #ce9178;"> </span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;"> </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">V3</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">)} {</span><span style="color: #c586c0;">reinterpret</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">uint</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;"> &#160;</span><span style="color: #c586c0;">addr</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">__finalize</span><span style="color: #ce9178;"> )} </span></div><div><span style="color: #ce9178;">offset x &#160; &#160; &#160; &#160; &#160; = {</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">offsetof</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">x</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;"> </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">V3</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">)} {</span><span style="color: #c586c0;">reinterpret</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">uint</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;"> &#160;</span><span style="color: #c586c0;">addr</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">x</span><span style="color: #ce9178;">)}</span></div><div><span style="color: #ce9178;">offset y &#160; &#160; &#160; &#160; &#160; = {</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">offsetof</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">y</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;"> </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">V3</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">)} {</span><span style="color: #c586c0;">reinterpret</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">uint</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;"> </span><span style="color: #c586c0;">addr</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">y</span><span style="color: #ce9178;">)}</span></div><div><span style="color: #ce9178;">offset set &#160; &#160; &#160; &#160; = {</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">offsetof</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">set</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;"> </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">V3</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">)} {</span><span style="color: #c586c0;">reinterpret</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">uint</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;"> </span><span style="color: #c586c0;">addr</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">set</span><span style="color: #ce9178;">)}</span></div><div><span style="color: #ce9178;">offset z &#160; &#160; &#160; &#160; &#160; = {</span><span style="color: #c586c0;">typeinfo</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">offsetof</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">z</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;"> </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #9cdcfe;">V3</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;">)} {</span><span style="color: #c586c0;">reinterpret</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">uint</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #ce9178;"> </span><span style="color: #c586c0;">addr</span><span style="color: #ce9178;">(</span><span style="color: #9cdcfe;">a</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">z</span><span style="color: #ce9178;">)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; )</span></div><div><span style="color: #d4d4d4;">Output:</span></div><div><span style="color: #d4d4d4;">sizeof(a) = </span><span style="color: #b5cea8;">40</span></div><div><span style="color: #d4d4d4;">offset __rtti &#160; &#160; &#160;= </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;"> &#160;</span><span style="color: #b5cea8;">0x4adb5f80</span></div><div><span style="color: #d4d4d4;">offset __finalize &#160;= </span><span style="color: #b5cea8;">8</span><span style="color: #d4d4d4;"> &#160;</span><span style="color: #b5cea8;">0x4adb5f88</span></div><div><span style="color: #d4d4d4;">offset x &#160; &#160; &#160; &#160; &#160; = </span><span style="color: #b5cea8;">16</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0x4adb5f90</span></div><div><span style="color: #d4d4d4;">offset y &#160; &#160; &#160; &#160; &#160; = </span><span style="color: #b5cea8;">20</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0x4adb5f94</span></div><div><span style="color: #d4d4d4;">offset set1 &#160; &#160; &#160; &#160;= </span><span style="color: #b5cea8;">24</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0x4adb5f98</span></div><div><span style="color: #d4d4d4;">offset z &#160; &#160; &#160; &#160; &#160; = </span><span style="color: #b5cea8;">32</span><span style="color: #d4d4d4;"> </span><span style="color: #b5cea8;">0x4adb5fa0</span></div></div><br><em>(более практичное применение этого — паттерны типа event/callback)</em></p>
<h2 id="RTTI"><a href="#RTTI" class="headerlink" title="RTTI"></a>RTTI</h2><p><a href="https://github.com/GaijinEntertainment/daScript/blob/f050f7f9a4aaaac75e454834663389c9d8ebd343/examples/test/unit_tests/reflection.das#L110" target="_blank" rel="noopener">https://github.com/GaijinEntertainment/daScript/blob/f050f7f9a4aaaac75e454834663389c9d8ebd343/examples/test/unit_tests/reflection.das#L110</a></p>
<p>Пример вывода на экран информации о типе в runtime:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">class</span><span style="color: #d4d4d4;"> V2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; x : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; y : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">set</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">X, Y</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; x = X</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; y = Y</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> fn &lt;- @@ &lt;| ( a : </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> )</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> a </span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">unsafe</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//inplace init syntax</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> v_customset = [[ V2() </span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; set &lt;- @@ (</span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> self : V2; X,Y : </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">) {</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; self.x = X * </span><span style="color: #b5cea8;">100.0f</span><span style="color: #d4d4d4;">;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; self.y = Y * </span><span style="color: #b5cea8;">100.0f</span><span style="color: #d4d4d4;">;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; }</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; ]]</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; v_customset-&gt;set(</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">v_customset</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">x</span><span style="color: #ce9178;">}, {</span><span style="color: #9cdcfe;">v_customset</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">y</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//Output: 100.000000000, 200.000000000</span></div><br><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//reset after construction, pipe + block syntax</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; v_customset.set = @@ &lt;| (</span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> self : V2; X,Y : </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; self.x = X * </span><span style="color: #b5cea8;">200.0f</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; self.y = Y * </span><span style="color: #b5cea8;">200.0f</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">v_customset</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">x</span><span style="color: #ce9178;">}, {</span><span style="color: #9cdcfe;">v_customset</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">y</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//Output: 200.000000000, 400.000000000</span></div></div>
<p>Доступна информация о названиях и типах полей, а также мета-информация (<a href="https://dascript.org/doc/stdlib/rtti.html?highlight=rtti#alias-structinfoflags" target="_blank" rel="noopener">флаги</a> класс/структура, выделена на стеке/хипе, аннотации и т.п.).</p>
<p>Для того, чтобы передать и распознать аннотации, необходимо включить опцию <code>options rtti=true</code> (в противном случае, метаинформация о произвольных аннотациях выбрасывается после симуляции, <a href="https://github.com/GaijinEntertainment/daScript/wiki/options" target="_blank" rel="noopener">линк</a>). Пример:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> rtti</span></div><div><span style="color: #d4d4d4;">...</span></div><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> V3()</span></div><div><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"class_info(a): {class_info(a)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">) </span></div><div><span style="color: #d4d4d4;">describeStructure(*class_info(a))</span></div><div><span style="color: #6a9955;">//Output:</span></div><div><span style="color: #6a9955;">//https://dascript.org/doc/stdlib/rtti.html?highlight=rtti#StructInfo</span></div><div><span style="color: #d4d4d4;">class_info(a): [[ </span><span style="color: #b5cea8;">0x6</span><span style="color: #d4d4d4;">; V3; ; (_class|heapGC); </span><span style="color: #b5cea8;">0x28</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">0x93b8d07b5cc8cee</span><span style="color: #d4d4d4;">; </span><span style="color: #b5cea8;">0xcf51414d2d20b41e</span><span style="color: #d4d4d4;">]]</span></div><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> V3</span></div><div><span style="color: #d4d4d4;">&#160; &#160; __rtti : </span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;">?</span></div><div><span style="color: #d4d4d4;">&#160; &#160; __finalize : </span><span style="color: #4ec9b0;">function</span><span style="color: #d4d4d4;">&lt;(V2):</span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;">&gt;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; x : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; y : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; set1 : </span><span style="color: #4ec9b0;">function</span><span style="color: #d4d4d4;">&lt;(V2;</span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;">;</span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;">):</span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;">&gt;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; z : </span><span style="color: #4ec9b0;">float</span></div></div>
<p><a href="https://gist.github.com/spiiin/961974938919cc9233bacf0bb5c71cd1" target="_blank" rel="noopener">Полный пример</a></p>
<h2 id="Abstract-и-sealed-методы"><a href="#Abstract-и-sealed-методы" class="headerlink" title="Abstract и sealed-методы"></a>Abstract и sealed-методы</h2><p>Методы можно сделать абстрактыми, или закрытыми для переопределения</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">options</span><span style="color: #d4d4d4;"> rtti=</span><span style="color: #c586c0;">true</span></div><div><span style="color: #d4d4d4;">...</span></div><div><span style="color: #569cd6;">class</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">V3</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">V2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; [[test]] z : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">...</span></div><div><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">describeStructure</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">sinfo</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> anyAnn = </span><span style="color: #c586c0;">false</span></div><div><span style="color: #d4d4d4;">&#160; &#160; structure_for_each_annotation(sinfo) &lt;| </span><span style="color: #569cd6;">$</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">ann</span><span style="color: #d4d4d4;">; </span><span style="color: #9cdcfe;">annArgs</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> argT = join([</span><span style="color: #569cd6;">{for</span><span style="color: #d4d4d4;"> arg in annArgs; </span><span style="color: #ce9178;">"{</span><span style="color: #9cdcfe;">arg</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">name</span><span style="color: #ce9178;">}{describeValue(get_annotation_argument_value(arg))}"</span><span style="color: #d4d4d4;">}],</span><span style="color: #ce9178;">","</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"[{</span><span style="color: #9cdcfe;">ann</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">name</span><span style="color: #ce9178;">}({</span><span style="color: #9cdcfe;">argT</span><span style="color: #ce9178;">})]</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"struct {</span><span style="color: #9cdcfe;">sinfo</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">name</span><span style="color: #ce9178;">}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> sfield </span><span style="color: #c586c0;">in</span><span style="color: #d4d4d4;"> sinfo</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> sfield.annotation_arguments != </span><span style="color: #c586c0;">null</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">for</span><span style="color: #d4d4d4;"> arg </span><span style="color: #c586c0;">in</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">deref</span><span style="color: #d4d4d4;">(sfield.annotation_arguments)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\t</span><span style="color: #ce9178;">[[{</span><span style="color: #9cdcfe;">arg</span><span style="color: #d4d4d4;">.</span><span style="color: #9cdcfe;">name</span><span style="color: #ce9178;">}]] "</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; describeVariable(sfield,</span><span style="color: #ce9178;">"</span><span style="color: #d7ba7d;">\t</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">...</span></div><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> V3()</span></div><div><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"class_info(a): {class_info(a)}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">describeStructure(*class_info(a))</span></div><br><div><span style="color: #6a9955;">//Output:</span></div><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> V3</span></div><div><span style="color: #d4d4d4;">&#160; &#160; __rtti : </span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;">?</span></div><div><span style="color: #d4d4d4;">&#160; &#160; __finalize : </span><span style="color: #4ec9b0;">function</span><span style="color: #d4d4d4;">&lt;(V2):</span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;">&gt;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; x : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; y : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; set1 : </span><span style="color: #4ec9b0;">function</span><span style="color: #d4d4d4;">&lt;(V2;</span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;">;</span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;">):</span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;">&gt;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; [[test]] z : </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;"> </span><span style="color: #6a9955;">//&lt;-- аннотация test</span></div></div>
<h2 id="Видимость"><a href="#Видимость" class="headerlink" title="Видимость"></a>Видимость</h2><ul>
<li>Из модуля экспортируются функции с аннотацией [export]</li>
</ul>
<p><code>options always_export_initializer=true</code> позволяет проставить аннотацию для всех инициализаторов на уровне модуля</p>
<ul>
<li><code>private</code> для переменных и типов ограничивает их доступность из других модулей</li>
</ul>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">class</span><span style="color: #d4d4d4;"> Test</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">def abstract</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">setX</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">X</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">): </span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;"> </span><span style="color: #6a9955;">//необходимо явно определить сигнатуру метода -- тип аргументов и результата</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">sealed</span><span style="color: #d4d4d4;"> setY(Y: </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">) &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//метод нельзя переопределить в потомках</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">pass</span></div></div>
<p>Приватными могут быть также поля и функции структур/классов</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #6a9955;">//module1.das</span></div><div><span style="color: #c586c0;">module</span><span style="color: #d4d4d4;"> module1</span></div><br><div><span style="color: #c586c0;">class</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">private</span><span style="color: #d4d4d4;"> V1</span></div><div><span style="color: #d4d4d4;">&#160; &#160; w : </span><span style="color: #4ec9b0;">float</span></div><br><div><span style="color: #c586c0;">class</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">private</span><span style="color: #d4d4d4;"> V2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; x : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; y : </span><span style="color: #4ec9b0;">float</span></div><br><div><span style="color: #569cd6;">class</span><span style="color: #d4d4d4;"> public </span><span style="color: #4ec9b0;">V3</span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">V2</span></div><div><span style="color: #d4d4d4;">&#160; &#160; v1 : V1</span></div><div><span style="color: #d4d4d4;">&#160; &#160; z : </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;"> = </span><span style="color: #b5cea8;">3.0</span></div><div><span style="color: #d4d4d4;">...</span></div><div><span style="color: #6a9955;">//main.das</span></div><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> module1</span></div><div><span style="color: #6a9955;">//можно звать инициализацию полей, и пост-инициализацию для V3 (также открываются поля V2), но нельзя инициализировать явно поле приватного класса V1</span></div><div><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[V3() x=</span><span style="color: #b5cea8;">1.0f</span><span style="color: #d4d4d4;">, y=</span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">, z=</span><span style="color: #b5cea8;">3.0f</span><span style="color: #d4d4d4;">]]</span></div></div>
<h2 id="Инициализаторы"><a href="#Инициализаторы" class="headerlink" title="Инициализаторы"></a>Инициализаторы</h2><p>Инициализатор для класса — это функция, у которой имя совпадает с именем класса. Так как классы — надстройки над структурами, и все варианты синтаксиса иницилизации действуют и для них, то нет никакой гарантии того, что инициализатор класса будет вызван.</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">class</span><span style="color: #d4d4d4;"> MyClass</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">private</span><span style="color: #d4d4d4;"> a : </span><span style="color: #4ec9b0;">int</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">def private</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">set_a</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">val</span><span style="color: #d4d4d4;">:</span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; a = val</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> get_a</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> a</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">MyClass</span><span style="color: #d4d4d4;">()</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; self-&gt;set_a(</span><span style="color: #b5cea8;">42</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">export</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> f = </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> MyClass()</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #dcdcaa;">print</span><span style="color: #d4d4d4;">(</span><span style="color: #ce9178;">"f.a = {</span><span style="color: #9cdcfe;">f</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #ce9178;">get_a()}</span><span style="color: #d7ba7d;">\n</span><span style="color: #ce9178;">"</span><span style="color: #d4d4d4;">)</span></div></div>
<h2 id="Интерфейсы"><a href="#Интерфейсы" class="headerlink" title="Интерфейсы"></a>Интерфейсы</h2><p><a href="https://github.com/GaijinEntertainment/daScript/blob/eaecd72d6d44b46f5566dc4a0ce3956d5488672c/daslib/interfaces.das" target="_blank" rel="noopener">https://github.com/GaijinEntertainment/daScript/blob/eaecd72d6d44b46f5566dc4a0ce3956d5488672c/daslib/interfaces.das</a></p>
<p>Библиотека <code>interfaces</code> с помощью пары макросов позволяет реализовать паттерн интерфейса — классы, который содержит только абстрактные методы. Макрос <code>implements</code> позволяет изобразить множественное наследование от интерфейсов.</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">class</span><span style="color: #d4d4d4;"> Test</span></div><div><span style="color: #d4d4d4;">&#160; &#160; i : </span><span style="color: #4ec9b0;">float</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">Test</span><span style="color: #d4d4d4;">(</span><span style="color: #9cdcfe;">I </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">)</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; i = I</span></div><br><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> main</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> a &lt;- </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> Test(</span><span style="color: #b5cea8;">33.0f</span><span style="color: #d4d4d4;">) &#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//initializer called</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> b &lt;- </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> Test() &#160; &#160; &#160; &#160; &#160; &#160; &#160;</span><span style="color: #6a9955;">//initializer dont called</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">var</span><span style="color: #d4d4d4;"> c &lt;- </span><span style="color: #c586c0;">new</span><span style="color: #d4d4d4;"> [[Test() i = </span><span style="color: #b5cea8;">2.0f</span><span style="color: #d4d4d4;">]] </span><span style="color: #6a9955;">//initializer dont called</span></div></div>
<h1 id="Связь-с-C-типами"><a href="#Связь-с-C-типами" class="headerlink" title="Связь с C++ типами"></a>Связь с C++ типами</h1><p><a href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/tutorial/tutorial03.cpp#L15" target="_blank" rel="noopener">https://github.com/GaijinEntertainment/daScript/blob/master/examples/tutorial/tutorial03.cpp#L15</a><br>Базовый пример прокидывания C++ класса в daScript. Похоже на другие скриптовые языки, создаётся класс-обёртка (<code>ManagedStructureAnnotation</code>) над типом, которая позволяет привязать и настроить отображение полей и методов структуры на тип в daScript, а также переопределить группу методов, определяющих свойства этого типа в daScript.</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">interface</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">class</span><span style="color: #d4d4d4;"> ITick</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">def abstract</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">tick</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">dt</span><span style="color: #d4d4d4;">:</span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;">) : </span><span style="color: #4ec9b0;">void</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">interface</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">class</span><span style="color: #d4d4d4;"> ILogger</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">def abstract</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">log</span><span style="color: #d4d4d4;"> (</span><span style="color: #9cdcfe;">message </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">string</span><span style="color: #d4d4d4;">) : </span><span style="color: #4ec9b0;">void</span></div><br><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">implements</span><span style="color: #d4d4d4;">(ITick), implements(ILogger)]</span></div><div><span style="color: #c586c0;">class</span><span style="color: #d4d4d4;"> Foo</span></div><div><span style="color: #d4d4d4;">&#160; &#160; ...</span></div></div>
<p>Более продвинутые <a href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/test/test_handles.cpp" target="_blank" rel="noopener">примеры</a>, также можно смотреть код <a href="https://github.com/GaijinEntertainment/daScript/tree/master/modules" target="_blank" rel="noopener">модулей</a>.</p>
<h2 id="Наследование"><a href="#Наследование" class="headerlink" title="Наследование"></a>Наследование</h2><p>Отнаследоваться от C++ типа нельзя (<em>ну, или я не нашёл способа сделать такой тип</em>).</p>
<p>Существует возможность передать в daScript связь родитель-потомок между C++-типами (<a href="https://github.com/borisbat/dasSFML/blob/4501a9167692180d138da4a487a42375a377db68/src/dasSFML.struct.add.inc#L134" target="_blank" rel="noopener">пример</a>), для upcast-приведения типов аргументов функций.</p>
<p>Пример организации связи между С++ и daScript-классами - <a href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/tutorial/tutorial04.cpp#L45" target="_blank" rel="noopener">tutorial04</a>.</p>
<img style="background-color:white;" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjk3IiBoZWlnaHQ9IjE5OSIgdmVyc2lvbj0iMS4xIiBiYXNlUHJvZmlsZT0iZnVsbCIgdmlld2JveD0iMCAwIDY5NyAxOTkiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhtbG5zOmV2PSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL3htbC1ldmVudHMiIHN0eWxlPSJmb250LXdlaWdodDpib2xkOyBmb250LXNpemU6MTJwdDsgZm9udC1mYW1pbHk6J0NhbGlicmknLCBIZWx2ZXRpY2EsIHNhbnMtc2VyaWY7O3N0cm9rZS13aWR0aDozO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2UtbGluZWNhcDpyb3VuZCI+PHBhdGggZD0iTTE4NC4xIDQ0LjUgTDExMiA2NC41IEwxMTIgODQuNSBMMTEyIDg0LjUgIiBzdHlsZT0ic3Ryb2tlOiMzMzMyMkU7ZmlsbDpub25lO3N0cm9rZS1kYXNoYXJyYXk6bm9uZTsiPjwvcGF0aD4KPHBhdGggZD0iTTEwNi43IDcxLjIgTDExMiA3Ny44IEwxMTcuMyA3MS4yIEwxMTIgODQuNSBaIiBzdHlsZT0ic3Ryb2tlOiMzMzMyMkU7ZmlsbDojMzMzMjJFO3N0cm9rZS1kYXNoYXJyYXk6bm9uZTsiPjwvcGF0aD4KPHBhdGggZD0iTTI5NS45IDQ0LjUgTDM2OCA2NC41IEwzNjggODQuNSBMMzY4IDg0LjUgIiBzdHlsZT0ic3Ryb2tlOiMzMzMyMkU7ZmlsbDpub25lO3N0cm9rZS1kYXNoYXJyYXk6NiA2OyI+PC9wYXRoPgo8cGF0aCBkPSJNMzYyLjcgNzEuMiBMMzY4IDc3LjggTDM3My4zIDcxLjIgTDM2OCA4NC41IFoiIHN0eWxlPSJzdHJva2U6IzMzMzIyRTtmaWxsOiMzMzMyMkU7c3Ryb2tlLWRhc2hhcnJheTpub25lOyI+PC9wYXRoPgo8cGF0aCBkPSJNNjA1IDExNS41IEw2MDUgMTM1LjUgTDUzOC4yIDE1NS41IEw1MzguMiAxNTUuNSAiIHN0eWxlPSJzdHJva2U6IzMzMzIyRTtmaWxsOm5vbmU7c3Ryb2tlLWRhc2hhcnJheTpub25lOyI+PC9wYXRoPgo8cGF0aCBkPSJNNTQ5LjUgMTQ2LjYgTDU0NC42IDE1My42IEw1NTIuNSAxNTYuOCBMNTM4LjIgMTU1LjUgWiIgc3R5bGU9InN0cm9rZTojMzMzMjJFO2ZpbGw6IzMzMzIyRTtzdHJva2UtZGFzaGFycmF5Om5vbmU7Ij48L3BhdGg+CjxwYXRoIGQ9Ik0zNjggMTE1LjUgTDM2OCAxMzUuNSBMNDM0LjggMTU1LjUgTDQzNC44IDE1NS41ICIgc3R5bGU9InN0cm9rZTojMzMzMjJFO2ZpbGw6bm9uZTtzdHJva2UtZGFzaGFycmF5Om5vbmU7Ij48L3BhdGg+CjxwYXRoIGQ9Ik00MjAuNSAxNTYuOCBMNDI4LjQgMTUzLjYgTDQyMy41IDE0Ni42IEw0MzQuOCAxNTUuNSBaIiBzdHlsZT0ic3Ryb2tlOiMzMzMyMkU7ZmlsbDojMzMzMjJFO3N0cm9rZS1kYXNoYXJyYXk6bm9uZTsiPjwvcGF0aD4KPHJlY3QgeD0iMTIyLjUiIHk9IjEzLjUiIGhlaWdodD0iMzEiIHdpZHRoPSIyMzUiIHN0eWxlPSJzdHJva2U6IzMzMzIyRTtmaWxsOnBpbms7c3Ryb2tlLWRhc2hhcnJheTpub25lOyI+PC9yZWN0Pgo8dGV4dCB4PSIxMzAuOCIgeT0iMzUiIHN0eWxlPSIiPlR1dG9yaWFsQmFzZUNsYXNzIChkYXMpPC90ZXh0Pgo8cmVjdCB4PSIxMy41IiB5PSI4NC41IiBoZWlnaHQ9IjMxIiB3aWR0aD0iMTk3IiBzdHlsZT0ic3Ryb2tlOiMzMzMyMkU7ZmlsbDpwaW5rO3N0cm9rZS1kYXNoYXJyYXk6bm9uZTsiPjwvcmVjdD4KPHRleHQgeD0iMjEuOCIgeT0iMTA2IiBzdHlsZT0iIj5FeGFtcGxlT2JqZWN0IChkYXMpPC90ZXh0Pgo8cmVjdCB4PSIyNTAuNSIgeT0iODQuNSIgaGVpZ2h0PSIzMSIgd2lkdGg9IjIzNSIgc3R5bGU9InN0cm9rZTojMzMzMjJFO2ZpbGw6I2VlZThkNTtzdHJva2UtZGFzaGFycmF5Om5vbmU7Ij48L3JlY3Q+Cjx0ZXh0IHg9IjI1OC44IiB5PSIxMDYiIHN0eWxlPSIiPlR1dG9yaWFsQmFzZUNsYXNzIChjcHApPC90ZXh0Pgo8cmVjdCB4PSI1MjUuNSIgeT0iODQuNSIgaGVpZ2h0PSIzMSIgd2lkdGg9IjE1OSIgc3R5bGU9InN0cm9rZTojMzMzMjJFO2ZpbGw6I2VlZThkNTtzdHJva2UtZGFzaGFycmF5Om5vbmU7Ij48L3JlY3Q+Cjx0ZXh0IHg9IjUzMy44IiB5PSIxMDYiIHN0eWxlPSIiPkJhc2VDbGFzcyAoY3BwKTwvdGV4dD4KPHJlY3QgeD0iMzc0LjUiIHk9IjE1NS41IiBoZWlnaHQ9IjMxIiB3aWR0aD0iMjI1IiBzdHlsZT0ic3Ryb2tlOiMzMzMyMkU7ZmlsbDojZWVlOGQ1O3N0cm9rZS1kYXNoYXJyYXk6bm9uZTsiPjwvcmVjdD4KPHRleHQgeD0iMzgyLjUiIHk9IjE3NyIgc3R5bGU9IiI+QmFzZUNsYXNzQWRhcHRlciAoY3BwKTwvdGV4dD48L3N2Zz4=" />
<p>В примере связь организуется через класс <code>BaseClassAdapter</code>, который наследуется одновременно от базового C++-класса и сгенерированного по das-коду C++-классу-адаптеру</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">struct</span><span style="color: #d4d4d4;"> Color {</span></div><div><span style="color: #d4d4d4;">&#160; &#160; uint8_t r, g, b, a;</span></div><div><span style="color: #d4d4d4;">};</span></div><div><span style="color: #d4d4d4;">MAKE_TYPE_FACTORY(Color, Color);</span></div><br><div><span style="color: #569cd6;">struct</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">ColorAnnotation</span><span style="color: #d4d4d4;"> : </span><span style="color: #4ec9b0;">public</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">ManagedStructureAnnotation</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #4ec9b0;">Color</span><span style="color: #d4d4d4;">,</span><span style="color: #4ec9b0;">true</span><span style="color: #d4d4d4;">,</span><span style="color: #4ec9b0;">true</span><span style="color: #d4d4d4;">&gt; {</span></div><div><span style="color: #d4d4d4;">&#160; &#160; ColorAnnotation(ModuleLibrary &amp; ml) : ManagedStructureAnnotation (</span><span style="color: #ce9178;">"Color"</span><span style="color: #d4d4d4;">, ml) {</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//type fields</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; addField&lt;DAS_BIND_MANAGED_FIELD(r)&gt;(</span><span style="color: #ce9178;">"r"</span><span style="color: #d4d4d4;">);</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; addField&lt;DAS_BIND_MANAGED_FIELD(g)&gt;(</span><span style="color: #ce9178;">"g"</span><span style="color: #d4d4d4;">);</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; addField&lt;DAS_BIND_MANAGED_FIELD(b)&gt;(</span><span style="color: #ce9178;">"b"</span><span style="color: #d4d4d4;">);</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; addField&lt;DAS_BIND_MANAGED_FIELD(a)&gt;(</span><span style="color: #ce9178;">"a"</span><span style="color: #d4d4d4;">);</span></div><div><span style="color: #d4d4d4;">&#160; &#160; }</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #6a9955;">//type behaviour</span></div><div><span style="color: #d4d4d4;">&#160; &#160; virtual </span><span style="color: #4ec9b0;">bool</span><span style="color: #d4d4d4;"> isLocal() </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">override</span><span style="color: #d4d4d4;"> { </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">true</span><span style="color: #d4d4d4;">; }</span></div><div><span style="color: #d4d4d4;">&#160; &#160; virtual </span><span style="color: #4ec9b0;">bool</span><span style="color: #d4d4d4;"> canCopy() </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">override</span><span style="color: #d4d4d4;"> { </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">true</span><span style="color: #d4d4d4;">; } </span></div><div><span style="color: #d4d4d4;">&#160; &#160; virtual </span><span style="color: #4ec9b0;">bool</span><span style="color: #d4d4d4;"> canMove() </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">override</span><span style="color: #d4d4d4;"> { </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">true</span><span style="color: #d4d4d4;">; }</span></div><div><span style="color: #d4d4d4;">};</span></div><br><div><span style="color: #569cd6;">class</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">Module_Tutorial03</span><span style="color: #d4d4d4;"> : </span><span style="color: #4ec9b0;">public</span><span style="color: #d4d4d4;"> </span><span style="color: #4ec9b0;">Module</span><span style="color: #d4d4d4;"> {</span></div><div><span style="color: #c586c0;">public</span><span style="color: #d4d4d4;">:</span></div><div><span style="color: #d4d4d4;">&#160; &#160; Module_Tutorial03() : Module(</span><span style="color: #ce9178;">"tutorial_03"</span><span style="color: #d4d4d4;">) {</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; ModuleLibrary lib;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; lib.addModule(this);</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; addAnnotation(make_smart&lt;ColorAnnotation&gt;(lib));</span></div><div><span style="color: #d4d4d4;">&#160; &#160; }</span></div><div><span style="color: #d4d4d4;">};</span></div><div><span style="color: #d4d4d4;">REGISTER_MODULE(Module_Tutorial03);</span></div></div>
<p><code>TutorialBaseClass</code> - интерфейс между C++/daScript, который используется генератором C++-обёрток <code>log_cpp_class_adapter</code>, на выходе получается примерно такой C++-код:</p>
<div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">options</span><span style="color: #d4d4d4;"> remove_unused_symbols = </span><span style="color: #c586c0;">false</span></div><br><div><span style="color: #6a9955;">//interface C++/daScript</span></div><div><span style="color: #c586c0;">class</span><span style="color: #d4d4d4;"> TutorialBaseClass</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #569cd6;">def abstract</span><span style="color: #d4d4d4;"> </span><span style="color: #dcdcaa;">update</span><span style="color: #d4d4d4;"> ( </span><span style="color: #9cdcfe;">dt </span><span style="color: #d4d4d4;">: </span><span style="color: #4ec9b0;">float</span><span style="color: #d4d4d4;"> ) : </span><span style="color: #4ec9b0;">void</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> </span><span style="color: #c586c0;">abstract</span><span style="color: #d4d4d4;"> get_position : </span><span style="color: #4ec9b0;">float3</span></div><br><div><span style="color: #6a9955;">// uncomment the section to generate C++ bindings for the TutorialBaseClass</span></div><div><span style="color: #6a9955;">// this code will generate tutorial04_gen.inc which contains C++ bindings</span></div><br><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> fio</span></div><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> ast</span></div><div><span style="color: #c586c0;">require</span><span style="color: #d4d4d4;"> daslib/cpp_bind</span></div><div><span style="color: #d4d4d4;">[</span><span style="color: #569cd6;">init</span><span style="color: #d4d4d4;">]</span></div><div><span style="color: #c586c0;">def</span><span style="color: #d4d4d4;"> generate_cpp_bindings</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">let</span><span style="color: #d4d4d4;"> root = get_das_root() + </span><span style="color: #ce9178;">"/examples/tutorial/"</span></div><div><span style="color: #d4d4d4;">&#160; &#160; fopen(root + </span><span style="color: #ce9178;">"tutorial04_gen.inc"</span><span style="color: #d4d4d4;">,</span><span style="color: #ce9178;">"wb"</span><span style="color: #d4d4d4;">) &lt;| </span><span style="color: #569cd6;">$</span><span style="color: #d4d4d4;"> ( </span><span style="color: #9cdcfe;">cpp_file</span><span style="color: #d4d4d4;"> )</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; </span><span style="color: #6a9955;">//generate c++ code from dascript rtti class information</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; log_cpp_class_adapter(cpp_file, </span><span style="color: #ce9178;">"TutorialBaseClass"</span><span style="color: #d4d4d4;">, </span><span style="color: #c586c0;">typeinfo</span><span style="color: #d4d4d4;">(ast_typedecl </span><span style="color: #c586c0;">type</span><span style="color: #d4d4d4;">&lt;TutorialBaseClass&gt;))</span></div></div>
<p>Вызов:<br><div style="color: #d4d4d4;background-color: #1e1e1e;font-family: Consolas, 'Courier New', monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;"><div><span style="color: #c586c0;">class</span><span style="color: #d4d4d4;"> TutorialBaseClass {</span></div><div><span style="color: #d4d4d4;">protected:</span></div><div><span style="color: #d4d4d4;">&#160; </span><span style="color: #c586c0;">enum</span><span style="color: #d4d4d4;"> {</span></div><div><span style="color: #d4d4d4;">&#160; &#160; __fn_update = </span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">,</span></div><div><span style="color: #d4d4d4;">&#160; &#160; __fn_get_position = </span><span style="color: #b5cea8;">1</span><span style="color: #d4d4d4;">,</span></div><div><span style="color: #d4d4d4;">&#160; };</span></div><div><span style="color: #d4d4d4;">protected:</span></div><div><span style="color: #d4d4d4;">&#160; static </span><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> _das_class_method_offset[</span><span style="color: #569cd6;">2</span><span style="color: #d4d4d4;">];</span></div><div><span style="color: #c586c0;">public</span><span style="color: #d4d4d4;">:</span></div><div><span style="color: #d4d4d4;">&#160; TutorialBaseClass ( </span><span style="color: #c586c0;">const</span><span style="color: #d4d4d4;"> StructInfo * info ) {</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">if</span><span style="color: #d4d4d4;"> ( _das_class_method_offset[</span><span style="color: #569cd6;">0</span><span style="color: #d4d4d4;">]==</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;"> ) {</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; _das_class_method_offset[</span><span style="color: #569cd6;">__fn_update</span><span style="color: #d4d4d4;">] = adapt_field_offset(</span><span style="color: #ce9178;">"update"</span><span style="color: #d4d4d4;">,info);</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; _das_class_method_offset[</span><span style="color: #569cd6;">__fn_get_position</span><span style="color: #d4d4d4;">] = adapt_field_offset(</span><span style="color: #ce9178;">"get_position"</span><span style="color: #d4d4d4;">,info);</span></div><div><span style="color: #d4d4d4;">&#160; &#160; }</span></div><div><span style="color: #d4d4d4;">&#160; }</span></div><div><span style="color: #d4d4d4;">&#160; ...</span></div><div><span style="color: #d4d4d4;">&#160; static __forceinline Func get_get_position ( </span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;"> * self ) {</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> getDasClassMethod(self,_das_class_method_offset[</span><span style="color: #569cd6;">__fn_get_position</span><span style="color: #d4d4d4;">]);</span></div><div><span style="color: #d4d4d4;">&#160; }</span></div><div><span style="color: #d4d4d4;">&#160; static __forceinline </span><span style="color: #4ec9b0;">float3</span><span style="color: #d4d4d4;"> invoke_get_position ( Context * __context__, Func __funcCall__, </span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;"> * self ) {</span></div><div><span style="color: #d4d4d4;">&#160; &#160; </span><span style="color: #c586c0;">return</span><span style="color: #d4d4d4;"> das_invoke_function&lt;</span><span style="color: #4ec9b0;">float3</span><span style="color: #d4d4d4;">&gt;::</span><span style="color: #dcdcaa;">invoke</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &lt;</span><span style="color: #4ec9b0;">void</span><span style="color: #d4d4d4;"> *&gt;</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; (__context__,nullptr,__funcCall__,</span></div><div><span style="color: #d4d4d4;">&#160; &#160; &#160; &#160; &#160; self);</span></div><div><span style="color: #d4d4d4;">&#160; }</span></div><div><span style="color: #d4d4d4;">};</span></div><div><span style="color: #4ec9b0;">int</span><span style="color: #d4d4d4;"> TutorialBaseClass::_das_class_method_offset[</span><span style="color: #569cd6;">2</span><span style="color: #d4d4d4;">];</span></div></div></p>
<p>Класс не содержит особой магии, а просто хранит адреса daScript-функций и позволяет прозрачно для вызывающего C++-кода их вызывать и изменять.</p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/2629978232/">Позже</a><a class="pagination__link pagination__next" href="/blog/2975166623/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2023 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>