<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | daScript: ООП и всякое</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,0.1),rgba(40,44,52,0.9))}</style><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/2629978232/">Позже</a><a class="pagination__link pagination__next" href="/blog/2975166623/">Раньше</a></div><article class="article post"><h3 class="article__title">daScript: ООП и всякое</h3><div class="article__date metadata"><div class="post-info">2023/01/12</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/longread/">longread</a><a class="article__tags__link metadata" href="/tags/dascript/">dascript</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><h1><span id="struktury">Структуры</span><a href="#struktury" class="header-anchor">#</a></h1><h2><span id="struktury-dascript-nasledovanie">Структуры daScript, наследование</span><a href="#struktury-dascript-nasledovanie" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/structs.html#struct-declaration">https://dascript.org/doc/reference/language/structs.html#struct-declaration</a></p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> V2</span></span>
<span class="line"><span style="color: #E6E6E6">    x : </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">-</span><span style="color: #B5CEA8">1.0f</span></span>
<span class="line"><span style="color: #E6E6E6">    y : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">struct</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">V3</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">V2</span></span>
<span class="line"><span style="color: #E6E6E6">    z </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">3.0f</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> a : V3</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;a = {</span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> b </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> V3()</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;b = {</span><span style="color: #9CDCFE">b</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> c </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[V3 y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;c = {</span><span style="color: #9CDCFE">c</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> d </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[V3() y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;d = {</span><span style="color: #9CDCFE">d</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> e </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[V3() y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">, x </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;e = {</span><span style="color: #9CDCFE">e</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> pd </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> [[V3() y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;pd = {</span><span style="color: #9CDCFE">pd</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//Output:</span></span>
<span class="line"><span style="color: #E6E6E6">a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #B5CEA8">0.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">0.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">0.000000000</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">b </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #D4D4D4">-</span><span style="color: #B5CEA8">1.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">0.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">3.000000000</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">c </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #B5CEA8">0.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">2.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">0.000000000</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">d </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #D4D4D4">-</span><span style="color: #B5CEA8">1.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">2.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">3.000000000</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">e </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #B5CEA8">1.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">2.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">3.000000000</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">pd </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #D4D4D4">-</span><span style="color: #B5CEA8">1.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">2.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">3.000000000</span><span style="color: #E6E6E6">]]</span></span></code></pre></div></div></figure>
<p>a,b,c,d,e - структуры, размещенные на стеке. В зависимости от способа объявления можно пропускать инициализацию полей по умолчанию — круглые скобки в объявлении добавляют код инициализации (в порядке от родительской структуры к дочерним). Синтаксис с квадратными скобками позволяет изменить значения отдельных полей. Неинициализированные явно или по умолчанию поля инициализируются нулями — получить в качестве значений неинициализированный мусор нельзя.</p>
<p>Ещё несколько примеров комбинаций синтаксиса инициализации, в первом случае создаётся структура, во втором — массив структур, в третьем — итератор<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//where clause: post init function</span></span>
<span class="line"><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> f </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[V3 </span><span style="color: #C586C0">where</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">self</span><span style="color: #E6E6E6">) {</span></span>
<span class="line"><span style="color: #E6E6E6">    self</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">x </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">11.0f</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    self</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">11.0f</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    self</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">z </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">11.0f</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">}]]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//array initialization, g_arr: V3[2]</span></span>
<span class="line"><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> g_arr </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[V3 </span></span>
<span class="line"><span style="color: #E6E6E6">    x</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">, y</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">, z</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">    x</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">, y</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">, z</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">2.0f</span></span>
<span class="line"><span style="color: #E6E6E6">]]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//array comprehesion, h_arr : iterator&lt;V3&gt;</span></span>
<span class="line"><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> h_iter </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> [[ </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> i </span><span style="color: #C586C0">in</span><span style="color: #E6E6E6"> range(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">10</span><span style="color: #E6E6E6">); [[V3 x</span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6">float(i), y</span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6">float(i), z</span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6">float(i)]]; </span><span style="color: #C586C0">where</span><span style="color: #E6E6E6"> (i</span><span style="color: #D4D4D4">&amp;</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)</span><span style="color: #D4D4D4">==</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> ]]</span></span>
<span class="line"><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> g_iter </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> [[ </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> i </span><span style="color: #C586C0">in</span><span style="color: #E6E6E6"> range(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">10</span><span style="color: #E6E6E6">); </span><span style="color: #DCDCAA">invoke</span><span style="color: #E6E6E6">({ </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">fi</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> float(i); </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> [[V3 x</span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6">fi, </span><span style="color: #9CDCFE">y</span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6">fi, </span><span style="color: #9CDCFE">z</span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6">fi]]; }); </span><span style="color: #C586C0">where</span><span style="color: #E6E6E6"> (i</span><span style="color: #D4D4D4">&amp;</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)</span><span style="color: #D4D4D4">==</span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6"> ]] </span><span style="color: #6A9955">// same</span></span></code></pre></div></div></figure></p>
<p>pd - указатель на структуру, размещенную в куче. Сама структура может быть инициализирована любым из перечисленных выше способов.</p>
<h2><span id="finalizatory">Финализаторы</span><a href="#finalizatory" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/finalizers.html#finalizers">https://dascript.org/doc/reference/language/finalizers.html#finalizers</a></p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> d </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[V3() y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;d = {</span><span style="color: #9CDCFE">d</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #C586C0">delete</span><span style="color: #E6E6E6"> d</span></span>
<span class="line"><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;d = {</span><span style="color: #9CDCFE">d</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> pd </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> [[V3() y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;pd = {</span><span style="color: #9CDCFE">pd</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #C586C0">unsafe</span><span style="color: #E6E6E6"> { </span><span style="color: #C586C0">delete</span><span style="color: #E6E6E6"> pd; }</span></span>
<span class="line"><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;pd = {</span><span style="color: #9CDCFE">pd</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//Output</span></span>
<span class="line"><span style="color: #E6E6E6">d </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #D4D4D4">-</span><span style="color: #B5CEA8">1.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">2.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">3.000000000</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">d </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #B5CEA8">0.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">0.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">0.000000000</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">pd </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #D4D4D4">-</span><span style="color: #B5CEA8">1.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">2.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">3.000000000</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">pd </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">null</span></span></code></pre></div></div></figure>
<p>Финализатор по умолчанию для структуры зануляет память (в порядке от потомков к родителям, при необходимости зовёт финализаторы для членов структуры в порядке объявления). Для указателей — после зануления полей структуры дополнительно меняет адрес указателя на null. Финализаторы для структур и классов зовутся вручную. Финализаторы не освобождают память, на которую указывает объект.</p>
<h2><span id="osvobozhdenie-pamyati">Освобождение памяти</span><a href="#osvobozhdenie-pamyati" class="header-anchor">#</a></h2><p>Модель памяти по умолчанию в daScript не подразумевает очистки памяти в ходе выполнения скрипта, за очистку отвечает хост-приложение, которое может просто освободить всю память контекста целиком — пересоздание контекстов by design быстро и эффективно, так что такой способ предпочтительный.</p>
<p>Но можно настроить поведение контекста опцией <code>persistent_heap</code>:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">options</span><span style="color: #E6E6E6"> persistent_heap </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">true</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> pd </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> [[V3() y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> pd2 </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> pd</span></span>
<span class="line"><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;addr(pd) = {</span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">pd</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;addr(pd2) = {</span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">pd2</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">delete</span><span style="color: #E6E6E6"> pd</span></span>
<span class="line"><span style="color: #E6E6E6">pd2</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">x </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">33.0f</span></span>
<span class="line"><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;pd2 = {</span><span style="color: #9CDCFE">pd2</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//Output</span></span>
<span class="line"><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(pd) </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0xf1909e10</span></span>
<span class="line"><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(pd2) </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0xf1909e10</span></span>
<span class="line"><span style="color: #E6E6E6">pd2 </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #B5CEA8">33.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #D4D4D4">-</span><span style="color: #B5CEA8">431602080.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #D4D4D4">-</span><span style="color: #B5CEA8">431602080.000000000</span><span style="color: #E6E6E6">]] </span><span style="color: #6A9955">//мусор</span></span></code></pre></div></div></figure>
<p>Я включил опцию <code>DAS_SANITIZER</code> при сборке daScript, чтобы после освобождения объектов в случае с persistent_heap память перезаписывалась мусорными значениями (0xCD, -431602080 если интерпретировать 0xCDCDCDCD как float-значение). В данном случае программа по счастливому стечению обстоятельств не упала, но благодаря санитайзеру видно, что указатель pd2 после удаления pd стал висячим — указывает на свободную память, которая могла бы быть выделена другому объекту (объекту daScript того же контекста в случае <code>persistent_heap=false</code>, или любому другому объекту хост-приложения с <code>persistent_heap=true</code>).</p>
<p>Более “злобный” вариант примера:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> pd </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> [[V3() y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> pd2 </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> pd</span></span>
<span class="line"><span style="color: #C586C0">unsafe</span><span style="color: #E6E6E6"> { </span><span style="color: #C586C0">delete</span><span style="color: #E6E6E6"> pd; }</span></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> pd3 </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> [[V3() x </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">33.0f</span><span style="color: #E6E6E6">, y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">33.0f</span><span style="color: #E6E6E6">, z </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">33.0f</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">pd2</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">x </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">-</span><span style="color: #B5CEA8">100.0f</span><span style="color: #E6E6E6"> </span><span style="color: #6A9955">// &lt;----- kaboom!</span></span>
<span class="line"><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;pd2 = {</span><span style="color: #9CDCFE">pd2</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;pd3 = {</span><span style="color: #9CDCFE">pd3</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//Output</span></span>
<span class="line"><span style="color: #E6E6E6">pd2 </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #D4D4D4">-</span><span style="color: #B5CEA8">100.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">33.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">33.000000000</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">pd3 </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #D4D4D4">-</span><span style="color: #B5CEA8">100.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">33.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">33.000000000</span><span style="color: #E6E6E6">]]</span></span></code></pre></div></div></figure><br>После освобождения память на которую указывали pd и pd2 была повторно отдана новому объекту, на который указывает pd3. Этот объект теперь может поменяться через указатель pd2. Должно быть понятно, насколько unsafe операция удаления — код стал насколько же опасным (но и настолько же быстрым), как и код на языке си.</p>
<h2><span id="kastomnye-finalizatory">Кастомные финализаторы</span><a href="#kastomnye-finalizatory" class="header-anchor">#</a></h2><p>Финализатор можно переопределить, пример: финализатор для структуры V2</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">finalize</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">v </span><span style="color: #E6E6E6">: V2)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;kill V2 {</span><span style="color: #9CDCFE">v</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> d </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ V3 x </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">11.0f</span><span style="color: #E6E6E6">, y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">22.0f</span><span style="color: #E6E6E6">, z </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">33.0f</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #C586C0">delete</span><span style="color: #E6E6E6"> d</span></span>
<span class="line"><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;d = {</span><span style="color: #9CDCFE">d</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//Output</span></span>
<span class="line"><span style="color: #E6E6E6">kill V2 [[ </span><span style="color: #B5CEA8">11.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">22.000000000</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">d </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #B5CEA8">11.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">22.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">33.000000000</span><span style="color: #E6E6E6">]]</span></span></code></pre></div></div></figure>
<p>Вместо финализатора зануления по умолчанию вызывается функция, логгирующая поле. Также можно заметить неочевидную вещь (если думать о финализаторах как о деструкторах, но лучше не думать) — финализаторы не зовутся в порядке от потомков к предкам, а как работают как обычные функции, daScript нашёл подходящую функцию, принимающую тип V2, и не вызвал зануления также и у поля z - т.е. финализатор родительской структуры “подошёл” к дочерней.</p>
<p>Более похожий на порядок вызова деструкторов в C/C++ код<br><blockquote><p>(<strong>ещё раз, финализаторы — это не деструкторы, они вызываются только при явном вызове оператора delete!</strong>)</p>
</blockquote></p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">finalize</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">v </span><span style="color: #E6E6E6">: V2 </span><span style="color: #C586C0">explicit</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;kill V2 {</span><span style="color: #9CDCFE">v</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">finalize</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">v </span><span style="color: #E6E6E6">: V3 </span><span style="color: #C586C0">explicit</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    finalize(</span><span style="color: #C586C0">cast</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">V2</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> v)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;kill V3 {</span><span style="color: #9CDCFE">v</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> d </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ V3 x </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">11.0f</span><span style="color: #E6E6E6">, y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">22.0f</span><span style="color: #E6E6E6">, z </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">33.0f</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">delete</span><span style="color: #E6E6E6"> d</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;d = {</span><span style="color: #9CDCFE">d</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #6A9955">//Output</span></span>
<span class="line"><span style="color: #E6E6E6">kill V2 [[ </span><span style="color: #B5CEA8">11.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">22.000000000</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">kill V3 [[ </span><span style="color: #B5CEA8">11.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">22.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">33.000000000</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #E6E6E6">d </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ </span><span style="color: #B5CEA8">11.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">22.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">33.000000000</span><span style="color: #E6E6E6">]]</span></span></code></pre></div></div></figure>
<p>daScript не позволяет каст к дочерним типам <code>explicit</code>-аргументов.</p>
<p>Вместо перегрузки <code>finalize</code> можно перегрузить <code>def operator delete(var v : V2 explicit)</code> — семантически более точно описывает, что для структур код финализатора будет вызван только в момент явного вызова оператора <code>delete</code>.</p>
<h2><span id="metody">Методы</span><a href="#metody" class="header-anchor">#</a></h2><p>Методы не могут быть объявлены при объявлении структур, но структуры могут хранить указатели на функции</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> V2</span></span>
<span class="line"><span style="color: #E6E6E6">    x : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    y : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    set </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> @@set</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> V2()</span></span>
<span class="line"><span style="color: #E6E6E6">a </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> set(</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//call function via pipe syntax</span></span>
<span class="line"><span style="color: #DCDCAA">invoke</span><span style="color: #E6E6E6">(a</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">set, a, </span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">)  </span><span style="color: #6A9955">// exactly same thing as above</span></span>
<span class="line"><span style="color: #E6E6E6">a</span><span style="color: #D4D4D4">-&gt;</span><span style="color: #E6E6E6">set(</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">)  </span><span style="color: #6A9955">// this one can call something else, if overridden in derived class.</span></span></code></pre></div></div></figure>
<p>Потомок может переопределить функцию</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> V2</span></span>
<span class="line"><span style="color: #E6E6E6">    x : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    y : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    set </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> @@set</span></span>
<span class="line"><span style="color: #569CD6">struct</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">V3</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">V2</span></span>
<span class="line"><span style="color: #E6E6E6">    z : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">override</span><span style="color: #E6E6E6"> set </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">cast</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">auto</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> @@set_v3</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">set</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">thisV</span><span style="color: #E6E6E6">: V2; </span><span style="color: #9CDCFE">X, Y</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">with</span><span style="color: #E6E6E6"> thisV</span></span>
<span class="line"><span style="color: #E6E6E6">        x </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> X</span></span>
<span class="line"><span style="color: #E6E6E6">        y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> Y</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">set_v3</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">thisV</span><span style="color: #E6E6E6">: V3; </span><span style="color: #9CDCFE">X, Y</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    set(</span><span style="color: #C586C0">cast</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">V2</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> thisV, X, Y)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">with</span><span style="color: #E6E6E6"> thisV</span></span>
<span class="line"><span style="color: #E6E6E6">        z </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">3.0f</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> V3()</span></span>
<span class="line"><span style="color: #E6E6E6">    a </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> set_v3(</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//non virtual call</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">invoke</span><span style="color: #E6E6E6">(a</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">set, a, </span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">)  </span><span style="color: #6A9955">// exactly same thing as above</span></span>
<span class="line"><span style="color: #E6E6E6">    a</span><span style="color: #D4D4D4">-&gt;</span><span style="color: #E6E6E6">set(</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">)  </span><span style="color: #6A9955">// this one can call something else, if overridden in derived class.</span></span></code></pre></div></div></figure>
<p>(<a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/test/unit_tests/override.das">https://github.com/GaijinEntertainment/daScript/blob/master/examples/test/unit_tests/override.das</a>)</p>
<p>daScript позволяет создать две перегрузки функции set (а не определять дополнительное имя <code>set_v3</code>), принимающие V2 и V3, тогда можно переписать пример без использования дополнительного имени, с уточнением типа функции set перед кастом и последующим автоматическим приведением этого указателя к правильному типу, определённому в V2:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> V2</span></span>
<span class="line"><span style="color: #E6E6E6">    x : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    y : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    set </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> @@</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">(</span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> thisV: V2; X, Y: </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">):</span><span style="color: #4EC9B0">void</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> set</span></span>
<span class="line"><span style="color: #569CD6">struct</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">V3</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">V2</span></span>
<span class="line"><span style="color: #E6E6E6">    z : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">override</span><span style="color: #E6E6E6"> set </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">cast</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">auto</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> @@</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">(</span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> thisV: V3; X, Y: </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">):</span><span style="color: #4EC9B0">void</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> set </span><span style="color: #6A9955">//&lt;------ cast</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">set</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">thisV</span><span style="color: #E6E6E6">: V2 </span><span style="color: #C586C0">explicit</span><span style="color: #E6E6E6">; </span><span style="color: #9CDCFE">X, Y</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">with</span><span style="color: #E6E6E6"> thisV</span></span>
<span class="line"><span style="color: #E6E6E6">        x </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> X</span></span>
<span class="line"><span style="color: #E6E6E6">        y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> Y</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">set</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">thisV</span><span style="color: #E6E6E6">: V3; </span><span style="color: #9CDCFE">X, Y</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    set(</span><span style="color: #C586C0">cast</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">V2</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> thisV, X, Y)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">with</span><span style="color: #E6E6E6"> thisV</span></span>
<span class="line"><span style="color: #E6E6E6">        z </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">3.0f</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> V3()</span></span>
<span class="line"><span style="color: #E6E6E6">    a </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> set(</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">) </span><span style="color: #6A9955">//virtual call</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">invoke</span><span style="color: #E6E6E6">(a</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">set, a, </span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">)  </span><span style="color: #6A9955">// exactly same thing as above</span></span>
<span class="line"><span style="color: #E6E6E6">    a</span><span style="color: #D4D4D4">-&gt;</span><span style="color: #E6E6E6">set(</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #9CDCFE">a</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span></code></pre></div></div></figure>
<p>Здесь <code>explicit</code> в первом объявлении свободной функции <code>set</code> позволяет сделать некоторую магию — несмотря на то, что эта функция “пропускает” только указатели на V2, это позволяет однозначно выделить эту функцию в приведении <code>set = @@&lt;(var thisV: V2; X, Y: float):void&gt; set</code> среди двух прегруженных (иначе возникла бы неоднозначность — обе приводились бы с одинаковым приоритетом, и daScript выдавал бы ошибку). Но при этом сигнатура функции <code>V2&#39;set</code> уже не содержит этого <code>explicit</code> (её тип выводится автоматически по правой части выражения, где явно указана сигнатура без <code>explicit</code>). Таким образом <code>V2&#39;set</code> работает как виртуальная функция — может принимать первым аргументом как <code>V2</code>, так и её потомков, которые не переопределили функцию.</p>
<h1><span id="klassy">Классы</span><a href="#klassy" class="header-anchor">#</a></h1><p><a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/classes.html#classes">https://dascript.org/doc/reference/language/classes.html#classes</a></p>
<p>Классы в daScript — это структуры “на стероидах”. Немного отличий:</p>
<ul>
<li>Класс может быть отнаследован от структуры, но структура не может быть унаследована от класса (связано с тем, что классы могут иметь инициализаторы)</li>
<li>Объявление локального класса на стеке небезопасно (требует явного unsafe)</li>
</ul>
<p>Методы <a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/structs.html#structure-function-members">реализованы</a> как указатели на функции, но с возможностью объявлять их в теле класса и переопределять с помощью ключевого слова <code>override</code> без явного каста типа метода, как было со структурами</p>
<figure class="shiki cpp"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">V2</span></span>
<span class="line"><span style="color: #E6E6E6">    x : </span><span style="color: #569CD6">float</span></span>
<span class="line"><span style="color: #E6E6E6">    y : </span><span style="color: #569CD6">float</span></span>
<span class="line"><span style="color: #E6E6E6">    def set(X, Y: </span><span style="color: #569CD6">float</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        x = X</span></span>
<span class="line"><span style="color: #E6E6E6">        y = Y</span></span>
<span class="line"><span style="color: #E6E6E6">class V3: </span><span style="color: #4EC9B0">V2</span></span>
<span class="line"><span style="color: #E6E6E6">    z : </span><span style="color: #569CD6">float</span></span>
<span class="line"><span style="color: #E6E6E6">    def override set(X, Y: </span><span style="color: #569CD6">float</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        V2`set(self, </span><span style="color: #4EC9B0">X</span><span style="color: #E6E6E6">, </span><span style="color: #4EC9B0">Y</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        z = 3.0f</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[export]</span></span>
<span class="line"><span style="color: #E6E6E6">def main</span></span>
<span class="line"><span style="color: #E6E6E6">    var a = new V3()</span></span>
<span class="line"><span style="color: #E6E6E6">    a-&gt;set(1.0f, 2.0f)</span><span style="color: #6A9955"> //V3`set(*a, 1.0f, 2.0f)</span></span>
<span class="line"><span style="color: #E6E6E6">    print(&quot;a = {a}\n</span><span style="color: #CE9178">&quot;)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CE9178">//Output</span></span>
<span class="line"><span style="color: #CE9178">a = [[ 0x29990d19b90; V3&#39;__finalize/*V3&#39;__finalize S&lt;::V3&gt;*/; 1.000000000; 2.000000000; V3`set/*V3`set S&lt;::V3&gt; Cf Cf*/; 3.000000000]]</span></span></code></pre></div></div></figure>
<p>Можно заметить, что имя объявленной внутри класса-функции манглится с помощью префикса-имени класса (<code>set -&gt; V2&#39;set</code>). Также внутри метода доступен указатель <code>self</code>, неявно передаваемый первым аргументов в методы класса.</p>
<p>Стоит более детально рассмотреть вывод результата.</p>
<h2><span id="poryadok-poley-obekta-v-pamyati">Порядок полей объекта в памяти</span><a href="#poryadok-poley-obekta-v-pamyati" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/classes.html#implementation-details">https://dascript.org/doc/reference/language/classes.html#implementation-details</a></p>
<p>Содержимое <code>a</code>:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #B5CEA8">0x29990d19b90</span><span style="color: #E6E6E6">; </span><span style="color: #6A9955">//указатель на rtti информацию</span></span>
<span class="line"><span style="color: #E6E6E6">    V3</span><span style="color: #CE9178">&#39;__finalize/*V3&#39;</span><span style="color: #E6E6E6">__finalize S</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">::V3</span><span style="color: #D4D4D4">&gt;*/</span><span style="color: #E6E6E6">;  </span><span style="color: #6A9955">//указатель на функцию-финализатор</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #B5CEA8">1.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #6A9955">//x</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #B5CEA8">2.000000000</span><span style="color: #E6E6E6">; </span><span style="color: #6A9955">//y</span></span>
<span class="line"><span style="color: #E6E6E6">    V3`set</span><span style="color: #6A9955">/*V3`set S&lt;::V3&gt; Cf Cf*/</span><span style="color: #E6E6E6">; </span><span style="color: #6A9955">//указатель на виртуальную функцию set</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #B5CEA8">3.000000000</span><span style="color: #E6E6E6"> </span><span style="color: #6A9955">//z</span></span>
<span class="line"><span style="color: #E6E6E6">]]</span></span></code></pre></div></div></figure>
<p>Комментарии после имён функций — замангленное имя функции и её сигнатуры (аргументы и результаты). </p>
<blockquote><p>Расположение в памяти серьёзно отличается от C++ — указатели на виртуальные функции хранятся не в отдельной таблице (vtable), а в каждом объекте класса в том порядке, в котором были объявлены функции. Это позволяет убрать один уровень индирекции при вызове функций (не нужно идти за адресом в виртуальную таблицу) и изменять адреса функций динамически для каждого отдельного объекта, но увеличивает расходы памяти на хранение указателей, и также может повлиять на выравнивание и padding между полями.</p>
</blockquote>
<p>Тем не менее, для модификации порядка данных структур возможно написать собственный макрос, который будет хранить функции в самостоятельно сгенерированной таблице или выносить указатели на функции в конец структуры.<br><a href="/blog/1547564887/" title="daScript macro">daScript macro</a> — пример макроса перестановки порядка полей при определении структур</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span></span>
<span class="line"><span style="color: #CE9178">&quot;</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">sizeof(a) = {</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">sizeof</span><span style="color: #CE9178"> </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">V3</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span></span>
<span class="line"><span style="color: #CE9178">offset __rtti      = {</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">offsetof</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">__rtti</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178"> </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">V3</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">)} {</span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">  </span><span style="color: #C586C0">addr</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">a</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">__rtti</span><span style="color: #CE9178">)} </span></span>
<span class="line"><span style="color: #CE9178">offset __finalize  = {</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">offsetof</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">__finalize</span><span style="color: #CE9178"> </span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178"> </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">V3</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">)} {</span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">  </span><span style="color: #C586C0">addr</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">a</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">__finalize</span><span style="color: #CE9178"> )} </span></span>
<span class="line"><span style="color: #CE9178">offset x           = {</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">offsetof</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">x</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178"> </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">V3</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">)} {</span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">  </span><span style="color: #C586C0">addr</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">a</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">x</span><span style="color: #CE9178">)}</span></span>
<span class="line"><span style="color: #CE9178">offset y           = {</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">offsetof</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">y</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178"> </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">V3</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">)} {</span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178"> </span><span style="color: #C586C0">addr</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">a</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">y</span><span style="color: #CE9178">)}</span></span>
<span class="line"><span style="color: #CE9178">offset set         = {</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">offsetof</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">set</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178"> </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">V3</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">)} {</span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178"> </span><span style="color: #C586C0">addr</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">a</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">set</span><span style="color: #CE9178">)}</span></span>
<span class="line"><span style="color: #CE9178">offset z           = {</span><span style="color: #C586C0">typeinfo</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">offsetof</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">z</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178"> </span><span style="color: #C586C0">type</span><span style="color: #D4D4D4">&lt;</span><span style="color: #9CDCFE">V3</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178">)} {</span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">uint</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178"> </span><span style="color: #C586C0">addr</span><span style="color: #CE9178">(</span><span style="color: #9CDCFE">a</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">z</span><span style="color: #CE9178">)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span></span>
<span class="line"><span style="color: #E6E6E6">        )</span></span>
<span class="line"><span style="color: #E6E6E6">Output:</span></span>
<span class="line"><span style="color: #E6E6E6">sizeof(a) </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">40</span></span>
<span class="line"><span style="color: #E6E6E6">offset __rtti      </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">  </span><span style="color: #B5CEA8">0x4adb5f80</span></span>
<span class="line"><span style="color: #E6E6E6">offset __finalize  </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">8</span><span style="color: #E6E6E6">  </span><span style="color: #B5CEA8">0x4adb5f88</span></span>
<span class="line"><span style="color: #E6E6E6">offset x           </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">16</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0x4adb5f90</span></span>
<span class="line"><span style="color: #E6E6E6">offset y           </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">20</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0x4adb5f94</span></span>
<span class="line"><span style="color: #E6E6E6">offset set1        </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">24</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0x4adb5f98</span></span>
<span class="line"><span style="color: #E6E6E6">offset z           </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">32</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0x4adb5fa0</span></span></code></pre></div></div></figure>
<p>Существует также макрос <code>[cpp_layout]</code>, который не меняет порядок членов класса/структуры, но добавляет дополнительное правило выравнивания, как делают С/C++ — в конце родительской структуры будет оставлено пространство для её выравнивания по максимальному выравниванию членов структуры — например, если добавить в конце V2 поле на 4 байта <code>padding: uint8[4]</code>, то из-за выравнивания структуры в 8 байт (из-за указателей на 64-битной платформе), поле z, будет добавлено с отступом в 8 байт (без макроса daScript без проблем “встраивает” это поле сразу за 4-байтным отступом).</p>
<h2><span id="pereopredelenie-metoda-v-ekzemplyare-klassa">Переопределение метода в экземпляре класса</span><a href="#pereopredelenie-metoda-v-ekzemplyare-klassa" class="header-anchor">#</a></h2><p>Как было замеченно выше, каждый экземпляр класса/структуры хранит собственные копии указателей на функции, так что можно переопределить метод не на уровне класса-потомка, а в экземпляре класса (в пост-инициализаторе, или в любой момент после создания):</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">class</span><span style="color: #E6E6E6"> V2</span></span>
<span class="line"><span style="color: #E6E6E6">    x : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    y : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">set</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">X, Y</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        x </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> X</span></span>
<span class="line"><span style="color: #E6E6E6">        y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> Y</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> fn </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> @@ </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> ( a : </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> )</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> a </span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//inplace init syntax</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> v_customset </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[ V2() </span></span>
<span class="line"><span style="color: #E6E6E6">            set </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> @@ (</span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> self : V2; X,Y : </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">) {</span></span>
<span class="line"><span style="color: #E6E6E6">                self</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">x </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> X </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">100.0f</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">                self</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> Y </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">100.0f</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">            }</span></span>
<span class="line"><span style="color: #E6E6E6">        ]]</span></span>
<span class="line"><span style="color: #E6E6E6">        v_customset</span><span style="color: #D4D4D4">-&gt;</span><span style="color: #E6E6E6">set(</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #9CDCFE">v_customset</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">x</span><span style="color: #CE9178">}, {</span><span style="color: #9CDCFE">v_customset</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">y</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//Output: 100.000000000, 200.000000000</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//reset after construction, pipe + block syntax</span></span>
<span class="line"><span style="color: #E6E6E6">        v_customset</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">set </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> @@ </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> (</span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> self : V2; X,Y : </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">            self</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">x </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> X </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">200.0f</span></span>
<span class="line"><span style="color: #E6E6E6">            self</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">y </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> Y </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">200.0f</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;{</span><span style="color: #9CDCFE">v_customset</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">x</span><span style="color: #CE9178">}, {</span><span style="color: #9CDCFE">v_customset</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">y</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//Output: 200.000000000, 400.000000000</span></span></code></pre></div></div></figure>
<p><em>(более практичное применение этого — паттерны типа event/callback)</em></p>
<h2><span id="rtti">RTTI</span><a href="#rtti" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/f050f7f9a4aaaac75e454834663389c9d8ebd343/examples/test/unit_tests/reflection.das#L110">https://github.com/GaijinEntertainment/daScript/blob/f050f7f9a4aaaac75e454834663389c9d8ebd343/examples/test/unit_tests/reflection.das#L110</a></p>
<p>Пример вывода на экран информации о типе в runtime:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> rtti</span></span>
<span class="line"><span style="color: #D4D4D4">...</span></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> V3()</span></span>
<span class="line"><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;class_info(a): {class_info(a)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">) </span></span>
<span class="line"><span style="color: #E6E6E6">describeStructure(</span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6">class_info(a))</span></span>
<span class="line"><span style="color: #6A9955">//Output:</span></span>
<span class="line"><span style="color: #6A9955">//https://dascript.org/doc/stdlib/rtti.html?highlight=rtti#StructInfo</span></span>
<span class="line"><span style="color: #E6E6E6">class_info(a): [[ </span><span style="color: #B5CEA8">0x6</span><span style="color: #E6E6E6">; V3; ; (_class</span><span style="color: #D4D4D4">|</span><span style="color: #E6E6E6">heapGC); </span><span style="color: #B5CEA8">0x28</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">0x93b8d07b5cc8cee</span><span style="color: #E6E6E6">; </span><span style="color: #B5CEA8">0xcf51414d2d20b41e</span><span style="color: #E6E6E6">]]</span></span>
<span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> V3</span></span>
<span class="line"><span style="color: #E6E6E6">    __rtti : </span><span style="color: #4EC9B0">void</span><span style="color: #E6E6E6">?</span></span>
<span class="line"><span style="color: #E6E6E6">    __finalize : </span><span style="color: #4EC9B0">function</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">(V2):</span><span style="color: #4EC9B0">void</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">    x : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    y : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    set1 : </span><span style="color: #4EC9B0">function</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">(V2;</span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6">;</span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6">):</span><span style="color: #4EC9B0">void</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">    z : </span><span style="color: #4EC9B0">float</span></span></code></pre></div></div></figure>
<p>Доступна информация о названиях и типах полей, а также мета-информация (<a target="_blank" rel="noopener" href="https://dascript.org/doc/stdlib/rtti.html?highlight=rtti#alias-structinfoflags">флаги</a> класс/структура, выделена на стеке/хипе, аннотации и т.п.).</p>
<p>Для того, чтобы передать и распознать аннотации, необходимо включить опцию <code>options rtti=true</code> (в противном случае, метаинформация о произвольных аннотациях выбрасывается после симуляции, <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/wiki/options">линк</a>). Пример:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">options</span><span style="color: #E6E6E6"> rtti</span><span style="color: #D4D4D4">=</span><span style="color: #C586C0">true</span></span>
<span class="line"><span style="color: #D4D4D4">...</span></span>
<span class="line"><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">V3</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">V2</span></span>
<span class="line"><span style="color: #E6E6E6">    [[test]] z : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #D4D4D4">...</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">describeStructure</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">sinfo</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> anyAnn </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">false</span></span>
<span class="line"><span style="color: #E6E6E6">    structure_for_each_annotation(sinfo) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">ann</span><span style="color: #E6E6E6">; </span><span style="color: #9CDCFE">annArgs</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> argT </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> join([{</span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> arg </span><span style="color: #C586C0">in</span><span style="color: #E6E6E6"> annArgs; </span><span style="color: #CE9178">&quot;{</span><span style="color: #9CDCFE">arg</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">name</span><span style="color: #CE9178">}{describeValue(get_annotation_argument_value(arg))}&quot;</span><span style="color: #E6E6E6">}],</span><span style="color: #CE9178">&quot;,&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;[{</span><span style="color: #9CDCFE">ann</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">name</span><span style="color: #CE9178">}({</span><span style="color: #9CDCFE">argT</span><span style="color: #CE9178">})]</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;struct {</span><span style="color: #9CDCFE">sinfo</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">name</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> sfield </span><span style="color: #C586C0">in</span><span style="color: #E6E6E6"> sinfo</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> sfield</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">annotation_arguments </span><span style="color: #D4D4D4">!=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">null</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> arg </span><span style="color: #C586C0">in</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">deref</span><span style="color: #E6E6E6">(sfield</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">annotation_arguments)</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;</span><span style="color: #D7BA7D">\t</span><span style="color: #CE9178">[[{</span><span style="color: #9CDCFE">arg</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">name</span><span style="color: #CE9178">}]] &quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        describeVariable(sfield,</span><span style="color: #CE9178">&quot;</span><span style="color: #D7BA7D">\t</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #D4D4D4">...</span></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> V3()</span></span>
<span class="line"><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;class_info(a): {class_info(a)}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">describeStructure(</span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6">class_info(a))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//Output:</span></span>
<span class="line"><span style="color: #C586C0">struct</span><span style="color: #E6E6E6"> V3</span></span>
<span class="line"><span style="color: #E6E6E6">    __rtti : </span><span style="color: #4EC9B0">void</span><span style="color: #E6E6E6">?</span></span>
<span class="line"><span style="color: #E6E6E6">    __finalize : </span><span style="color: #4EC9B0">function</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">(V2):</span><span style="color: #4EC9B0">void</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">    x : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    y : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    set1 : </span><span style="color: #4EC9B0">function</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">(V2;</span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6">;</span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">const</span><span style="color: #E6E6E6">):</span><span style="color: #4EC9B0">void</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">    [[test]] z : </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6"> </span><span style="color: #6A9955">//&lt;-- аннотация test</span></span></code></pre></div></div></figure>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/spiiin/961974938919cc9233bacf0bb5c71cd1">Полный пример</a></p>
<h2><span id="abstract-i-sealed-metody">Abstract и sealed-методы</span><a href="#abstract-i-sealed-metody" class="header-anchor">#</a></h2><p>Методы можно сделать абстрактыми, или закрытыми для переопределения</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">class</span><span style="color: #E6E6E6"> Test</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">abstract </span><span style="color: #DCDCAA">setX</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">X</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">): </span><span style="color: #4EC9B0">void</span><span style="color: #E6E6E6"> </span><span style="color: #6A9955">//необходимо явно определить сигнатуру метода -- тип аргументов и результата</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">sealed</span><span style="color: #E6E6E6"> setY(Y: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">)         </span><span style="color: #6A9955">//метод нельзя переопределить в потомках</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">pass</span></span></code></pre></div></div></figure>
<h2><span id="vidimost">Видимость</span><a href="#vidimost" class="header-anchor">#</a></h2><ul>
<li>Из модуля экспортируются функции с аннотацией [export]</li>
</ul>
<p><code>options always_export_initializer=true</code> позволяет проставить аннотацию для всех инициализаторов на уровне модуля</p>
<ul>
<li><code>private</code> для переменных и типов ограничивает их доступность из других модулей</li>
</ul>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//module1.das</span></span>
<span class="line"><span style="color: #C586C0">module</span><span style="color: #E6E6E6"> module1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">class</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">private</span><span style="color: #E6E6E6"> V1</span></span>
<span class="line"><span style="color: #E6E6E6">    w : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">class</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">private</span><span style="color: #E6E6E6"> V2</span></span>
<span class="line"><span style="color: #E6E6E6">    x : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    y : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> public </span><span style="color: #4EC9B0">V3</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">V2</span></span>
<span class="line"><span style="color: #E6E6E6">    v1 : V1</span></span>
<span class="line"><span style="color: #E6E6E6">    z : </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">3.0</span></span>
<span class="line"><span style="color: #D4D4D4">...</span></span>
<span class="line"><span style="color: #6A9955">//main.das</span></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> module1</span></span>
<span class="line"><span style="color: #6A9955">//можно звать инициализацию полей, и пост-инициализацию для V3 (также открываются поля V2), но нельзя инициализировать явно поле приватного класса V1</span></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> [[V3() x</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">1.0f</span><span style="color: #E6E6E6">, y</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">, z</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">3.0f</span><span style="color: #E6E6E6">]]</span></span></code></pre></div></div></figure>
<p>Приватными могут быть также поля и функции структур/классов</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">class</span><span style="color: #E6E6E6"> MyClass</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">private</span><span style="color: #E6E6E6"> a : </span><span style="color: #4EC9B0">int</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">private </span><span style="color: #DCDCAA">set_a</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">val</span><span style="color: #E6E6E6">:</span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> val</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> get_a</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> a</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">MyClass</span><span style="color: #E6E6E6">()</span></span>
<span class="line"><span style="color: #E6E6E6">        self</span><span style="color: #D4D4D4">-&gt;</span><span style="color: #E6E6E6">set_a(</span><span style="color: #B5CEA8">42</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> f </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> MyClass()</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;f.a = {</span><span style="color: #9CDCFE">f</span><span style="color: #D4D4D4">-&gt;</span><span style="color: #CE9178">get_a()}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span></code></pre></div></div></figure>
<h2><span id="inicializatory">Инициализаторы</span><a href="#inicializatory" class="header-anchor">#</a></h2><p>Инициализатор для класса — это функция, у которой имя совпадает с именем класса. Так как классы — надстройки над структурами, и все варианты синтаксиса иницилизации действуют и для них, то нет никакой гарантии того, что инициализатор класса будет вызван.</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">class</span><span style="color: #E6E6E6"> Test</span></span>
<span class="line"><span style="color: #E6E6E6">    i : </span><span style="color: #4EC9B0">float</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">Test</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">I </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        i </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> I</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> Test(</span><span style="color: #B5CEA8">33.0f</span><span style="color: #E6E6E6">)         </span><span style="color: #6A9955">//initializer called</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> b </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> Test()              </span><span style="color: #6A9955">//initializer don&#39;t called</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> c </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> [[Test() i </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">2.0f</span><span style="color: #E6E6E6">]] </span><span style="color: #6A9955">//initializer don&#39;t called</span></span></code></pre></div></div></figure>
<h2><span id="interfeysy">Интерфейсы</span><a href="#interfeysy" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/eaecd72d6d44b46f5566dc4a0ce3956d5488672c/daslib/interfaces.das">https://github.com/GaijinEntertainment/daScript/blob/eaecd72d6d44b46f5566dc4a0ce3956d5488672c/daslib/interfaces.das</a></p>
<p>Библиотека <code>interfaces</code> с помощью пары макросов позволяет реализовать паттерн интерфейса — классы, который содержит только абстрактные методы. Макрос <code>implements</code> позволяет изобразить множественное наследование от интерфейсов.</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">interface</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">class</span><span style="color: #E6E6E6"> ITick</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">abstract </span><span style="color: #DCDCAA">tick</span><span style="color: #E6E6E6"> (</span><span style="color: #9CDCFE">dt</span><span style="color: #E6E6E6">:</span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">) : </span><span style="color: #4EC9B0">void</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">interface</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">class</span><span style="color: #E6E6E6"> ILogger</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">abstract </span><span style="color: #DCDCAA">log</span><span style="color: #E6E6E6"> (</span><span style="color: #9CDCFE">message </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">string</span><span style="color: #E6E6E6">) : </span><span style="color: #4EC9B0">void</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">implements</span><span style="color: #E6E6E6">(ITick), implements(ILogger)]</span></span>
<span class="line"><span style="color: #C586C0">class</span><span style="color: #E6E6E6"> Foo</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #D4D4D4">...</span></span></code></pre></div></div></figure>
<h1><span id="svyaz-s-c-tipami">Связь с C++-типами</span><a href="#svyaz-s-c-tipami" class="header-anchor">#</a></h1><p><em>update</em></p>
<ul>
<li><a href="/blog/2757704498/" title="Связь daScript классов с C++-классами">Связь daScript классов с C++-классами</a> - перенёс в отдельную заметку</li>
</ul>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"Ov23liG1mZbiQOIdi91X","clientSecret":"e05812685eb741a752982b89dcf6f5b58dc10251","repo":"spiiin.github.io","owner":"spiiin","admin":["spiiin"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/2629978232/">Позже</a><a class="pagination__link pagination__next" href="/blog/2975166623/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div><!-- hexo injector body_end start -->
  <script>
  const CODE_CONFIG = {
    beautify: undefined,
    highlightCopy: undefined,
    highlightLang: undefined,
    highlightHeightLimit: undefined,
    isHighlightShrink: undefined,
    copy: {
      success: 'undefined',
      error: 'undefined',
      noSupport: 'undefined',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body></html>