<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | Реверс Flintstones Rescue Dino & Hoppy и Surprise at The Dinosaur Peak! [NES]</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,0.1),rgba(40,44,52,0.9))}</style><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/1474905038/">Позже</a><a class="pagination__link pagination__next" href="/blog/1562805408/">Раньше</a></div><article class="article post"><h3 class="article__title">Реверс Flintstones Rescue Dino & Hoppy и Surprise at The Dinosaur Peak! [NES]</h3><div class="article__date metadata"><div class="post-info">2016/04/05</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/nes/">nes</a><a class="article__tags__link metadata" href="/tags/hack/">hack</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>Когда-то я для тестов автоматического корраптера игр я <a target="_blank" rel="noopener" href="http://spiiin.livejournal.com/73202.html">находил</a> массивы с описаниями экранов уровней обеих игр серии Flintstones для NES.</p>
<p>С помощью цепочки логических рассуждений (и скриптов для их автоматизации) можно получить полное описание формата уровней.</p>
<p><strong>Теория</strong><br>Раньше для оптимизации поиска-коррапта я использовал только знание о том, что в nes-файле хранятся как банки с кодом и данными (PRG-банки), так и банки только с видеопамятью (CHR-банки), в которых данных не может быть по определению.</p>
<p>Количество банков в файле можно прочитать сразу в начале заголовка nes-файла (первые 16 байт файла), и не искать ничего в CHR-банках.</p>
<p>Однако, можно пойти ещё дальше, и разделить данные и код.</p>
<p>Идея показана в видео CaH4e3’а с <a target="_blank" rel="noopener" href="http://spiiin.livejournal.com/91296.html">разбором Чёрного Плаща</a>.</p>
<p>Эмулятор Fceux умеет (в меню <strong><em>Debug -&gt; Code/Data Logger</em></strong>) во время проигрывания игры запоминать, какие байты каким образом использовались - были ли они выполнены или рассматривались как данные.</p>
<p>Эти данные он сохраняет в простом по формату cdl-файле (для каждого байта в ROM создаётся байт с флажками, которые сигнализируют о его типе). Этот файл можно использовать в своих скриптах, чтобы корраптить только данные, но не код, либо же загрузить в дизассемблер IDA.</p>
<p>Для этого понадобятся плагин-загрузчик nes-ромов и скрипт загрузки для наложения на открытый файл cdl-файла (ссылки на них <a target="_blank" rel="noopener" href="https://tcrf.net/User:Cah4e3">тут</a>).</p>
<p><strong>Конвертация адресов</strong></p>
<p>Проходим игру, с запущенным Code-Data Logger, запуская все возможные сценарии (полное проигрывание заставки и диалогов, нахождение секреток, использование способностей, все варианты поражения и победы). Дальше применяем полученный в результате cdl-файл к открытой в IDA базе (Run script и открыть файл cdl.idc, который считает что файл cdl называется также, как и rom с игрой, но имеет разширение не nes, а cdl). Получаем листинг с размеченным кодом и данными. Чтобы конвертировать абсолютный адрес в ROM (который используется в конфигах <a target="_blank" rel="noopener" href="https://github.com/spiiin/CadEditor">CadEditor</a>) в адрес вида Bank:Offset в листинге IDA (загрузчик ines.ldw от Cah4eЗ), вычитаем из абсолютного адреса 0x10 и делим на размер банка - 0x2000 в загрузчике, а затем прибавляем смещение самого банка.</p>
<p>Для примера сверим данные для конфига второго уровня (Settings_Flintstones_2.cs) - загружаем конфиг в CadEditor и переключаем на режим отображения номеров макроблоков <img src="http://ic.pics.livejournal.com/spiiin/20318251/42261/42261_300.png" alt> Теперь можно проверить, что в Ida по вычисленному смещению находятся те же самые данные, что и отображает CadEditor.</p>
<p>Для примера со скрина это: <em>0x00, 0x00, 0x50, 0xD0, 0x11, 0x06</em> и т.д. (данные читаются не по строкам, а по столбцам!).</p>
<p>Абсолютное смещение этих данных 0x1519, относительное вычисляем по приведённой выше формуле: 0x1519 % 0x2000 - 0x10 + bank0_base = 0x1509 + 0x8000 = 0x9509 в банке 0.</p>
<p>Проверяем данные по этому адресу в IDA и убеждаемся, что этому смещению находятся правильные данные. Такие рассчёты необходимо проводить для каждого адреса, используемого в IDA.</p>
<p><strong>Арифметика</strong></p>
<p>Дальше сравним смещения экранов первого и второго уровня. Можно предположить, что все данные между этими массивами описывают первый уровень.</p>
<p>Размер первого уровня - 60x8 макроблоков, значит, размер данных между массивами экранов: 0x9509 - (0x8000 + 480) = 4905 байт, в которых и закодировано всё описание уровня.</p>
<p>Сначала этого массива идёт описание макроблоков уровня, но проблема в том, что неясно точное количество макроблоков, некоторые макроблоки выглядят неосмысленно, если открыть уровень в CadEditor</p>
<p>в режиме отображения номеров блоков и приглядеться повнимательнее, то окажется, что неправильные макроблоки имеют индексы: 16,26,36,46,56,… и 1F,2F,3F,4F,5F,…</p>
<p>Причём, макроблоки X6 используются на уровне для отрисовки колеса и динозавра-босса, так что они просто используют какую-то технику переключения видеопамяти,а макроблоки XF (и несколько последних из набора XE) дейстительно не используются, следовательно, описание макроблоков в ROM, идёт не последовательно, а с шагом 16, и самих макроблоков получается не 256, а чуть меньше:<br><img src="http://ic.pics.livejournal.com/spiiin/20318251/42638/42638_300.png" alt></p>
<p>Почему такой странный порядок описания макроблоков? Это небольшой трюк разработчиков, чтобы избежать лишней операции сдвига – один макроблок описывается 16 байтами входящих в него индексов блоков, следовательно, шаг между макроблоками составляет 16 байт адресов.</p>
<p>А это именно 4 бита, так что увеличивать старшие биты в индексе макроблока на 16, а не на 1, но по такой индекс можно сразу использовать для обращения ко второму макроблоку.</p>
<p>Позже будет замечено, что для вторых флинтстоунов, в которых размер макроблока составляет 4x2 блоков, индексы макроблоков идут в порядке с шагом 8 (т.е. сначала растут 5 старших бит, далее разряд перебрасывается в младшие), что согласуется с этой теорией.</p>
<p>На скрине видно не все макроблоки в высоту, всего “неправильных” блоков получается 26, т.е. кол-во макроблоков 256-26 = 230. Проверить это можно, если изменить следующий за последним байт описания - должен измениться первый блок - кусочек чистого голубого неба. Его абсолютный адрес вычисляется как: <em>0x1F0 + 230</em>(4<em>4) = 0x1050 (адрес маленьких блоков)</em> </p>
<p>Получаем:<br><img src="http://ic.pics.livejournal.com/spiiin/20318251/42823/42823_300.png" alt></p>
<p>Как видим, чистое небо “перекрасилось”. Значит, размер массива макроблоков 230<em>(4</em>4) = 3680 байт, а следующий за ним массив - описание блоков, начинается с адреса 0x1050. Дальше в IDA рассматриваем конец оставшегося куска данных (размером 0x9509 - 0x9040 = 1225 байт), и видим чёткий переход по адресу 93F0 - оттуда описание блоков сменяется из произольных байт сменяется чем-то ещё, состоящим только из 0,1,2 и 3. Очень похоже но то, что сначала идёт описание блоков и 4х кусочков-тайлов, а затем на каждый блок по одному байту, который указывает на индекс в субпалитре (в ней всего 2 значащих бита, что и даёт значения от 1 до 3).</p>
<p>Отсюда получается и количество самих блоков - весь массив данных до описания субпалитр, занимает 944 байта, значит, он описывает 944/4 = 236 блоков, а следом за ним идёт еще 236 байт описания палитры. Всего до описания следующего уровня осталось 45 байт (кол-во байт = 3/4 от ширины уровня, которые каким-то образом переключают палитры и загружают новые части видеопамяти при скроллинге экрана влево и вправо (теоретически, движок может позволить создать уровень, который будет выглядеть по разному при движении влево и вправо).</p>
<p>Автоматизация</p>
<p>Дальше для удобства разметки всех уровней удобно прикинуть количество макроблоков и блоков в уровне автоматически. Для этого я использую немного магии - загружу редактор CadEditor как сборку в Python с помощью модуля Python.Net, и использую Jupyter Notebook, чтобы написать интерактивный скрипт подсчёта количества макроблоков и блоков на уровне.</p>
<p>Рассчёт количества сделан из простого соображения - если пройтись по всем номерам макроблоков в массиве, описывающем экран, самый самый старший номер покажет, сколько всего макроблоков было использовано.</p>
<p>Аналогично для количества блоков - проходим по описаниям всех макроблоков и ищем самый старший индекс.<br><a target="_blank" rel="noopener" href="http://nbviewer.jupyter.org/github/spiiin/CadEditor/blob/master/JupyterCadEditor/CadEditor-FlinstonesRDH.ipynb">http://nbviewer.jupyter.org/github/spiiin/CadEditor/blob/master/JupyterCadEditor/CadEditor-FlinstonesRDH.ipynb</a></p>
<p>Для Flintstones : Surprise at The Dinosaur Peak все рассчёты аналогичны.</p>
<p>Получаем практически готовые конфиги для CadEditor’а (осталось только эмпирическим путём подобрать палитру и используемую на уровне видеопамять из доступных 16):<br><img src="http://ic.pics.livejournal.com/spiiin/20318251/43233/43233_300.png" alt></p>
<p><strong>Заметки по формату уровней</strong></p>
<p>Часто используются хитрости для уменьшения размера, причём для разных уровней - свои.</p>
<p>Для уровня замка используется полбанка видеопамяти, которые дублируются во вторую половину видеопамяти, Для некоторых подуровней одного уровня используется общая “раскладка”, например, для ночных джунглей, т.е. они используют общие наборы блоков и макроблоков, а также координатную сетку для описания объектов). </p>
<p>После разметки обнаруживается небольшое различие в экранах для европейской, американской и японской версии игры, для уровня 3 данные не влезли в первые два банка, поэтому он находится в последнем банке с данными, в котором хранятся и строки, из-за чего смещения отличаются.</p>
<p>В Surprise at the Dinosaur Peak размер макроблока уменьшен до 4x2, при этом удалось достичь того, что уровни состоят из намного меньшего числа макроблоков, при таком размере их функциональность намного увеличена.</p>
<p>В описании уровней нету данных о физике блоков, она хранится где-то среди других данных, возможно, рядом со списками объектов.</p>
<p>(<a target="_blank" rel="noopener" href="http://spiiin.livejournal.com/photo/album/924/?page=1">полноразмерные скрины</a>)</p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"Ov23liG1mZbiQOIdi91X","clientSecret":"e05812685eb741a752982b89dcf6f5b58dc10251","repo":"spiiin.github.io","owner":"spiiin","admin":["spiiin"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/1474905038/">Позже</a><a class="pagination__link pagination__next" href="/blog/1562805408/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div><!-- hexo injector body_end start -->
  <script>
  const CODE_CONFIG = {
    beautify: undefined,
    highlightCopy: undefined,
    highlightLang: undefined,
    highlightHeightLimit: undefined,
    isHighlightShrink: undefined,
    copy: {
      success: 'undefined',
      error: 'undefined',
      noSupport: 'undefined',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body></html>