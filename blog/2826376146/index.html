<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | Файберы, диспетчеры, асинки</title><meta name="description" content="&lt;a href=&quot;/blog/2550823652/&quot; title=&quot;Итераторы, колстеки, корутины&quot;&gt;Итераторы, колстеки, корутины&lt;/a&gt; -- первая часть статьи про итераторы и асинхронное программирование. В ней были перечислены особенности абстракций обхода коллекций в нескольких языках, а также описана связь между ними и возобновляемыми функциями. В конце статьи рассмотрено представление возобновляемых функций в различных языках и различная терминология для их обозначений. Дальше можно постепенно перейти к способам управления этими функциями."><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,0.1),rgba(40,44,52,0.9))}</style><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/1186660544/">Позже</a><a class="pagination__link pagination__next" href="/blog/3309518526/">Раньше</a></div><article class="article post"><h3 class="article__title">Файберы, диспетчеры, асинки</h3><div class="article__date metadata"><div class="post-info">2022/09/04</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/cpp/">cpp</a><a class="article__tags__link metadata" href="/tags/dev/">dev</a><a class="article__tags__link metadata" href="/tags/link/">link</a><a class="article__tags__link metadata" href="/tags/longread/">longread</a><a class="article__tags__link metadata" href="/tags/dascript/">dascript</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><a href="/blog/2550823652/" title="Итераторы, колстеки, корутины">Итераторы, колстеки, корутины</a> -- первая часть статьи про итераторы и асинхронное программирование. В ней были перечислены особенности абстракций обхода коллекций в нескольких языках, а также описана связь между ними и возобновляемыми функциями. В конце статьи рассмотрено представление возобновляемых функций в различных языках и различная терминология для их обозначений. Дальше можно постепенно перейти к способам управления этими функциями.

<span id="more"></span>
<h2><span id="ssylki">Ссылки</span><a href="#ssylki" class="header-anchor">#</a></h2><p>(также см. ссылки из первой статьи)<br>[1] Иван Чукич - Функциональное программирование на C++ — глава 7 Диапазоны<br>[2] Alex Davies - Async in C# 5.0<br>[3] <a target="_blank" rel="noopener" href="https://www.researchgate.net/publication/220802950_The_F_Asynchronous_Programming_Model">Don Syme - F Asynchronous Programming Model</a><br>[4] <a target="_blank" rel="noopener" href="http://www.kegel.com/c10k.html">The C10K problem</a><br>[5] <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=i0RB7UqxERE">Async await in Nim A demonstration of the flexibility metaprogramming can bring to a language</a>. Еще несколько ссылок про async в Nim - <a target="_blank" rel="noopener" href="https://nim-lang.org/blog/2014/04/21/version-094-released.html">1</a>, <a target="_blank" rel="noopener" href="https://nim-lang.org/docs/asyncdispatch.html">2</a>, <a target="_blank" rel="noopener" href="https://peterme.net/asynchronous-programming-in-nim.html">3</a><br>[6] <a target="_blank" rel="noopener" href="https://cpratt.co/async-tips-tricks/">C# async tips and tricks</a> -  sequence tasks vs parallel. Tasks return “hot”<br>[7] <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/asyncio-task.html">Python asyncio-task</a><br>[8] <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=OE45F3iKtv4">Павел Новиков — Учимся готовить C++ корутины на практике</a><br>[9] <a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2021/10132/">Meet async/await in Swift</a><br>[10] <a target="_blank" rel="noopener" href="https://marek-g.github.io/posts/projects/archive/nemerle_async_await/">Nemerle macro async/await</a>, еще одна реализация через <a target="_blank" rel="noopener" href="https://habr.com/ru/post/108184/">монады</a><br>[11] <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=yJxFPoxqzWE">“Clojure core.async” by Rich Hickey (2013)</a><br>[12] <a target="_blank" rel="noopener" href="http://hueypetersen.com/posts/2013/08/02/the-state-machines-of-core-async/">The State Machines of core.async</a><br>[13] <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=R3PZMIwXN_g">Core Async Go Macro Internals - Part I</a> - реализация goroutine-макроса в closure<br>[14] <a target="_blank" rel="noopener" href="https://github.com/scylladb/seastar/blob/master/doc/tutorial.md">Scylla DB Tutorial</a> - туториал по библиотеке c++, интенсивно использующий корутины. Еще больше статей - <a target="_blank" rel="noopener" href="https://www.scylladb.com/2020/03/26/avi-kivity-at-core-c-2019/">1</a>, <a target="_blank" rel="noopener" href="https://www.scylladb.com/2020/05/05/how-io_uring-and-ebpf-will-revolutionize-programming-in-linux/">2</a></p>
<h2><span id="asinhronnost">Асинхронность</span><a href="#asinhronnost" class="header-anchor">#</a></h2><p>Если рассматривать итераторы как абстракцию способов обхода коллекции, то в первую очередь они напоминают “умный” индекс в коллекции, который может пропускать какие-либо элементы, менять направление, или даже управляться элементами самой коллекции (например, можно описать вектором цепь Маркова, и сделать итератор, который реализует переключение состояний в этой цепи).</p>
<p>Есть ещё одно важное свойство отделения итерации от вызывающего её кода — на момент запроса следующего элемента коллекции сама коллекция не обязана существовать целиком. Процесс создания следующих элементов коллекции может быть описан в виде функции — коллекция всех натуральных чисел, передача запроса на получение элемента из файла/от внешнего устройства/по сети (само чтение данных может происходит в других потоках, которые каким-либо образом вернут данные итератору).</p>
<h2><span id="opisanie-kollekcii-v-vide-funkcii">Описание коллекции в виде функции</span><a href="#opisanie-kollekcii-v-vide-funkcii" class="header-anchor">#</a></h2><p>Простейший пример на <code>daScript</code> — бесконечная коллекция натуральных чисел, заданная в виде генератора:<br><figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #F8F8F2">var natural </span><span style="color: #FF79C6">&lt;-</span><span style="color: #F8F8F2"> generator</span><span style="color: #FF79C6">&lt;</span><span style="color: #F8F8F2">int</span><span style="color: #FF79C6">&gt;()</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">&lt;|</span><span style="color: #F8F8F2"> $</span><span style="color: #FF79C6">()</span></span>
<span class="line"><span style="color: #F8F8F2">  var i </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">1</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">while</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">true</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #FF79C6">yield</span><span style="color: #F8F8F2"> i</span></span>
<span class="line"><span style="color: #F8F8F2">    i</span><span style="color: #FF79C6">++</span></span></code></pre></div></div></figure></p>
<p>Мы не можем использовать её в цикле foreach напрямую, потому что этот цикл пытается пройти по всем элементам коллекции. Но можно сделать другой генератор, который возьмёт несколько элементов из бесконечной коллекции и остановится.</p>
<figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #F8F8F2">def take</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">var src</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2">iterator</span><span style="color: #FF79C6">&lt;</span><span style="color: #F8F8F2">auto</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">TT</span><span style="color: #FF79C6">)&gt;;</span><span style="color: #F8F8F2"> count</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2">int</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  unsafe</span></span>
<span class="line"><span style="color: #F8F8F2">    var gen </span><span style="color: #FF79C6">&lt;-</span><span style="color: #F8F8F2"> generator</span><span style="color: #FF79C6">&lt;</span><span style="color: #F8F8F2">TT</span><span style="color: #FF79C6">&gt;()</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">&lt;|</span><span style="color: #F8F8F2"> $</span><span style="color: #FF79C6">()</span></span>
<span class="line"><span style="color: #F8F8F2">      var aValue </span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2"> TT</span><span style="color: #FF79C6">-&amp;</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #FF79C6">for</span><span style="color: #F8F8F2"> i </span><span style="color: #FF79C6">in</span><span style="color: #F8F8F2"> range</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">count</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FF79C6">if</span><span style="color: #F8F8F2"> next</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">src</span><span style="color: #FF79C6">,</span><span style="color: #F8F8F2"> aValue</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">          </span><span style="color: #FF79C6">yield</span><span style="color: #F8F8F2"> aValue</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FF79C6">else</span></span>
<span class="line"><span style="color: #F8F8F2">          </span><span style="color: #FF79C6">return</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">false</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #FF79C6">return</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">false</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #FF79C6">return</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">&lt;-</span><span style="color: #F8F8F2">gen</span></span>
<span class="line"><span style="color: #FF79C6">for</span><span style="color: #F8F8F2"> num </span><span style="color: #FF79C6">in</span><span style="color: #F8F8F2"> natural </span><span style="color: #FF79C6">|&gt;</span><span style="color: #F8F8F2"> take</span><span style="color: #FF79C6">(</span><span style="color: #BD93F9">3</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">{num} </span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #6272A4">//Output: &quot;1 2 3&quot;</span></span></code></pre></div></div></figure>
<h2><span id="kompoziciya-funkciy-i-lenivye-vychisleniya">Композиция функций и ленивые вычисления</span><a href="#kompoziciya-funkciy-i-lenivye-vychisleniya" class="header-anchor">#</a></h2><p>Попробуем “просеять” натуральные числа, оставив только простые. Пример реализации функции <a target="_blank" rel="noopener" href="https://github.com/spiiin/dascript_trivial_examples/tree/main/primes/primes_mix_compile_runtime.das">prime</a> (самая быстрая реализация, без учёта потребляемой памяти — просто посчитать первые n чисел заранее в compile-time :) ).</p>
<figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #FF79C6">for</span><span style="color: #F8F8F2"> num </span><span style="color: #FF79C6">in</span><span style="color: #F8F8F2"> natural </span><span style="color: #FF79C6">|&gt;</span><span style="color: #F8F8F2"> filter</span><span style="color: #FF79C6">(@@</span><span style="color: #F8F8F2">is</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">prime</span><span style="color: #FF79C6">)</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">|&gt;</span><span style="color: #F8F8F2"> take</span><span style="color: #FF79C6">(</span><span style="color: #BD93F9">10</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">{num} </span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #6272A4">//Output: 2, 3, 5, 7, 11, 13, 17, 19, 23, 29</span></span></code></pre></div></div></figure>
<p>Можно заметить, что не существует вычисленной промежуточной коллекции <code>natural |&gt; filter(@@is_prime)</code>, которая представляла бы собой бесконечный список всех простых чисел). Вычисление следующего элемента коллекции, описанного композицией этих функций, вычисляется только по запросу этого элемента или <strong>лениво</strong> (lazy) — <code>take</code> запрашивает следующий элемент из <code>filter</code>, которая может запросить и вычислить один или несколько элементов из коллекции <code>natural</code>.</p>
<p>Если попробовать реализовать такую композицию на C++ с помощью итераторов и алгоритмов STL, окажется, что они не годятся для этого, функция <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/algorithm/copy">std::copy_if</a>, с помощью которой можно было бы провести фильтр элементов, ожидает на вход итераторы <strong>существующей</strong> коллекции, что требует создания временной копии и её заполнения элементами. Но вместо итераторов можно воспользоваться библиотекой <code>ranges</code> - <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/algorithm/ranges/copy">стандарт C++20</a>, <a target="_blank" rel="noopener" href="https://github.com/ericniebler/range-v3">range-v3</a>, она позволяет строить ленивые итераторы (<code>std::views</code>) или инплейсно изменять коллекции (<code>std::actions</code>).</p>
<figure class="shiki cpp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #FF79C6">using</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">namespace</span><span style="color: #F8F8F2"> std</span><span style="color: #FF79C6">::</span><span style="color: #F8F8F2">views;</span></span>
<span class="line"><span style="color: #FF79C6">for</span><span style="color: #F8F8F2"> (</span><span style="color: #FF79C6">int</span><span style="color: #F8F8F2"> i : </span><span style="color: #50FA7B">iota</span><span style="color: #F8F8F2">(</span><span style="color: #BD93F9">1</span><span style="color: #F8F8F2">) </span><span style="color: #FF79C6">|</span><span style="color: #F8F8F2"> </span><span style="color: #50FA7B">filter</span><span style="color: #F8F8F2">(is_prime) </span><span style="color: #FF79C6">|</span><span style="color: #F8F8F2"> </span><span style="color: #50FA7B">take</span><span style="color: #F8F8F2">(</span><span style="color: #BD93F9">10</span><span style="color: #F8F8F2">)) {</span></span>
<span class="line"><span style="color: #F8F8F2">  std</span><span style="color: #FF79C6">::</span><span style="color: #F8F8F2">cout </span><span style="color: #FF79C6">&lt;&lt;</span><span style="color: #F8F8F2"> i </span><span style="color: #FF79C6">&lt;&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C"> </span><span style="color: #E9F284">&quot;</span><span style="color: #F8F8F2">;</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span>
<span class="line"><span style="color: #6272A4">//2 3 5 7 11 13 17 19 23 29</span></span></code></pre></div></div></figure>
<h2><span id="kollekciya-kak-dannye-iz-vneshnego-istochnika">Коллекция как данные из внешнего источника</span><a href="#kollekciya-kak-dannye-iz-vneshnego-istochnika" class="header-anchor">#</a></h2><p>В отличие от всех предыдущих случаев, при получении данных от внешнего источника мы не всегда знаем когда именно данные будут получены, что приводит к следующей проблеме — что делать, если все данные готовые данные обработаны, а новых ещё нет? Как и с итераторами, возможны два основных подхода — либо вызывающий код регулярно опрашивает источник данных, есть ли новые данные для обработки, либо же источнику данных передаётся колбек, который будет вызван, когда появятся новые данные для обработки.</p>
<h2><span id="opros-istochnika-dannyh">Опрос источника данных</span><a href="#opros-istochnika-dannyh" class="header-anchor">#</a></h2><p>Игрушечная симуляция длительно выполняющейся задачи — счётчик до 100, который позволяет информировать внешний код о прогрессе каждые 10 итераций<br><figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #F8F8F2">typedef </span></span>
<span class="line"><span style="color: #F8F8F2">  ValueOrReady </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> variant</span><span style="color: #FF79C6">&lt;</span><span style="color: #F8F8F2">value</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2">int</span><span style="color: #FF79C6">;</span><span style="color: #F8F8F2"> ready</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2">bool</span><span style="color: #FF79C6">&gt;</span></span>
<span class="line"><span style="color: #FF79C6">[</span><span style="color: #F8F8F2">export</span><span style="color: #FF79C6">]</span></span>
<span class="line"><span style="color: #F8F8F2">def main</span><span style="color: #FF79C6">()</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #6272A4">//создаём генератор, который может возвращать значение или флаг &quot;значение не готово&quot;</span></span>
<span class="line"><span style="color: #F8F8F2">  var gen </span><span style="color: #FF79C6">&lt;-</span><span style="color: #F8F8F2"> generator</span><span style="color: #FF79C6">&lt;</span><span style="color: #F8F8F2">ValueOrReady</span><span style="color: #FF79C6">&gt;()</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">&lt;|</span><span style="color: #F8F8F2"> $</span><span style="color: #FF79C6">()</span></span>
<span class="line"><span style="color: #F8F8F2">    var i </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">1</span></span>
<span class="line"><span style="color: #F8F8F2">    var answer</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2"> ValueOrReady</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #FF79C6">while</span><span style="color: #F8F8F2"> i </span><span style="color: #FF79C6">&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">100</span></span>
<span class="line"><span style="color: #F8F8F2">      unsafe</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #6272A4">//каждый 10 шагов выдаём значение</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FF79C6">if</span><span style="color: #F8F8F2"> i </span><span style="color: #FF79C6">%</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">10</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">==</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">0</span></span>
<span class="line"><span style="color: #F8F8F2">          answer </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">[[</span><span style="color: #F8F8F2">ValueOrReady value </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> i</span><span style="color: #FF79C6">]]</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #6272A4">//иначе выдаём флаг &quot;работа в процессе&quot;, данных пока нет</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FF79C6">else</span></span>
<span class="line"><span style="color: #F8F8F2">          answer </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">[[</span><span style="color: #F8F8F2">ValueOrReady ready </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">false</span><span style="color: #FF79C6">]]</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #FF79C6">yield</span><span style="color: #F8F8F2"> answer</span></span>
<span class="line"><span style="color: #F8F8F2">      i</span><span style="color: #FF79C6">++</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #6272A4">//задача выполнена</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #FF79C6">return</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">false</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">for</span><span style="color: #F8F8F2"> num </span><span style="color: #FF79C6">in</span><span style="color: #F8F8F2"> gen</span></span>
<span class="line"><span style="color: #F8F8F2">    unsafe</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #FF79C6">if</span><span style="color: #F8F8F2"> num is value</span></span>
<span class="line"><span style="color: #F8F8F2">        print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">{num.value} </span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #FF79C6">else</span></span>
<span class="line"><span style="color: #F8F8F2">        print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">x </span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">\n</span><span style="color: #F1FA8C">done</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #6272A4">//Output: x x x x x x x x x 10 x x x x x x x x x 20 x x x x x x x x x 30 x x x x x x x x x 40 x x x x x x x x x 50 x x x x x x x x x 60 x x x x x x x x x 70 x x x x x x x x x 80 x x x x x x x x x 90 x x x x x x x x x</span></span>
<span class="line"><span style="color: #6272A4">//done</span></span></code></pre></div></div></figure></p>
<p>Видно, что опрос генератор требует двух специальных флагов — выполнена ли задача полностью, и готовы ли данные. Для возврата признака, готовы ли данные, использован тип <code>variant&lt;value:int; ready:bool&gt;</code> (задача возвращает либо данные, либо флаг неготовности, но не их одновременно).</p>
<p>Вместо такой искусственной задержки генератор может совершать реальную работу — например опрос сокетов операционной системы, и предоставлять не результат, а интерфейс для чтения данных, когда они будут готовы (один из подходов к решению проблемы 10000 соединений к серверу [2])</p>
<p>Такое примитивное описание асинхронной выполняемой задачи оставляет сразу серию вопросов и возможных улучшений:</p>
<ul>
<li>пока что наш “опрос” источника внешних данных заключался в том, чтобы проверить какой-то флаг, выставляемый этим источником, в основном потоке. Реальное получение данных после того, как был получен сигнал о готовности, требует синхронизации при чтении данных из источника, что можно выразить в виде паттерна с использованием примитивов синхронизации.</li>
<li>в программе может существовать несколько выполняемых задач, ожидающих данных. Где-то может существовать диспетчер, опрашивающий все ожидающие задачи, чтобы не писать цикл их опроса вручную. Диспетчер может даже раскидывать выполнение задач на несколько потоков выполнения.</li>
<li>различные ожидающие задачи могут требовать результатов других ожидающих задач. Какие-то результаты могут потребоваться раньше, какие-то позже. Есть различные способы выражения того, что в конкретном месте выполнения программа должна дождаться данных от одной или нескольких подзадач.</li>
<li>если задача полностью зависит от внешнего источника, недоступного для управления из программы, логично предусмотреть возможность её завершения не дожидаясь окончания</li>
</ul>
<h2><span id="ozhidanie-kolbekov">Ожидание колбеков</span><a href="#ozhidanie-kolbekov" class="header-anchor">#</a></h2><p>Можно переписать задачу вычисления чисел так, чтобы она информировала вызывающий код о прогрессе сама (аналог внутреннего итератора):<br><figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #F8F8F2">def makeLongCalculation</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">blk</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  var i </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">1</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">while</span><span style="color: #F8F8F2"> i </span><span style="color: #FF79C6">&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">100</span></span>
<span class="line"><span style="color: #F8F8F2">    unsafe</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #FF79C6">if</span><span style="color: #F8F8F2"> i </span><span style="color: #FF79C6">%</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">10</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">==</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">0</span></span>
<span class="line"><span style="color: #F8F8F2">        invoke</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">blk</span><span style="color: #FF79C6">,</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">[[</span><span style="color: #F8F8F2">ValueOrReady value </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> i</span><span style="color: #FF79C6">]],</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">false</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #FF79C6">else</span></span>
<span class="line"><span style="color: #F8F8F2">        invoke</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">blk</span><span style="color: #FF79C6">,</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">[[</span><span style="color: #F8F8F2">ValueOrReady ready </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">false</span><span style="color: #FF79C6">]],</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">false</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">    i</span><span style="color: #FF79C6">++</span></span>
<span class="line"><span style="color: #F8F8F2">  invoke</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">blk</span><span style="color: #FF79C6">,</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">[[</span><span style="color: #F8F8F2">ValueOrReady ready </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">false</span><span style="color: #FF79C6">]],</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">true</span><span style="color: #FF79C6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6272A4">//использование функции</span></span>
<span class="line"><span style="color: #F8F8F2">makeLongCalculation </span><span style="color: #FF79C6">&lt;|</span><span style="color: #F8F8F2"> $</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">num</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2"> ValueOrReady</span><span style="color: #FF79C6">;</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">done:</span><span style="color: #F8F8F2"> bool</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">if</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">!done</span></span>
<span class="line"><span style="color: #F8F8F2">    unsafe</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #FF79C6">if</span><span style="color: #F8F8F2"> num is value</span></span>
<span class="line"><span style="color: #F8F8F2">        print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">{num.value} </span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #FF79C6">else</span></span>
<span class="line"><span style="color: #F8F8F2">        print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">x </span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">else</span></span>
<span class="line"><span style="color: #F8F8F2">    print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">\n</span><span style="color: #F1FA8C">done</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #6272A4">//Output: x x x x x x x x x 10 x x x x x x x x x 20 x x x x x x x x x 30 x x x x x x x x x 40 x x x x x x x x x 50 x x x x x x x x x 60 x x x x x x x x x 70 x x x x x x x x x 80 x x x x x x x x x 90 x x x x x x x x x</span></span>
<span class="line"><span style="color: #6272A4">//done</span></span></code></pre></div></div></figure></p>
<p>Таким способом часто выглядят функции запроса данных по сети — в колбек приходит информация о массиве частично-скачанных данных, и флаги — ожидать ли ещё данных, и были ли ошибки.</p>
<p>Рассмотрим эволюцию паттернов работы с колбеками на примере .Net, в дань тому, что в F# и затем в C# впервые ушли от них к более свежим подходам. Microsoft в C# называет паттерны асинхронного вызова с использованием колбеков умными аббревиатурами <code>EAP</code> и <code>APM</code>. Примеры кода:</p>
<figure class="shiki csharp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #6272A4">//.NET 1, APM (Asynchronous Programming Model)</span></span>
<span class="line"><span style="color: #FF79C6">file</span><span style="color: #F8F8F2">.</span><span style="color: #50FA7B">BeginCall</span><span style="color: #F8F8F2">(buffer, </span><span style="color: #BD93F9">0</span><span style="color: #F8F8F2">, maxLength, </span><span style="color: #FFB86C; font-style: italic">asyncResult</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">=&gt;</span><span style="color: #F8F8F2"> {</span></span>
<span class="line"><span style="color: #6272A4">  //вызовется через какое-то время</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">int</span><span style="color: #F8F8F2"> numBytesRead </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> file.</span><span style="color: #50FA7B">EndRead</span><span style="color: #F8F8F2">(asyncResult);</span></span>
<span class="line"><span style="color: #F8F8F2">}, </span><span style="color: #BD93F9">null</span><span style="color: #F8F8F2">)</span></span></code></pre></div></div></figure>
<p>В некоторых вызовах неочевидно, в каком контексте будет вызван колбек (из какого потока, нужно ли синхронизироваться и передавать результат обратно в поток, в котором будет обработан результат)<br>Если же нужно из колбека вызвать еще несколько вложенных операций, получается колбек-хелл, с жутким синтаксисом и смутным представлением контекста выполнения каждого из колбеков.</p>
<figure class="shiki csharp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #6272A4">//.NET 2, APM (Asynchronous Programming Model)</span></span>
<span class="line"><span style="color: #F8F8F2">webClient.DownloadStringCompleted </span><span style="color: #FF79C6">+=</span><span style="color: #F8F8F2"> (</span><span style="color: #FFB86C; font-style: italic">sender</span><span style="color: #F8F8F2">, </span><span style="color: #FFB86C; font-style: italic">args</span><span style="color: #F8F8F2">) </span><span style="color: #FF79C6">=&gt;</span><span style="color: #F8F8F2"> {</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">string</span><span style="color: #F8F8F2"> html </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> args.Result;</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span>
<span class="line"><span style="color: #F8F8F2">webClient.DownloadStringAsync(new Uri(&quot;http:</span><span style="color: #6272A4">//example.com&quot;));</span></span></code></pre></div></div></figure>
<p>Примерно то же самое, но с необходимостью явно оторвать колбек от вызова (и возможностью навесить несколько обработчиков) — чуть меньше “лесенок” в коде</p>
<h2><span id="future-async-await">Future, async/await</span><a href="#future-async-await" class="header-anchor">#</a></h2><p>Future (или Task в C#) — обёртка для результата, которая запускает задачу, и возвращает управление вызывающему коду. Код сам может решить что ему делать с объектом задачи, когда остановиться, чтобы дождаться результата, или как скомбинировать полученный объект с другими задачами.</p>
<figure class="shiki csharp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #6272A4">//.NET 4</span></span>
<span class="line"><span style="color: #8BE9FD; font-style: italic">Task</span><span style="color: #F8F8F2">&lt;</span><span style="color: #FF79C6">string</span><span style="color: #F8F8F2">&gt; htmlTask </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> webClient.</span><span style="color: #50FA7B">DownloadStringTaskAsync</span><span style="color: #F8F8F2">(url);</span></span>
<span class="line"><span style="color: #6272A4">//тот можно выполнить код, которому не требуется результат hmtlTask</span></span>
<span class="line"><span style="color: #6272A4">//...</span></span>
<span class="line"><span style="color: #FF79C6">string</span><span style="color: #F8F8F2"> html </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> htmlTask.Result; </span><span style="color: #6272A4">//тут блокировка до ожидания результата</span></span>
<span class="line"><span style="color: #6272A4">//или прикрепить к задаче продолжение</span></span>
<span class="line"><span style="color: #F8F8F2">htmlTask.</span><span style="color: #50FA7B">ContinueWith</span><span style="color: #F8F8F2">(</span><span style="color: #FFB86C; font-style: italic">task</span><span style="color: #FF79C6">=&gt;</span><span style="color: #F8F8F2"> {</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">string</span><span style="color: #F8F8F2"> html </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> task.Result;</span></span>
<span class="line"><span style="color: #F8F8F2">})</span></span></code></pre></div></div></figure>
<p>Следующий шаг, сделанный в F# и перенятый в других языках — продвинутый синтаксический сахар, который позволяет записать <code>ContinueWith</code> не в виде лямбда-функции, а кодом, который выглядит, ка<br><figure class="shiki csharp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #6272A4">//.NET 5</span></span>
<span class="line"><span style="color: #8BE9FD; font-style: italic">Task</span><span style="color: #F8F8F2">&lt;</span><span style="color: #FF79C6">string</span><span style="color: #F8F8F2">&gt; htmlTask </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> webClient.</span><span style="color: #50FA7B">DownloadStringTaskAsync</span><span style="color: #F8F8F2">(url);</span></span>
<span class="line"><span style="color: #FF79C6">string</span><span style="color: #F8F8F2"> html </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">await</span><span style="color: #F8F8F2"> htmlTask; </span><span style="color: #6272A4">//то же что и в прошлом примере с ContinueWith</span></span>
<span class="line"><span style="color: #50FA7B">doSomething</span><span style="color: #F8F8F2">(html)             </span><span style="color: #6272A4">//строки ниже await также &quot;переписываются&quot; внутрь ContinueWith</span></span></code></pre></div></div></figure></p>
<p>Другие языки с async/await в похожем виде адаптируют эти идеи из C#</p>
<ul>
<li>[5] - вкручивание их в Nim синтаксическими макросами.</li>
<li>[8] приводится пример разбора устройства Task в стандарте C++</li>
<li>[9] Swift. Достаточно подробное объяснение, тайминги<br>22:14 — трансформация кода на колбеках в async код<br>22:53 — про “цвета” функций<br>30:38 — continuation pattern cc/resume<br>32:19 — сохранение continuation %)</li>
<li>[10] Nemerle</li>
<li>[11] Closure, [12]<br> 8:24 C# async, linear code -&gt; callbacks + state machine, обзор подходов async и channel</li>
</ul>
<p>Проще говоря, <code>co_await</code> в C++ позволяет записать:<br><figure class="shiki cpp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #8BE9FD; font-style: italic">task</span><span style="color: #F8F8F2">&lt;&gt; </span><span style="color: #50FA7B">tcp_echo_server</span><span style="color: #F8F8F2">() {</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">char</span><span style="color: #F8F8F2"> data[</span><span style="color: #BD93F9">1024</span><span style="color: #F8F8F2">];</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">while</span><span style="color: #F8F8F2"> (</span><span style="color: #BD93F9">true</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #FF79C6">size_t</span><span style="color: #F8F8F2"> n </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">co_await</span><span style="color: #F8F8F2"> socket.</span><span style="color: #50FA7B">async_read_some</span><span style="color: #F8F8F2">(</span><span style="color: #50FA7B">buffer</span><span style="color: #F8F8F2">(data));</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #FF79C6">co_await</span><span style="color: #F8F8F2"> </span><span style="color: #50FA7B">async_write</span><span style="color: #F8F8F2">(socket, </span><span style="color: #50FA7B">buffer</span><span style="color: #F8F8F2">(data, n));</span></span>
<span class="line"><span style="color: #F8F8F2">    std</span><span style="color: #FF79C6">::</span><span style="color: #F8F8F2">cout </span><span style="color: #FF79C6">&lt;&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">resended</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span></span>
<span class="line"><span style="color: #F8F8F2">  }</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span></code></pre></div></div></figure><br>вместо чего-то типа:<br><figure class="shiki cpp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #F8F8F2">socket.</span><span style="color: #50FA7B">async_read_some</span><span style="color: #F8F8F2">(</span><span style="color: #50FA7B">buffer</span><span style="color: #F8F8F2">(data)).</span><span style="color: #50FA7B">continueWith</span><span style="color: #F8F8F2">([</span><span style="color: #FF79C6">&amp;</span><span style="color: #F8F8F2">](</span><span style="color: #FF79C6">auto</span><span style="color: #F8F8F2"> </span><span style="color: #FFB86C; font-style: italic">task</span><span style="color: #F8F8F2">){</span></span>
<span class="line"><span style="color: #F8F8F2">  n </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> task.</span><span style="color: #50FA7B">result</span><span style="color: #F8F8F2">();</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #50FA7B">async_write</span><span style="color: #F8F8F2">(socket, </span><span style="color: #50FA7B">buffer</span><span style="color: #F8F8F2">(data, n)).</span><span style="color: #50FA7B">continueWith</span><span style="color: #F8F8F2">([</span><span style="color: #FF79C6">&amp;</span><span style="color: #F8F8F2">](</span><span style="color: #FF79C6">auto</span><span style="color: #F8F8F2"> </span><span style="color: #FFB86C; font-style: italic">task</span><span style="color: #F8F8F2">){</span></span>
<span class="line"><span style="color: #F8F8F2">    std</span><span style="color: #FF79C6">::</span><span style="color: #F8F8F2">cout </span><span style="color: #FF79C6">&lt;&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">resended</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span></span>
<span class="line"><span style="color: #F8F8F2">  });</span></span>
<span class="line"><span style="color: #F8F8F2">});</span></span></code></pre></div></div></figure><br>(специально не хочу вникать в особенности именно С++ реализации переписывания из-за её вырвиглазности, при желании можно покопаться в этом в [8]).</p>
<p>Можно рассматривать оператор <code>co_await</code> как возможность приостановить выполнение и “подписаться” на уведомление о завершении или приостановке выражения-аргумента.</p>
<p>Разбор некоторых проблем сочетания синхронных функций с асинхронными в статье <a target="_blank" rel="noopener" href="http://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/">What Color is Your Function?</a>. Библиотечные функции для синхронной и асинхронной работы “разных цветов”, и необходимо иметь 2 версии функций для того, чтобы вызывающий код мог выбирать из них (к примеру, синхронный <a target="_blank" rel="noopener" href="https://github.com/redis/redis-py">redispy</a> и его асихронный двойник <a target="_blank" rel="noopener" href="https://github.com/aio-libs/aioredis-py">aioredis</a>, или асинхронная копия <a target="_blank" rel="noopener" href="https://pypi.org/project/asynctkinter/">tkinter</a>, <a target="_blank" rel="noopener" href="https://github.com/aio-libs">десятки их</a>). Язык <code>Zig</code> кажется, один из немногих, в котором реализована поддержка универсальных бесцветных функций, которые могут работать синхронно или асинхронно, решение переносится на вызывающий кода (см ссылки [26], [27] в первой части статьи).</p>
<p>Интересно, насколько просто добавляются подобные операторы в языки с поддержкой синтаксических макросов. Например, модуль <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/138f625c7f95943341a5e96cca114ae7d0772ba6/daslib/coroutines.das">coroutine</a> в <code>daScript</code>, реализующий макрос <code>co_await</code>, и примеры его использования <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/138f625c7f95943341a5e96cca114ae7d0772ba6/examples/test/misc/coroutines_example_2.das">1</a> и <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/110bb4313fa479d7b837413700ed7f6c68601e24/examples/test/misc/coroutines_example.das">2</a>.</p>
<p>Первый пример — последовательная передача управления между двумя функциями:<br><figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #FF79C6">[</span><span style="color: #F8F8F2">coroutine</span><span style="color: #FF79C6">]</span></span>
<span class="line"><span style="color: #F8F8F2">def subcr</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">name</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2">string</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">{name} sub 1</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  co</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">continue</span><span style="color: #FF79C6">()</span></span>
<span class="line"><span style="color: #F8F8F2">  print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">{name} sub 2</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  co</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">continue</span><span style="color: #FF79C6">()</span></span>
<span class="line"><span style="color: #F8F8F2">  print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">{name} sub 3</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF79C6">[</span><span style="color: #F8F8F2">coroutine</span><span style="color: #FF79C6">]</span></span>
<span class="line"><span style="color: #F8F8F2">def coroutine</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">example</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">name</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2">string</span><span style="color: #FF79C6">;</span><span style="color: #F8F8F2">count</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2">int</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">{name} step 1</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  co</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">continue</span><span style="color: #FF79C6">()</span></span>
<span class="line"><span style="color: #F8F8F2">  print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">{name} step 2</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  co</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">continue</span><span style="color: #FF79C6">()</span></span>
<span class="line"><span style="color: #F8F8F2">  co</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">await </span><span style="color: #FF79C6">&lt;|</span><span style="color: #F8F8F2"> subcr</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">name</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  co</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">continue</span><span style="color: #FF79C6">()</span></span>
<span class="line"><span style="color: #F8F8F2">  print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">{name} step 3</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  co</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">continue</span><span style="color: #FF79C6">()</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">for</span><span style="color: #F8F8F2"> i </span><span style="color: #FF79C6">in</span><span style="color: #F8F8F2"> range</span><span style="color: #FF79C6">(</span><span style="color: #BD93F9">4</span><span style="color: #FF79C6">,</span><span style="color: #BD93F9">4</span><span style="color: #FF79C6">+</span><span style="color: #F8F8F2">count</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">    print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">{name} step {i}</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">    co</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">continue</span><span style="color: #FF79C6">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF79C6">[</span><span style="color: #F8F8F2">export</span><span style="color: #FF79C6">]</span></span>
<span class="line"><span style="color: #F8F8F2">def main</span></span>
<span class="line"><span style="color: #F8F8F2">    var crs </span><span style="color: #FF79C6">&lt;-</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">[{</span><span style="color: #F8F8F2">auto</span></span>
<span class="line"><span style="color: #F8F8F2">        coroutine</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">example</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">co1</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">,</span><span style="color: #BD93F9">1</span><span style="color: #FF79C6">);</span></span>
<span class="line"><span style="color: #F8F8F2">        coroutine</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">example</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">co2</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">,</span><span style="color: #BD93F9">2</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #FF79C6">}]</span></span>
<span class="line"><span style="color: #F8F8F2">    cr</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">run</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">all</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">crs</span><span style="color: #FF79C6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6272A4">//Output:</span></span>
<span class="line"><span style="color: #6272A4">//co2 step 1</span></span>
<span class="line"><span style="color: #6272A4">//co1 step 1</span></span>
<span class="line"><span style="color: #6272A4">//co2 step 2</span></span>
<span class="line"><span style="color: #6272A4">//co1 step 2</span></span>
<span class="line"><span style="color: #6272A4">//co2 sub 1</span></span>
<span class="line"><span style="color: #6272A4">//co1 sub 1</span></span>
<span class="line"><span style="color: #6272A4">//co2 sub 2</span></span>
<span class="line"><span style="color: #6272A4">//co1 sub 2</span></span>
<span class="line"><span style="color: #6272A4">//co2 sub 3</span></span>
<span class="line"><span style="color: #6272A4">//co1 sub 3</span></span>
<span class="line"><span style="color: #6272A4">//co2 step 3</span></span>
<span class="line"><span style="color: #6272A4">//co1 step 3</span></span>
<span class="line"><span style="color: #6272A4">//co2 step 4</span></span>
<span class="line"><span style="color: #6272A4">//co1 step 4</span></span>
<span class="line"><span style="color: #6272A4">//co2 step 5</span></span></code></pre></div></div></figure></p>
<p>Второй пример — это внутренний итератор по дереву из первой части статьи (раздел <strong><code>Файберы</code></strong>), оформленный в виде корутины:<br><figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #FF79C6">[</span><span style="color: #F8F8F2">coroutine</span><span style="color: #FF79C6">]</span></span>
<span class="line"><span style="color: #F8F8F2">def each</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">async</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">tree </span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2"> Tree?</span><span style="color: #FF79C6">)</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2"> int</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">if</span><span style="color: #F8F8F2"> tree.left </span><span style="color: #FF79C6">!=</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">null</span></span>
<span class="line"><span style="color: #F8F8F2">    co</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">await </span><span style="color: #FF79C6">&lt;|</span><span style="color: #F8F8F2"> each</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">async</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">tree.left</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">yield</span><span style="color: #F8F8F2"> tree.data</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">if</span><span style="color: #F8F8F2"> tree.right </span><span style="color: #FF79C6">!=</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">null</span></span>
<span class="line"><span style="color: #F8F8F2">    co</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">await </span><span style="color: #FF79C6">&lt;|</span><span style="color: #F8F8F2"> each</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">async</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">tree.right</span><span style="color: #FF79C6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF79C6">for</span><span style="color: #F8F8F2"> t </span><span style="color: #FF79C6">in</span><span style="color: #F8F8F2"> each</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">async</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">tree</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">{t}</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span></code></pre></div></div></figure></p>
<p>Макрос corountine превращает функцию в генератор, который может быть приостановлен и возобновлён. Как показывает пример, асинхронные значения могут возвращаться в том числе и из рекурсивной функции. Теперь можно как в <code>ruby</code>, возвращать управление из вложенных функций!</p>
<h2><span id="kanaly">Каналы</span><a href="#kanaly" class="header-anchor">#</a></h2><p>Отойдём ненадолго от асинхронных функций, и посмотрим на работу с потоками. В <code>daScript</code> функции для работы с ними собраны в модуле <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/d60f0a310086458d28bf4726e93aa0e6c1e06abe/daslib/jobque_boost.das">jobque_boost</a>. Примеры использования - <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/fdc48d4d4cfc46f08f0ca2fd8938a05896b973a6/examples/test/unit_tests/test_job_que.das">test_job_que</a> и <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/test/misc/producer-consumer.das">produser-consumer</a>.</p>
<p>Новый поток создаётся функцией <code>new_thread</code>, а передача данных осуществляется через каналы (<code>channel</code>), которые объединяют примитив синхронизации (мьютекс) и результат, который может быть отправлен в канал из одного потока и принят из другого.</p>
<figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #FF79C6">struct</span><span style="color: #F8F8F2"> Answer</span></span>
<span class="line"><span style="color: #F8F8F2">    text</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2">string</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">def work</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">in</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">thread</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">var channel</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #6272A4">//создаём потока (в реальном коде нужно обернуть в job, чтобы иметь возможность дождаться завершения)</span></span>
<span class="line"><span style="color: #F8F8F2">new</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">thread </span><span style="color: #FF79C6">&lt;|</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">@</span></span>
<span class="line"><span style="color: #F8F8F2">    print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">in thread</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #FF79C6">for</span><span style="color: #F8F8F2"> i </span><span style="color: #FF79C6">in</span><span style="color: #F8F8F2"> range</span><span style="color: #FF79C6">(</span><span style="color: #BD93F9">3</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">      channel </span><span style="color: #FF79C6">|&gt;</span><span style="color: #F8F8F2"> push</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">clone</span><span style="color: #FF79C6">([[</span><span style="color: #F8F8F2">Answer text</span><span style="color: #FF79C6">=</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">work in progress {i}</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">]])</span><span style="color: #F8F8F2">  </span><span style="color: #6272A4">//передаём данные в канал</span></span>
<span class="line"><span style="color: #F8F8F2">      sleep</span><span style="color: #FF79C6">(</span><span style="color: #BD93F9">1000</span><span style="color: #F8F8F2">u</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">    channel </span><span style="color: #FF79C6">|&gt;</span><span style="color: #F8F8F2"> notify</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">and</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">release                                    </span><span style="color: #6272A4">//закрываем канал</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #6272A4">//completion |&gt; notify_and_release</span></span>
<span class="line"><span style="color: #F8F8F2">    print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">done thread</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">  print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">work_in_thread done</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF79C6">[</span><span style="color: #F8F8F2">export</span><span style="color: #FF79C6">]</span></span>
<span class="line"><span style="color: #F8F8F2">def main</span></span>
<span class="line"><span style="color: #F8F8F2">  with</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">channel</span><span style="color: #FF79C6">(</span><span style="color: #BD93F9">1</span><span style="color: #FF79C6">)</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">&lt;|</span><span style="color: #F8F8F2"> $</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">channel</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">    work</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">in</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">thread</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">channel</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">    print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">thread created</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">    for</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">each</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">channel</span><span style="color: #FF79C6">)</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">&lt;|</span><span style="color: #F8F8F2"> $</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">ans</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2">Answer#</span><span style="color: #FF79C6">)</span><span style="color: #F8F8F2">              </span><span style="color: #6272A4">//принимаем данные из канала</span></span>
<span class="line"><span style="color: #F8F8F2">        print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">result from thread: {ans.text}</span><span style="color: #FF79C6">\n</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">    print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">done</span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #6272A4">//Output</span></span>
<span class="line"><span style="color: #6272A4">//work_in_thread done</span></span>
<span class="line"><span style="color: #6272A4">//thread created</span></span>
<span class="line"><span style="color: #6272A4">//in thread</span></span>
<span class="line"><span style="color: #6272A4">//result from thread: work in progress 0</span></span>
<span class="line"><span style="color: #6272A4">//result from thread: work in progress 1</span></span>
<span class="line"><span style="color: #6272A4">//result from thread: work in progress 2</span></span>
<span class="line"><span style="color: #6272A4">//done thread</span></span>
<span class="line"><span style="color: #6272A4">//done</span></span></code></pre></div></div></figure>
<p>Каналы по интерфейсу похожи на итераторы, однако в <code>dascript</code> не встроены в язык, поэтому работают не с встроенной функцией <code>for</code>, а с функцией из модуля joque_boost <code>for_each</code>, которая на очередной итерации достаёт из канала очередное значение или блокирует поток до тех пор, пока канал пуст. Итерация заканчивается после того, как канал будет закрыт (<code>release/notify_and_release</code>).</p>
<p>Но можно попробовать переписать код так, чтобы работа выполнялась в потоке, но была спрятана внутри асинхронной функции-корутине, которая предоставляет интерфейс в виде стандартного итератора. Используем предыдущий игрушечный пример с асинхронным счётчиком.<br><figure class="shiki fsharp"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #F8F8F2">require daslib</span><span style="color: #FF79C6">/</span><span style="color: #F8F8F2">coroutines</span></span>
<span class="line"><span style="color: #F8F8F2">require daslib</span><span style="color: #FF79C6">/</span><span style="color: #F8F8F2">jobque</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">boost</span></span>
<span class="line"><span style="color: #F8F8F2">require fio</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">typedef </span></span>
<span class="line"><span style="color: #F8F8F2">    ValueOrReady </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> variant</span><span style="color: #FF79C6">&lt;</span><span style="color: #F8F8F2">value</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2">int</span><span style="color: #FF79C6">;</span><span style="color: #F8F8F2"> ready</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2">bool</span><span style="color: #FF79C6">&gt;</span></span>
<span class="line"><span style="color: #FF79C6">struct</span><span style="color: #F8F8F2"> Answer</span></span>
<span class="line"><span style="color: #F8F8F2">    value</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2">int</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">def work</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">in</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">thread</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">var channel</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2"> Channel?</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">    new</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">thread </span><span style="color: #FF79C6">&lt;|</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">@</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FF79C6">for</span><span style="color: #F8F8F2"> i </span><span style="color: #FF79C6">in</span><span style="color: #F8F8F2"> range</span><span style="color: #FF79C6">(</span><span style="color: #BD93F9">100</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #FF79C6">if</span><span style="color: #F8F8F2"> i </span><span style="color: #FF79C6">%</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">10</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">==</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">0</span></span>
<span class="line"><span style="color: #F8F8F2">                channel </span><span style="color: #FF79C6">|&gt;</span><span style="color: #F8F8F2"> push</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">clone</span><span style="color: #FF79C6">([[</span><span style="color: #F8F8F2">Answer value</span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2">i</span><span style="color: #FF79C6">]])</span></span>
<span class="line"><span style="color: #F8F8F2">            sleep</span><span style="color: #FF79C6">(</span><span style="color: #BD93F9">10</span><span style="color: #F8F8F2">u</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">        channel </span><span style="color: #FF79C6">|&gt;</span><span style="color: #F8F8F2"> append</span><span style="color: #FF79C6">(</span><span style="color: #BD93F9">1</span><span style="color: #FF79C6">)</span><span style="color: #F8F8F2"> </span><span style="color: #6272A4">//create buffer to inform that channel finish send data increase size to satisfy assert inside channel::release </span></span>
<span class="line"><span style="color: #F8F8F2">        channel </span><span style="color: #FF79C6">|&gt;</span><span style="color: #F8F8F2"> release   </span><span style="color: #6272A4">//we need to call release satisfy the condition of the ChannelAndStatusCapture macro </span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #6272A4">//completion |&gt; notify_and_release //for thread completion logic</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF79C6">[</span><span style="color: #F8F8F2">coroutine</span><span style="color: #FF79C6">]</span></span>
<span class="line"><span style="color: #F8F8F2">def makeLongCalculationInThread</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">work</span><span style="color: #FF79C6">)</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2"> ValueOrReady</span></span>
<span class="line"><span style="color: #F8F8F2">    var channel </span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2"> Channel?</span></span>
<span class="line"><span style="color: #F8F8F2">    unsafe </span><span style="color: #FF79C6">{</span><span style="color: #F8F8F2"> channel </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> channel</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">create</span><span style="color: #FF79C6">();</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">}</span></span>
<span class="line"><span style="color: #F8F8F2">    invoke</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">work</span><span style="color: #FF79C6">,</span><span style="color: #F8F8F2"> channel</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #FF79C6">while</span><span style="color: #F8F8F2"> channel.size </span><span style="color: #FF79C6">==</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">0</span><span style="color: #F8F8F2"> </span><span style="color: #6272A4">// channel.size==1 is a signal to stop receiving</span></span>
<span class="line"><span style="color: #F8F8F2">        sleep</span><span style="color: #FF79C6">(</span><span style="color: #BD93F9">10</span><span style="color: #F8F8F2">u</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">        var answer</span><span style="color: #FF79C6">:</span><span style="color: #F8F8F2"> ValueOrReady</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FF79C6">if</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">!</span><span style="color: #F8F8F2">channel.isEmpty</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #FF79C6">let</span><span style="color: #F8F8F2"> void_data </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">builtin</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">channel</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">pop</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">channel</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">            unsafe</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #FF79C6">let</span><span style="color: #F8F8F2"> typed_data </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> reinterpret</span><span style="color: #FF79C6">&lt;</span><span style="color: #F8F8F2">Answer?#</span><span style="color: #FF79C6">&gt;</span><span style="color: #F8F8F2"> void</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">data</span></span>
<span class="line"><span style="color: #F8F8F2">                answer </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">[[</span><span style="color: #F8F8F2">ValueOrReady value </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> typed</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">data.value</span><span style="color: #FF79C6">]]</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FF79C6">else</span></span>
<span class="line"><span style="color: #F8F8F2">            answer </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">[[</span><span style="color: #F8F8F2">ValueOrReady ready </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">false</span><span style="color: #FF79C6">]]</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FF79C6">yield</span><span style="color: #F8F8F2"> answer</span></span>
<span class="line"><span style="color: #F8F8F2">    unsafe </span><span style="color: #FF79C6">{</span><span style="color: #F8F8F2"> channel</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">remove</span><span style="color: #FF79C6">(</span><span style="color: #F8F8F2">channel</span><span style="color: #FF79C6">);</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">}</span></span>
<span class="line"><span style="color: #F8F8F2">        </span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF79C6">[</span><span style="color: #F8F8F2">export</span><span style="color: #FF79C6">]</span></span>
<span class="line"><span style="color: #F8F8F2">def main</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #FF79C6">for</span><span style="color: #F8F8F2"> num </span><span style="color: #FF79C6">in</span><span style="color: #F8F8F2"> makeLongCalculationInThread</span><span style="color: #FF79C6">(@@</span><span style="color: #F8F8F2">work</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">in</span><span style="color: #FF79C6">_</span><span style="color: #F8F8F2">thread</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FF79C6">if</span><span style="color: #F8F8F2"> num is value</span></span>
<span class="line"><span style="color: #F8F8F2">            print</span><span style="color: #FF79C6">(</span><span style="color: #E9F284">&quot;</span><span style="color: #F1FA8C">{num as value} </span><span style="color: #E9F284">&quot;</span><span style="color: #FF79C6">)</span></span>
<span class="line"><span style="color: #6272A4">//Output (async):</span></span>
<span class="line"><span style="color: #6272A4">//0 10 20 30 40 50 60 70 80 90</span></span></code></pre></div></div></figure></p>
<p><em>channel_create и channel_remove тут - функции, добавленные в библиотеку работы с каналами, потому что стандартное и безопасное api каналов daScript (with_channel) предоставляет доступ к созданному каналу только внутри блока, а из блока нельзя возвращать значение с помощью yield</em></p>
<p>Теперь внешний интерфейс — это асинхронная функция,  которая запускает вычисление в потоке и возвращает управление, но сохранит результат вычислений из потока в канале, как только он будет готов. Основной поток при этом не блокируется и может продолжать выполнение, до тех пор пока этот результат не потребуется. Когда результат потребуется — функция main либо приостановится, чтобы его дождаться, либо сразу прочитает его из канала, если он уже готов.</p>
<h2><span id="communicating-sequential-processes">Communicating sequential processes</span><a href="#communicating-sequential-processes" class="header-anchor">#</a></h2><p>Каналы повсеместно используются в <code>Go</code>, примитивы и паттерны работы с ними рассмотрены в [22] и [23] по ссылкам в первой части статьи (теорию по работе с каналами можно гуглить по аббревиатуре <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Communicating_sequential_processes">CSP</a>). Поиграться с примерами в браузере в можно <a target="_blank" rel="noopener" href="https://go.dev/tour/concurrency/1">тут</a>. Go позволяет создавать буферизированные и небуферизированные каналы. Отличие в том, что при попытке отправить второе сообщение в канал, пока не прочитано первое, тред блокируется до тех пор, пока сообщение не будет прочитано. Каналы в <code>daScript</code> буферизированы, так что можно отправить сразу несколько сообщений без блокировки отправителя, даже если читатель ещё не принял эти сообщения.</p>
<p>В <code>Go</code> есть удобные примитивы для соединения выходов нескольких каналов:<br><img src="/blog/2826376146/dataflow.png" alt><br><figure class="shiki go"><div class="codeblock"><div class="code"><pre class="shiki dracula"><code><span class="line"><span style="color: #FF79C6">func</span><span style="color: #F8F8F2"> </span><span style="color: #50FA7B">Funnel_receiveOrTimeout</span><span style="color: #F8F8F2">(c &lt;-</span><span style="color: #FF5555; font-style: italic; text-decoration: underline"> </span><span style="color: #F8F8F2">chan </span><span style="color: #8BE9FD; font-style: italic">int</span><span style="color: #F8F8F2">, duration time.Duration) (data </span><span style="color: #8BE9FD; font-style: italic">int</span><span style="color: #F8F8F2">, more, ok </span><span style="color: #8BE9FD; font-style: italic">bool</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">select</span><span style="color: #F8F8F2"> {</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #FF79C6">case</span><span style="color: #F8F8F2"> data, more </span><span style="color: #FF79C6">=</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">&lt;-</span><span style="color: #F8F8F2"> c :       </span><span style="color: #6272A4">//канал с данными</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #FF79C6">return</span><span style="color: #F8F8F2"> data, more, </span><span style="color: #BD93F9">true</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #FF79C6">case</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">&lt;-</span><span style="color: #F8F8F2"> time.</span><span style="color: #8BE9FD">After</span><span style="color: #F8F8F2">(duration):  </span><span style="color: #6272A4">//канал таймаута, выдаёт сообщение после указанного времени</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #FF79C6">return</span><span style="color: #F8F8F2"> </span><span style="color: #BD93F9">0</span><span style="color: #F8F8F2">, </span><span style="color: #BD93F9">true</span><span style="color: #F8F8F2">, </span><span style="color: #BD93F9">false</span></span>
<span class="line"><span style="color: #F8F8F2">  }</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF79C6">func</span><span style="color: #F8F8F2"> </span><span style="color: #50FA7B">Fanout</span><span style="color: #F8F8F2">(in &lt;-</span><span style="color: #FF5555; font-style: italic; text-decoration: underline"> </span><span style="color: #F8F8F2">chan </span><span style="color: #8BE9FD; font-style: italic">int</span><span style="color: #F8F8F2">, out1, out2 </span><span style="color: #FF79C6">chan</span><span style="color: #F8F8F2"> </span><span style="color: #8BE9FD; font-style: italic">int</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #FF79C6">for</span><span style="color: #F8F8F2"> data </span><span style="color: #FF79C6">:=</span><span style="color: #F8F8F2"> </span><span style="color: #FF79C6">range</span><span style="color: #F8F8F2"> in { </span><span style="color: #6272A4">//получает новые данные</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #FF79C6">select</span><span style="color: #F8F8F2"> {             </span><span style="color: #6272A4">//отправляет в первый попавшийся незаблокированный канал</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #FF79C6">case</span><span style="color: #F8F8F2"> out1 </span><span style="color: #FF79C6">&lt;-</span><span style="color: #F8F8F2"> data</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #FF79C6">case</span><span style="color: #F8F8F2"> out2 </span><span style="color: #FF79C6">&lt;-</span><span style="color: #F8F8F2"> data</span></span>
<span class="line"><span style="color: #F8F8F2">    }</span></span>
<span class="line"><span style="color: #F8F8F2">  }</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span></code></pre></div></div></figure></p>
<p><code>select</code> в первом случае позволяет либо получить сообщение с данными из канала, либо сообщение из канала таймаута, если данных не поступило в течение определенного времени. Во втором — отправить данные в первый свободный канал из списка.</p>
<p><code>Go</code> также отличается тем, что имеет встроенный диспетчер горутин, который распределяет выполнений по нескольким потокам. Таким образом горутины в го — это корутины, которые могут быть выполнены или перенесены в другой поток. Выполнение горутины приостанавливается при ожидании при ожиданнии данных из канала.</p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"Ov23liG1mZbiQOIdi91X","clientSecret":"e05812685eb741a752982b89dcf6f5b58dc10251","repo":"spiiin.github.io","owner":"spiiin","admin":["spiiin"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/1186660544/">Позже</a><a class="pagination__link pagination__next" href="/blog/3309518526/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div><!-- hexo injector body_end start -->
  <script>
  const CODE_CONFIG = {
    beautify: undefined,
    highlightCopy: undefined,
    highlightLang: undefined,
    highlightHeightLimit: undefined,
    isHighlightShrink: undefined,
    copy: {
      success: 'undefined',
      error: 'undefined',
      noSupport: 'undefined',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body></html>