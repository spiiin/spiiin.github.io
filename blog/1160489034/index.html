<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | daScript in imaginery world</title><meta name="description" content="&lt;p&gt;Мой собственный способ измерить выразительность и скорость языка — решить на нём “задачу Джеймса Бонда младшего”, выдуманную головоломку из игры на NES &lt;code&gt;James Bond Jr&lt;/code&gt; (&lt;a href=&quot;https://youtu.be/Kzu_cGHFqM8?t=1290&quot;&gt;видео&lt;/a&gt;). Несмотря на игрушечность задачи, кажется, это неплохой тест нового языка. Это веселее, чем реализовывать абстрактный поиск в ширину/глубину. Задачу решаю с небольшими алгоритмическими оптимизациями, но без оптимизаций по мелочам (скорее, наоборот, массив чисел специально копируется, как решена первая версия задачи на питоне, чтобы решения были сравнивыми, чтобы симулировать “код новичка” на языка и посмотреть, как язык справляется с этим копированием).&lt;/p&gt;
&lt;p&gt;Сразу выводы про &lt;code&gt;daScript&lt;/code&gt; для тех, кому не особенно интересны подробности реализации:&lt;/p&gt;
&lt;p&gt;— Выразительность языка ОЧЕНЬ похожа на &lt;code&gt;Python&lt;/code&gt;. Более того, я фактически просто переписал своё решение на &lt;code&gt;Python&lt;/code&gt; 13-летней давности построчно, с парой изменений.&lt;br&gt;— &lt;code&gt;daScript&lt;/code&gt; по скорости &lt;strong&gt;в режиме интерпретации&lt;/strong&gt; находится в одной лиге с компилируемыми языками (!!!). Код по скорости сопоставим с версией на &lt;code&gt;Nim&lt;/code&gt; (чуть быстрее “наивной” &lt;strong&gt;скомпилированной&lt;/strong&gt; версии, и раза в 1.5-2 медленнее оптимизированной).&lt;br&gt;— В режиме &lt;code&gt;Ahead-of-Time&lt;/code&gt; компиляции &lt;code&gt;daScript&lt;/code&gt; обгоняет &lt;code&gt;nim&lt;/code&gt; (который вообще показывает достаточно хорошие результаты в нормальных бенчмарках с другими языками).&lt;/p&gt;"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,0.1),rgba(40,44,52,0.9))}</style><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/2301621444/">Позже</a><a class="pagination__link pagination__next" href="/blog/3006126295/">Раньше</a></div><article class="article post"><h3 class="article__title">daScript in imaginery world</h3><div class="article__date metadata"><div class="post-info">2022/06/19</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/dascript/">dascript</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>Мой собственный способ измерить выразительность и скорость языка — решить на нём “задачу Джеймса Бонда младшего”, выдуманную головоломку из игры на NES <code>James Bond Jr</code> (<a target="_blank" rel="noopener" href="https://youtu.be/Kzu_cGHFqM8?t=1290">видео</a>). Несмотря на игрушечность задачи, кажется, это неплохой тест нового языка. Это веселее, чем реализовывать абстрактный поиск в ширину/глубину. Задачу решаю с небольшими алгоритмическими оптимизациями, но без оптимизаций по мелочам (скорее, наоборот, массив чисел специально копируется, как решена первая версия задачи на питоне, чтобы решения были сравнивыми, чтобы симулировать “код новичка” на языка и посмотреть, как язык справляется с этим копированием).</p>
<p>Сразу выводы про <code>daScript</code> для тех, кому не особенно интересны подробности реализации:</p>
<p>— Выразительность языка ОЧЕНЬ похожа на <code>Python</code>. Более того, я фактически просто переписал своё решение на <code>Python</code> 13-летней давности построчно, с парой изменений.<br>— <code>daScript</code> по скорости <strong>в режиме интерпретации</strong> находится в одной лиге с компилируемыми языками (!!!). Код по скорости сопоставим с версией на <code>Nim</code> (чуть быстрее “наивной” <strong>скомпилированной</strong> версии, и раза в 1.5-2 медленнее оптимизированной).<br>— В режиме <code>Ahead-of-Time</code> компиляции <code>daScript</code> обгоняет <code>nim</code> (который вообще показывает достаточно хорошие результаты в нормальных бенчмарках с другими языками).</p>
<span id="more"></span>
<p>Заметки<br>1 - <a href="/blog/28461/" title="Python in imaginary world">(2009) Python in imaginary world</a><br>2 - <a href="/blog/3351183716/" title="Scala in imaginary world">(2015) Scala in imaginary world</a><br>3 - <a href="/blog/1808122922/" title="Nim in imaginary world">(2021) Nim in imaginary world</a><br>Исходники<br><a target="_blank" rel="noopener" href="https://github.com/spiiin/james_bond_jr_problem">https://github.com/spiiin/james_bond_jr_problem</a></p>
<h2><span id="podgotovka">Подготовка</span><a href="#podgotovka" class="header-anchor">#</a></h2><p>Сборка автономного интерпретатора - проект <code>daScript</code> (можно в cmake поотключать дополнительные библиотеки типа <code>glfw</code>, ненужные для интерпретатора)<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">option(DAS_XXX_MODULE_DISABLED &quot;Disable any unneeded modules&quot; OFF)</span></span></code></pre></div></div></figure><br>Также не забывать собрать Release-версию. Теперь можно запускать скрипты из командной строки:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">daScript.exe james_bond_jr.das</span></span></code></pre></div></div></figure></p>
<h2><span id="reshenie">Решение</span><a href="#reshenie" class="header-anchor">#</a></h2><div class="spoiler collapsed">
    <div class="spoiler-title">
        gist
    </div>
    <div class="spoiler-content">
        <script src="//gist.github.com/3bd63cd5271b277f5bc87f670b0ab967.js?file=james_bond_jr_dascript.das"></script>
    </div>
</div>
<p>Отличия в синтаксис от <code>Python</code>:</p>
<p><strong><code>- Отсутствует присваивание кортежей</code></strong><br>Из-за чего нельзя написать сдвиг в массиве как в <code>python</code>:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">n[0+plus],n[1+plus],n[2+plus],n[3+plus] = n[3+plus],n[0+plus],n[1+plus],n[2+plus]</span></span></code></pre></div></div></figure><br>и приходится писать отдельную функцию сдвига</p>
<p><strong><code>- Нельзя сравнить два массива с помощью оператора проверки равенства</code></strong><br>Что логично из-за неопределенности поведения такого оператора (сравнивать ли содержимое или указатели). Из-за этого используется самописная функция <code>same</code>:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">same</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">a,b</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">[</span><span style="color: #B5CEA8">16</span><span style="color: #E6E6E6">])</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> ai, bi </span><span style="color: #C586C0">in</span><span style="color: #E6E6E6"> a, b</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> ai </span><span style="color: #D4D4D4">!=</span><span style="color: #E6E6E6"> bi</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">false</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">true</span></span></code></pre></div></div></figure></p>
<p><strong><code>- Поддержка именованных именованных кортежей без необходимости использовать отдельный класс</code></strong><br><code>Python</code> позволяет использовать <a target="_blank" rel="noopener" href="https://docs.python.org/3.6/library/collections.html?highlight=namedtuple#collections.namedtuple">именованные кортежи</a> вместо обычных там, где не хочется заводить структуру. В <code>daScript</code> возможность именовать поля кортежа встроена в язык:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">typedef</span><span style="color: #E6E6E6"> FieldPathInfo </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">tuple</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">field:</span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">[</span><span style="color: #B5CEA8">16</span><span style="color: #E6E6E6">]; fieldFrom:</span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">[</span><span style="color: #B5CEA8">16</span><span style="color: #E6E6E6">];  rate:</span><span style="color: #4EC9B0">int</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> a </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> [[FieldPathInfo val, vert, rate(val)]]</span></span></code></pre></div></div></figure></p>
<p><strong><code>- Ошибки вывода типа в генериках иногда напоминают вывод ошибок в шаблонов C++</code></strong><br><a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/issues/309">https://github.com/GaijinEntertainment/daScript/issues/309</a></p>
<p><strong><code>- Нет встроенного аналога list из Python и DoubleLinkedList из Nim</code></strong><br>Вместо этого кортежи хранятся в классе <code>array</code>, представляющем собой динамический массив. Для того, чтобы избежать лишнего копирования данных при сортировке, память под кортежи выделяется на стеке:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//медленный вариант</span></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> open: </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">FieldPathInfo</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">open </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">push </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> [[FieldPathInfo source, rate(source), zeros]] </span><span style="color: #6A9955">//хранение в массиве объектов</span></span>
<span class="line"><span style="color: #6A9955">//более быстрый вариант</span></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> open: </span><span style="color: #C586C0">array</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">FieldPathInfo?</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #E6E6E6">open </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">push </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> [[FieldPathInfo source, zeros, rate(source)]] </span><span style="color: #6A9955">//хранение в массиве ссылок на объекта на хипе</span></span></code></pre></div></div></figure></p>
<p>Также можно отметить, что объекты на хипе выделяются в соседних областях памяти, аллокатор контекста по умолчанию выделяет память из предвыделенного линейного блока:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6"> </span><span style="color: #C586C0">for</span><span style="color: #E6E6E6"> i </span><span style="color: #C586C0">in</span><span style="color: #E6E6E6"> range(</span><span style="color: #B5CEA8">16</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> xxx </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> [[FieldPathInfo val, vert, rate(val)]]</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #DCDCAA">print</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;addr={</span><span style="color: #C586C0">reinterpret</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">void</span><span style="color: #CE9178">?</span><span style="color: #D4D4D4">&gt;</span><span style="color: #CE9178"> </span><span style="color: #9CDCFE">xxx</span><span style="color: #CE9178">}</span><span style="color: #D7BA7D">\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//output:</span></span>
<span class="line"><span style="color: #C586C0">addr</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">0x28b1bb582f0</span></span>
<span class="line"><span style="color: #C586C0">addr</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">0x28b1bb58380</span></span>
<span class="line"><span style="color: #C586C0">addr</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">0x28b1bb58410</span></span>
<span class="line"><span style="color: #C586C0">addr</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">0x28b1bb584a0</span></span>
<span class="line"><span style="color: #C586C0">addr</span><span style="color: #D4D4D4">=</span><span style="color: #B5CEA8">0x28b1bb58530</span></span>
<span class="line"><span style="color: #D4D4D4">...</span></span></code></pre></div></div></figure></p>
<p>Так что, в теории, разница в скорости в выделении объектов на стеке и в куче для <code>daScript</code> должна быть небольшой, и хранение узлов в массиве должно дать даже небольшой прирост скорости из-за локальности хранения узлов в памяти, по отношению к способу хранения в списке.</p>
<p>За исключением перечисленных отличий, код “переведён” построчно с Python версии (с “бонусной” проверкой ошибок типизации интерпретатором). В такой форме при интерпретации он уже работает лишь чуть медленнее скомпилированной версии на <code>Nim</code>.</p>
<h2><span id="ahead-of-time-kompilyaciya">Ahead-of-Time компиляция</span><a href="#ahead-of-time-kompilyaciya" class="header-anchor">#</a></h2><p><code>daScript</code> можно настроить, чтобы вместо интерпретации он генерировал C++-код, выполняющий те же действия. В репозитория проекта есть <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/examples/tutorial/CMakeLists.txt#L36">пример</a> настройки <code>cmake</code> для автоматической генерации AoT-версии кода.<br>Можно проделать этот этап вручную:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">daScript.exe -aot james_bond_jr.das james_bond_jr.das.cpp</span></span></code></pre></div></div></figure></p>
<p>Полученный C++ файл можно скомпилировать (можно просто добавить его в один из туториалов), и теперь при выполнении скрипта <code>james_bond_jr.das</code>, вместо интерпретации, будут выполнены скомпилированные версии функций. В таком режиме скрипт обгоняет разогнанную <code>nim</code> версию решения. Выводы в начале.</p>
<p><img src="/blog/1160489034/jbjr.gif" alt="jbjr"></p>
<h2><span id="eshchyo-bystree">Ещё быстрее!</span><a href="#eshchyo-bystree" class="header-anchor">#</a></h2><p>Пара оптимизаций, чтобы сделать программу ешё быстрее.</p>
<p><strong><code>[[unsafe_deref]]</code></strong><br>аннотация для функций, которая “инлайнит” обращения по указателям.<br>Код из <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/a0fcdfdbf134d3dfb8055c9218c6e57ff4ae925b/src/ast/ast_simulate.cpp#L1023">ast_simulate</a>:<br><figure class="shiki cpp"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #4EC9B0">SimNode</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">*</span><span style="color: #E6E6E6"> ExprPtr2Ref::</span><span style="color: #DCDCAA">simulate</span><span style="color: #E6E6E6"> (</span><span style="color: #4EC9B0">Context</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">&amp;</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">context</span><span style="color: #E6E6E6">) </span><span style="color: #569CD6">const</span><span style="color: #E6E6E6"> {</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> ( unsafeDeref ) {</span></span>
<span class="line"><span style="color: #6A9955">        //симуляция выполнения ноды</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">subexpr</span><span style="color: #E6E6E6">-&gt;</span><span style="color: #DCDCAA">simulate</span><span style="color: #E6E6E6">(context);</span></span>
<span class="line"><span style="color: #E6E6E6">    } </span><span style="color: #C586C0">else</span><span style="color: #E6E6E6"> {</span></span>
<span class="line"><span style="color: #6A9955">        //создание ноды для более поздней симуляции</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">context</span><span style="color: #E6E6E6">.</span><span style="color: #9CDCFE">code</span><span style="color: #E6E6E6">-&gt;</span><span style="color: #9CDCFE">makeNode</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">SimNode_Ptr2Ref</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">(at,</span><span style="color: #9CDCFE">subexpr</span><span style="color: #E6E6E6">-&gt;</span><span style="color: #DCDCAA">simulate</span><span style="color: #E6E6E6">(context));</span></span>
<span class="line"><span style="color: #E6E6E6">    }</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span></code></pre></div></div></figure></p>
<p><strong><code>Векторизация!</code></strong><br>В daScript есть встроенные векторные типы int4 и float4, и описание поля логичнее переделать на их использование:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//typedef Field = int[16]</span></span>
<span class="line"><span style="color: #C586C0">typedef</span><span style="color: #E6E6E6"> Field </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">int4</span><span style="color: #E6E6E6">[</span><span style="color: #B5CEA8">4</span><span style="color: #E6E6E6">]</span></span></code></pre></div></div></figure><br>Тогда горизонтальные сдвиги можно описать так:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">right</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">v</span><span style="color: #E6E6E6">:Field; </span><span style="color: #9CDCFE">line</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> ans </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> v</span></span>
<span class="line"><span style="color: #E6E6E6">    ans[</span><span style="color: #569CD6">line</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> ans[</span><span style="color: #569CD6">line</span><span style="color: #E6E6E6">]</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">yzwx</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> ans</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">left</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">v</span><span style="color: #E6E6E6">:Field; </span><span style="color: #9CDCFE">line</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> ans </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> v</span></span>
<span class="line"><span style="color: #E6E6E6">    ans[</span><span style="color: #569CD6">line</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> ans[</span><span style="color: #569CD6">line</span><span style="color: #E6E6E6">]</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">wxyz</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> ans</span></span></code></pre></div></div></figure></p>
<p>Что 1) короче 2) очень быстро</p>
<p>Можно измерить скорость выполнения обычной и оптимизированной версии встроенным профайлером:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">profile(20, &quot;JamesBondUsual&quot;) &lt;|</span></span>
<span class="line"><span style="color: #E6E6E6">        for i in range(100)</span></span>
<span class="line"><span style="color: #E6E6E6">            var dif &lt;- extract(search())</span></span></code></pre></div></div></figure></p>
<p>Получился прирост скорости ещё на 25% ( 0.4 -&gt; 0.3 миллисекунд за 100 запусков).<br>Код быстрой версии:</p>
<div class="spoiler collapsed">
    <div class="spoiler-title">
        gist
    </div>
    <div class="spoiler-content">
        <script src="//gist.github.com/5aba216fdf4aa70984c112cd4c6496df.js?file=james_bond_jr_fast.das"></script>
    </div>
</div>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"Ov23liG1mZbiQOIdi91X","clientSecret":"e05812685eb741a752982b89dcf6f5b58dc10251","repo":"spiiin.github.io","owner":"spiiin","admin":["spiiin"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/2301621444/">Позже</a><a class="pagination__link pagination__next" href="/blog/3006126295/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div><!-- hexo injector body_end start -->
  <script>
  const CODE_CONFIG = {
    beautify: undefined,
    highlightCopy: undefined,
    highlightLang: undefined,
    highlightHeightLimit: undefined,
    isHighlightShrink: undefined,
    copy: {
      success: 'undefined',
      error: 'undefined',
      noSupport: 'undefined',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body></html>