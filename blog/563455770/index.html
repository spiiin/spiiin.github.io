<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | Управление умными лампочками Milight с телефона на Android и iOS</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/17905/">Позже</a><a class="pagination__link pagination__next" href="/blog/2409821993/">Раньше</a></div><article class="article post"><h3 class="article__title">Управление умными лампочками Milight с телефона на Android и iOS</h3><div class="article__date metadata"><div class="post-info">2017/12/25</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/python/">python</a><a class="article__tags__link metadata" href="/tags/iphone/">iphone</a><a class="article__tags__link metadata" href="/tags/codespell/">codespell</a><a class="article__tags__link metadata" href="/tags/hardware/">hardware</a><a class="article__tags__link metadata" href="/tags/android/">android</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>Пару лет назад уже писал про китайские лампочки <a href="https://spiiin.livejournal.com/94218.html" target="_blank" rel="noopener">Milight</a>, которыми можно управлять через Wi-Fi. С тех пор использовал их просто как цветные лампочки с пультом управления и радовался. Но зимой просыпаться утром особенно трудно, поэтому я решил сделать себе будильник, который будет постепенно увеличивать яркость света, вместо того, чтобы просто звенеть.  </p>
<p>К сожалению, до сих пор сцепление разных устройств между собой и программное управление ими часто представляет собой нетривиальную задачу. Поэтому решил записать, что получилось в ходе попыток организовать “будильник с умными лампочками”.  </p>
<p>Схема управления будет выглядеть примерно так:<br><img src="https://spiiin.dreamwidth.org/file/6006.png" alt>  </p>
<p>К домашнему роутеру цепляется сервер-будильник, и роутер управления лампочками. В нужный момент сервер-будильник передаёт сигнал “Зажечь лампочки”, затем домашний роутер передаёт его на роутер управления лампочками MiLight, который зажигает лампочки и будит человека.  </p>
<h2><span id="nastroyka-seti">Настройка сети</span><a href="#nastroyka-seti" class="header-anchor">#</a></h2><p>Как настроить <a href="https://www.amazon.com/Controller-iBox2-Wireless-Downlight-Compatible/dp/B01N7C3HXQ" target="_blank" rel="noopener">роутер управления лампочками</a>, чтобы он подключался к домашней сети, описано <a href="http://www.milight.com/support/#A3" target="_blank" rel="noopener">тут</a>. В качестве альтернативы, можно воспользоваться программой <a href="http://easybulb.com/2015/01/easybulb-ios-android-app-released/" target="_blank" rel="noopener">EasyBulb</a>, которая предназначена для других лампочек, но тем не менее, позволяет легко перевести роутер в нужный режим (управление лампочками через неё тоже возможно, но криво - протоколы всё-таки немного отличаются).  </p>
<h2><span id="vybor-servera-budilnika">Выбор “сервера-будильника”</span><a href="#vybor-servera-budilnika" class="header-anchor">#</a></h2><p>Вообще говоря, лампочки Milight не предназначены для программного управления, после настройки сети производитель лампочек предполагал, что пользователь установит стандартную программу “пульт управления” и будет счастлив. Однако, протокол управления лампочками достаточно прост и <a href="https://hackaday.io/project/5888-reverse-engineering-the-milight-on-air-protocol" target="_blank" rel="noopener">исследован</a>, и существуют сторонние библиотеки и программы управления, поэтому можно попытаться выбрать устройство, которое будет работать как будильник.  </p>
<p>Лучшим выбором, скорее всего, будет отдельное устройство на основе микроконтроллера, одного заказанные мной для этой цели <strong><em>Arduino</em></strong> идут из Китая слишком долго, поэтому я решил попытаться выбрать на роль сервера одно из имеющихся в наличии устройств. В наличии оказались: <strong><em>ноутбук</em></strong> (который жалко держать включенным постоянно), <strong><em>iPhone</em></strong> (выглядящий перспективно) и старый <strong><em>Samsung Galaxy</em></strong> (с раздолбанным экраном и включающийся не с первой попытки).  </p>
<h2><span id="popytki-s-iphone">Попытки с iPhone</span><a href="#popytki-s-iphone" class="header-anchor">#</a></h2><p>На iPhone после недолгих поисков в AppStore обнаружилось чудесная программа <a href="https://itunes.apple.com/us/app/home-remote/id926193671?mt=8" target="_blank" rel="noopener">Home Remote</a>. Программа действительно замечательная, и позволяет составлять триггеры с возможностью выбрать действие (поддерживаются все типы ламп Milight и несколько других, команды по TCP/IP, а также комбинации других действий) и способ активации действия. Среди способов активации - геопозиция (координаты зоны, в которую входит пользователь, или параметры сети, к которой подключится пользователь), микрофон (неплохо распознает голос, правда почему-то только на английском), таймер (то, что мне изначально было нужно), или кнопка на связанных с iPhone часах iWatch или маке. Всё чудно, но из-за ограничений iOS триггеры работают, только если открыто главное окно программы.</p>
<p> Если же телефон уснёт, то программа всего лишь показывает локальное уведомление “хочу активировать команду, разблокируйте телефон и откройте программу, чтобы я смогла это сделать”. Из-за этого использовать её или любую другую программу на iOS в качестве умного будильника нельзя. Я весело поговорил со своей лампой (“Лампа, режим Диско!”), и перешёл к поиску подходящего софта под андроид.  </p>
<h2><span id="server-budilnik-na-android">Сервер-будильник на Android</span><a href="#server-budilnik-na-android" class="header-anchor">#</a></h2><p>Жалко было отказываться от iOS версии, но держать телефон включённым всю ночь не хотелось, поэтому я стал искать планировщик запуска своих программ под Android (на крайний случай, из него можно и полноценный сервер сделать - всё равно валяется без дела). Почти сразу же мне на глаза попалась бесплатная программа <a href="http://androidideas.org/taskbomb/" target="_blank" rel="noopener">TaskBomb</a>. Я просмотрел несколько <a href="http://androidideas.org/taskbomb/tutorials/" target="_blank" rel="noopener">туториалов</a> к ней, и обнаружил пример, озаглавленный “Running a script every 5 minutes”. Тут мои глаза загорелись и вся схема нарисовалась в голове:  </p>
<ul>
<li>К TaskBomb существуют готовые плагины для решения типовых задач. Один из таких плагинов - <a href="https://play.google.com/store/apps/details?id=org.androidideas.scriptlauncher" target="_blank" rel="noopener">SL4A Script Launcher</a>, позволяет запускать скрипты SL4A.  </li>
<li><a href="https://github.com/damonkohler/sl4a" target="_blank" rel="noopener">SL4A</a> (Script Layer for Android) слой, который позволяет выполнять скрипты на множестве разных языков на выбор.  </li>
<li><a href="https://github.com/kuri65536/python-for-android" target="_blank" rel="noopener">Python for Android</a> - добавляет возможность выполнять скрипты на Python для SL4A.  </li>
<li>Python for Android позволяет <a href="https://www.pythoncentral.io/python-for-android-the-scripting-layer-sl4a/" target="_blank" rel="noopener">ставить 3rd party модули</a> в директорию /sdcard/com.googlecode.pythonforandroid/extras/python .  </li>
<li>Если добавить туда модуль <a href="https://github.com/McSwindler/python-milight" target="_blank" rel="noopener">управления лампами milight</a> (а также модуль importlib из стандартной поставки python для win32/linux/mac, который используется этим модулем), то можно запускать по таймеру собственные python скрипты!  </li>
</ul>
<p>Тестовый скрипт, включающий все лампы (всего в 4 строки!):<br><a href="https://gist.github.com/spiiin/3b0ebc3a3ee798ef3723c24798fb0978" target="_blank" rel="noopener">https://gist.github.com/spiiin/3b0ebc3a3ee798ef3723c24798fb0978</a>  </p>
<p>Дальше остаётся только повесить этот скрипт на запуск в определённое время через TaskBomb и лечь спать.</p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"Ov23liG1mZbiQOIdi91X","clientSecret":"e05812685eb741a752982b89dcf6f5b58dc10251","repo":"spiiin.github.io","owner":"spiiin","admin":["spiiin"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/17905/">Позже</a><a class="pagination__link pagination__next" href="/blog/2409821993/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>