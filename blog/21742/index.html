<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | Уровни Jungle Book [NES]. Часть 2</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/4383/">Позже</a><a class="pagination__link pagination__next" href="/blog/41044/">Раньше</a></div><article class="article post"><h3 class="article__title">Уровни Jungle Book [NES]. Часть 2</h3><div class="article__date metadata"><div class="post-info">2011/10/20</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/nes/">nes</a><a class="article__tags__link metadata" href="/tags/hack/">hack</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p><strong>Шаг 0x0A.</strong> </p>
<p>Остается последний шаг, чтобы связать результаты анализа снизу (от экрана к набору) и сверху (от набора к экрану) - понять, как адреса из предэкрана + смещение попадают в экран . Так как для этого копирования используется адресация через нулевую страницу, точку остановки поставить нельзя, поэтому можно только поставить ее на запись в экран и просто искать в окрестностях чтение из предэкрана .</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ROM:840F JSR sub_856B ; Копирование 4х адресов в зону предэкран-вторичные индексы</span><br><span class="line">ROM:840F ; х циклически проходит диапазон (00-03)</span><br><span class="line">ROM:8412 LDA byte_A5</span><br><span class="line">ROM:8414 EOR #3</span><br><span class="line">ROM:8416 TAX</span><br><span class="line">ROM:8417 LSR A</span><br><span class="line">ROM:8418 STA byte_A9</span><br><span class="line">ROM:841A</span><br><span class="line">ROM:841A LDY #0</span><br><span class="line">ROM:841C LDA ($A3),Y ; индекс относительно базового адреса из предэкрана</span><br><span class="line">ROM:841E TAY</span><br><span class="line">ROM:841F PHA</span><br><span class="line">ROM:8420 BMI loc_8427</span><br><span class="line">ROM:8422 LDA ($83),Y ; отсюда мы считываем индекс начала цепочки</span><br><span class="line">ROM:8424 JMP loc_8429</span><br><span class="line">ROM:8427 ; ---------------------------------------------------------------------------</span><br><span class="line">ROM:8427</span><br><span class="line">ROM:8427 LDA ($85),Y</span><br><span class="line">ROM:8429</span><br><span class="line">ROM:8429 TAY</span><br><span class="line">ROM:842A BPL loc_843B</span><br><span class="line">ROM:842C LDA ($95),Y ; используем считанный индекс, чтобы взять тайл из набора</span><br><span class="line">ROM:842E STA $40B,X</span><br><span class="line">ROM:8431 LDA ($99),Y</span><br><span class="line">ROM:8433 STA $40C,X</span><br><span class="line">ROM:8436 LDA ($71),Y</span><br><span class="line">ROM:8438 JMP loc_8447</span><br><span class="line">ROM:843B ; ---------------------------------------------------------------------------</span><br><span class="line">ROM:843B</span><br><span class="line">ROM:843B LDA ($93),Y</span><br><span class="line">ROM:843D STA $40B,X</span><br><span class="line">ROM:8440 LDA ($97),Y</span><br><span class="line">ROM:8442 STA $40C,X</span><br><span class="line">ROM:8445 LDA ($6F),Y</span><br><span class="line">ROM:8447</span><br><span class="line">ROM:8447 AND #3</span><br><span class="line">ROM:8449 TAY</span><br><span class="line">ROM:844A LDA $8B16,Y</span><br><span class="line">ROM:844D LDY byte_A9</span><br><span class="line">ROM:844F STA $455,Y</span><br><span class="line">ROM:8452 INC byte_A9</span><br><span class="line">ROM:8454 PLA</span><br><span class="line">ROM:8455 TAY</span><br><span class="line">ROM:8456 BMI loc_845D</span><br><span class="line">ROM:8458 LDA ($87),Y</span><br><span class="line">ROM:845A JMP loc_845F</span><br><span class="line">ROM:845D ; ---------------------------------------------------------------------------</span><br><span class="line">ROM:845D</span><br><span class="line">ROM:845D LDA ($89),Y</span><br><span class="line">ROM:845F</span><br><span class="line">ROM:845F TAY</span><br><span class="line">ROM:8460 BPL loc_8471 ; что-то типа записи в столбик, из которого будет перенос в видеопамять</span><br><span class="line">ROM:8462 LDA ($95),Y</span><br><span class="line">ROM:8464 STA $40D,X</span><br><span class="line">ROM:8467 LDA ($99),Y</span><br><span class="line">ROM:8469 STA $40E,X</span><br><span class="line">ROM:846C LDA ($71),Y</span><br><span class="line">ROM:846E JMP loc_847D</span><br><span class="line">ROM:8471 ; ---------------------------------------------------------------------------</span><br><span class="line">ROM:8471</span><br><span class="line">ROM:8471 LDA ($93),Y ; что-то типа записи в столбик, из которого будет перенос в видеопамять</span><br><span class="line">ROM:8473 STA $40D,X</span><br><span class="line">ROM:8476 LDA ($97),Y</span><br><span class="line">ROM:8478 STA $40E,X</span><br><span class="line">ROM:847B LDA ($6F),Y</span><br><span class="line">ROM:847D</span><br><span class="line">ROM:847D AND #3</span><br><span class="line">ROM:847F TAY</span><br><span class="line">ROM:8480 LDA $8B16,Y</span><br><span class="line">ROM:8483 LDY byte_A9</span><br><span class="line">ROM:8485 STA $455,Y</span><br><span class="line">ROM:8488 INC byte_A9</span><br><span class="line">ROM:848A INX</span><br><span class="line">ROM:848B INX</span><br><span class="line">ROM:848C INX</span><br><span class="line">ROM:848D INX</span><br><span class="line">ROM:848E DEC byte_3F0 ; кол-во повторов считывания</span><br><span class="line">ROM:8491 BMI loc_84BE ; выход из копирования столбца</span><br><span class="line">ROM:8493 LDA xcoord ; x-координата столбца</span><br><span class="line">ROM:8496 INC xcoord</span><br><span class="line">ROM:8499 CMP #2</span><br><span class="line">ROM:849B BCS loc_84A1</span><br><span class="line">ROM:849D LDA #0</span><br><span class="line">ROM:849F BEQ loc_84B0</span><br><span class="line">ROM:84A1</span><br><span class="line">ROM:84A1 BIT byte_12</span><br><span class="line">ROM:84A3 BPL loc_84AD</span><br><span class="line">ROM:84A5 LDA xcoord</span><br><span class="line">ROM:84A8 CMP byte_36F</span><br><span class="line">ROM:84AB BCS loc_84C1</span><br><span class="line">ROM:84AD</span><br><span class="line">ROM:84AD LDA xshift_cycle60</span><br><span class="line">ROM:84B0</span><br><span class="line">ROM:84B0 CLC</span><br><span class="line">ROM:84B1 ADC byte_A3</span><br><span class="line">ROM:84B3 STA byte_A3</span><br><span class="line">ROM:84B5 LDA byte_A4</span><br><span class="line">ROM:84B7 ADC #0</span><br><span class="line">ROM:84B9 STA byte_A4</span><br><span class="line">ROM:84BB JMP loc_841A ; повтор загрузки</span><br></pre></td></tr></table></figure>
<p>Этот кусок кода и есть функция- комбинатор . Она показывает связь между предэкраном и экраном . Новые важные переменные здесь <code>$366 (x_shift_cycle)</code> - насколько сдвигаться за один шаг цикла считывания, похоже на разницу между строками, то есть ширину всего уровня;<br><code>xcoord</code> - число повторов выборки, постоянно равно 5, от есть считывается по 4 тайла 5 раз = 20 раз - один столбец на экране. <code>$A2-$A3</code> - пара ячеек, в которых написан изначальный индекс, от которого проводится измерение. </p>
<p>Разбираться откуда он берется пока не обязательно, можно посмотреть первый попавшийся и начать написание функции-комбинатора, которая будет делать то же самое, что и приведенный выше кусок кода на ассемблере.</p>
<p><strong>Шаг 0x0B.</strong></p>
<p>Реализация комбинатора на питоне:<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">get4Lines</span><span class="params">(begin,end, levelSet, a3a4, step, vertCount)</span>:</span></span><br><span class="line">  cycleBegin = begin</span><br><span class="line">  cycleEnd   = end</span><br><span class="line">  a3a4ind = begin/<span class="number">4</span></span><br><span class="line">  line4 = []</span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> xrange(cycleBegin,cycleEnd):</span><br><span class="line">    <span class="keyword">if</span> x%<span class="number">4</span>==<span class="number">0</span>:</span><br><span class="line">      a3a4ind += <span class="number">1</span></span><br><span class="line">    b83,b85,b87,b89 = getLevelSetForCycle(levelSet, b8x_inds,(x+<span class="number">2</span>)%<span class="number">4</span>)</span><br><span class="line">    b93,b95,b97,b99 = getLevelSetForCycle(levelSet, b9x_inds,(x+<span class="number">2</span>)%<span class="number">4</span>)</span><br><span class="line">    line4.extend(makeLine(a3a4, a3a4ind, b83,b85,b87,b89, b93,b95,b97,b99, step, vertCount))</span><br><span class="line">  <span class="keyword">return</span> line4</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makeLine</span><span class="params">(a3a4, a3a4BaseInd, b83,b85,b87,b89, b93,b95,b97,b99, step, vertCount)</span>:</span></span><br><span class="line">  a3a4ind = a3a4BaseInd</span><br><span class="line">  lines = []</span><br><span class="line">  <span class="keyword">for</span> globalRepeat <span class="keyword">in</span> xrange(vertCount): <span class="comment">##5(screen size)</span></span><br><span class="line">    predInd = a3a4[a3a4ind]</span><br><span class="line">    ind2a,ind2b = <span class="number">-1</span>,<span class="number">-1</span></span><br><span class="line">    <span class="keyword">if</span> predInd&lt;<span class="number">128</span>:</span><br><span class="line">      ind2a = b83[predInd]</span><br><span class="line">      ind2b = b87[predInd]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      ind2a = b85[predInd]</span><br><span class="line">      ind2b = b89[predInd]</span><br><span class="line"> </span><br><span class="line">    res = [<span class="number">-1</span>]*<span class="number">4</span></span><br><span class="line">    <span class="keyword">if</span> ind2a&lt;<span class="number">128</span>:</span><br><span class="line">      res[<span class="number">0</span>],res[<span class="number">1</span>] = b93[ind2a], b97[ind2a]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      res[<span class="number">0</span>],res[<span class="number">1</span>] = b95[ind2a], b99[ind2a]</span><br><span class="line">    <span class="keyword">if</span> ind2b&lt;<span class="number">128</span>:</span><br><span class="line">      res[<span class="number">2</span>],res[<span class="number">3</span>] = b93[ind2b], b97[ind2b]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      res[<span class="number">2</span>],res[<span class="number">3</span>] = b95[ind2b], b99[ind2b]</span><br><span class="line">    lines.extend(res)</span><br><span class="line">    a3a4ind+=step</span><br><span class="line">  <span class="keyword">return</span> lines</span><br><span class="line"> </span><br><span class="line">b8x_inds = [[<span class="number">5</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">4</span>], [<span class="number">7</span>,<span class="number">7</span>,<span class="number">6</span>,<span class="number">6</span>], [<span class="number">9</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">8</span>], [<span class="number">11</span>,<span class="number">11</span>,<span class="number">10</span>,<span class="number">10</span>]]</span><br><span class="line">b9x_inds = [[<span class="number">12</span>,<span class="number">13</span>,<span class="number">12</span>,<span class="number">13</span>], [<span class="number">14</span>,<span class="number">15</span>,<span class="number">14</span>,<span class="number">15</span>], [<span class="number">16</span>,<span class="number">17</span>,<span class="number">16</span>,<span class="number">17</span>], [<span class="number">18</span>,<span class="number">19</span>,<span class="number">18</span>,<span class="number">19</span>]]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getLevelSetForCycle</span><span class="params">(levelSet,indsConst,loop)</span>:</span></span><br><span class="line">  inds = map (<span class="keyword">lambda</span> v: v[loop], indsConst)</span><br><span class="line">  <span class="keyword">return</span> map (<span class="keyword">lambda</span> i: levelSet[i], inds)</span><br></pre></td></tr></table></figure></p>
<p>Набор данных можно выхватить прямо из дампа памяти: </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepareBinary</span><span class="params">(binaryDump, addrBegin, addrLen, outName)</span>:</span></span><br><span class="line">f = open(binaryDump,<span class="string">"rb"</span>)</span><br><span class="line">byt = f.read()</span><br><span class="line">f.close()</span><br><span class="line">bb = byt[addrBegin:addrBegin+addrLen]</span><br><span class="line">f =open(outName,<span class="string">"wb"</span>)</span><br><span class="line">f.write(bb)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>Дальше можно проверить отрисовку и убедиться, нарисовалась полоса уровня высотой в 20 клеток.</p>
<p><strong>Шаг 0x0C.</strong></p>
<p>Экспериментируя с параметрами <code>A2A3</code> и значением <code>vertCount</code> можно получать разные срезы уровня, например, такой:<br><a href="http://pics.livejournal.com/spiiin/pic/0001xwst/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/0001xwst" alt></a></p>
<p>По нему можно прикинуть, откуда начинается мусор, и как конец уровня связан с началом по высоте и вычислить правильное значение <code>A2A3</code> соответствуюшее началу уровня (и в итоге заметить, что оно на 1 меньше, чем адрес в <code>$47-$48</code> (это первое значение из набора ), то есть равно первому значению и набора - 1).</p>
<p>Также можно обратить внимание, что рядом с шириной уровня ($366) в ячейке $367 лежит и его ширина).</p>
<p>Тогда можно вывести полную схему работы комбинатора:<br><a href="http://pics.livejournal.com/spiiin/pic/0001y71x/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/0001y71x/s640x480" alt></a></p>
<p>и написать универсальную функцию рисования:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makeJob</span> <span class="params">(binaryName, spritesName, addr, baseAddrSet, w,h, levelNo)</span>:</span></span><br><span class="line">  tempName1 = binaryName+<span class="string">".a2a3."</span>+str(levelNo)+<span class="string">".bin"</span></span><br><span class="line"> </span><br><span class="line">  imNameTable = Image.open(spritesName)</span><br><span class="line">  nameSize = imNameTable.size</span><br><span class="line">  nameTable = [imNameTable.crop((x,y,x+<span class="number">8</span>,y+<span class="number">8</span>)) <span class="keyword">for</span> y,x <span class="keyword">in</span> itertools.product(xrange(<span class="number">0</span>,nameSize[<span class="number">1</span>],<span class="number">8</span>),xrange(<span class="number">0</span>,nameSize[<span class="number">0</span>],<span class="number">8</span>))]</span><br><span class="line">  sprites = map (<span class="keyword">lambda</span> im: PpuSprite(im),nameTable) </span><br><span class="line"> </span><br><span class="line">  prepareBinary(binaryName, addr, <span class="number">0x2000</span>, tempName1)</span><br><span class="line">  a3a4 = parseBinData256(tempName1)</span><br><span class="line"> </span><br><span class="line">  prepareBinaries(binaryName, baseAddrSet)</span><br><span class="line">  levelSet = map(loadLevelSetElement, baseAddrSet)</span><br><span class="line">  ll = get4Lines(<span class="number">0</span>,w*<span class="number">4</span>, levelSet, a3a4, w,h)</span><br><span class="line">  drawLevelFromData(ll, sprites,(w*<span class="number">4</span>,h*<span class="number">4</span>),<span class="literal">True</span>).show()</span><br></pre></td></tr></table></figure>
<p>(уровень определяется - дампом памяти, набором адресов, размерами (ширина и высота) и картой тайлов).</p>
<p>Этой функцией можно нарисовать любой уровень:<br>Уровень 1.<br><a href="http://pics.livejournal.com/spiiin/pic/0001zdhq/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/0001zdhq/s640x480" alt="1"></a><br>Уровень 2.<br><a href="http://pics.livejournal.com/spiiin/pic/00020r8e/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/00020r8e/s640x480" alt="2"></a><br>Уровень 3.<br><a href="http://pics.livejournal.com/spiiin/pic/0002115d/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/0002115d/s640x480" alt="3"></a><br>Уровень 4.<br><a href="http://pics.livejournal.com/spiiin/pic/000228yk/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/000228yk/s640x480" alt="4"></a><br>Уровень 5.<br><a href="http://pics.livejournal.com/spiiin/pic/00023f84/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/00023f84/s640x480" alt="5"></a><br>Уровень 6.<br><a href="http://pics.livejournal.com/spiiin/pic/00024g9r/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/00024g9r/s640x480" alt="6"></a><br>Уровень 7.<br><a href="http://pics.livejournal.com/spiiin/pic/00025e0b/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/00025e0b/s640x480" alt="7"></a><br>Уровень 8.<br><a href="http://pics.livejournal.com/spiiin/pic/00026hc9/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/00026hc9/s640x480" alt="8"></a><br>Уровень 9.<br><a href="http://pics.livejournal.com/spiiin/pic/000277fy/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/000277fy/s640x480" alt="9"></a><br>Уровень 10. <a href="http://pics.livejournal.com/spiiin/pic/00028s1z/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/00028s1z/s640x480" alt="10"></a><br><a href="http://pastebin.com/e4qedf4X" target="_blank" rel="noopener">Код скрипта</a> (использовался больше в интерактивном режиме)</p>
<p> <em>//Если что-то долго ломать, то оно сломается.</em></p>
<p> <strong>Конец</strong></p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"Ov23liG1mZbiQOIdi91X","clientSecret":"e05812685eb741a752982b89dcf6f5b58dc10251","repo":"spiiin.github.io","owner":"spiiin","admin":["spiiin"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/4383/">Позже</a><a class="pagination__link pagination__next" href="/blog/41044/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>