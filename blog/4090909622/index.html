<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | daScript: C++ auto-bindings, msgpack</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,0.1),rgba(40,44,52,0.9))}</style><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/500729544/">Позже</a><a class="pagination__link pagination__next" href="/blog/1257365288/">Раньше</a></div><article class="article post"><h3 class="article__title">daScript: C++ auto-bindings, msgpack</h3><div class="article__date metadata"><div class="post-info">2022/05/30</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/dascript/">dascript</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>Ещё один “подход” к языку daScript от Gaijin. В последней заметке про использование <a href="/blog/4232971949/" title="daScript OpenGL">байндингов к OpenGL</a> в daScript, я упоминал про наличие скрипта <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/issues/231">dasClangBind</a>, позволяюшего генерировать байндинги к библиотекам на C и C++. Так как из документации к скрипту только совет автора <code>Use it, abuse it</code>, то неплохо попробовать его в деле, чтобы разобраться, что он умеет/не умеет.</p>
<p>С помощью этого генератора байндингов сделаны обёртки над: <a target="_blank" rel="noopener" href="https://github.com/VasiliyRyabtsev/dasRequests">dasRequests</a>, <a target="_blank" rel="noopener" href="https://github.com/VasiliyRyabtsev/dasPhys2d">dasPhys2d</a>, а также добавленные в основной репозиторий <strong><code>dasGLFW, dasBGFX, dasImgui, dasOpenGL, dasClangBind</code></strong> (привязки для генератора байндингов тоже сгенерированы им самим).</p>
<p><code>dasClangBind</code> не собирается с дефолтными настройками cmake, поэтому сначала необходимо включить его сборку. В файле <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/modules/dasClangBind/CMakeLists.txt">CMakeLists.txt</a> видим настройку пути с <code>libclang</code>:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">SET(PATH_TO_LIBCLANG ${PROJECT_SOURCE_DIR}/../libclang)</span></span></code></pre></div></div></figure></p>
<p>Можно скачать скомпилированные библиотеки <a target="_blank" rel="noopener" href="https://github.com/llvm/llvm-project/releases/tag/llvmorg-14.0.0">LLVM</a> (yay, даже для windows!), и указать путь к скачанной библиотеке с cmake-файле. Дальше перегенерируем решение с помощью команды <code>generate_msvc_XXX.bat</code> и компилируем проект <code>libDasModuleClangBind</code>.</p>
<p>Получаем библиотеку <code>libDasModuleClangBind.lib</code>, которую можно подключить для статической линковки из проекта, который будет использовать этот модуль (командой <code>TARGET_LINK_LIBRARIES</code>). В сгенерированном решении убеждаемся в том, что линкер подключает библиотеки <code>libDasModuleClangBind.lib</code> и <code>libclang.lib</code>:<br><img src="/blog/4090909622/lib.png" alt="lib"></p>
<p>Далее в коде подключаем заголовочный файл и макрос добавления модуля в daScript:<br><figure class="shiki cpp"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">#include</span><span style="color: #569CD6"> </span><span style="color: #CE9178">&quot;../modules/dasClangBind/src/dasClangBind.h&quot;</span></span>
<span class="line"><span style="color: #E6E6E6">...</span></span>
<span class="line"><span style="color: #569CD6">int</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">main</span><span style="color: #E6E6E6">( </span><span style="color: #569CD6">int</span><span style="color: #E6E6E6">, </span><span style="color: #569CD6">char</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">*</span><span style="color: #E6E6E6"> [] ) {</span></span>
<span class="line"><span style="color: #E6E6E6">    NEED_ALL_DEFAULT_MODULES;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #DCDCAA">NEED_MODULE</span><span style="color: #E6E6E6">(Module_dasClangBind);</span><span style="color: #6A9955"> //&lt;---</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span></code></pre></div></div></figure></p>
<p>Теперь в das-скрипте можно импортировать модуль <code>cbind</code>, который предоставляет функции-обёртки над библиотекой <code>clang</code>, а главное — <code>cbind_boost</code>, классы, с помощью которых можно настроить поведение генераторы, без низкоуровневого обращения к c-апи clang-а:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> cbind</span></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> cbind_boost</span></span></code></pre></div></div></figure></p>
<h2><span id="libclang">libclang</span><a href="#libclang" class="header-anchor">#</a></h2><p>Для начала лучше бегло ознакомиться с тем, что умеет <code>libclang</code>:<br><a target="_blank" rel="noopener" href="https://shaharmike.com/cpp/libclang/">Using libclang to Parse C++</a><br><a target="_blank" rel="noopener" href="https://habr.com/ru/post/439270/">Пример разбора C++ кода с помощью libclang на Python</a><br><a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/Tooling.html">Choosing the Right Interface for Your Application</a></p>
<h2><span id="dasgenbind">DasGenBind</span><a href="#dasgenbind" class="header-anchor">#</a></h2><p>У генератор привязок <code>dasClangBind</code>, есть 2 режима: генерация обёрток над функциями в виде daScript (с помощью ffi-интерфейса <code>dasbind</code>) — <code>DasGenBind</code>, и более мощная генерация “обвязочного” c++-кода библиотеки — <code>CppGenBind</code>. С помощью <code>DasGenBind</code> <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/modules/dasClangBind/bind/bind_opengl.das">сгенерированы</a> байндинги к <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/modules/dasOpenGL/opengl/opengl_func.das">OpenGL</a>, так как сама библиотека language-agnostic, и её обвязки тривиальны — используются только функции и примитивные типы.</p>
<h2><span id="cppgenbind">CppGenBind</span><a href="#cppgenbind" class="header-anchor">#</a></h2><p>Более интересно посмотреть на байндинги к <a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/modules/dasClangBind/bind/bind_glfw.das">glfw</a>, по которым можно приблизительно понять, что генерируется автоматически, а что необходимо добавлять в исключения и дописывать руками. <code>dasClangBind</code> в ходе своей работы пишет, какие объявляния функций он пропускает (<a target="_blank" rel="noopener" href="https://github.com/GaijinEntertainment/daScript/blob/master/modules/dasClangBind/cbind/cbind_boost.das">код</a> - поиск по ключевому слову <code>skip</code>):</p>
<ul>
<li>шаблоны</li>
<li>функции с аргументами-указателями на функции (к примеру, колбеки)</li>
<li>чисто виртуальные функции</li>
<li>глобальные операторы<br>Также генерируются, но вызывают последующие ошибки компиляции, функции (в лучших традициях текстов ошибок шаблонов C++), получающие аргументы POD-типов по значению.</li>
</ul>
<p>Для таких функций предполагается добавление их в список пропускаемых при автоматической генерации и последующее написания обработчика вручную:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//переопределение метода AnyGenBind</span></span>
<span class="line"><span style="color: #E6E6E6"> </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">override </span><span style="color: #DCDCAA">skip_anyFunction</span><span style="color: #E6E6E6"> ( </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">c </span><span style="color: #E6E6E6">: CXCursor; </span><span style="color: #9CDCFE">isMethod </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">bool</span><span style="color: #E6E6E6"> )</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> AnyGenBind`skip_anyFunction(self, c, isMethod)</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">true</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//свои проверки, нужно или нет генерировать обёртку для функции</span></span></code></pre></div></div></figure></p>
<p>Для дописывания несгенерированных автоматически функций предусмотрен файл <code>MODULENAME.main.cpp</code>. На выходе генератор байндингов выдаёт <a target="_blank" rel="noopener" href="https://github.com/borisbat/dasGlfw/tree/48f2715f0fe4cb8076866365a4bf0a29b7104765/src">пачку</a> и кусок cmake-файла в stdout, с помощью которого можно собрать их в модуль. На практике почему-то у меня не создавались файлы <code>MODULE.func.reg.inc</code> и <code>MODULE.func.decl.,inc</code>, их для теста заполнил руками.</p>
<h2><span id="cmakelist-txt">CmakeList.txt</span><a href="#cmakelist-txt" class="header-anchor">#</a></h2><p>В качестве шаблона cmake-файла можно взять готовый из других модулей, основная логика:</p>
<ul>
<li>собрать модуль из сгенерированных файлов (это за нас выводит сам <code>dasClangBind</code>)</li>
<li>подключить lib-файл самой C++ библиотеки, для которой делается обвязка</li>
<li>определить переменные сборки daScript, позволяющие отключить модуль по желанию пользователя</li>
</ul>
<h2><span id="generaciya-bayndingov-dlya-biblioteke-messagepack">Генерация байндингов для библиотеке MessagePack</span><a href="#generaciya-bayndingov-dlya-biblioteke-messagepack" class="header-anchor">#</a></h2><p>Исходя из ограничений генератора, для учебного примера проще всего выбрать для примера максимально простую библиотеку, имеющую C, а не С++-интерфейс. Например - <a target="_blank" rel="noopener" href="https://github.com/msgpack/msgpack-c/tree/c_master">MessagePack</a>.</p>
<p>Стартовый код генератора:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> cbind</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">cbind_boost</span></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> daslib</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">safe_addr</span></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> daslib</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">strings</span></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> daslib</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">defer</span></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> daslib</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">fio</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">class</span><span style="color: #E6E6E6"> </span><span style="color: #4EC9B0">MsgpackGen</span><span style="color: #E6E6E6"> : </span><span style="color: #4EC9B0">CppGenBind</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">override</span><span style="color: #E6E6E6"> func_to_stdout </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">false</span></span>
<span class="line"><span style="color: #E6E6E6">    unique_functions : </span><span style="color: #C586C0">table</span><span style="color: #D4D4D4">&lt;</span><span style="color: #4EC9B0">string</span><span style="color: #E6E6E6">; </span><span style="color: #4EC9B0">bool</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> MsgpackGen</span></span>
<span class="line"><span style="color: #E6E6E6">        bind_root </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&quot;{get_das_root()}/modules/dasMsgpack/src&quot;</span></span>
<span class="line"><span style="color: #E6E6E6">        bind_module </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&quot;msgpack&quot;</span></span>
<span class="line"><span style="color: #E6E6E6">        bind_das_module </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&quot;msgpack&quot;</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> pfn </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&quot;msgpack.h&quot;</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> pfp </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&quot;{get_das_root()}/modules/dasMsgpack/msgpack-c/include/&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> args </span><span style="color: #D4D4D4">&lt;-</span><span style="color: #E6E6E6"> [{</span><span style="color: #4EC9B0">string</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #CE9178">&quot;-xc++-header&quot;</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #CE9178">&quot;-std=c++1z&quot;</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #CE9178">&quot;-I{get_full_file_name(pfp)}&quot;</span></span>
<span class="line"><span style="color: #E6E6E6">        }]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        func_per_chunk </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">20</span></span>
<span class="line"><span style="color: #E6E6E6">        init_args(pfn,pfp,args)</span></span>
<span class="line"><span style="color: #E6E6E6">        setDefaultFiles()</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//init_skip_func()</span></span>
<span class="line"><span style="color: #E6E6E6">        openAllFiles()</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">override </span><span style="color: #DCDCAA">namespace_name</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">name</span><span style="color: #E6E6E6">:</span><span style="color: #4EC9B0">string</span><span style="color: #E6E6E6">; </span><span style="color: #9CDCFE">dash</span><span style="color: #E6E6E6">:</span><span style="color: #4EC9B0">string</span><span style="color: #D4D4D4">=</span><span style="color: #CE9178">&quot;::&quot;</span><span style="color: #E6E6E6">) : </span><span style="color: #4EC9B0">string</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> AnyGenBind`namespace_name(self, name, dash)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">override </span><span style="color: #DCDCAA">skip_struct</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">name </span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">string</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">false</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//return AnyGenBind`skip_struct(name)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">override </span><span style="color: #DCDCAA">skip_anyFunction</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">c </span><span style="color: #E6E6E6">: CXCursor; </span><span style="color: #9CDCFE">isMethod</span><span style="color: #E6E6E6">:</span><span style="color: #4EC9B0">bool</span><span style="color: #E6E6E6">) : </span><span style="color: #4EC9B0">bool</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">let</span><span style="color: #E6E6E6"> funcname </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> string(clang_getCursorSpelling(c))</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//не генерировать обвязку для повторно встречаемой функции (не совсем понимаю, почему встречаются повторы)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> unique_functions </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">find</span><span style="color: #E6E6E6">(funcname) </span><span style="color: #D4D4D4">!=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">null</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">true</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">else</span></span>
<span class="line"><span style="color: #E6E6E6">            unique_functions[</span><span style="color: #569CD6">funcname</span><span style="color: #E6E6E6">] </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">true</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> AnyGenBind`skip_anyFunction(self, c, isMethod)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//генерируем код для файлов, подходящих по шаблону msgpack/*.h</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">override </span><span style="color: #DCDCAA">skip_file</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">fname</span><span style="color: #E6E6E6">:</span><span style="color: #4EC9B0">string</span><span style="color: #E6E6E6">) : </span><span style="color: #4EC9B0">bool</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> fname </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">find</span><span style="color: #E6E6E6">(</span><span style="color: #CE9178">&quot;msgpack/&quot;</span><span style="color: #E6E6E6">) </span><span style="color: #D4D4D4">!=</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">-</span><span style="color: #B5CEA8">1</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">false</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">!</span><span style="color: #E6E6E6"> fname </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> ends_with(PARSE_FILE_NAME)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">override</span><span style="color: #E6E6E6"> generateModuleHPrefix</span></span>
<span class="line"><span style="color: #E6E6E6">        module_h_file </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> fwrite(</span><span style="color: #CE9178">&quot;#include </span><span style="color: #D7BA7D">\&quot;</span><span style="color: #CE9178">need_msgpack.h</span><span style="color: #D7BA7D">\&quot;\n</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> cgb </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> MsgpackGen()</span></span>
<span class="line"><span style="color: #E6E6E6">    defer </span><span style="color: #D4D4D4">&lt;|</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">delete</span><span style="color: #E6E6E6"> cgb</span></span>
<span class="line"><span style="color: #E6E6E6">    cgb</span><span style="color: #D4D4D4">-&gt;</span><span style="color: #E6E6E6">generate()</span></span>
<span class="line"><span style="color: #E6E6E6">    cgb</span><span style="color: #D4D4D4">-&gt;</span><span style="color: #E6E6E6">genCMakeDecl(</span><span style="color: #CE9178">&quot;DAS_MSGPACK_BIND&quot;</span><span style="color: #E6E6E6">)</span></span></code></pre></div></div></figure>
<p>Такой скрипт генерирует привязки к библиотеке, однако при её компиляции возникают несколько ошибок вида:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">использование неопределенного типа &quot;das::cast&lt;TT&gt;&quot; libDasModuleMsgpack \daScript\include\daScript\simulate\simulate.h</span></span></code></pre></div></div></figure></p>
<p>Необходимо добавить эти функции в список исключаемых из генерации:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">//передача в качестве аргумента POD-объекта по значению</span></span>
<span class="line"><span style="color: #E6E6E6">msgpack_object_print</span></span>
<span class="line"><span style="color: #E6E6E6">msgpack_object_print_buffer</span></span>
<span class="line"><span style="color: #E6E6E6">msgpack_object_equal</span></span>
<span class="line"><span style="color: #E6E6E6"></span></span>
<span class="line"><span style="color: #E6E6E6">//какие-то непонятки с передачей некоторых из базовых типов из C++ в daScript?</span></span>
<span class="line"><span style="color: #E6E6E6">msgpack_pack_char</span></span>
<span class="line"><span style="color: #E6E6E6">msgpack_pack_long</span></span>
<span class="line"><span style="color: #E6E6E6">msgpack_pack_unsigned_long</span></span></code></pre></div></div></figure></p>
<p>Убрав их из генерации, получаем компилирующийся модуль daScript <code>dasMsgpack</code>.</p>
<h2><span id="testovyy-skript">Тестовый скрипт</span><a href="#testovyy-skript" class="header-anchor">#</a></h2><p>Попытаемся портировать тестовый <a target="_blank" rel="noopener" href="https://github.com/msgpack/msgpack-c/blob/c_master/example/simple_c.c">пример</a> библиотеки с <code>MessagePack</code> с языка C на daScript:</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> msgpack</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> sbuf : msgpack_sbuffer</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> pk : msgpack_packer</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> mempool: msgpack_zone</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> deserialized: msgpack_object</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">unsafe</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> ptrBuf </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(sbuf)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> ptrPk </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(pk)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> ptrMempool </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(mempool)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> ptrDeserialized </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(deserialized)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">/* msgpack::sbuffer is a simple buffer implementation. */</span></span>
<span class="line"><span style="color: #E6E6E6">        msgpack_sbuffer_init(ptrBuf)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">/* serialize values into the buffer using msgpack_sbuffer_write callback function. */</span></span>
<span class="line"><span style="color: #E6E6E6">        msgpack_packer_init(ptrPk, ptrBuf)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        msgpack_pack_array(ptrPk, </span><span style="color: #B5CEA8">4</span><span style="color: #E6E6E6">ul)</span></span>
<span class="line"><span style="color: #E6E6E6">        msgpack_pack_int(ptrPk, </span><span style="color: #B5CEA8">1</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        msgpack_pack_true(ptrPk)</span></span>
<span class="line"><span style="color: #E6E6E6">        msgpack_pack_float(ptrPk, </span><span style="color: #B5CEA8">3.0</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        msgpack_pack_str(ptrPk, </span><span style="color: #B5CEA8">7</span><span style="color: #E6E6E6">ul)</span></span>
<span class="line"><span style="color: #E6E6E6">        msgpack_pack_str_body(ptrPk, </span><span style="color: #CE9178">&quot;example&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">7</span><span style="color: #E6E6E6">ul);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//print(&quot;{sbuf.data}, {sbuf.size}&quot;)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        msgpack_zone_init(ptrMempool, </span><span style="color: #B5CEA8">204</span><span style="color: #E6E6E6">8ul)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> data </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">ul;</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> ptrData </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">addr</span><span style="color: #E6E6E6">(data)</span></span>
<span class="line"><span style="color: #E6E6E6">        msgpack_unpack(sbuf</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">data, sbuf</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">size, ptrData, ptrMempool, ptrDeserialized);</span></span>
<span class="line"><span style="color: #E6E6E6">        msgpack_object_print(ptrDeserialized);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        msgpack_zone_destroy(ptrMempool);</span></span>
<span class="line"><span style="color: #E6E6E6">        msgpack_sbuffer_destroy(ptrBuf)</span></span></code></pre></div></div></figure>
<p>Некоторые функции из примеры не попали в автоматическую обвязку, поэтому необходимо дописать обвязку для них вручную в файле <code>msgpack.main.cpp</code>:<br><figure class="shiki cpp"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//передаём 3-й параметр по умолчанию</span></span>
<span class="line"><span style="color: #569CD6">void</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">das_msgpack_packer_init</span><span style="color: #E6E6E6">(</span><span style="color: #4EC9B0">msgpack_packer</span><span style="color: #569CD6">*</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">pk</span><span style="color: #E6E6E6">, </span><span style="color: #569CD6">void*</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">data</span><span style="color: #E6E6E6">) {</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #DCDCAA">msgpack_packer_init</span><span style="color: #E6E6E6">(pk, data, msgpack_sbuffer_write);</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//передаём параметр по указателю, не по значению</span></span>
<span class="line"><span style="color: #569CD6">void</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">das_msgpack_object_print</span><span style="color: #E6E6E6">(</span><span style="color: #4EC9B0">msgpack_object</span><span style="color: #569CD6">*</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">o</span><span style="color: #E6E6E6">) {</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #DCDCAA">msgpack_object_print</span><span style="color: #E6E6E6">(stdout, </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6">o);</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">//меняем тип второго указателя на const char* вместо неизвестного генератору void *</span></span>
<span class="line"><span style="color: #569CD6">void</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">das_msgpack_pack_str_body</span><span style="color: #E6E6E6">(</span><span style="color: #4EC9B0">msgpack_packer</span><span style="color: #569CD6">*</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">pk</span><span style="color: #E6E6E6">, </span><span style="color: #569CD6">const</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">char*</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">b</span><span style="color: #E6E6E6">, </span><span style="color: #569CD6">size_t</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">l</span><span style="color: #E6E6E6">) {</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #DCDCAA">msgpack_pack_str_body</span><span style="color: #E6E6E6">(pk, b, l);</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">void</span><span style="color: #E6E6E6"> Module_msgpack::</span><span style="color: #DCDCAA">initMain</span><span style="color: #E6E6E6">() {</span></span>
<span class="line"><span style="color: #6A9955">    //добавляем функции в модуль</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #DCDCAA">addExtern</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">DAS_BIND_FUN</span><span style="color: #E6E6E6">(</span><span style="color: #4EC9B0">das_msgpack_packer_init</span><span style="color: #E6E6E6">)&gt;(</span><span style="color: #D4D4D4">*</span><span style="color: #569CD6">this</span><span style="color: #E6E6E6">,lib,</span><span style="color: #CE9178">&quot;msgpack_packer_init&quot;</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">            SideEffects::worstDefault,</span><span style="color: #CE9178">&quot;das_msgpack_packer_init&quot;</span><span style="color: #E6E6E6">);</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #DCDCAA">addExtern</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">DAS_BIND_FUN</span><span style="color: #E6E6E6">(</span><span style="color: #4EC9B0">das_msgpack_object_print</span><span style="color: #E6E6E6">)&gt;(</span><span style="color: #D4D4D4">*</span><span style="color: #569CD6">this</span><span style="color: #E6E6E6">, lib, </span><span style="color: #CE9178">&quot;msgpack_object_print&quot;</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">		SideEffects::worstDefault, </span><span style="color: #CE9178">&quot;das_msgpack_object_print&quot;</span><span style="color: #E6E6E6">);</span></span>
<span class="line"><span style="color: #E6E6E6">	</span><span style="color: #DCDCAA">addExtern</span><span style="color: #E6E6E6">&lt;</span><span style="color: #4EC9B0">DAS_BIND_FUN</span><span style="color: #E6E6E6">(</span><span style="color: #4EC9B0">das_msgpack_pack_str_body</span><span style="color: #E6E6E6">)&gt;(</span><span style="color: #D4D4D4">*</span><span style="color: #569CD6">this</span><span style="color: #E6E6E6">, lib, </span><span style="color: #CE9178">&quot;msgpack_pack_str_body&quot;</span><span style="color: #E6E6E6">,</span></span>
<span class="line"><span style="color: #E6E6E6">		SideEffects::worstDefault, </span><span style="color: #CE9178">&quot;das_msgpack_pack_str_body&quot;</span><span style="color: #E6E6E6">);</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span></code></pre></div></div></figure></p>
<p>Теперь скрипт работает и выдаёт корректный результат десериализации объекта:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">[1, true, 3.000000, &quot;example&quot;]</span></span></code></pre></div></div></figure></p>
<p>Дальнейшая работа над модулем может предполагать:</p>
<ul>
<li>возможность устанавливать daScript колбеки (<a target="_blank" rel="noopener" href="https://github.com/borisbat/dasGlfw/blob/48f2715f0fe4cb8076866365a4bf0a29b7104765/src/cb_dasGLFW.h">пример из dasGlfw</a>)</li>
<li>daScript-обвязка над POD-структурой msgpack_object и корректная передача исключенных типов(?)</li>
<li>написание “daScript-ивизирующей” обёртки msgpack_boost, для перехода от с-апи к более удобной работы с библиотекой</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/spiiin/dasClangBind_modules">Репозиторий с примерами кода</a></p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"Ov23liG1mZbiQOIdi91X","clientSecret":"e05812685eb741a752982b89dcf6f5b58dc10251","repo":"spiiin.github.io","owner":"spiiin","admin":["spiiin"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/500729544/">Позже</a><a class="pagination__link pagination__next" href="/blog/1257365288/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div><!-- hexo injector body_end start -->
  <script>
  const CODE_CONFIG = {
    beautify: undefined,
    highlightCopy: undefined,
    highlightLang: undefined,
    highlightHeightLimit: undefined,
    isHighlightShrink: undefined,
    copy: {
      success: 'undefined',
      error: 'undefined',
      noSupport: 'undefined',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body></html>