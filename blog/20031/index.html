<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | Препарирование Tecmo World Cup Soccer [NES]</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><article class="article post"><h3 class="article__title">Препарирование Tecmo World Cup Soccer [NES]</h3><div class="article__date metadata"><div class="post-info">2011/05/07</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/nes/">nes</a><a class="article__tags__link metadata" href="/tags/hack/">hack</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>Игра посвящена событиям двадцатилетней давности, а именно <code>Чемпионату Мира по футболу в США 1990 года</code>.<br>Понять, что именно этому, а не какого-нибудь другому, можно только по дате выхода игры, потому что разработчики из Tecmo взяли из 24 реально участвующих там команд 13, добавили к ним зачем-то Францию, Польшу и Японию (Впрочем, Японию понятно зачем).</p>
<p>Регламент турнира они тоже изменили, и поэтому выбранной игроком команде в борьбе за чемпионский тутил предстоит победить всех остальных. Так как турнир при таком раскладе получается для одной из команд довольно длинный, то игроку представлена возможность начать игру не сначала, а с некоторым количеством уже выбитых команд, указав для удостоверения своих результатов выдаваемый игрой пароль.</p>
<p>Для разминки мозгов мне захотелось найти метод генерации этого пароля. Процесс разгадывания сгодится как базовый туториал по хаку игр.</p>
<h3 id="Часть-1"><a href="#Часть-1" class="headerlink" title="Часть 1."></a>Часть 1.</h3><p>Пароли в игре состоят из 9 букв, причем игра позволяет вводить только буквы от A до P. 16 символов в 9 позициях, значит всего существует <code>16**9 = 68 719 476 736</code> паролей. Число правильных паролей также можно посчитать. Для каждой команды есть пятнадцатиразрядный вектор из двоичных значений, показывающий, выбит ли её соответствующий соперник. Все такие вектора являются правильными паролями, кроме вектора из всех нулей (нет пароля, пока никто не выбит) и вектора из всех единиц (нет пароля на все выбитые команды). Значит, всего есть <code>16 * (2**15-2) = 524 256</code> верных значений. </p>
<h3 id="Часть-2"><a href="#Часть-2" class="headerlink" title="Часть 2."></a>Часть 2.</h3><p>Отношение верных паролей к полному их числу показывает, что на миллион паролей приходится где-то 7-8 правильных.</p>
<p>То есть просто выбирая случайные цифры, подобрать правильный пароль сложно. Но можно взять один из правильных паролей, сгенерированных игрой, и попробовать менять пары его символов. Данный метод изредка работает, из одного правильного пароля таким образом удается получить еще 3-4, что для начала неплохо, но получить из этого какие-то правила пока сложно.</p>
<p>Дальше можно набрать как можно больше паролей и сравнивать разность наиболее близких по смыслу пар паролей (метод “черного ящика” - внутренности системы неизвестны, зато можно легко анализировать её входы и выходы). Для получение большого числа паролей нужно как-то ускорить процесс их получения. Например, можно использовать поиск читов в эмуляторе <code>FceUltra</code> или <code>ArtMoney</code>.</p>
<p>С помощью поиска нужно найти в памяти ячейки, которые отвечают за кол-во минут до конца матча и счет. Так можно за несколько секунд прописывать себе победу и сохранять сгенерированный игрой пароль. Полученная таблица для всех побежденных 1-х соперников сборной Бразилии :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Германия    GDJGMBAFA</span><br><span class="line">Италия      LLKGMFONI</span><br><span class="line">Голландия   FLKGABPGI</span><br><span class="line">Аргентина   DLLHNBCNA</span><br><span class="line">СССР        DNMGMBCNA</span><br><span class="line">Польша      JLMGMBCNA</span><br><span class="line">Англия      DLHIMBONA</span><br><span class="line">Испания     GDLIMBAFA</span><br><span class="line">Колумбия    LLMIMBOPI</span><br><span class="line">Шотландия   FPMIMBPGI</span><br><span class="line">Франция     ELJINBCOA</span><br><span class="line">Кореея      DLKIMBCOE</span><br><span class="line">Япония      FLKIMBDCA</span><br></pre></td></tr></table></figure>
<p>Соседние пароли отличаются друг от друга довольно сильно :( Тут мне не повезло, так как я взял в качестве своей команды сборную Бразилии, стоящую в списке команд первой, и долго не замечал той вещи, что если “выбивать” Бразилию, то разность паролей от этого меняется меньше всего, что должно было бы сразу сигнализировать, что на пароль влияют не только выбитые команды, но и номер побежденного соперника. </p>
<p>Но к этому я пришел только, когда заметил, что при выбивании команд в разном порядке можно получить разные пароли. Зато в ходе экспериментов оказалось, что правильных паролей существует во 30 раз больше (каждый раз игра может сгенерировать 15 разных, в зависимости от текущей команды соперника, и, кроме того, при поражении выдается специальный пароль, который позволяет сыграть с той же самой командой, без жеребьевки, что еще вдвое удваивает количество верных пассов). После этого осталось только найти в памяти с помощью того же поиска читов номер текущего соперника и занулять его сразу после финального свистка судьи. Так получилась “чистая таблица” в которой были исключительно эффекты от победы над командой:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Германия    EDJGMDONA</span><br><span class="line">Уругвай     EFJGMDONI</span><br><span class="line">Англия      EFFGMDONI</span><br><span class="line">Голландия   EFFGADOOI</span><br><span class="line">Италия      MFFGAHOOI</span><br><span class="line">Испания     LNMOIHPOI</span><br><span class="line">Аргентина   LNOPIHPOI</span><br><span class="line">Япония      LNOPIHAKI</span><br><span class="line">Польша      PNOPJHACA</span><br><span class="line">Корея       PNOPJHACM</span><br><span class="line">Колумбия    IFOPJHAEM</span><br><span class="line">СССР        AFNDIHADM</span><br><span class="line">Франция     BFPDIHADM</span><br></pre></td></tr></table></figure>
<p>Здесь уже точно видно, что каждая из команд _почти_ всегда выбивается взаимным изменением пары символов (например, для устранения Франции 1-й символ увеличивается на 1, а третий - на 2). Запомнив эту разность, ее можно проверить на другом исходном правильном пароле и убедиться, что действительно выбивается та же команда. _почти_ всегда. </p>
<p>Примерно в одном из восьми случаев внезапно вместо пары символов меняются почти все. Это показывает, что в генераторе пароля где-то присутствует обратная связь, мешающая просто убирать команды таким методом.</p>
<p>Кажется, что этот иногда работающий способ - лучший, которого можно добиться, просто анализируя генерируемые игрой пароли, если только вы не Шерлок Холмс и не прогнозирующая нейронная сеть. </p>
<h3 id="Часть-3"><a href="#Часть-3" class="headerlink" title="Часть 3."></a>Часть 3.</h3><p>Так как простые методы не дают результата, приходится использовать более мощные инструменты. Далее понадобится сборка эмулятора для отладки <a href="http://www.the-interweb.com/serendipity/index.php?/categories/9-FCEUXD-SP" target="_blank" rel="noopener">FCEUltra SP</a> и дизассемблер <a href="http://www.idapro.ru/" target="_blank" rel="noopener">Ida Pro</a>, понимающий архитектуру 6502 для интерактивного анализа кода.</p>
<p>Сначала необходимо получить образ памяти для анализа, так как просто открыть ROM в дизассемблере мало - в нем может быть несколько банков памяти, отражающихся на одно адресное пространство процессора. </p>
<p>Вместо этого лучше открыть в эмуляторе просмотр памяти (ёTools-&gt;HexEditorё) и скопировать ее всю в отдельный файл.</p>
<p>Необходимо найти в памяти функцию, проверяющую правильность введенного пользователем пароля. Сложная, иногда требующая интуиции и удачи часть. Здесь решается относительно просто. Нужно в игре набрать случайный пароль и дальше найти его в памяти эмулятора. Там он есть в виде аски символов на экране и в виде чисел от 0 до 15. </p>
<p>Теперь на найденные адреса в отладчике ставятся точки остановки на чтение (нужно узнать, какая инструкция попытается считать введенные значения). Далее следует еще один сложный шаг - пошаговое слежение за выполнением функции в отладчике, с целью отловить ее окончание, чтобы понять, куда вернется программа, выполнив проверку на корректность пароля.</p>
<p>В результате выясняется, что вызов функции проверки находится по адресу $A816 [JSR A8A2], которая с адреса $A95E [RTS] возвращает управление обратно. Эти 328 байт необходимо из машинных инструкций мысленно превратить в код и понять его смысл.</p>
<p>Настоятельно рекомендую делать это с помощью отдельного дизассемблера ( например Ida Pro, <a href="http://griever.magicteam.net/doc/?doc=NES_IDA" target="_blank" rel="noopener">туториал</a> по использованию есть у Griever’а), потому что в отладчике делать это очень неудобно.</p>
<p>Дизассемблированный код алгоритма (с комментариями): <a href="http://www.everfall.com/paste/id.php?bpgzprxyq26j" target="_blank" rel="noopener">http://www.everfall.com/paste/id.php?bpgzprxyq26j</a></p>
<p>Дальше код алгоритма надо переписать в отдельную программу (на любом языке, например, <code>python</code>), которая будет проверять его на корректность и выдавать результат - <code>(команда игрока, команда соперника, какие команды выбиты и будет ли жеребьевка перед стартом очередного матча)</code>.<br>Код: <a href="http://www.everfall.com/paste/id.php?coljec5m2j2r" target="_blank" rel="noopener">http://www.everfall.com/paste/id.php?coljec5m2j2r</a></p>
<p>Так можно запустить подборщик паролей. А пока он работает, еще чуть посчитать. Правильное число правильных паролей - <code>256*256*16*16*2</code> (два байта на выбитые команды, 256 пар и бит жеребьевки) = 33 554 432, в 64 раза больше начальных прикидок.</p>
<p>Среди правильных паролей имеются такие, которые игра никогда не выдаст, и даже такие, которые по логике не должны выпадать никогда.</p>
<p>Например, игра с уже побежденной командой, выбивание своей собственной команды, “пустой пароль” без выбитых команд и “зеркальная игра” одной сборной:<br><a href="http://pics.livejournal.com/spiiin/pic/0001c2r4/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/0001c2r4" alt=""></a></p>
<p>Первый найденный брутфорсом пароль <code>AAAAEBPFJ</code>. </p>
<p>Собственно, подборщик лучше остановить, так как он будет работать очень долго, и заняться процедурой генерации пароля.</p>
<p>Ее можно получить, “развернув” все действия в обратном направлении или просто найти в памяти, поставив точку остановки отладчика на чтение на адрес $A6F1, где хранятся константы трансформации, найденные во время реверсирования процедуры проверки.</p>
<p>Версия генератора на питоне:<br><a href="http://www.everfall.com/paste/id.php?ou56bj09642s" target="_blank" rel="noopener">http://www.everfall.com/paste/id.php?ou56bj09642s</a></p>
<p>Попутно можно исследовать байт, в котором хранится бит жеребьевки. Другие биты и байты по соседству управляют состоянием матча и номерами-указателями на цвета команда.</p>
<p>Лулзов ради можно сдвинуть эти указатели за границу стандартных шестнадцати цветов команд и сыграть матч между сборной Фиолетововолосых Травяных Людей и сборной Пандорры:<br><a href="http://pics.livejournal.com/spiiin/pic/0001d96p/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/0001d96p" alt=""></a> </p>
<p>Напоследок можно вырвать из видеопамяти кусок, хранящий шрифт игры ( Tools-&gt;PPU Viewer… в FCEUltra в момент, когда на экране есть текст), и отрисовывать пароли именно им.</p>
<p>Пароли на все возможные финалы:</p>
<p><a href="http://pics.livejournal.com/spiiin/pic/0001ewyz/" target="_blank" rel="noopener"><img src="http://pics.livejournal.com/spiiin/pic/0001ewyz/s640x480" alt=""></a> </p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/47716/">Next</a><a class="pagination__link pagination__next" href="/blog/53133/">Back</a></div></main><footer class="footer metadata"><p class="footer__text">© 2022 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div></body></html>