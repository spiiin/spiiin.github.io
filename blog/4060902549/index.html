<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Spiiin's blog | daScript. SFML, dasBox и semi-transparent render target</title><meta name="description" content=""><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif&amp;display=swap"><link rel="stylesheet" href="/css/highlights/darkula.css"><link rel="stylesheet" href="/css/main.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spiiin.github.io/atom.xml" title="Spiiin's blog"><script>(function (i, s, o, g, r, a, m) {
  i['GoogleAnalyticsObject'] = r;
  i[r] = i[r] || function () {
    (i[r].q = i[r].q || []).push(arguments)
  }, i[r].l = 1 * new Date();
  a = s.createElement(o),
    m = s.getElementsByTagName(o)[0];
  a.async = 1;
  a.src = g;
  m.parentNode.insertBefore(a, m)
})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-00000000-0', 'auto');
ga('send', 'pageview');</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,0.1),rgba(40,44,52,0.9))}</style><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Spiiin's blog" type="application/atom+xml">
</head><body><div class="container"><header class="main-header"><h1 class="main-header__title uplize"><a class="main-header__title__link" href="/"><img class="header-image" src="/images/favicon.png" width="36" height="36">Spiiin's blog</a></h1><nav class="main-header__nav"><ul class="main-nav"><li class="main-nav__list"><a class="main-nav__list__link" href="/" target="_self">HOME</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/archives/" target="_self">ARCHIVE</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/tags/meta" target="_self">TAGS</a></li><li class="main-nav__list"><a class="main-nav__list__link" href="/blog/1" target="_self">ABOUT</a></li></ul></nav></header><main class="container__wrapper"><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/887709799/">Позже</a><a class="pagination__link pagination__next" href="/blog/2385889062/">Раньше</a></div><article class="article post"><h3 class="article__title">daScript. SFML, dasBox и semi-transparent render target</h3><div class="article__date metadata"><div class="post-info">2022/10/22</div></div><div class="article__tags metadata">Tags:
<a class="article__tags__link metadata" href="/tags/opengl/">opengl</a><a class="article__tags__link metadata" href="/tags/dascript/">dascript</a></div><div class="article__body"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><p>Пример работы с SFML в dasBox — рендер полупрозрачных объектов в рендер-таргет. Тривиальная задача для графического программиста, но почему-то многие разработчики игр не знают, как это корректно сделать.</p>
<h2><span id="intro">Intro</span><a href="#intro" class="header-anchor">#</a></h2><p>Изначальная задумка поста — собрать небольшой пример, показывающий алгоритм рендеринга полупрозрачных объектов в текстуру, с последующим корректным отображением этой текстуры, как если бы объекты рендерились на экран напрямую, без использования этой текстуры. Но попутно оказалось, что можно запилить фреймворк для таких демок, с возможноостью в live-режиме поиграться с параметрами и посмотреть результат.</p>
<h2><span id="dassfml">dasSFML</span><a href="#dassfml" class="header-anchor">#</a></h2><p>Примеры на <code>Opengl+GLFW</code>:<br><a href="/blog/4232971949/" title="daScript OpenGL">daScript OpenGL</a><br><a href="/blog/3006126295/" title="daScript - live-режим">daScript - live-режим</a></p>
<p>В отличие от GLFW, <code>SFML</code> представляет простые объекты-обёртки над функциями OpenGL для работы с текстурами, шейдерами, рендер-таргетами, и прочими примитивами библиотеки рендера, в то же время представляя для кастомизации практически все параметры рендера (во всяком случае необходимые для задуманного примера), для того, чтобы можно было писать небольшие примеры алгоритмов рендера на OpenGL.</p>
<p>Для начала, можно “завести” простейший <a target="_blank" rel="noopener" href="https://github.com/borisbat/dasSFML/blob/main/examples/graphics.das">пример</a> из комплекта привязки <code>SFML</code> к <code>daScript</code>.</p>
<p>Для его сборки выкачиваем сабмодули <code>daScript</code>:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">git submodule update --init --recursive</span></span></code></pre></div></div></figure></p>
<p>Затем включаем сборку этого модуля в CmakeLists.txt и добавляем линковку статической библиотеки с модулем libDasSFML и самих библиотек SFML:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">option(DAS_SFML_DISABLED &quot;Disable dasSFML (SFML multimedia library)&quot; OFF)</span></span>
<span class="line"><span style="color: #E6E6E6">...</span></span>
<span class="line"><span style="color: #E6E6E6">target_link_libraries(sfmlApp</span></span>
<span class="line"><span style="color: #E6E6E6">  libDasModuleSFML</span></span>
<span class="line"><span style="color: #E6E6E6">  sfml-graphics</span></span>
<span class="line"><span style="color: #E6E6E6">  sfml-network</span></span>
<span class="line"><span style="color: #E6E6E6">  sfml-system</span></span>
<span class="line"><span style="color: #E6E6E6">  sfml-window</span></span>
<span class="line"><span style="color: #E6E6E6">  #для windows также:</span></span>
<span class="line"><span style="color: #E6E6E6">  legacy_stdio_definitions</span></span>
<span class="line"><span style="color: #E6E6E6">  winmm</span></span>
<span class="line"><span style="color: #E6E6E6">  Opengl32</span></span>
<span class="line"><span style="color: #E6E6E6">  sfml-main</span></span>
<span class="line"><span style="color: #E6E6E6">)</span></span></code></pre></div></div></figure></p>
<p>и перегененируем проект<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">./generate_msvc_2019.bat</span></span></code></pre></div></div></figure></p>
<p>Затем в хост-приложении на C++:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//подключение заголовка с определением модуля</span></span>
<span class="line"><span style="color: #E6E6E6">#include </span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">dasSFML</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">src</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">dasSFML</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">h</span><span style="color: #D4D4D4">&gt;</span></span>
<span class="line"><span style="color: #D4D4D4">...</span></span>
<span class="line"><span style="color: #E6E6E6">  </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6"> main( </span><span style="color: #4EC9B0">int</span><span style="color: #E6E6E6">, char </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6"> [] ) {</span></span>
<span class="line"><span style="color: #E6E6E6">    NEED_ALL_DEFAULT_MODULES;</span></span>
<span class="line"><span style="color: #E6E6E6">    NEED_MODULE(Module_dasSFML); </span><span style="color: #6A9955">//&lt;---создаём модуль sfml</span></span>
<span class="line"><span style="color: #E6E6E6">    Module::Initialize();</span></span>
<span class="line"><span style="color: #E6E6E6">    run_script();</span></span>
<span class="line"><span style="color: #E6E6E6">    Module::Shutdown();</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">return</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">;</span></span>
<span class="line"><span style="color: #E6E6E6">}</span></span></code></pre></div></div></figure></p>
<p><code>run_script</code> вызывает метод <code>main</code> из примера, который создаёт SFML-окно и запускает цикл обработки сообщений в нём.</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> main</span></span>
<span class="line"><span style="color: #E6E6E6">    using(VideoMode(</span><span style="color: #B5CEA8">64</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">48</span><span style="color: #E6E6E6">0u), </span><span style="color: #CE9178">&quot;SFML window&quot;</span><span style="color: #E6E6E6">, uint(WindowStyle Default), ContextSettings()) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6"> ( </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">window </span><span style="color: #E6E6E6">: RenderWindow# )</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #C586C0">while</span><span style="color: #E6E6E6"> window </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> isOpen()</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> event : Event</span></span>
<span class="line"><span style="color: #E6E6E6">            </span><span style="color: #C586C0">while</span><span style="color: #E6E6E6"> window </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> pollEvent(event)</span></span>
<span class="line"><span style="color: #E6E6E6">                </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> event</span><span style="color: #D4D4D4">.</span><span style="color: #E6E6E6">_type </span><span style="color: #D4D4D4">==</span><span style="color: #E6E6E6"> EventType Closed</span></span>
<span class="line"><span style="color: #E6E6E6">                    window </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> close()</span></span>
<span class="line"><span style="color: #E6E6E6">            interface(window) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6"> ( </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rt </span><span style="color: #E6E6E6">: RenderTarget )</span></span>
<span class="line"><span style="color: #E6E6E6">                rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">clear</span><span style="color: #E6E6E6">( Color(</span><span style="color: #B5CEA8">6</span><span style="color: #E6E6E6">4u,</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u,</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u) )</span></span>
<span class="line"><span style="color: #E6E6E6">                using(</span><span style="color: #B5CEA8">50.0f</span><span style="color: #E6E6E6">,</span><span style="color: #B5CEA8">0x1e</span><span style="color: #E6E6E6">ul) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6"> ( </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">shape </span><span style="color: #E6E6E6">: CircleShape# )</span></span>
<span class="line"><span style="color: #E6E6E6">                    interface(shape) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6"> ( </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">tr </span><span style="color: #E6E6E6">: Transformable )</span></span>
<span class="line"><span style="color: #E6E6E6">                        tr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> move(</span><span style="color: #B5CEA8">20.</span><span style="color: #E6E6E6">,</span><span style="color: #B5CEA8">30.</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">                    shape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> setFillColor(Color(</span><span style="color: #B5CEA8">15</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">5</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u))</span></span>
<span class="line"><span style="color: #E6E6E6">                    shape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> setOutlineThickness(</span><span style="color: #B5CEA8">10.f</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">                    shape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> setOutlineColor(Color(</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">15</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">10</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u))</span></span>
<span class="line"><span style="color: #E6E6E6">                    rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> draw(shape, RenderStates_Default())</span></span>
<span class="line"><span style="color: #E6E6E6">            window </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> display()</span></span></code></pre></div></div></figure>
<p>В качестве фреймворка для создания окна используется имеющийся в SFML класс <code>Window</code>. Однако проще воспользоваться другим фреймворком, в который уже внедрены возможности daScript-а по перезагрузке кода.</p>
<h2><span id="dasbox">dasbox</span><a href="#dasbox" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://github.com/imp5imp5/dasbox">dasbox</a> — примитивный движок для 2d-игр, который Gaijin-ы использовали для проведения конкурса <a target="_blank" rel="noopener" href="https://gaijinjam.net/ru">Gaijin Jam</a> (<a target="_blank" rel="noopener" href="https://github.com/AlexLemminG/TheFarmers">игра-победитель</a>). Движок имеет простую <a target="_blank" rel="noopener" href="https://github.com/imp5imp5/dasbox/blob/main/doc/api.txt">апишку</a>, на которой можно потренироваться использованию языка на уровне “как будто типизированная lua”, а также настроен для подключения отладчика языка, веб-инспектора для отображения состояния ecs-модуля и горячей перезагрузке кода.</p>
<p>Но для меня интереснее другое — <code>dasbox</code> использует в качестве бекэнда <code>SFML</code>. И хотя это осознанно скрыто от пользователей для того, чтобы можно было сменить бекэнд, можно немного “поломать инкапсуляцию”, для того, чтобы воспользоваться в нём модулем <code>dasSFML</code>, и получить доступ к более богатому API, получив от самого dasbox-а фичи и инструменты по работе с кодом.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/spiiin/dasbox_sfml">dasbox_sfml</a> — порт дасбокса с включенным модулем dasSFML.</p>
<p>Базовый пример на нём выглядит так:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> daslib</span><span style="color: #D4D4D4">/</span><span style="color: #E6E6E6">media</span></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> sfml</span></span>
<span class="line"><span style="color: #C586C0">require</span><span style="color: #E6E6E6"> dasbox_sfml</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> initialize</span></span>
<span class="line"><span style="color: #E6E6E6">    set_window_title(</span><span style="color: #CE9178">&quot;sfml&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">act</span><span style="color: #E6E6E6">(</span><span style="color: #9CDCFE">dt</span><span style="color: #E6E6E6">: </span><span style="color: #4EC9B0">float</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">if</span><span style="color: #E6E6E6"> get_key(VK_ESCAPE)</span></span>
<span class="line"><span style="color: #E6E6E6">        schedule_quit_game()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> draw</span></span>
<span class="line"><span style="color: #E6E6E6">    withRenderTarget </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rt</span><span style="color: #E6E6E6">: RenderTarget</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">clear</span><span style="color: #E6E6E6">(Color(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u))</span></span>
<span class="line"><span style="color: #E6E6E6">        using(</span><span style="color: #B5CEA8">50.0f</span><span style="color: #E6E6E6">,</span><span style="color: #B5CEA8">0x1e</span><span style="color: #E6E6E6">ul) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">shape</span><span style="color: #E6E6E6">: CircleShape#)</span></span>
<span class="line"><span style="color: #E6E6E6">            interface(shape) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">tr</span><span style="color: #E6E6E6">: Transformable)</span></span>
<span class="line"><span style="color: #E6E6E6">                tr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> move(</span><span style="color: #B5CEA8">20.</span><span style="color: #E6E6E6">,</span><span style="color: #B5CEA8">30.</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">            shape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> setFillColor(Color(</span><span style="color: #B5CEA8">15</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">5</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u))</span></span>
<span class="line"><span style="color: #E6E6E6">            shape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> setOutlineThickness(</span><span style="color: #B5CEA8">10.f</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">            shape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> setOutlineColor(Color(</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">15</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">10</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u))</span></span>
<span class="line"><span style="color: #E6E6E6">            rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> draw(shape, RenderStates_Default())</span></span></code></pre></div></div></figure><br><img src="/blog/4060902549/screen1_small.png" alt></p>
<p><code>dasBox_sfml</code> подхватывает изменения в файле с кодом, а также отображает в своей консоли ошибки в этом файле.</p>
<p>Идиомы <code>daScript</code> в примере:</p>
<ul>
<li><code>using()</code> - создание переменной <a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/temporary.html">временного типа</a>, который существует только в пределах блока using</li>
</ul>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">using() </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">fs</span><span style="color: #E6E6E6">: das_string#)</span></span>
<span class="line"><span style="color: #E6E6E6">    fs </span><span style="color: #D4D4D4">:=</span><span style="color: #E6E6E6"> </span><span style="color: #CE9178">&quot;hello world&quot;</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//тут можно использовать переменную, в том числе передавать в другие функции</span></span>
<span class="line"><span style="color: #E6E6E6">    some_func(fs)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//но нельзя как-либо сохранить указатель на эту переменную</span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #6A9955">//var s = fs //ошибка, нельзя копировать временный тип</span></span></code></pre></div></div></figure>
<ul>
<li><code>interface</code> - приведение к базовому типу</li>
</ul>
<p>Генератор привязок на C++ позволяет передать отношение наследования двух C++ типов в daScript так:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">addExtern</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6"> decltype(</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">with_interface</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">sf::Sprite,sf::Transformable</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">), with_interface</span><span style="color: #D4D4D4">&lt;</span><span style="color: #E6E6E6">sf::Sprite,sf::Transformable</span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #D4D4D4">&gt;</span><span style="color: #E6E6E6">(</span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6">this,lib,</span><span style="color: #CE9178">&quot;interface&quot;</span><span style="color: #E6E6E6">,SideEffects::</span><span style="color: #DCDCAA">invoke</span><span style="color: #E6E6E6">,</span><span style="color: #CE9178">&quot;with_interface&lt;sf::Sprite,sf::Transformable&gt;&quot;</span><span style="color: #E6E6E6">);</span></span></code></pre></div></div></figure></p>
<p><code>daScript</code> заставляет думать о типах и их времени жизни немного больше, чем C++, но и позволяет выразить больше таких утверждений, которые сможет проверить компилятор, чтобы уберечься от ошибок.</p>
<h2><span id="rendertarget">RenderTarget</span><a href="#rendertarget" class="header-anchor">#</a></h2><p>Следующий пример — рендер в текстуру и отображение её на экране. В SFML для этого можно использовать класс <a target="_blank" rel="noopener" href="https://www.sfml-dev.org/documentation/2.5.1/classsf_1_1RenderTexture.php">RenderTexture</a></p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> draw</span></span>
<span class="line"><span style="color: #E6E6E6">    withRenderTarget </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rt</span><span style="color: #E6E6E6">: RenderTarget</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #DCDCAA">clear</span><span style="color: #E6E6E6">(rt, Color(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u))</span></span>
<span class="line"><span style="color: #E6E6E6">        using() </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rtTex</span><span style="color: #E6E6E6">: RenderTexture#)</span></span>
<span class="line"><span style="color: #E6E6E6">            rtTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> create(</span><span style="color: #B5CEA8">30</span><span style="color: #E6E6E6">0u, </span><span style="color: #B5CEA8">30</span><span style="color: #E6E6E6">0u, </span><span style="color: #C586C0">false</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">            using(</span><span style="color: #B5CEA8">50.0f</span><span style="color: #E6E6E6">,</span><span style="color: #B5CEA8">0x1e</span><span style="color: #E6E6E6">ul) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">shape</span><span style="color: #E6E6E6">: CircleShape#)</span></span>
<span class="line"><span style="color: #E6E6E6">                interface(shape) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">tr</span><span style="color: #E6E6E6">: Transformable)</span></span>
<span class="line"><span style="color: #E6E6E6">                    tr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> move(</span><span style="color: #B5CEA8">20.</span><span style="color: #E6E6E6">,</span><span style="color: #B5CEA8">30.</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">                shape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> setFillColor(Color(</span><span style="color: #B5CEA8">15</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">5</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u))</span></span>
<span class="line"><span style="color: #E6E6E6">                shape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> setOutlineThickness(</span><span style="color: #B5CEA8">10.f</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">                shape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> setOutlineColor(Color(</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">15</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">10</span><span style="color: #E6E6E6">0u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u))</span></span>
<span class="line"><span style="color: #E6E6E6">                rtTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> draw(shape, RenderStates_Default())</span></span>
<span class="line"><span style="color: #E6E6E6">            using(rtTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> getTexture()) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">sprite</span><span style="color: #E6E6E6">: Sprite#)</span></span>
<span class="line"><span style="color: #E6E6E6">                rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> draw(sprite, RenderStates_Default())</span></span></code></pre></div></div></figure>
<p>Пока всё хорошо, и круг отрендеренный в текстуру выглядит также, как если бы был выведен на экран напрямую</p>
<h2><span id="poluprozrachnye-obekty-v-rendertarget">Полупрозрачные объекты в RenderTarget</span><a href="#poluprozrachnye-obekty-v-rendertarget" class="header-anchor">#</a></h2><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #6A9955">//рендер двух полупрозрачных кругов</span></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">drawCircles</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rt</span><span style="color: #E6E6E6">: RenderTarget</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    using(</span><span style="color: #B5CEA8">125.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">12</span><span style="color: #E6E6E6">8ul) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">shape</span><span style="color: #E6E6E6">: CircleShape#)</span></span>
<span class="line"><span style="color: #E6E6E6">        shape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> setFillColor(Color(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u,</span><span style="color: #B5CEA8">12</span><span style="color: #E6E6E6">8u))</span></span>
<span class="line"><span style="color: #E6E6E6">        rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> draw(shape, RenderStates_Default())</span></span>
<span class="line"><span style="color: #E6E6E6">    using(</span><span style="color: #B5CEA8">125.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">12</span><span style="color: #E6E6E6">8ul) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">shape</span><span style="color: #E6E6E6">: CircleShape#)</span></span>
<span class="line"><span style="color: #E6E6E6">        interface(shape) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">tr</span><span style="color: #E6E6E6">: Transformable) { tr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> move(</span><span style="color: #B5CEA8">125.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">0.0f</span><span style="color: #E6E6E6">); }</span></span>
<span class="line"><span style="color: #E6E6E6">        shape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> setFillColor(Color(</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">05u</span><span style="color: #E6E6E6">,</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u,</span><span style="color: #B5CEA8">12</span><span style="color: #E6E6E6">8u))</span></span>
<span class="line"><span style="color: #E6E6E6">        rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> draw(shape, RenderStates_Default())</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> draw</span></span>
<span class="line"><span style="color: #E6E6E6">    withRenderTarget </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rt</span><span style="color: #E6E6E6">: RenderTarget</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">clear</span><span style="color: #E6E6E6">(Color(</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//простой рендер</span></span>
<span class="line"><span style="color: #E6E6E6">        text_out(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;Simple&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">0xFF000000</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        drawCircles(rt)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//рендер в текстуру</span></span>
<span class="line"><span style="color: #E6E6E6">        text_out(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">300</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;Texture&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">0xFF000000</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        using() </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rtTex</span><span style="color: #E6E6E6">: RenderTexture#)</span></span>
<span class="line"><span style="color: #E6E6E6">            rtTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> create(</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">0u </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">12</span><span style="color: #E6E6E6">5u, </span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">0u, </span><span style="color: #C586C0">false</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">            rtTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">clear</span><span style="color: #E6E6E6">(Color(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u, </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u, </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u, </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u))</span></span>
<span class="line"><span style="color: #E6E6E6">            drawCircles(rtTex)</span></span>
<span class="line"><span style="color: #E6E6E6">            using(rtTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> getTexture()) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">sprite</span><span style="color: #E6E6E6">: Sprite#)</span></span>
<span class="line"><span style="color: #E6E6E6">                interface(sprite) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">tr</span><span style="color: #E6E6E6">: Transformable)</span></span>
<span class="line"><span style="color: #E6E6E6">                    tr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> move(</span><span style="color: #B5CEA8">0.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">300.0f</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">                rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> draw(sprite, RenderStates_Default())</span></span></code></pre></div></div></figure>
<p><img src="/blog/4060902549/screen2_small.png" alt></p>
<p>Полупрозрачные круги, отрендеренные в текстуру, выглядят темнее, чем отрисованные на экране напрямую. С реальными текстурами (или отрендеренными в текстуру шрифтами), проблема обычно выглядит как темная рамка на краях объекта (там где края ради сглаживания плавно “уходят” в прозрачность).</p>
<p>Из-за чего это возникает?</p>
<p>Цвет пиксела отрисованного объекта смешивается в пикселем, уже находящимся в буфере цвете по настраиваемым формулам. При прямой отрисовке порядок рендера получается таким:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">рисуется пиксел красного круга -&gt; смешивается с цветом dst1 фона (белое изображение) = получаем цвет dst2</span></span>
<span class="line"><span style="color: #E6E6E6">рисуется пиксел зеленого круга -&gt; смешивается с цветом dst2 (фон + красный круг)</span></span></code></pre></div></div></figure></p>
<p>Тогда как в случае рендера в текстуру происходит:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">рисуется пиксел красного круга -&gt; смешивается с фоновым цветом рендер таргет текстуры dst_rt1 (&quot;пустой&quot; rgba цвет, rgb каналы по умолчанию чёрные) = получаем dst_rt2</span></span>
<span class="line"><span style="color: #E6E6E6">рисуется пиксел зелёного круга -&gt; смешивается с цветом dst_rt2 (пустой цвет текстуры + красный круг)</span></span>
<span class="line"><span style="color: #E6E6E6">текстура выводится на экран -&gt; смешивается цвет фона dst1 с цветом рендер таргет текстуры (пустой цвет текстуры + красный круг + зелёный круг)</span></span></code></pre></div></div></figure></p>
<p>Видно, что в итоговом цвете на экрана присутствует влияние цвета render-target текстуры — прозрачного по альфа каналу, но в итоговой формуле кроме альфа канала влияение оказывают также и RGB каналы цвета (чёрного или любого другого — неважно, но избавиться от влияния этого фонового цвета без изменения формулы смешивания невозможно, “невидимый” цвет начинает быть видимым).</p>
<h2><span id="nastroyka-rezhimov-smeshivaniya">Настройка режимов смешивания</span><a href="#nastroyka-rezhimov-smeshivaniya" class="header-anchor">#</a></h2><p><code>OpenGL</code> (и <code>SFML</code> над ней) дают возможность переключать формулы режимов смешивания. Важно отойти от представления “определенная формула магическим образом включает полупрозрачность” к тому, что графический API просто даёт возможность изменить уравнение смешивание, а вывод конкретных формул ложится на плечи программиста.</p>
<p>Стандартное уравнение смешивания для полупрозрачности смешивает цвета в пропорции:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA); </span></span>
<span class="line"><span style="color: #E6E6E6">GL_SRC_ALPHA - коэффициент смешивания рисуемого цвета - чем прозрачнее рисуемая фигура, тем меньше видно её цвет</span></span>
<span class="line"><span style="color: #E6E6E6">GL_ONE_MINUS_SRC_ALPHA - коэффициент смешивания фонового цвета - обратный, чем прозрачнее рисуемая фигура, тем больше видно цвет за ней</span></span>
<span class="line"><span style="color: #E6E6E6"></span></span>
<span class="line"><span style="color: #E6E6E6">r1 - цвет фона</span></span>
<span class="line"><span style="color: #E6E6E6">r2 - цвет 1-го круга</span></span>
<span class="line"><span style="color: #E6E6E6">r3 - цвет 2-го круга</span></span>
<span class="line"><span style="color: #E6E6E6">после отрисовки фона m1 = (a1 * r1)</span></span>
<span class="line"><span style="color: #E6E6E6">смешанный цвет после отрисовки первого круга m2 = (a2 * r2 + (1.0 - a2) * a1 * r1)</span></span>
<span class="line"><span style="color: #E6E6E6">смешанный цвет после отрисовки второго круга m3 = (a3 * r3 + (1.0 - a3) * (a2 * r2 + (1.0 - a2) * a1 * r1)) = </span></span>
<span class="line"><span style="color: #E6E6E6"> = (a3 * r3 + (1.0 - a3) * a2 * r2 + (1.0 - a3) * (1.0 - a2) * a1 * r1)</span></span></code></pre></div></div></figure></p>
<p>При рендере в текстуру по умолчанию используется другая формула, которая разделяет рассчёты для RGB-каналов цвета и для A-канала.</p>
<figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">glBlendFuncSeparate(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA, GL_ONE, GL_ONE_MINUS_SRC_ALPHA);</span></span>
<span class="line"><span style="color: #E6E6E6">для RGB-каналов - аналогично предыдущей формуле</span></span>
<span class="line"><span style="color: #E6E6E6">для A-канала:</span></span>
<span class="line"><span style="color: #E6E6E6">  Asrc + Adst * (1-Asrc) - альфа значение рисуемого цвета берётся &quot;как есть&quot; и складывается с уменьшенным фоновым значением </span></span>
<span class="line"><span style="color: #E6E6E6"></span></span>
<span class="line"><span style="color: #E6E6E6">Цвет и альфа для рендер-таргет текстуры - glBlendFuncSeparate(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA, GL_ONE, GL_ONE_MINUS_SRC_ALPHA);</span></span>
<span class="line"><span style="color: #E6E6E6">цвет в рендер-таргет текстуре rt1 = r1 * a1 (берём черный прозрачный цвет r1=(0,0,0), a1=0 - четвёртый компонент важен)</span></span>
<span class="line"><span style="color: #E6E6E6">цвет после добавления круга rt2 = (a2 * r2 + (1.0 - a2) * a1 * r1) = a2 * r2     //premultiply alpha</span></span>
<span class="line"><span style="color: #E6E6E6">альфа после добавления круга rta2 = a2 + a1 * (1-a2) = a2</span></span>
<span class="line"><span style="color: #E6E6E6">цвет после добавления второго круга rt3 = (a3 * r3 + (1.0 - a3) * a2 * r2)</span></span>
<span class="line"><span style="color: #E6E6E6">альфа после добавления второго круга rta3 = a3 + a2 * (1 - a3)</span></span></code></pre></div></div></figure>
<p>Эта формула годится только для рендера полностью непрозрачных объектов. Если какие-то части объекта прозрачные, необходимо использовать другую пару формул (для рендера в текстуру + для рендера полученной текстуры на экране). Для рендера в текстуру при этом можно даже получать “неправильные” цвета, которые можно потом смешать с изображением на экране так, чтобы смешанный итоговый цвет стал корректным.</p>
<p>Хороший разбор проблемы на <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/24346585/opengl-render-to-texture-with-partial-transparancy-translucency-and-then-rende">stackoverflow</a><br>Формулы смешивания также разжеваны в статье <a target="_blank" rel="noopener" href="https://habr.com/ru/post/468067/">Как работает альфа-композитинг</a></p>
<h2><span id="source-over">Source-Over</span><a href="#source-over" class="header-anchor">#</a></h2><p>Одно из возможных решений — смешать цвет полученной render target текстуры в режиме <code>Source-Over</code> (термин из статьи выше, из списка операторов смешивания Портера-Даффа):<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">glBlendFunc(GL_ONE, GL_ONE_MINUS_SRC_ALPHA)</span></span>
<span class="line"><span style="color: #E6E6E6">итоговый цвет m3 = rt3 + m1 * (1.0 - rta3)</span></span>
<span class="line"><span style="color: #E6E6E6"></span></span>
<span class="line"><span style="color: #E6E6E6">подставим сюда значения значения из предудыщей формулы для рендерт-таргет цвета и текстуры:</span></span>
<span class="line"><span style="color: #E6E6E6">m3 = (a3 * r3 + (1.0 - a3) * a2 * r2) + (a1 * r1) * (1.0 - a3 - a2 * (1 - a3))</span></span>
<span class="line"><span style="color: #E6E6E6"></span></span>
<span class="line"><span style="color: #E6E6E6">Теперь можно сравнить полученные значения итогового цвета m3 из формулы прямого рендера и этой формулы:</span></span>
<span class="line"><span style="color: #E6E6E6">m3_direct == m3_sourceover</span></span>
<span class="line"><span style="color: #E6E6E6">(a3 * r3 + (1.0 - a3) * a2 * r2 + (1.0 - a3) * (1.0 - a2) * a1 * r1) == (a3 * r3 + (1.0 - a3) * a2 * r2) + (a1 * r1) * (1.0 - a3 - a2 * (1 - a3))</span></span>
<span class="line"><span style="color: #E6E6E6">(1.0 - a3) * (1.0 - a2) == (1.0 - a3 - a2 * (1 - a3)</span></span>
<span class="line"><span style="color: #E6E6E6">1.0 - a3 - a2 + a2*a3 == 1.0 - a3 - a2 + a2*a3</span></span>
<span class="line"><span style="color: #E6E6E6"></span></span>
<span class="line"><span style="color: #E6E6E6">Тада! убедились в равенстве</span></span></code></pre></div></div></figure></p>
<p>Код смешивания в режиме <code>Source-Over</code>, правильный результат:<br><figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> draw</span></span>
<span class="line"><span style="color: #E6E6E6">    withRenderTarget </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rt</span><span style="color: #E6E6E6">: RenderTarget</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">clear</span><span style="color: #E6E6E6">(Color(</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//simple draw</span></span>
<span class="line"><span style="color: #E6E6E6">        text_out(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;Simple&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">0xFF000000</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        drawCircles(rt)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//render texture draw</span></span>
<span class="line"><span style="color: #E6E6E6">        text_out(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">300</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;Texture: Satsub&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">0xFF000000</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        using() </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rtTex</span><span style="color: #E6E6E6">: RenderTexture#)</span></span>
<span class="line"><span style="color: #E6E6E6">            rtTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> create(</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">0u </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">12</span><span style="color: #E6E6E6">5u, </span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">0u, </span><span style="color: #C586C0">false</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">            rtTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">clear</span><span style="color: #E6E6E6">(Color(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u, </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u, </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u, </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u))</span></span>
<span class="line"><span style="color: #E6E6E6">            drawCircles(rtTex)</span></span>
<span class="line"><span style="color: #E6E6E6">            using(rtTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> getTexture()) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">sprite</span><span style="color: #E6E6E6">: Sprite#)</span></span>
<span class="line"><span style="color: #E6E6E6">                interface(sprite) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">tr</span><span style="color: #E6E6E6">: Transformable)</span></span>
<span class="line"><span style="color: #E6E6E6">                    tr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> move(</span><span style="color: #B5CEA8">0.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">300.0f</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">                using(Factor One, Factor OneMinusSrcAlpha, Equation Add) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">blendMode</span><span style="color: #E6E6E6">: BlendMode#)</span></span>
<span class="line"><span style="color: #E6E6E6">                    using(blendMode) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">renderState</span><span style="color: #E6E6E6">: RenderStates#)</span></span>
<span class="line"><span style="color: #E6E6E6">                        rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> draw(sprite, renderState)</span></span></code></pre></div></div></figure><br><img src="/blog/4060902549/screen3_small.png" alt></p>
<h2><span id="premultiply-alpha">Premultiply alpha</span><a href="#premultiply-alpha" class="header-anchor">#</a></h2><p>Если посмотреть на коэффициенты смешивания в “неправильном” блендинге, и в <code>Sourse-Over</code>, можно прийти к более правильному интуитивному пониманию лишнего влияния цвета в неправильной версии. В неё не “вмешан” лишний чёрный цвет, а добавлено лишнее умножение цвета на альфа канал, которое “гасит” этот цвет больше, чем необходимо при корректном смешивании.</p>
<p>Можно пойти другим путём — убрать умножение цвета на альфу при смешивании совсем, но производить его 1 раз в шейдере — тогда не нужно переключать режим прозрачности, но нужно переключать шейдер, с которым отрисован объект. Преимуществом такого способами может быть то, что исходное изображение часто можно домножить на альфа-канал еще до запуска приложения (в демо-примере изображение генерится динамически, поэтому умножение сделано в шейдере).</p>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> fragmentShaderTex </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #CE9178">&quot;uniform sampler2D texture;</span></span>
<span class="line"><span style="color: #CE9178">void main()</span></span>
<span class="line"><span style="color: #D7BA7D">\{</span></span>
<span class="line"><span style="color: #CE9178">    gl_FragColor = texture2D(texture, gl_TexCoord[0].st);</span></span>
<span class="line"><span style="color: #D7BA7D">\}</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> fragmentShaderPremultiply </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> (</span></span>
<span class="line"><span style="color: #CE9178">&quot;void main()</span></span>
<span class="line"><span style="color: #D7BA7D">\{</span></span>
<span class="line"><span style="color: #CE9178">    //gl_FragColor = gl_Color;  //for testing no premultiply</span></span>
<span class="line"><span style="color: #CE9178">    gl_FragColor = vec4(gl_Color.rgb * gl_Color.a, gl_Color.a);</span></span>
<span class="line"><span style="color: #D7BA7D">\}</span><span style="color: #CE9178">&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> rsPremultiplySatSub, rsSatSub : RenderStates?</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> initialize</span></span>
<span class="line"><span style="color: #E6E6E6">    set_window_title(</span><span style="color: #CE9178">&quot;sfml&quot;</span><span style="color: #E6E6E6">) </span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> shaderPremult </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> Shader()</span></span>
<span class="line"><span style="color: #E6E6E6">    shaderPremult </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> load_fragment_shader_from_string(fragmentShaderPremultiply)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> shaderTex </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> Shader()</span></span>
<span class="line"><span style="color: #E6E6E6">    shaderTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> load_fragment_shader_from_string(fragmentShaderTex)    </span></span>
<span class="line"><span style="color: #E6E6E6">    shaderTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> bind_current_texture_to_uniform(</span><span style="color: #CE9178">&quot;texture&quot;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    </span></span>
<span class="line"><span style="color: #E6E6E6">    </span><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> blendModeSatSubSeparate </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> BlendMode(Factor One, Factor OneMinusSrcAlpha, Equation Add, Factor OneMinusDstAlpha, Factor One, Equation Add)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">    rsPremultiplySatSub </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> makeRenderTarget(shaderPremult, blendModeSatSubSeparate)</span></span>
<span class="line"><span style="color: #E6E6E6">    rsSatSub </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> makeRenderTarget(shaderTex, blendModeSatSubSeparate)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">drawCircles</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rt</span><span style="color: #E6E6E6">: RenderTarget</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">; </span><span style="color: #9CDCFE">rs</span><span style="color: #E6E6E6">: RenderStates</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">implicit</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    using(</span><span style="color: #B5CEA8">125.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">12</span><span style="color: #E6E6E6">8ul) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">shape</span><span style="color: #E6E6E6">: CircleShape#)</span></span>
<span class="line"><span style="color: #E6E6E6">        shape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> setFillColor(Color(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u,</span><span style="color: #B5CEA8">12</span><span style="color: #E6E6E6">8u))</span></span>
<span class="line"><span style="color: #E6E6E6">        rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> draw(shape, rs)</span></span>
<span class="line"><span style="color: #E6E6E6">    using(</span><span style="color: #B5CEA8">125.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">12</span><span style="color: #E6E6E6">8ul) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">shape</span><span style="color: #E6E6E6">: CircleShape#)</span></span>
<span class="line"><span style="color: #E6E6E6">        interface(shape) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">tr</span><span style="color: #E6E6E6">: Transformable) { tr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> move(</span><span style="color: #B5CEA8">125.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">0.0f</span><span style="color: #E6E6E6">); }</span></span>
<span class="line"><span style="color: #E6E6E6">        shape </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> setFillColor(Color(</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">05u</span><span style="color: #E6E6E6">,</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u,</span><span style="color: #B5CEA8">12</span><span style="color: #E6E6E6">8u))</span></span>
<span class="line"><span style="color: #E6E6E6">        rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> draw(shape, rs)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">render_with_blend_and_premultiply</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rt</span><span style="color: #E6E6E6">: RenderTarget</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    drawCircles(rt, </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6">rsPremultiplySatSub)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">def</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">render_sprite_with_blend</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rt</span><span style="color: #E6E6E6">: RenderTarget</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">; </span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">sprite</span><span style="color: #E6E6E6">: Sprite</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">implicit</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">    rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> draw(sprite, </span><span style="color: #D4D4D4">*</span><span style="color: #E6E6E6">rsSatSub)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">[</span><span style="color: #569CD6">export</span><span style="color: #E6E6E6">]</span></span>
<span class="line"><span style="color: #C586C0">def</span><span style="color: #E6E6E6"> draw</span></span>
<span class="line"><span style="color: #E6E6E6">    withRenderTarget </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rt</span><span style="color: #E6E6E6">: RenderTarget</span><span style="color: #D4D4D4">&amp;</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        rt </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">clear</span><span style="color: #E6E6E6">(Color(</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u,</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">5u))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//simple draw</span></span>
<span class="line"><span style="color: #E6E6E6">        text_out(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;Simple&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">0xFF000000</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">        drawCircles(rt, RenderStates_Default())</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        </span><span style="color: #6A9955">//render texture draw</span></span>
<span class="line"><span style="color: #E6E6E6">        text_out(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">300</span><span style="color: #E6E6E6">, </span><span style="color: #CE9178">&quot;Texture: Premult&quot;</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">0xFF000000</span><span style="color: #E6E6E6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6E6E6">        using() </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">rtTex</span><span style="color: #E6E6E6">: RenderTexture#)</span></span>
<span class="line"><span style="color: #E6E6E6">            rtTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> create(</span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">0u </span><span style="color: #D4D4D4">+</span><span style="color: #E6E6E6"> </span><span style="color: #B5CEA8">12</span><span style="color: #E6E6E6">5u, </span><span style="color: #B5CEA8">25</span><span style="color: #E6E6E6">0u, </span><span style="color: #C586C0">false</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">            rtTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> </span><span style="color: #DCDCAA">clear</span><span style="color: #E6E6E6">(Color(</span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u, </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u, </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u, </span><span style="color: #B5CEA8">0</span><span style="color: #E6E6E6">u))</span></span>
<span class="line"><span style="color: #E6E6E6">            render_with_blend_and_premultiply(rtTex)</span></span>
<span class="line"><span style="color: #E6E6E6">            using(rtTex </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> getTexture()) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">sprite</span><span style="color: #E6E6E6">: Sprite#)</span></span>
<span class="line"><span style="color: #E6E6E6">                interface(sprite) </span><span style="color: #D4D4D4">&lt;|</span><span style="color: #E6E6E6"> </span><span style="color: #569CD6">$</span><span style="color: #E6E6E6">(</span><span style="color: #569CD6">var</span><span style="color: #E6E6E6"> </span><span style="color: #9CDCFE">tr</span><span style="color: #E6E6E6">: Transformable)</span></span>
<span class="line"><span style="color: #E6E6E6">                    tr </span><span style="color: #D4D4D4">|&gt;</span><span style="color: #E6E6E6"> move(</span><span style="color: #B5CEA8">0.0f</span><span style="color: #E6E6E6">, </span><span style="color: #B5CEA8">300.0f</span><span style="color: #E6E6E6">)</span></span>
<span class="line"><span style="color: #E6E6E6">                render_sprite_with_blend(rt, sprite)</span></span></code></pre></div></div></figure>
<p><img src="/blog/4060902549/screen4_small.png" alt></p>
<p>Универсальный режим смешивания для premultiply изображений:<br><figure class="shiki"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #E6E6E6">glBlendFuncSeparate(GL_ONE, GL_ONE_MINUS_SRC_ALPHA, GL_ONE_MINUS_DST_ALPHA, GL_ONE);</span></span>
<span class="line"><span style="color: #E6E6E6"></span></span>
<span class="line"><span style="color: #E6E6E6">Порядок рендера:</span></span>
<span class="line"><span style="color: #E6E6E6">1. Вывод в изображения в рендер-таргет текстуру с premultiply-шейдером (или же вывод подготовленного заранее изображения с обычным шейдером)</span></span>
<span class="line"><span style="color: #E6E6E6">2. Вывод рендер-таргет текстуры на экран с обычным шейдером (чтобы избежать лишнего умножения)</span></span>
<span class="line"><span style="color: #E6E6E6"></span></span>
<span class="line"><span style="color: #E6E6E6">математика (скопипащена с stackoverflow ответа):</span></span>
<span class="line"><span style="color: #E6E6E6">after layer 2: (a2 * r2, a2)</span></span>
<span class="line"><span style="color: #E6E6E6">after layer 3: (a3 * r3 + (1.0 - a3) * a2 * r2, (1.0 - a2) * a3 + a2)</span></span>
<span class="line"><span style="color: #E6E6E6"></span></span>
<span class="line"><span style="color: #E6E6E6">srcR = a3 * r3 + (1.0 - a3) * a2 * r2</span></span>
<span class="line"><span style="color: #E6E6E6">srcA = (1.0 - a2) * a3 + a2</span></span>
<span class="line"><span style="color: #E6E6E6">dstR = a1 * r1</span></span>
<span class="line"><span style="color: #E6E6E6">ONE * srcR + ONE_MINUS_SRC_ALPHA * dstR</span></span>
<span class="line"><span style="color: #E6E6E6">    = srcR + (1.0 - srcA) * dstR</span></span>
<span class="line"><span style="color: #E6E6E6">    = a3 * r3 + (1.0 - a3) * a2 * r2 + (1.0 - ((1.0 - a2) * a3 + a2)) * a1 * r1</span></span>
<span class="line"><span style="color: #E6E6E6">    = a3 * r3 + (1.0 - a3) * a2 * r2 + (1.0 - a3 + a2 * a3 - a2) * a1 * r1</span></span>
<span class="line"><span style="color: #E6E6E6">    = a3 * r3 + (1.0 - a3) * a2 * r2 + (1.0 - a3) * (1.0 - a2) * a1 * r1</span></span></code></pre></div></div></figure></p>
<p>Заметки по daScript:</p>
<ul>
<li>Вывод объекта с изменённым режимом блендинга и шейдером в <code>SFML</code> инкапуслирован в объекте <code>RenderStates</code></li>
<li>Вместо создания временных типов в этом примере используются “обычные” для <code>daScript</code> указатели:</li>
</ul>
<figure class="shiki dascript"><div class="codeblock"><div class="code"><pre class="shiki slack-dark"><code><span class="line"><span style="color: #C586C0">var</span><span style="color: #E6E6E6"> shaderPremult : Shader? </span><span style="color: #D4D4D4">=</span><span style="color: #E6E6E6"> </span><span style="color: #C586C0">new</span><span style="color: #E6E6E6"> Shader()</span></span></code></pre></div></div></figure>
<p>Такие <a target="_blank" rel="noopener" href="https://dascript.org/doc/reference/language/datatypes.html#pointers">указатели</a> хранят объект в куче и владеют им, по семантике близко к <code>std::unique_ptr</code>. При желании можно освободить объект вручную, присвоив указателю <code>nullptr</code>.</p>
<ul>
<li>ключевое слово implicit после имени типа в аргументах функции позволяет функции работать с обычными типами, так и с временными.</li>
</ul>
<p>Код примеров - <a target="_blank" rel="noopener" href="https://github.com/spiiin/dasbox_sfml/tree/main/samples/sfml_blending">https://github.com/spiiin/dasbox_sfml/tree/main/samples/sfml_blending</a></p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"Ov23liG1mZbiQOIdi91X","clientSecret":"e05812685eb741a752982b89dcf6f5b58dc10251","repo":"spiiin.github.io","owner":"spiiin","admin":["spiiin"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></article><div class="pagination"><a class="pagination__link pagination__prev" href="/blog/887709799/">Позже</a><a class="pagination__link pagination__next" href="/blog/2385889062/">Раньше</a></div></main><footer class="footer metadata"><p class="footer__text">© 2024 spiiin</p><p class="footer__text">Powered by <a class="footer__text__link" href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a class="footer__text__link" href="https://pages.github.com/" target="_blank">Github Page</a></p></footer></div><!-- hexo injector body_end start -->
  <script>
  const CODE_CONFIG = {
    beautify: undefined,
    highlightCopy: undefined,
    highlightLang: undefined,
    highlightHeightLimit: undefined,
    isHighlightShrink: undefined,
    copy: {
      success: 'undefined',
      error: 'undefined',
      noSupport: 'undefined',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body></html>